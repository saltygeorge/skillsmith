<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rustic Skilling & Crafting Game</title>
<style>
 /* --- Base / Background --- */
/* Hide Number Input Arrows */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
  -webkit-appearance: none; 
  margin: 0; 
}
input[type=number] {
  -moz-appearance: textfield;
  appearance: textfield; /* This line fixes the warning */
}

:root {
  --panel-bg: rgba(64, 40, 20, 0.95); /* Deeper, earthier brown */
  /* --- ADD THIS LINE --- */
  --panel-noise: linear-gradient(rgba(0,0,0,0.03), rgba(0,0,0,0.03));
  
  --accent: #6d452d; /* Darker, richer wood tone */
  --accent-hover: #8a5a3a; /* Darker hover effect */
  --gold: #b5a642;
  --slot-size: 60px;
  --slot-gap: 10px;
}

/* --- NEW MASTER PANEL STYLE --- */
.sidebar, 
.main, 
.chat-panel, 
.trade-content, 
#sessionLockOverlay div, 
#deathOverlay div, 
.settings-modal, 
.game-modal, 
#statsPanel,
#spellsPanel {   /* <--- ADDED THIS */
  /* 1. Original brown color */
  background-color: var(--panel-bg);
  
  /* 2. Subtle noise texture on top */
  background-image: var(--panel-noise);
  
  /* 3. New 3D "Bevel" Border */
  border: 4px solid #453625; /* Fallback */
  border-top-color: #7c644c;    /* Lighter top */
  border-left-color: #7c644c;   /* Lighter left */
  border-bottom-color: #3f2b21; /* Darker bottom */
  border-right-color: #3f2b21;  /* Darker right */
  
  /* 4. Same shadow and radius */
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.4);
  border-radius: 10px;
}

body {
  margin: 0;
  font-family: "Garamond", serif;
  background: #3f2b21;
  background-image: url('images/brickbackground.png');
  background-size: cover;
  background-attachment: fixed;
  background-position: center center;
  color: #fff;
  -webkit-font-smoothing: antialiased;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;

  /* --- ADD THESE LINES --- */
  -webkit-user-select: none; /* Safari */
  -ms-user-select: none;     /* IE 10+ */
  -moz-user-select: none;    /* Firefox */
  user-select: none;         /* Standard */
}

/* --- Start / Game screens --- */
#startScreen, #gameScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
}
#gameScreen { display: none; }

/* --- Layout container (MODIFIED) --- */
.container {
  width: 100%;
  max-width: 1240px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 24px;
  box-sizing: border-box;
  margin: 0 auto;
}

/* --- Panel Row Wrappers --- */
#top-row-panels {
  display: flex;
  gap: 20px;
  align-items: stretch;
  width: 100%;
}

#bottom-row-chat {
  display: flex;
  gap: 20px;
  width: 100%;
}

/* --- Spacer for Chat Panel --- */
.sidebar-spacer {
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  flex-shrink: 0;
}


/* --- Sidebar --- */
.sidebar {
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  padding: 16px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

/* +++ ADD THIS NEW RULE HERE +++ */
#leaderboardContent {
  /* Reduced height to prevent page scrollbar */
  min-height: 150px; 
  display: flex;
  flex-direction: column;
}

.char-header { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
.char-header h2, .main h2, #leaderboardPanel h2 { 
  margin: 0; 
  font-size: 20px;
}

.hp-bar { background: #772222; border-radius: 6px; margin-bottom: 12px; position: relative; height: 28px; }
.hp-fill { height: 100%; background: #d22; width: 100%; transition: width 0.25s; }
.hp-text { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.7); font-size: 13px; }

.tabs { 
  display: flex; 
  gap: 5px; 
  margin-bottom: 12px; 
  justify-content: center; /* Center the buttons */
}
.tabs button { 
  width: var(--slot-size);  /* Fixed width (60px) */
  /* Height removed to let padding define it */
  padding: 4px;             /* Reduced padding to lower height */
  border-radius: 8px; 
  border: 0; 
  background: var(--accent); 
  color: #fff; 
  cursor: pointer; 
  font-weight: 700; 
  
  display: flex; 
  justify-content: center;
  align-items: center;
}

/* --- NEW RULE FOR THE IMAGE INSIDE THE BUTTON --- */
.tabs button img {
  width: 40px;  /* Slightly larger to fill the new slot size */
  height: 40px; 
  object-fit: contain;
  display: block;
}
/* --- END NEW RULE --- */

.tabs button:hover { background: var(--accent-hover); }

/* --- Equipment / Inventory / Skills / Quests --- */
.tab-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  /* +++ FIX: Enforce height to match the tall Inventory tab +++ */
  min-height: 380px; 
}

/* --- NEW: Sub-tab buttons for Quests/Missions inside the Quest tab --- */
.sub-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.sub-tabs button {
  flex: 1;
  padding: 6px; /* Slightly smaller button for sub-tabs */
  border-radius: 6px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: #fff;
  cursor: pointer;
  font-weight: 700;
  font-size: 13px;
}

.sub-tabs button.active {
  background: var(--accent-hover);
  border-color: var(--gold);
}

#equipmentTab {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  justify-content: space-between; /* This pushes the button to the bottom */
}

.equipment-character { display: flex; justify-content: center; }
.character-frame { 
  display: grid;
  grid-template-columns: repeat(3, var(--slot-size));
  gap: var(--slot-gap);
  /* All the old flexbox and width properties are gone */
}
.equipment-slot {
  width: var(--slot-size); height: var(--slot-size);
  background: #c69c6d;
  border-radius: 8px;
  border: 2px solid rgba(170,140,100,0.55);
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
  display: flex; align-items: center; justify-content: center; overflow: hidden;
  position: relative; /* <-- THIS IS THE FIX */
}
.equipment-slot img { width: 100%; height: 100%; object-fit: contain; display: block; }

/* --- Inventory --- */
.inventory-grid-wrap {
  width: 100%;
  height: 320px; /* <--- Increased height to prevent cutting off the bottom row */
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 0;
  margin-left: 5px; /* <--- Increased to 6px */
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}
.inventory-grid {
  display: grid;
  /* Fixed column width (60px) to match buttons exactly, centered */
  grid-template-columns: repeat(4, var(--slot-size)); 
  gap: 5px; 
  padding: 0; 
  align-content: start;
  justify-content: center; /* <--- Aligns grid with the centered tabs */
}
.inv-slot {
  width: var(--slot-size); height: var(--slot-size);
  box-sizing: border-box; /* Keeps size exactly 60px including border */
  background: #c8b89a33;
  border-radius: 8px;
  border: 2px solid rgba(120,90,50,0.25);
  position: relative;
  display: flex; align-items: center; justify-content: center; overflow: hidden;
  cursor: pointer;
}
.inv-slot img { width: 100%; height: 100%; object-fit: contain; display: block; pointer-events: none; }
.inv-amount {
  position: absolute;
  right: 4px; bottom: 4px;
  background: rgba(0,0,0,0.6);
  padding: 2px 5px;
  font-size: 12px;
  border-radius: 6px;
  color: #fff;
  font-weight: 700;
  pointer-events: none;
}

/* --- Tooltip --- */
.tooltip {
  position: fixed;
  pointer-events: none;
  background: rgba(20,20,20,0.95);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  z-index: 4500; /* *** FIXED: Higher than the Inspect Modal (4000) *** */
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
  max-width: 240px;
}

/* --- Custom Scrollbar --- */
.inventory-grid-wrap::-webkit-scrollbar,
#chatMessages::-webkit-scrollbar {
  width: 8px;
}
.inventory-grid-wrap::-webkit-scrollbar-track,
#chatMessages::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}
.inventory-grid-wrap::-webkit-scrollbar-thumb,
#chatMessages::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}
.inventory-grid-wrap::-webkit-scrollbar-thumb:hover,
#chatMessages::-webkit-scrollbar-thumb:hover {
  background: var(--accent-hover);
}

/* --- Main area --- */
.main {
  flex: 1;
  padding: 18px;
  min-height: 500px; 
  position: relative;

  /* --- NEW: Added flex properties --- */
  display: flex;
  flex-direction: column;
}

.bank-content-wrapper {
  /* This overrides the standard padding from the parent containers (like .main or #mainContentWrapper) */
  padding: 0 10px 10px 10px; /* Adjust top/bottom padding as needed, but reduce left/right */
  width: 100%;
  box-sizing: border-box; /* Crucial for preventing width overflow */
}

#mainContentWrapper {
  flex-grow: 1;
  overflow-y: auto;
  min-height: 0;
  
  /* +++ FIX: Add these two lines to enable height:100% on children +++ */
  display: flex;
  flex-direction: column; 
  
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}

#mainContentWrapper::-webkit-scrollbar {
  width: 8px;
}
#mainContentWrapper::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}
#mainContentWrapper::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}
#mainContentWrapper::-webkit-scrollbar-thumb:hover {
  background: var(--accent-hover);
}

/* --- Chat Panel --- */
.chat-panel {
  padding: 18px;
  display: flex; 
  flex-direction: column;
  min-height: 200px;
  flex-shrink: 0;
  flex: 1;
}
#chatMessages {
  flex-grow: 1; 
  background: rgba(0,0,0,0.2); 
  border-radius: 6px; 
  padding: 8px; 
  overflow-y: auto; 
  height: 150px; 
  display: flex; 
  flex-direction: column-reverse;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}
#chatInputContainer { 
  display: flex; 
  gap: 8px; 
  margin-top: 10px;
}
#chatInput { 
  flex-grow: 1; 
  padding: 8px; 
  border-radius: 6px; 
  border: 1px solid var(--accent); 
  background: #3f2b21; 
  color: #fff;
}

/* --- Action Progress --- */
.progress-container {
  background: #7c644c;
  border-radius: 10px;
  height: 24px;
  overflow: hidden;
  position: relative;
}

.progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.08s; }
.action-buttons { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }
button.primary {
  background: var(--accent); color: #fff; border: 0; padding: 10px 14px; border-radius: 8px; font-weight: 700; cursor: pointer;
}

.progress-text {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.7);
  pointer-events: none; /* Lets clicks pass through */
}

button.primary:hover { background: var(--accent-hover); }

.xp-popup {
  position: absolute;
  background: #ffd700cc;
  color: #000;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 800;
  pointer-events: none;
  z-index: 1500;
  transform-origin: center;
  animation: rise 900ms ease-out forwards;
  box-shadow: 0 8px 18px rgba(0,0,0,0.35);
  white-space: nowrap; /* <--- Forces text to stay on one line */
}
@keyframes rise {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-46px); opacity: 0; }
}

@keyframes shake {
  0% { transform: translate(1px, 1px) rotate(0deg); }
  10% { transform: translate(-1px, -2px) rotate(-1deg); }
  20% { transform: translate(-3px, 0px) rotate(1deg); }
  30% { transform: translate(3px, 2px) rotate(0deg); }
  40% { transform: translate(1px, -1px) rotate(1deg); }
  50% { transform: translate(-1px, 2px) rotate(-1deg); }
  60% { transform: translate(-3px, 1px) rotate(0deg); }
  70% { transform: translate(3px, 1px) rotate(-1deg); }
  80% { transform: translate(-1px, -1px) rotate(1deg); }
  90% { transform: translate(1px, 2px) rotate(0deg); }
  100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.shake-animation {
  animation: shake 0.5s;
  animation-iteration-count: infinite;
}

/* --- NEW: Monster Damage Shake Animation --- */
@keyframes damageShake {
  0% { transform: translate(0, 0) rotate(0deg); }
  20% { transform: translate(-6px, 2px) rotate(-3deg); }
  40% { transform: translate(6px, -2px) rotate(3deg); }
  60% { transform: translate(-3px, 1px) rotate(-1deg); }
  80% { transform: translate(3px, -1px) rotate(1deg); }
  100% { transform: translate(0, 0) rotate(0deg); }
}

.enemy-hit-anim {
  animation: damageShake 0.4s ease-out;
}


/* --- NEW WARNING POPUP --- */
.warning-popup {
  position: absolute;
  background: rgba(221, 68, 68, 0.9); /* Red background */
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: 800;
  pointer-events: none;
  z-index: 1501; /* Above XP popup */
  transform-origin: center;
  animation: fadeOutWarning 3000ms ease-out forwards; /* 3 second animation */
  box-shadow: 0 8px 18px rgba(0,0,0,0.35);
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
@keyframes fadeOutWarning {
  0% { transform: translateY(0); opacity: 1; }
  80% { transform: translateY(-30px); opacity: 1; }
  100% { transform: translateY(-40px); opacity: 0; }
}
/* --- END NEW --- */

/* --- Trade Modal --- */
#tradeModal { display: none; }
.trade-content {
  padding: 20px;
  width: 90%;
  max-width: 1300px;
  min-height: 600px;
  display: flex;
  flex-direction: column;
}
.trade-main-area { display: flex; gap: 20px; flex: 1; }
.trade-panel {
  background: rgba(0,0,0,0.15);
  border-radius: 8px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  flex: 1;
}
.trade-gold-display {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 16px;
}
.trade-gold-display img { width: 30px; height: 30px; }
#tradeInventoryGridWrap {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}
#tradeMyOfferGrid, #tradeTheirOfferGrid {
  display: grid;
  grid-template-columns: repeat(4, var(--slot-size));
  grid-template-rows: repeat(4, var(--slot-size));
  gap: var(--slot-gap);
  padding: var(--slot-gap);
  align-content: start;
  height: calc((var(--slot-size) + var(--slot-gap)) * 4 + var(--slot-gap));
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
}
.inv-slot.offer-slot-placeholder {
  background: rgba(120,90,50,0.1);
  border-style: dashed;
}
.trade-offer-layout { display: flex; gap: 20px; }
.trade-offer-box { flex: 1; display: flex; flex-direction: column; }
.trade-gold-input {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: bold;
}
#tradeMyGoldOffer {
  width: 100px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid var(--accent);
  background: #3f2b21;
  color: #fff;
  font-size: 14px;
}
#tradeAcceptBtn {
  margin-top: 15px;
  background: var(--accent);
  font-size: 16px;
}
#tradeAcceptBtn:disabled {
  background: #555;
  opacity: 0.7;
  cursor: not-allowed;
}
.trade-status-indicator {
  margin-top: 10px;
  text-align: center;
  font-weight: bold;
  padding: 8px;
  border-radius: 6px;
}
#myTradeStatus {
  background: rgba(150,0,0,0.3);
  color: #ffaaaa;
}
#myTradeStatus.accepted {
  background: rgba(0,150,0,0.3);
  color: #aaffaa;
}
#theirTradeStatus {
  background: rgba(150,0,0,0.3);
  color: #ffaaaa;
}
#theirTradeStatus.accepted {
  background: rgba(0,150,0,0.3);
  color: #aaffaa;
}

/* --- Drag & Drop --- */
.inv-slot.dragging {
  opacity: 0.4;
  cursor: grabbing;
}
.inv-slot.drag-over {
  border-color: var(--gold);
  border-style: dashed;
  background: rgba(181, 166, 66, 0.1);
}

/* +++ NEW: SESSION LOCK OVERLAY +++ */
#sessionLockOverlay {
  display: none; /* Hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  z-index: 5000;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}
#sessionLockOverlay div {
  padding: 30px 40px;
  max-width: 400px;
}
#sessionLockOverlay h2 {
  margin-top: 0;
  color: var(--gold);
}

#deathOverlay {
  display: none; /* Hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  z-index: 5001; /* Higher than session lock */
  justify-content: center;
  align-items: center;
  text-align: center;
}
#deathOverlay div {
  padding: 30px 40px;
  max-width: 400px;
}
#deathOverlay h2 {
  margin-top: 0;
  color: #ff4d4d; /* Red for death */
}
/* +++ END NEW STYLES +++ */

/* --- NEW: Broadcast Overlay Style --- */
#broadcastOverlay {
  display: none; /* Hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  z-index: 5002; /* Above death/session lock */
  justify-content: center;
  align-items: center;
  text-align: center;
}
#broadcastOverlay div {
  /* This uses the master panel style */
  padding: 30px 40px;
  max-width: 400px;
}
#broadcastOverlay h2 {
  margin-top: 0;
  color: var(--gold);
}
/* --- END NEW --- */

#combat-main-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

#combat-enemy-area {
  flex-basis: 200px; /* Reduced from 220px */
  flex-shrink: 0;
  text-align: center;
  position: relative;
  margin-bottom: 15px;
}

#combat-enemy-img {
  max-height: 150px; /* Reduced from 180px */
  max-width: 100%;
  object-fit: contain;
}

#combat-enemy-hp-bar {
  background: #772222;
  border-radius: 6px;
  /* overflow: hidden; */ /* <-- This is the fix */
  position: relative;
  height: 28px;
  width: 80%;
  max-width: 300px;
  margin: 10px auto 0 auto;
  border: 2px solid #333;
}

#combat-enemy-hp-fill {
  height: 100%;
  background: #d22;
  width: 100%;
  transition: width 0.25s;
}

#combat-enemy-hp-text {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  font-weight: bold;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.7);
  font-size: 13px;
}

#combat-player-area {
  flex-grow: 1;
  display: flex;
  gap: 20px;
  background: rgba(0,0,0,0.15);
  padding: 15px;
  border-radius: 8px;
  justify-content: center; /* <-- ADDED THIS to center the buttons */
}


#combat-action-panel {
  /* flex-grow: 1; has been removed */
  display: flex;
  flex-direction: column;
}

#combat-styles-container {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  align-items: center;
}

#combat-styles {
  display: flex;
  gap: 5px;
  flex-grow: 1;
}

#auto-eat-slot-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 60px;
  flex-shrink: 0;
}

.auto-eat-slot {
  width: 50px;
  height: 50px;
  background: rgba(0,0,0,0.3);
  border: 2px dashed #555;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  cursor: pointer;
}

.auto-eat-slot img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

#combat-styles button {
  flex: 1;
  padding: 12px;
  border: 2px solid var(--accent);
  background: var(--accent);
  opacity: 0.7;
}

#combat-styles button.active {
  background: var(--accent-hover);
  border-color: var(--gold);
  opacity: 1.0;
}


#combat-main-actions {
  display: flex;
  gap: 10px;
  flex-direction: column; /* Stack buttons */
}

#combat-main-actions button {
  /* flex: 1; removed */
  font-size: 16px;
}
/* --- END: Combat UI Styles --- */

.combat-splat {
  position: absolute;
  right: -40px; /* Moved over to center the new box */
  top: -5px;    /* Moved up slightly */
  font-size: 1.2rem;
  font-weight: bold;
  pointer-events: none;
  z-index: 1600;
  animation: rise 900ms ease-out forwards;
  
  /* --- NEW "BOX" STYLES --- */
  background: rgba(10, 10, 10, 0.75);
  border: 1px solid #000;
  border-radius: 6px;
  padding: 3px 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

.splat-damage {
  color: #ff4d4d; /* Bright red */
  text-shadow: 0 1px 2px rgba(0,0,0,0.7); /* Simpler shadow */
}

.splat-block {
  color: #6dafff; /* Bright blue */
  text-shadow: 0 1px 2px rgba(0,0,0,0.7); /* Simpler shadow */
}

/* --- NEW: Special Attack Splat --- */
.splat-special {
  color: #b300ff; /* Bright Purple */
  font-size: 1.6rem; /* Larger text */
  font-weight: 900;
  border: 2px solid #fff; /* White border */
  background: rgba(50, 0, 50, 0.9);
  box-shadow: 0 0 10px #b300ff;
  z-index: 1650;
}

/* --- NEW: Item Context Menu --- */
#itemContextMenu {
  display: none;
  position: fixed;
  z-index: 3000;
  background: var(--panel-bg);
  border: 2px solid #453625;
  border-radius: 6px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  padding: 5px;
  min-width: 100px;
}
.context-menu-btn {
  display: block;
  width: 100%;
  padding: 8px 12px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 4px;
  text-align: left;
  cursor: pointer;
  font-weight: 700;
}
.context-menu-btn:hover {
  background: var(--accent-hover);
}
/* --- END: Item Context Menu --- */

#bankGrid, #shopGrid {
  /* Set the number of columns - Increased to 6 to fill side space */
  grid-template-columns: repeat(6, var(--slot-size)); 
  
  /* --- CRITICAL FIX: Re-add centering and set min-width on its WRAPPER --- */
  /* This ensures the grid is centered again */
  justify-content: center; 
}
/* --- END NEW RULE --- */

/* --- NEW: Bank UI Styles --- */

#bankContainer {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
#bankGoldPanel {
  background: rgba(0,0,0,0.15);
  padding: 10px 15px; 
  border-radius: 0; 
  display: flex;
  /* This will put the input/button group on one side and "Banked Gold" on the other */
  justify-content: space-between; 
  align-items: center;
  flex-wrap: wrap;
  gap: 10px; 
  margin-top: -4px;
  margin-bottom: 0; /* <--- Removed gap so panels touch */
}
#bankGoldPanel > div {
  text-align: center;
}
#bankGoldPanel .gold-display {
  font-size: 18px;
  font-weight: bold;
  color: var(--gold);
}
#bankGoldPanel input {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid var(--accent);
  background: #3f2b21;
  color: #fff;
  width: 120px;
}
#bankGridPanels {
  display: flex;
  gap: 20px;
}
#bankPanel, #bankInventoryPanel {
  flex: 1;
  background: rgba(0,0,0,0.15);
  padding: 10px 15px; /* Reduced padding to save height */
  border-radius: 0; 
  display: flex;
  flex-direction: column;
  /* --- CRITICAL FIX: Add min-width to prevent panel from shrinking --- */
  min-width: 400px; 
}
#bankPanel h3, #bankInventoryPanel h3 {
  margin: 0 0 5px 0; /* Reduced margin */
  text-align: center;
}
#bankGridWrap {
  /* flex: 1; <-- REMOVED */
  overflow-y: auto;
  overflow-x: hidden;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
  /* 4-row height */
  height: calc((var(--slot-size) + var(--slot-gap)) * 4 + var(--slot-gap));
}

/* --- NEW: Bank Tabs --- */
.bank-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 5px; /* Reduced margin */
  border-bottom: 2px solid var(--accent);
  padding-bottom: 5px;
}
.bank-tab-btn {
  background: #5a3e2b;
  border: 1px solid var(--accent);
  color: #aaa;
  padding: 6px 12px;
  cursor: pointer;
  font-weight: bold;
  border-radius: 4px 4px 0 0;
}
.bank-tab-btn.active {
  background: var(--accent);
  color: var(--gold);
  border-bottom-color: var(--accent); /* Merge with border */
}
/* +++ NEW: Style for bank tab images +++ */
.bank-tab-btn img {
  width: 32px; /* Increased size to fill space better */
  height: 32px; 
  object-fit: contain;
  pointer-events: none;
  display: block;
}
.add-tab-btn {
  background: #44aa44;
  color: #fff;
  font-weight: bold;
  border: 1px solid #2a662a;
  padding: 6px 10px;
  cursor: pointer;
  border-radius: 4px;
  margin-left: 5px;
}
.add-tab-btn:hover {
  background: #55cc55;
}

#shopGridWrap {
  /* This wrap will now auto-size to its content */
  overflow-y: hidden; /* Prevent scrollbar */
  overflow-x: hidden;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  height: auto !important; /* <-- THIS IS THE FIX */
  padding: var(--slot-gap);
  box-sizing: border-box;
}

#gameModalOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.7);
  z-index: 4000;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  box-sizing: border-box;
}
.game-modal {
  padding: 20px;
  width: 100%;
  max-width: 450px;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
.game-modal-title {
  font-size: 20px;
  font-weight: bold;
  color: var(--gold);
  margin: 0 0 15px 0;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 10px;
}
.game-modal-content {
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 20px;
}
.game-modal-input {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--accent);
  background: #3f2b21;
  color: #fff;
  font-size: 16px;
  box-sizing: border-box; /* Important */
}
.game-modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

#equipmentStats {
  /* This style is now used by the pop-up panel */
  padding: 10px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
}
.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 4px; /* Shrunk padding */
  font-size: 13px;   /* Shrunk font */
}
.stat-row:not(:last-child) {
  border-bottom: 1px solid var(--accent);
}
.stat-label {
  color: #efe3cf;
  font-weight: bold;
}
.stat-value {
  color: var(--gold);
  font-weight: bold;
}
/* --- END: Equipment Stats Display --- */

/* --- NEW: Locked Item/Vein Style --- */
.locked-item {
  opacity: 0.4;
  filter: grayscale(80%);
  cursor: not-allowed !important;
}
.locked-item:hover {
  background: var(--accent) !important; /* Prevents hover effect */
}
/* --- END: Locked Item/Vein Style --- */

.tabs button.active {
  background: var(--accent-hover); /* Make it look "pressed" */
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  border: 1px solid var(--gold); /* Highlight it */
}
#smithingItemsContainer {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 10px;
}
/* --- END: Smithing Tabs --- */

/* --- NEW: Smithing Tab Active State --- */
.tabs button.active {
  background: var(--accent-hover); /* Make it look "pressed" */
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  border: 1px solid var(--gold); /* Highlight it */
}
#smithingItemsContainer {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 10px;
}
/* --- END: Smithing Tabs --- */

#settingsBtn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  right: 2px; /* <-- FIX: Changed from 18px */
  width: 22px;
  height: 22px;
  background: transparent; 
  border: 0;
  outline: none;
  border-radius: 6px;
  cursor: pointer;
  padding: 0; 
  box-sizing: border-box;
  z-index: 10;
}
#settingsBtn:hover {
  background: transparent; /* <-- FIX: Keep background transparent on hover */
  opacity: 0.8; /* <-- Add a subtle hover effect instead */
}
#settingsBtn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none; /* Let clicks pass to the button */
}

.setting-row label {
  font-weight: bold;
  font-size: 16px;
  flex-basis: 110px; /* Give labels a fixed width to align sliders */
  flex-shrink: 0;
}
.setting-mute-btn {
  min-width: 80px; /* Make mute buttons smaller */
  padding: 8px 10px;
  margin-left: 15px; /* Space from slider */
}

/* --- NEW: Settings Modal --- */
#settingsModalOverlay {
  display: none; /* Hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.7);
  z-index: 4500; /* Below session lock, above trade */
  justify-content: center;
  align-items: center;
}
.settings-modal {
  padding: 20px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
}
.settings-modal-title {
  font-size: 20px;
  font-weight: bold;
  color: var(--gold);
  margin: 0 0 15px 0;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 10px;
}
.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  gap: 15px;
}
.setting-row label {
  font-weight: bold;
  font-size: 16px;
}
.volume-slider {
  flex-grow: 1;
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 12px;
  background: #3f2b21;
  border: 1px solid #453625;
  border-radius: 6px;
  outline: none;
}
.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  background: var(--accent-hover);
  border: 2px solid #453625;
  border-radius: 50%;
  cursor: pointer;
}
.volume-slider::-moz-range-thumb {
  width: 24px;
  height: 24px;
  background: var(--accent-hover);
  border: 2px solid #453625;
  border-radius: 50%;
  cursor: pointer;
}

/* --- NEW: Hub Screen Toggler --- */
.hub-screen {
  display: none; /* Hide all hubs by default */
  width: 100%;
  height: 100%;
  flex-direction: column;
}
.hub-screen.active {
  display: flex; /* Show the active one */
}
/* --- END NEW --- */

/* --- NEW: Spells Panel (Mirrors Stats Panel) --- */
#spellsPanel {
  display: flex; /* Always flex so layout works inside */
  visibility: hidden; /* Hidden visually, but keeps the space reserved */
  
  /* This width perfectly matches the .sidebar panel above it */
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  
  /* This height perfectly matches the .chat-panel next to it */
  min-height: 200px; 
  
  /* New layout styles */
  padding: 16px;
  box-sizing: border-box;
  flex-direction: column;
  flex-shrink: 0;
}
#spellsPanelHeader {
  font-size: 18px;
  font-weight: bold;
  color: #fff; /* <-- CHANGED TO WHITE */
  margin: -5px -5px 10px -5px;
  padding: 5px 10px;
  border-bottom: 2px solid var(--accent);
}
#spellsPanelContent {
  /* We can re-use the .stat-row styles here */
  padding: 10px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  flex-grow: 1; /* Allow content area to stretch */
}
#spellsPanelFooter {
  display: flex;
  justify-content: space-between; /* To put the autocast text on the left */
  align-items: center;
  margin-top: 15px;
}
/* --- END: Spells Panel --- */

/* --- NEW: Stats Panel --- */
#statsPanel {
  display: flex;
  visibility: hidden;
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  min-height: 200px; 
  padding: 16px;
  box-sizing: border-box;
  flex-direction: column;
  flex-shrink: 0;
  justify-content: space-between; 
  align-items: stretch; /* Changed from center to stretch so children fill width */
}
#statsPanelHeader {
  font-size: 18px;
  font-weight: bold;
  color: #fff; /* <-- CHANGED TO WHITE */
  margin: -5px -5px 10px -5px;
  padding: 5px 10px;
  border-bottom: 2px solid var(--accent);
}
#statsPanelContent {
  padding: 12px;
  background: rgba(0,0,0,0.15);
  border-radius: 6px;
  display: flex;
  gap: 12px;
  justify-content: center;
  /* Centering Logic */
  width: 100%;             /* Ensures the box fills the panel width */
  margin: auto 0;          /* Pushes the box to the vertical center of the panel */
  box-sizing: border-box;
}
.stats-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.stat-row {
  display: flex;
  justify-content: space-between; /* Pushes name to left, value to right */
  align-items: center;
  font-size: 12px;
  border-bottom: 1px solid rgba(109, 69, 45, 0.3);
  padding-bottom: 2px;
  width: 100%;
}
.stat-label {
  color: #efe3cf;
  font-weight: bold;
  flex-shrink: 1;    /* Allows text to breathe */
  padding-right: 4px; /* Small safety gap */
}
.stat-value {
  color: var(--gold);
  font-weight: bold;
}
#statsPanelFooter {
  display: flex;
  justify-content: flex-end; 
  align-items: center;
  margin-top: 15px;
  width: 100%;            /* Added to span the full width */
  box-sizing: border-box; /* Ensures padding doesn't cause overflow */
}

/* --- NEW: Updates Panel --- */
#updatesContent {
  /* Set a fixed height to make it scrollable */
  height: 112px; 
  background: rgba(0,0,0,0.2); 
  border-radius: 6px; 
  padding: 8px; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; /* Normal top-to-bottom flow */
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}
#updatesContent::-webkit-scrollbar { width: 8px; }
#updatesContent::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
#updatesContent::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
#updatesContent::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }

.update-message {
  margin-bottom: 8px;
  line-height: 1.4;
  font-size: 13px;
  word-break: break-word;
  /* Add a small border like the leaderboard */
  padding-bottom: 8px;
  border-bottom: 1px dashed rgba(255,255,255,0.1);
}
.update-message:last-child {
  border-bottom: none;
  margin-bottom: 0;
}
.update-message strong {
  color: var(--gold);
  display: block; /* Timestamp on its own line */
  font-size: 12px;
  opacity: 0.8;
  margin-bottom: 3px;
}
/* --- END: Updates Panel --- */

/* --- NEW: Loading Bar --- */
#loading-bar-container {
  width: 100%;
  background: #3f2b21;
  border: 2px solid var(--accent);
  border-radius: 8px;
  padding: 3px;
  margin-top: 15px;
  box-sizing: border-box;
  position: relative;
  height: 28px;
}
#loading-bar-fill {
  width: 0%;
  height: 100%;
  background: var(--gold);
  border-radius: 4px;
  transition: width 0.1s ease-out; /* A fast transition */
}
#loading-progress-percent {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  color: #fff;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.7);
}
/* --- END: Loading Bar --- */

/* --- NEW: Lottery System Styles --- */
.lottery-window {
  width: 100%;
  max-width: 400px; /* <--- Reduced width to 400px */
  height: 100px;
  background: #2a1a11;
  border: 4px solid #b5a642; /* Gold border */
  border-radius: 8px;
  overflow: hidden; /* Hides the strip */
  position: relative;
  margin: 0 auto;
  box-shadow: inset 0 0 20px #000;
}

.lottery-pointer {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 100%;
  background: rgba(255, 215, 0, 0.5); /* Semi-transparent gold line */
  z-index: 10;
  border-left: 1px solid #fff;
  border-right: 1px solid #fff;
}

.lottery-pointer::after {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 15px solid #fff;
}

.lottery-reel {
  display: flex;
  height: 100%;
  align-items: center;
  transform: translateX(0px);
}

.lottery-slot {
  width: 80px;
  height: 80px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-right: 1px solid rgba(255,255,255,0.1);
  position: relative;
  box-sizing: border-box; /* <--- THIS IS THE FIX */
}

.lottery-slot img {
  width: 60px;
  height: 60px;
  object-fit: contain;
}

.lottery-slot .qty-badge {
  position: absolute;
  bottom: 2px;
  right: 2px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  font-size: 10px;
  padding: 2px 4px;
  border-radius: 4px;
}
/* --- END Lottery Styles --- */

/* --- Quest Styles --- */
.quest-line-card {
  padding: 15px;
  background: rgba(0,0,0,0.2);
  border: 2px solid var(--accent);
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.quest-line-card:hover {
  background: rgba(0,0,0,0.3);
  border-color: var(--gold);
}
.quest-line-completed {
  opacity: 0.6;
  border-color: #44aa44;
}
.quest-req-met {
  color: #aaffaa;
}
.quest-req-not-met {
  color: #ffaaaa;
}

/* --- Completed Quest History Styles --- */
.completed-quest-row {
  padding: 6px 10px;
  background: rgba(0,0,0,0.2);
  margin-bottom: 4px;
  border-radius: 4px;
  font-size: 13px;
  color: #aaa; /* Dimmed text */
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 3px solid #44aa44; /* Green accent */
}
.completed-quest-row:last-child {
  margin-bottom: 0;
}

/* --- Specific Fix for Quest Line Hub Layout --- */
#hubQuestLine {
  /* These rules force the hub to stay inside the main panel without expanding it */
  flex-grow: 1;
  height: 0; /* CRITICAL: Forces flex calculation based on space, not content */
  min-height: 0;
  overflow: hidden; 
  display: flex;
  flex-direction: column;
}

/* NEW: The container that holds the text and scrolls */
.quest-scroll-container {
  flex-grow: 1;
  overflow-y: auto;
  padding-right: 10px; /* Prevent text hitting the scrollbar */
  margin-bottom: 10px;
  
  /* Firefox Scrollbar */
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}

/* Custom Scrollbar Styling */
.quest-scroll-container::-webkit-scrollbar {
  width: 8px;
}
.quest-scroll-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}
.quest-scroll-container::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}
.quest-scroll-container::-webkit-scrollbar-thumb:hover {
  background: var(--accent-hover);
}

/* --- NEW: Level Up Popup Styles --- */
#levelUpOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  z-index: 6000;
  justify-content: center;
  align-items: center;
  
  /* CHANGED: Allow clicks on the overlay to block game interaction */
  pointer-events: auto; 
  cursor: pointer; /* Indicates it can be clicked to close */
  
  /* +++ FADE EFFECT SETTINGS +++ */
  opacity: 0;
  transition: opacity 0.5s ease-in-out;
}

/* Class to toggle visibility */
#levelUpOverlay.visible {
  opacity: 1;
}

.levelup-card {
  position: relative;
  background: var(--panel-bg);
  border: 4px solid var(--gold);
  border-radius: 12px;
  padding: 30px 50px;
  text-align: center;
  box-shadow: 0 0 30px rgba(181, 166, 66, 0.6), inset 0 0 20px rgba(0,0,0,0.5);
  animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  overflow: hidden;
}

/* Festive Sunburst Background */
.levelup-rays {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 400px; height: 400px;
  background: repeating-conic-gradient(
    from 0deg,
    rgba(255, 215, 0, 0.1) 0deg 20deg,
    transparent 20deg 40deg
  );
  animation: rotateRays 10s linear infinite;
  z-index: 0;
  pointer-events: none;
}

.levelup-content {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.levelup-title {
  font-size: 32px;
  font-weight: bold;
  color: var(--gold);
  text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.levelup-icon-frame {
  width: 80px; height: 80px;
  background: rgba(0,0,0,0.3);
  border: 2px solid var(--accent);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 10px 0;
  box-shadow: 0 0 15px var(--gold);
}

.levelup-icon-frame img {
  width: 64px; height: 64px;
  object-fit: contain;
}

.levelup-text {
  font-size: 20px;
  color: #fff;
  text-shadow: 0 1px 2px #000;
}

.levelup-level {
  font-size: 48px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 0 10px var(--gold);
}

@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes rotateRays {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* --- Farm Interactive Overlay Styles --- */
.interactive-container {
  position: relative;
  width: 100%;
  max-width: 420px; /* Matches your image size constraint */
  margin: 0 auto;   /* Centers the container */
}

.interactive-bg {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 8px;
  border: 2px solid var(--accent);
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

.interactive-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10;
}

/* The interactive shapes */
.farm-zone {
  fill: rgba(255, 255, 255, 0.0); /* Invisible by default */
  stroke: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* Hover effect: Uses the gradient defined in HTML */
.farm-zone:hover {
  fill: url(#goldHoverGradient); 
  stroke: none;     /* <--- Removed the outline */
  stroke-width: 0;  /* <--- Set width to 0 */
  filter: drop-shadow(0 0 8px var(--gold)); 
}

/* --- Garden SVG Styles --- */
.garden-zone {
  fill: transparent;
  stroke: rgba(255, 255, 255, 0.2);
  stroke-width: 1;
  cursor: pointer;
  transition: all 0.2s;
}

.garden-zone:hover {
  fill: rgba(255, 215, 0, 0.3); /* Gold highlight */
  stroke: var(--gold);
  stroke-width: 2;
}

/* --- NEW: Wet Soil Styles (Overrides Gold) --- */
.garden-zone.watered-soil {
  fill: rgba(80, 50, 20, 0.4); /* Brown tint for wet dirt */
  stroke: #8B4513; /* SaddleBrown border */
  stroke-width: 2;
}

.garden-zone.watered-soil:hover {
  fill: rgba(100, 60, 30, 0.6); /* Darker brown on hover */
  stroke: #A0522D; /* Sienna border on hover */
}

.crop-svg-img {
  pointer-events: none; /* Click passes through to the polygon */
  filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
}

.planting-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  border-bottom: 1px solid #444;
  cursor: pointer;
  background: var(--panel-bg);
  color: #fff;
}
.planting-menu-item:hover {
  background: var(--accent);
}
.planting-menu-item img {
  width: 32px;
  height: 32px;
}

/* --- Garden SVG Styles --- */
.garden-zone {
  fill: transparent;
  stroke: rgba(255, 255, 255, 0.2);
  stroke-width: 1;
  cursor: pointer;
  transition: all 0.2s;
}

.garden-zone:hover {
  fill: rgba(255, 215, 0, 0.3); /* Gold highlight */
  stroke: var(--gold);
  stroke-width: 2;
}

.crop-svg-img {
  pointer-events: none; /* Click passes through to the polygon */
  filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
}

/* --- Farm Slot Styles --- */
.coop-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px; 
  justify-content: center;
  width: 100%;
  /* NEW: Restrict width to force 3 items per row (3 items x ~100px + gaps = ~320px) */
  max-width: 330px; 
  margin: 20px auto 0 auto; /* Centers the container block itself */
}

.chicken-slot {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 90px; /* Reduced width from 120px */
  background: rgba(0,0,0,0.2);
  padding: 5px; /* Reduced padding */
  border-radius: 8px;
  border: 1px solid #553322;
  position: relative;
}

.chicken-img-active {
  width: 70px; /* Reduced size from 100px */
  height: 70px;
  object-fit: contain;
  cursor: help;
}

.chicken-img-locked {
  width: 70px; /* Reduced size from 100px */
  height: 70px;
  object-fit: contain;
  filter: brightness(0.2) grayscale(100%); /* Darken effect */
  opacity: 0.7;
}

.feed-btn {
  margin-top: 5px;
  padding: 4px 8px;
  font-size: 12px;
  width: 100%;
}

/* --- Cow Slot Styles --- */
.cow-slot {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 90px; 
  background: rgba(0,0,0,0.2);
  padding: 5px; 
  border-radius: 8px;
  border: 1px solid #553322;
  position: relative;
}

.cow-img-active {
  width: 70px; 
  height: 70px;
  object-fit: contain;
  cursor: help;
}

.cow-img-locked {
  width: 70px; 
  height: 70px;
  object-fit: contain;
  filter: brightness(0.2) grayscale(100%); 
  opacity: 0.7;
}

/* --- Thieving Styles --- */
.thieving-target-card {
  background: rgba(0,0,0,0.3);
  border: 2px solid var(--accent);
  border-radius: 8px;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.thieving-info {
  flex-grow: 1;
}
.thieving-timer {
  font-family: monospace;
  color: var(--gold);
  font-weight: bold;
}
.thieving-chance {
  font-size: 13px;
  color: #ffaaaa;
}
.thieving-reward-preview {
  font-size: 12px;
  color: #aaa;
  font-style: italic;
}

/* --- Enchanting Glows --- */
.enchant-glow-1 { 
  filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.8)); 
  border: 2px solid rgba(0, 255, 0, 1) !important; 
  background: rgba(20, 40, 20, 0.8) !important; /* Dark Greenish Background */
}
.enchant-glow-2 { 
  filter: drop-shadow(0 0 8px rgba(0, 100, 255, 0.8)); 
  border: 2px solid rgba(0, 150, 255, 1) !important; 
  background: rgba(10, 20, 40, 0.8) !important; /* Dark Blueish Background */
}
.enchant-glow-3 { 
  filter: drop-shadow(0 0 10px rgba(180, 0, 255, 0.8)); 
  border: 2px solid rgba(180, 0, 255, 1) !important; 
  background: rgba(30, 10, 40, 0.8) !important; /* Dark Purplish Background */
}
.enchant-glow-4 { 
  filter: drop-shadow(0 0 12px rgba(255, 120, 0, 1)); 
  border: 2px solid rgba(255, 120, 0, 1) !important; 
  background: rgba(40, 20, 10, 0.8) !important; /* Dark Orangish Background */
}

.legendary-glow {
  filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.8)); 
  border: 2px solid rgba(255, 215, 0, 1) !important; 
  background: rgba(45, 35, 10, 0.9) !important; /* Rich Dark Gold Background */
  box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.2) !important;
}

.enchant-level-badge {
  position: absolute;
  top: 3px;
  left: 3px;
  color: #fff;
  font-weight: bold;
  font-size: 11px;
  text-shadow: 1px 1px 2px #000;
  pointer-events: none;
  background: rgba(0,0,0,0.5); /* Semi-transparent circle background */
  padding: 1px 4px;
  border-radius: 4px;
  z-index: 5;
}

#enchant-slot-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -150%); /* Moved higher up */
  z-index: 20;
}

/* --- NEW: Enchanting Visuals --- */
#enchantOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: black;
  opacity: 0;
  pointer-events: none;
  z-index: 4900; /* Below modals, above game */
  transition: opacity 0.5s ease-in-out;
}

#enchantOverlay.active {
  opacity: 0.7; /* Darkens screen */
}

/* Intense Shake for Enchanting */
@keyframes intenseShake {
  0% { transform: translate(0, 0) rotate(0deg); }
  10% { transform: translate(-5px, -5px) rotate(-1deg); }
  20% { transform: translate(5px, 5px) rotate(1deg); }
  30% { transform: translate(-5px, 5px) rotate(0deg); }
  40% { transform: translate(5px, -5px) rotate(1deg); }
  50% { transform: translate(-5px, 0px) rotate(-1deg); }
  60% { transform: translate(5px, 0px) rotate(0deg); }
  70% { transform: translate(0px, 5px) rotate(1deg); }
  80% { transform: translate(0px, -5px) rotate(-1deg); }
  90% { transform: translate(-2px, 2px) rotate(0deg); }
  100% { transform: translate(0, 0) rotate(0deg); }
}

.enchant-shake {
  animation: intenseShake 0.1s infinite; /* Fast shake */
}

/* Particles */
.magic-particle {
  position: fixed;
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 0 10px white, 0 0 20px var(--gold);
  pointer-events: none;
  z-index: 5005; /* Above everything */
}


</style>
</head>
<body>

<div id="loadingScreen" style="display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; background-color: #3f2b21;
 background-image: url('images/tittle.jpeg'); background-size: contain; background-position: center center; background-repeat: no-repeat; z-index: 10000;">
  <!-- Make the container a bit wider to fit the bar -->
  <div style="text-align: center; color: var(--gold); font-size: 20px; font-weight: bold; width: 300px;">
    Loading assets...
    <!-- NEW Progress Bar Structure -->
    <div id="loading-bar-container">
      <div id="loading-bar-fill"></div>
      <div id="loading-progress-percent">0%</div>
    </div>
    <!-- END Progress Bar -->
  </div>
</div>

<div id="authScreen" style="display:none; align-items:center; justify-content:center; width:100%;">
  <div style="background:rgba(0,0,0,0.15); padding:26px; border-radius:12px; text-align:center;">
    <h1>Login or Register</h1>
    <input id="authEmail" placeholder="Email" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:8px;"><br>
    <input id="authPassword" type="password" placeholder="Password" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:12px;"><br>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button class="primary" id="registerBtn">Register</button>
      <button class="primary" id="loginBtn" style="background:#666;">Login</button>
    </div>
    <div style="margin-top:12px; font-size:13px; opacity:0.9;">
      After login you will name your character and begin.
    </div>
  </div>
</div>

<div id="startScreen" style="display:none;">
  <div style="background:rgba(0,0,0,0.15); padding:26px; border-radius:12px; text-align:center;">
    <h1>Create your character</h1>
    <input id="playerName" placeholder="Enter name" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:12px;">
    <br>
    <button class="primary" onclick="createCharacter()">Create Character</button>
    <p style="margin-top:10px; font-size:13px; opacity:0.9;">Images: place them in <code>images/</code> (optional)</p>
  </div>
</div>


<div id="gameScreen">
  <div class="container">
    
    <div id="top-row-panels">
      
      <div class="sidebar">
        <div class="char-header" style="position: relative;">
          <h2 id="charName">Player</h2>
          <button id="settingsBtn" onmouseenter="showTooltip(event, 'Settings')" onmouseleave="hideTooltip()">
            <img src="images/gearicon.png" alt="Settings">
          </button>
        </div>
        <div class="hp-bar">
          <div class="hp-fill" id="hpFill" style="width:100%"></div>
          <div class="hp-text" id="hpText">10 / 10 HP</div>
        </div>
        <div class="tabs">
  <button onclick="showTab('equipment')" id="tabEquipmentBtn" onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Equipment</div>')" onmouseleave="hideTooltip()">
    <img src="images/equipmenticon.png" alt="Equipment">
  </button>
  <button onclick="showTab('inventory')" id="tabInventoryBtn" onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Inventory</div>')" onmouseleave="hideTooltip()">
    <img src="images/backpackicon.png" alt="Inventory">
  </button>
  <button onclick="showTab('skills')" id="tabSkillsBtn" onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Skills</div>')" onmouseleave="hideTooltip()">
    <img src="images/skillicon.png" alt="Skills">
  </button>
  <button onclick="showTab('quests')" id="tabQuestsBtn" onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Quests / Missions</div>')" onmouseleave="hideTooltip()">
    <img src="images/questicon.png" alt="Quests">
  </button>
</div>
        <div class="tab-content">
          <div id="equipmentTab">
            <div class="equipment-character">
              <div class="character-frame">
                <div class="equipment-slot" id="necklace">
                  <img src="images/necklace.png" alt="Necklace">
                </div>
                <div class="equipment-slot" id="helmet">
                  <img src="images/helmet.png" alt="Helmet">
                </div>
                <div class="equipment-slot" id="cape">
                  <img src="images/cape.png" alt="Cape">
                </div>
                <div class="equipment-slot" id="weapon">
                  <img src="images/weapon.png" alt="Weapon">
                </div>
                <div class="equipment-slot" id="chest">
                  <img src="images/chestplate.png" alt="Chest">
                </div>
                <div class="equipment-slot" id="shield">
                  <img src="images/shield.png" alt="Shield">
                </div>
                <div class="equipment-slot" id="ring1">
                  <img src="images/ring.png" alt="Ring 1">
                </div>
                <div class="equipment-slot" id="legs">
                  <img src="images/legs.png" alt="Legs">
                </div>
                <div class="equipment-slot" id="ring2">
                  <img src="images/ring.png" alt="Ring 2">
                </div>
                <div class="equipment-slot" id="arrows">
                  <img src="images/arrows.png" alt="Arrows">
                </div>
                <div class="equipment-slot" id="boots">
                  <img src="images/boots.png" alt="Boots">
                </div>
                <div class="equipment-slot" id="pet">
                  <img src="images/pet.png" alt="Pet">
                </div>
              </div>
            </div>

            <div id="statsButtonContainer" style="display: flex; justify-content: space-between; margin-top: 20px;">
    <button class="primary" id="toggleStatsBtn">Stats</button> <button class="primary" id="toggleSpellsBtn">Spells</button>
</div>
            </div>
          
          <div id="inventoryTab" style="display:none;">
            <div class="inventory-grid-wrap" id="inventoryGridWrap">
              <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 14px;">
            
  <div id="goldDisplay" style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 0px 8px;">
    <img src="images/goldpouch.png" alt="Gold" style="width: 40px; height: 40px; object-fit: contain;">
    <span id="goldAmountText" style="font-weight: bold; font-size: 16px; color: var(--gold); padding-top: 0px;">0</span>
  </div>
              
</div>
            
          </div>
          
          <div id="skillsTab" style="display:none;">
            </div>
          
          <div id="questsTab" style="display:none; flex-direction: column; flex-grow: 1;">
            <div class="sub-tabs">
              <button id="showQuestsBtn" class="active" onclick="showQuestSubTab('quests')">Quests</button>
              <button id="showMissionsBtn" onclick="showQuestSubTab('missions')">Missions</button>
            </div>

            <div id="questTabContentWrapper" class="quest-scroll-container" style="flex-grow: 1; padding-right: 0;">
            
              <div id="questsSubTabContent" style="display: block;">
                </div>

              <div id="missionsSubTabContent" style="display: none;">
                </div>
            </div>

            </div>
          
        </div>
      </div>

      <div class="main" id="mainArea">

        <div id="mainContentWrapper">
        
          <div id="hubActions" class="hub-screen">
            <div id="actionScreen" style="display: flex; gap: 10px; flex-wrap: wrap;">
              <img id="minesActionIcon" src="images/mines.png" alt="Mines" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="crystalMineActionIcon" src="images/crystalmine.jpeg" alt="Crystal Mine" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="fishingActionIcon" src="images/fishingareasbutton.jpeg" alt="Fishing Areas" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="forestActionIcon" src="images/foresticon.png" alt="Forest" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="blacksmithActionIcon" src="images/blacksmithicon.png" alt="Blacksmith" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="fletchingActionIcon" src="images/fletchingworkbench.png" alt="Fletching" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="kitchenActionIcon" src="images/kitchenbutton.png" alt="Kitchen" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="combatActionIcon" src="images/combatareas.png" alt="Combat Areas" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="shopActionIcon" src="images/shopbutton.png" alt="Shop" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="bankActionIcon" src="images/bankbutton.png" alt="Bank" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="craftingActionIcon" src="images/craftingbenchbutton.png" alt="Crafting" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="elementalForgeActionIcon" src="images/elementalforge.jpeg" alt="Elemental Forge" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="lotteryActionIcon" src="images/lotteryicon.jpeg" alt="Lottery" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="questsActionIcon" src="images/questbuttonicon.jpg" alt="Quests" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="huntingBoardActionIcon" src="images/huntingboard.jpeg" alt="Hunting Board" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="personalFarmActionIcon" src="images/farmicon.jpeg" alt="My Farm" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="petYardActionIcon" src="images/petyardicon.jpeg" alt="Pet Yard" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="alchemyActionIcon" src="images/alchemyicon.jpeg" alt="Alchemy Table" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="tailoringActionIcon" src="images/tailoringtable.png" alt="Tailoring Table" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;">
              <img id="thievingActionIcon" src="images/thievingicon.jpeg" alt="Thieving" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;" onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Thieving</div>Pickpocket and loot')" onmouseleave="hideTooltip()">
              <img id="enchantingActionIcon" src="images/enchantingtableicon.jpeg" alt="Enchanting Table" style="margin-top: 10px; cursor: pointer; width: 60px; height: 60px; object-fit: contain;" onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Enchanting Table</div>Upgrade your gear')" onmouseleave="hideTooltip()">
            </div>
          </div>

          <div id="hubQuests" class="hub-screen">
            <h2>Quest Lines</h2>
            <div style="margin-top:8px; color:#efe3cf;">Select a category to view your current task.</div>
            <div id="questLinesContainer" style="margin-top: 20px; display: flex; flex-direction: column; gap: 15px;">
                </div>
            <div class="action-buttons" style="margin-top: 20px;">
              <button id="hubQuests_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubHuntingBoard" class="hub-screen">
            <h2>Hunting Board</h2>
            <div style="margin-top:8px; color:#efe3cf;">Accept bounties to earn gold and experience.</div>
            
            <div id="bountyContent" style="margin-top: 20px; display: flex; flex-direction: column; gap: 15px;">
                </div>

            <div class="action-buttons" style="margin-top: 20px;">
              <button id="hubHuntingBoard_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubPersonalFarm" class="hub-screen">
            <h2>My Farm</h2>
          
            
            <div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                
                <div class="interactive-container">
                    <img src="images/personalfarm.webp" alt="Personal Farm" class="interactive-bg">
                    
                    <svg class="interactive-overlay" viewBox="0 0 488 300" preserveAspectRatio="none">
                        
                        <defs>
                          <radialGradient id="goldHoverGradient" cx="50%" cy="50%" r="70%" fx="50%" fy="50%">
                            <stop offset="0%" style="stop-color:rgb(255, 215, 0); stop-opacity:0" />
                            <stop offset="100%" style="stop-color:rgb(255, 215, 0); stop-opacity:0.5" />
                          </radialGradient>
                        </defs>

                        <polygon class="farm-zone" 
                                 points="177,217 281,217 281,276 177,276" 
                                 onclick="handleBarnClick(); playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');" 
                                 onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Barn</div>Manage Cows'); playGlobalSound('sounds/soundeffects/cowbuttonsoundeffect.mp3');" 
                                 onmouseleave="hideTooltip()">
                        </polygon>

                        <polygon class="farm-zone" 
                                 points="113,241 125,231 163,231 175,241 175,276 113,276" 
                                 onclick="handleCellarClick(); playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');" 
                                 onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Cellar</div>Grow Mushrooms');" 
                                onmouseleave="hideTooltip()">
                                </polygon>                       

                        <polygon class="farm-zone" 
                                 points="18,218 105,190 105,276 18,276" 
                                 onclick="handleChickenCoopClick(); playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');" 
                                 onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Chicken Coop</div>Manage Chickens'); playGlobalSound('sounds/soundeffects/chickenbuttonsoundeffect.mp3');" 
                                 onmouseleave="hideTooltip()">
                        </polygon>

                        
                      
                        <polygon class="farm-zone" 
                                 points="345,126 334,126 334,110 322,110 322,105 368,63 378,63 423,105 423,110 411,110 411,126 403,126 412,250 333,250" 
                                 onclick="handleWindmillClick()" 
                                 onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Windmill</div>Process Flour')" 
                                 onmouseleave="hideTooltip()">
                        </polygon>

                        <polygon class="farm-zone" 
                                 points="395,194 483,194 483,280 395,280" 
                                 onclick="handleWellClick(); playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');" 
                                 onmouseenter="showTooltip(event, '<div style=\'color:var(--gold); font-weight:bold;\'>Well</div>Fresh Water'); playGlobalSound('sounds/soundeffects/wellsoundeffect.mp3');" 
                                 onmouseleave="hideTooltip()">
                        </polygon>

                    </svg>
                </div>

                <div style="width: 100%; max-width: 420px; display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button id="goToGardenBtn" class="primary" style="padding: 8px 16px; font-size: 18px;" onmouseenter="showTooltip(event, 'Go to Garden')" onmouseleave="hideTooltip()">
                        &#10140; </button>
                </div>

            </div>

            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubPersonalFarm_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubPetYard" class="hub-screen">
            <h2>Pet Yard</h2>
            
            <div id="petYardContent" style="margin-top: 20px;"></div>

            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubPetYard_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubAlchemy" class="hub-screen">
            <h2>Alchemy Table</h2>
            <div style="margin-top:8px; color:#efe3cf;">Brew powerful potions from mushrooms and herbs.</div>
            <div id="alchemyItemsContainer" class="action-buttons" style="margin-top: 14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubAlchemy_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>

          <div id="hubTailoring" class="hub-screen">
            <h2>Tailoring Table</h2>
            <div style="margin-top:8px; color:#efe3cf;">Work with leather and cloth to create armor.</div>
            <div id="tailoringItemsContainer" class="action-buttons" style="margin-top: 14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubTailoring_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>

          <div id="hubThieving" class="hub-screen">
            <h2>Thieving</h2>
            <div style="margin-top:8px; color:#efe3cf;">Pickpocket targets or loot containers. Be careful not to get caught!</div>
            <div id="thievingTargetsList" style="margin-top: 20px; display: flex; flex-direction: column;">
                <!-- Targets injected here -->
            </div>
            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubThieving_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubGarden" class="hub-screen">
            <h2>The Garden</h2>
            
            <div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                
                <div class="interactive-container" style="height: 320px;">
                    <img src="images/cropfield.jpeg" alt="The Garden" class="interactive-bg" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
                    
                    <svg class="interactive-overlay" viewBox="0 0 600 400" preserveAspectRatio="none">
                        
                        <polygon id="garden-poly-0" 
                                 points="113,192 199,192 191,225 98,225" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 0)"></polygon>
                        
                        <image id="garden-img-0" 
                               href="" 
                               x="101" y="152" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>

                               <polygon id="garden-poly-1" 
                                 points="212,192 296,192 296,225 205,225" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 1)"></polygon>
                        
                        <image id="garden-img-1" 
                               href="" 
                               x="204" y="152" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>

                               <polygon id="garden-poly-2" 
                                 points="309,192 394,192 402,225 309,225" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 2)"></polygon>
                        
                        <image id="garden-img-2" 
                               href="" 
                               x="305" y="152" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>

                               <polygon id="garden-poly-3" 
                                 points="406,192 492,192 507,225 415,225" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 3)"></polygon>
                        
                        <image id="garden-img-3" 
                               href="" 
                               x="407" y="152" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>

                        <polygon id="garden-poly-4" 
                                 points="92,236 189,236 181,273 73,273" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 4)"></polygon>
                        
                        <image id="garden-img-4" 
                               href="" 
                               x="85" y="198" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>

                        <polygon id="garden-poly-5" 
                                 points="203,236 296,236 296,272 194,272" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 5)"></polygon>
                        
                        <image id="garden-img-5" 
                               href="" 
                               x="200" y="198" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>       
                        
                        <polygon id="garden-poly-6" 
                                 points="308,236 405,236 414,272 308,272" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 6)"></polygon>
                        
                        <image id="garden-img-6" 
                               href="" 
                               x="309" y="198" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>       
                         
                        <polygon id="garden-poly-7" 
                                 points="418,236 514,236 530,272 429,272" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 7)"></polygon>
                        
                        <image id="garden-img-7" 
                               href="" 
                               x="423" y="198" width="100" height="100" 
                               class="crop-svg-img" 
                               style="display:none;"></image>   
                               
                        <polygon id="garden-poly-8" 
                                 points="68,282 178,282 167,327 46,327" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 8)"></polygon>
                        
                        <image id="garden-img-8" 
                               href="" 
                               x="62" y="241" width="110" height="110" 
                               class="crop-svg-img" 
                               style="display:none;"></image>    
                               
                        <polygon id="garden-poly-9" 
                                 points="189,282 298,282 298,327 179,327" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 9)"></polygon>
                        
                        <image id="garden-img-9" 
                               href="" 
                               x="189" y="241" width="110" height="110" 
                               class="crop-svg-img" 
                               style="display:none;"></image>   
                               
                        <polygon id="garden-poly-10" 
                                 points="308,282 418,282 429,327 308,327" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 10)"></polygon>
                        
                        <image id="garden-img-10" 
                               href="" 
                               x="310" y="241" width="110" height="110" 
                               class="crop-svg-img" 
                               style="display:none;"></image>     
                               
                        <polygon id="garden-poly-11" 
                                 points="430,282 538,282 558,327 440,327" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 11)"></polygon>
                        
                        <image id="garden-img-11" 
                               href="" 
                               x="435" y="241" width="110" height="110" 
                               class="crop-svg-img" 
                               style="display:none;"></image>       

                        <polygon id="garden-poly-12" 
                                 points="39,336 162,336 144,400 6,400" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 12)"></polygon>
                        
                        <image id="garden-img-12" 
                               href="" 
                               x="25" y="300" width="130" height="130" 
                               class="crop-svg-img" 
                               style="display:none;"></image>    
                               
                        <polygon id="garden-poly-13" 
                                 points="175,336 298,336 298,400 161,400" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 13)"></polygon>
                        
                        <image id="garden-img-13" 
                               href="" 
                               x="173" y="300" width="130" height="130" 
                               class="crop-svg-img" 
                               style="display:none;"></image>     
                               
                        <polygon id="garden-poly-14" 
                                 points="308,336 430,336 446,400 308,400" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 14)"></polygon>
                        
                        <image id="garden-img-14" 
                               href="" 
                               x="310" y="300" width="130" height="130" 
                               class="crop-svg-img" 
                               style="display:none;"></image>    
                               
                        <polygon id="garden-poly-15" 
                                 points="444,336 566,336 601,400 461,400" 
                                 class="garden-zone"
                                 onclick="handleGardenSlotClick(event, 15)"></polygon>
                        
                        <image id="garden-img-15" 
                               href="" 
                               x="454" y="300" width="130" height="130" 
                               class="crop-svg-img" 
                               style="display:none;"></image>       

                    </svg>
                </div>

                <div style="width: 100%; max-width: 420px; display: flex; justify-content: flex-start; margin-top: 10px;">
                    <button id="backToFarmFromGardenBtn" class="primary" style="padding: 8px 16px; font-size: 18px;" onmouseenter="showTooltip(event, 'Back to Farm')" onmouseleave="hideTooltip()">
                        &#10140; 
                    </button>
                </div>

            </div>

            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubGarden_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
         
         <div id="hubCellar" class="hub-screen">
            <h2>The Cellar</h2>
            <div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
                <div class="interactive-container" style="height: 320px;">
                    <img src="images/cellar.jpeg" alt="The Cellar" class="interactive-bg" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
                    <svg class="interactive-overlay" viewBox="0 0 600 400" preserveAspectRatio="none">
                        <!-- Polygons 0-15 -->
                        <polygon id="cellar-poly-0" points="113,192 199,192 191,225 98,225" class="garden-zone" onclick="handleCellarSlotClick(event, 0)"></polygon>
                        <image id="cellar-img-0" x="101" y="152" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-1" points="212,192 296,192 296,225 205,225" class="garden-zone" onclick="handleCellarSlotClick(event, 1)"></polygon>
                        <image id="cellar-img-1" x="204" y="152" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-2" points="309,192 394,192 402,225 309,225" class="garden-zone" onclick="handleCellarSlotClick(event, 2)"></polygon>
                        <image id="cellar-img-2" x="305" y="152" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-3" points="406,192 492,192 507,225 415,225" class="garden-zone" onclick="handleCellarSlotClick(event, 3)"></polygon>
                        <image id="cellar-img-3" x="407" y="152" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-4" points="92,236 189,236 181,273 73,273" class="garden-zone" onclick="handleCellarSlotClick(event, 4)"></polygon>
                        <image id="cellar-img-4" x="85" y="198" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-5" points="203,236 296,236 296,272 194,272" class="garden-zone" onclick="handleCellarSlotClick(event, 5)"></polygon>
                        <image id="cellar-img-5" x="200" y="198" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-6" points="308,236 405,236 414,272 308,272" class="garden-zone" onclick="handleCellarSlotClick(event, 6)"></polygon>
                        <image id="cellar-img-6" x="309" y="198" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-7" points="418,236 514,236 530,272 429,272" class="garden-zone" onclick="handleCellarSlotClick(event, 7)"></polygon>
                        <image id="cellar-img-7" x="423" y="198" width="100" height="100" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-8" points="68,282 178,282 167,327 46,327" class="garden-zone" onclick="handleCellarSlotClick(event, 8)"></polygon>
                        <image id="cellar-img-8" x="62" y="241" width="110" height="110" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-9" points="189,282 298,282 298,327 179,327" class="garden-zone" onclick="handleCellarSlotClick(event, 9)"></polygon>
                        <image id="cellar-img-9" x="189" y="241" width="110" height="110" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-10" points="308,282 418,282 429,327 308,327" class="garden-zone" onclick="handleCellarSlotClick(event, 10)"></polygon>
                        <image id="cellar-img-10" x="310" y="241" width="110" height="110" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-11" points="430,282 538,282 558,327 440,327" class="garden-zone" onclick="handleCellarSlotClick(event, 11)"></polygon>
                        <image id="cellar-img-11" x="435" y="241" width="110" height="110" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-12" points="39,336 162,336 144,400 6,400" class="garden-zone" onclick="handleCellarSlotClick(event, 12)"></polygon>
                        <image id="cellar-img-12" x="25" y="300" width="130" height="130" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-13" points="175,336 298,336 298,400 161,400" class="garden-zone" onclick="handleCellarSlotClick(event, 13)"></polygon>
                        <image id="cellar-img-13" x="173" y="300" width="130" height="130" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-14" points="308,336 430,336 446,400 308,400" class="garden-zone" onclick="handleCellarSlotClick(event, 14)"></polygon>
                        <image id="cellar-img-14" x="310" y="300" width="130" height="130" class="crop-svg-img" style="display:none;"></image>
                        <polygon id="cellar-poly-15" points="444,336 566,336 601,400 461,400" class="garden-zone" onclick="handleCellarSlotClick(event, 15)"></polygon>
                        <image id="cellar-img-15" x="454" y="300" width="130" height="130" class="crop-svg-img" style="display:none;"></image>
                    </svg>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubCellar_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubWell" class="hub-screen">
            <h2>The Well</h2>
            <div style="margin-top:8px; color:#efe3cf;">The water is cool and crystal clear.</div>
            <div class="action-buttons" style="margin-top: 20px;">
              <button id="hubWell_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubBarn" class="hub-screen">
            <h2>The Barn</h2>
            
            <div style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; width: 90%; max-width: 400px; display: flex; align-items: center; justify-content: space-between; margin-left: auto; margin-right: auto;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="images/bucketofmilk.png" style="width: 32px; height: 32px; margin-top: 4px;">
                    <span id="milkReadyDisplay" style="font-size: 16px; font-weight: bold; color: var(--gold);">0 Ready</span>
                </div>
                <button id="collectMilkBtn" class="primary" onclick="collectMilk()">Milk All</button>
            </div>

            <div id="barnSlotsContainer" class="coop-container" style="margin-top: 20px;">
                </div>

            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubBarn_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubChickenCoop" class="hub-screen">
            <h2>Chicken Coop</h2>
            <div style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; width: 90%; max-width: 400px; display: flex; align-items: center; justify-content: space-between; margin-left: auto; margin-right: auto;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="images/egg.png" style="width: 38px; height: 32px; margin-top: 4px;">
                    <span id="eggCountDisplay" style="font-size: 18px; font-weight: bold; color: var(--gold);">0</span>
                </div>
                <button id="collectEggsBtn" class="primary" onclick="collectEggs()">Collect All</button>
            </div>

            <div id="coopSlotsContainer" class="coop-container" style="margin-top: 20px;">
                </div>

            <div class="action-buttons" style="margin-top: auto; padding-bottom: 10px;">
              <button id="hubChickenCoop_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubWindmill" class="hub-screen">
            <h2>The Windmill</h2>
            <div style="margin-top:8px; color:#efe3cf;">The massive blades spin slowly in the breeze.</div>
            <div class="action-buttons" style="margin-top: 20px;">
              <button id="hubWindmill_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubQuestLine" class="hub-screen">
            <h2 id="questLineTitle" style="color: #fff; flex-shrink: 0;">Quest Line Title</h2>
            
            <div class="quest-scroll-container">
                
                <div id="activeQuestContainer" style="margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--accent);">
                </div>

                <div id="completedQuestsSection" style="margin-top: 15px; display:none; background: rgba(0,0,0,0.15); padding: 10px; border-radius: 8px;">
                    <div style="color: #888; font-size: 12px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase;">History</div>
                    <div id="completedQuestsList">
                    </div>
                </div>
            
            </div>

            <div class="action-buttons" style="margin-top: 20px; flex-shrink: 0;">
              <button id="questLine_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubCrafting" class="hub-screen">
            <h2>Crafting Bench</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose an item to craft.</div>
            <div id="craftingItemsContainer" class="action-buttons" style="margin-top: 14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubCrafting_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>

          <div id="hubElementalForge" class="hub-screen">
            <h2>Elemental Forge</h2>
            <div style="margin-top:8px; color:#efe3cf;">Forge magical stones from crystal shards.</div>
            <div id="elementalForgeItemsContainer" class="action-buttons" style="margin-top: 14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubElementalForge_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>
          
          <div id="hubMine" class="hub-screen">
            <h2>Mine</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose a vein to mine.</div>
            <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              <button id="sandVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/sandvein.jpeg" alt="Sand" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="copperVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/coppervein.png" alt="Copper Vein" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="coalVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/coalvein.png" alt="Coal Vein" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="ironVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/ironvein.png" alt="Iron Vein" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="silverVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/silvervein.jpeg" alt="Silver Vein" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="goldVeinBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/goldvein.jpeg" alt="Gold Vein" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
            </div>
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubMine_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>

          <div id="hubCrystalMine" class="hub-screen">
            <h2>Crystal Mine</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose a crystal vein to mine.</div>
            <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              <button id="earthCrystalBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/earthcrystalvein.png" alt="Earth Crystal" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="airCrystalBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/aircrystalvein.png" alt="Air Crystal" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              <button id="waterCrystalBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/watercrystalvein.png" alt="Water Crystal" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
            </div>
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubCrystalMine_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>
          
          <div id="hubBlacksmith" class="hub-screen">
            <h2>Blacksmithing</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose an item to smith.</div>
            <div class="tabs" style="margin-top: 14px; margin-bottom: 14px; width: 100%;">
    <button id="smithCopperTab" class="active">Copper</button>
    <button id="smithIronTab">Iron</button>
    <button id="smithSilverTab">Silver</button>
    <button id="smithGoldTab">Gold</button>
</div>
            <div id="smithingItemsContainer" class="action-buttons" style="margin-top: 0; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubBlacksmith_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>

          <div id="hubFletching" class="hub-screen">
            <h2>Fletching</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose an item to fletch.</div>
            <div id="fletchingItemsContainer" class="action-buttons" style="margin-top: 14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              </div>
            <div class="action-buttons" style="margin-top: 14px; width: 100%;">
              <button id="hubFletching_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>
          
          <div id="hubForest" class="hub-screen">
    <h2>Forest</h2>
    <div style="margin-top:8px; color:#efe3cf;">Choose a tree to chop.</div>
    
    <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
      <button id="softwoodTreeBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/softwood.png" alt="Softwood Tree" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      
      <button id="oakTreeBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/oak.png" alt="Oak Tree" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>

      <button id="birchTreeBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/birch.png" alt="Birch Tree" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      
      <button id="mapleTreeBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/maple.png" alt="Maple Tree" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      
      <button id="mahoganyTreeBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/mahogany.png" alt="Mahogany Tree" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
    </div>

    <div class="action-buttons" style="margin-top: 14px;">
      <button id="hubForest_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
    </div>
</div>
          
          
          <div id="hubKitchen" class="hub-screen">
            <h2>Kitchen</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose something to cook.</div>
            <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              
              <button id="cookChickenBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cookedchicken.png" alt="Cooked Chicken" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>

              <button id="cookBeefBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cookedbeef.png" alt="Cooked Beef" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>

              <button id="cookHerringBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cookedherring.png" alt="Cooked Herring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="cookTroutBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cookedtrout.png" alt="Cooked Trout" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="cookSalmonBtn" class="primary" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cookedsalmon.png" alt="Cooked Salmon" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
              </button>

            </div>
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubKitchen_ReturnBtn" class="primary" style="background:#666; margin-top: 20px;">Return</button>
            </div>
          </div>
          
          <div id="hubCombat" class="hub-screen">
            <h2>Combat Areas</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose an area to start fighting.</div>
            
            <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:row; flex-wrap: wrap; align-items:flex-start; gap: 10px;">
              <button id="farmAreaBtn" class="primary" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/farm.png" alt="Farm Area" style="width: 80px; height: 80px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="caveAreaBtn" class="primary" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/cave.png" alt="Cave Area" style="width: 80px; height: 80px; border-radius: 4px; object-fit: contain;">
              </button>

              <!-- NEW FOREST BUTTON -->
              <button id="normalForestAreaBtn" class="primary" 
                      style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0; outline: none; background: transparent; border: none; box-shadow: none; overflow: hidden;"
                      onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>The Forest</div>')" 
                      onmouseleave="hideTooltip()">
                <img src="images/normalforest.jpeg" alt="Forest Area" 
                     style="width: 100%; height: 100%; border-radius: 4px; object-fit: cover; display: block; image-rendering: auto; backface-visibility: hidden;">
              </button>

              <!-- DARK FOREST BUTTON -->
              <button id="darkForestAreaBtn" class="primary" 
                      style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0; outline: none; background: transparent; border: none; box-shadow: none; overflow: hidden;"
                      onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>The Dark Forest</div>')" 
                      onmouseleave="hideTooltip()">
                <img src="images/darkforest.jpeg" alt="Dark Forest Area" 
                     style="width: 100%; height: 100%; border-radius: 4px; object-fit: cover; display: block; image-rendering: auto; backface-visibility: hidden;">
              </button>
              
              <button id="madmaxCastleBtn" class="primary" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0; border: 2px solid #900;">
                <img src="images/madmaxcastle.jpeg" alt="Madmax Castle" style="width: 80px; height: 80px; border-radius: 4px; object-fit: contain;">
              </button>
            </div>

            <div class="action-buttons" style="margin-top: 30px;">
              <button id="hubCombat_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
          
          <div id="hubCave" class="hub-screen">
            <h2>The Cave</h2>
            <div style="margin-top:8px; color:#efe3cf;">A dark, damp cave.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Rat')" 
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Rat (Lvl 1)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/ratmonster.jpeg" alt="Rat" style="height: 100px; object-fit: cover; object-position: center;">
              </div>
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Spider')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Spider (Lvl 2)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/spidermonster.jpeg" alt="Spider" style="height: 100px; object-fit: cover; object-position: center;">
              </div>
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Centipede')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Centipede (Lvl 5)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/centipedemonster.jpeg" alt="Centipede" style="height: 100px; object-fit: cover; object-position: center;">
              </div>

              <!-- NEW GOBLIN MONSTER -->
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Goblin')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Goblin (Lvl 8)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/goblinmonster.jpeg" alt="Goblin" style="height: 100px; object-fit: cover; object-position: center;">
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubCave_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubMadmaxCastle" class="hub-screen">
            <h2 style="color:#ff4d4d;">Madmax Castle</h2>
            <div style="margin-top:8px; color:#efe3cf;">The lair of the beast. Tread carefully.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Madmax')" 
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:red;\'>Madmax (Lvl 69)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/madmaxmonster.jpeg" alt="Madmax" style="height: 120px; border: 2px solid red; border-radius: 8px;">
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubMadmaxCastle_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <!-- NEW FOREST COMBAT HUB -->
          <div id="hubNormalForest" class="hub-screen">
            <h2>The Forest</h2>
            <div style="margin-top:8px; color:#efe3cf;">A dense forest filled with strange creatures.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Crazy Platypus')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Crazy Platypus (Lvl 5)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/platypusmonster.jpeg" alt="Crazy Platypus" style="height: 100px; object-fit: cover; object-position: center;">
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubNormalForest_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubDarkForest" class="hub-screen">
            <h2>The Dark Forest</h2>
            <div style="margin-top:8px; color:#efe3cf;">The trees seem to watch you as you walk...</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Crazy Owl')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Crazy Owl (Lvl 10)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/crazyowlmonster.jpeg" alt="Crazy Owl" style="height: 100px; object-fit: cover; border-radius: 8px;">
              </div>

              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('The Witch')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>The Witch (Lvl 15)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/witchmonster.jpeg" alt="The Witch" style="height: 100px; object-fit: cover; border-radius: 8px;">
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 24px;">
              <button id="hubDarkForest_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
          <div id="hubEnchanting" class="hub-screen">
            <h2>Enchanting Altar</h2>
            <div style="position: relative; width: 300px; height: 250px; margin: 20px auto;">
                <img src="images/enchantingtable.png" alt="Enchanting Table" style="width: 100%; height: 100%; object-fit: contain; margin-top: 40px;">
                
                <div id="enchant-slot-container">
                    <div id="enchantSlot" class="inv-slot" style="width: 70px; height: 70px; background: rgba(0,0,0,0.5); border: 2px dashed var(--gold);" onclick="returnEnchantItem()">
                        <!-- Item appears here -->
                    </div>
                </div>
            </div>

            <div id="enchantInfo" style="text-align: center; min-height: 50px; margin-top: 0px;">
                <p id="enchantCostText" style="color: var(--gold); font-size: 18px; font-weight: bold; margin-top: 0;"></p>
                <button id="enchantBtn" class="primary" style="display: none; margin: 0 auto;" onclick="attemptEnchant()">Enchant</button>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
              <button onclick="backToActions()" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubShop" class="hub-screen">
            <h2>General Store</h2>
            
            <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 16px; width: 100%;">
            
              <div style="background:rgba(0,0,0,0.1); border-radius:6px; padding: 10px 15px; display: flex; flex-direction: column;">
                <h3 style="margin:0 0 10px 0; color: var(--gold); text-align: center;">Items for Sale</h3>
                
                <div class="inventory-grid-wrap" id="shopGridWrap">
                  <div class="inventory-grid" id="shopGrid">
                    </div>
                </div>
              </div>
              
            </div>
            
            <div class="action-buttons" style="margin-top:20px;">
              <button id="hubShop_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
          
          <div id="hubBank" class="hub-screen">
            <div id="bankContainer" style="width: 100%;">
              <div class="bank-content-wrapper"> 
                <div id="bankGoldPanel">
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" id="bankGoldInput" min="0" style="width: 70px;">
                    
                    <button id="bankDepositGoldBtn" class="primary" style="padding: 8px 12px;">Deposit</button>
                    <button id="bankDepositAllGoldBtn" class="primary" style="padding: 4px 8px; display:flex; align-items:center;" onmouseenter="showTooltip(event, 'Deposit All Gold')" onmouseleave="hideTooltip()">
                        <img src="images/goldpouch.png" style="width: 24px; height: 24px;">
                    </button>
                    
                    <div style="width: 1px; height: 25px; background: #555; margin: 0 5px;"></div>

                    <button id="bankWithdrawGoldBtn" class="primary" style="padding: 8px 12px;">Withdraw</button>
                    <button id="bankWithdrawAllGoldBtn" class="primary" style="padding: 4px 8px; display:flex; align-items:center; background: #900;" onmouseenter="showTooltip(event, 'Withdraw All Gold')" onmouseleave="hideTooltip()">
                        <img src="images/goldpouch.png" style="width: 24px; height: 24px;">
                    </button>
                  </div>
                </div>

                <div id="bankPanel">
                  <h3></h3>
                  
                  <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid var(--accent); margin-bottom: 5px; padding-bottom: 5px;">
                    
                    <div class="bank-tabs" id="bankTabsContainer" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; margin-right: 5px;">
                        <div style="color: #ccc; font-weight: bold; font-size: 14px;">Bank:</div>
                        <div id="bankStoredGold" class="gold-display" style="color:var(--gold); font-weight:bold; font-size:16px;">0</div>
                    </div>

                  </div>

                  <div class="inventory-grid-wrap" id="bankGridWrap">
                    <div class="inventory-grid" id="bankGrid"></div>
                  </div>
                </div>
              </div>
              <div class="action-buttons" style="margin-top:0px; align-self: flex-start;">
                <button id="hubBank_ReturnBtn" class="primary" style="background:#666;">Return</button>
              </div>
            </div>
          </div>

          <div id="hubFarm" class="hub-screen">
            <h2>The Farm</h2>
            <div style="margin-top:8px; color:#efe3cf;">A peaceful farm, mostly.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Chicken')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Chicken (Lvl 1)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/chickenmonster.jpeg" alt="Chicken" style="height: 100px;">
              </div>
              
              <div style="text-align:center; cursor:pointer;" onclick="openCombatInterface('Cow')"
                   onmouseenter="showTooltip(event, '<div style=\'font-weight:bold; color:var(--gold);\'>Cow (Lvl 2)</div>')"
                   onmouseleave="hideTooltip()">
                <img src="images/cowmonster.png" alt="Cow" style="height: 100px;">
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubFarm_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
          <div id="hubDynamic" class="hub-screen">
            </div>

          <div id="hubFishingAreas" class="hub-screen">
            <h2>Fishing Areas</h2>
            <div style="margin-top:8px; color:#efe3cf;">Choose an area to start fishing.</div>
            <div class="action-buttons" style="margin-top:14px; display:flex; flex-direction:column; align-items:flex-start;">
              
              <button id="oceanAreaBtn" class="primary" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0;">
                <img src="images/oceanbutton.png" alt="Ocean Area" style="width: 80px; height: 80px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="riverAreaBtn" class="primary" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; padding: 0; margin-top: 10px;">
                <img src="images/riverbutton.jpeg" alt="River Area" style="width: 80px; height: 80px; border-radius: 4px; object-fit: contain;">
              </button>
              
              <button id="hubFishingAreas_ReturnBtn" class="primary" style="background:#666; margin-top: 30px;">Return</button>
            </div>
          </div>
          
          <div id="hubOcean" class="hub-screen">
            <h2>The Ocean</h2>
            <div style="margin-top:8px; color:#efe3cf;">The vast, open ocean.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div id="fishHerringBtn" style="text-align:center; cursor:pointer;" onclick="openFishHerring()">
                <img src="images/herring.png" alt="Herring" style="height: 100px;">
                
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubOcean_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>
          
          <div id="hubRiver" class="hub-screen">
            <h2>The River</h2>
            <div style="margin-top:8px; color:#efe3cf;">A fast-flowing river.</div>
            
            <div style="margin-top:20px; display:flex; justify-content: center; align-items: flex-end; gap: 40px; flex-wrap: wrap;">
              
              <div id="fishTroutBtn" style="text-align:center; cursor:pointer;" onclick="openFishTrout()">
                <img src="images/trout.png" alt="Trout" style="height: 100px;">
              
              </div>
              
              <div id="fishSalmonBtn" style="text-align:center; cursor:pointer;" onclick="openFishSalmon()">
                <img src="images/salmon.png" alt="Salmon" style="height: 100px;">
                
              </div>
            
            </div>
            
            <div class="action-buttons" style="margin-top: 14px;">
              <button id="hubRiver_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
          </div>

          <div id="hubLottery" class="hub-screen">
            <h2 style="text-align: center; color: var(--gold); text-shadow: 0 0 10px rgba(181, 166, 66, 0.5);">Skillsmith Lottery</h2>
            <div style="margin-top:8px; color:#efe3cf; text-align: center;">
                Pay 10,000 Gold for a chance to win the legendary <strong id="lotteryJackpotName">...</strong>!
                <br><span style="font-size: 12px; color: #aaa;">(Chance: 1 in 1,000)</span>
                <br><span id="lotteryJackpotDesc" style="font-size: 11px; color: #888; font-style: italic;">...</span>
                <div style="margin-top: 8px; font-size: 13px; color: var(--gold); border-top: 1px solid rgba(255,215,0,0.2); padding-top: 8px; display: inline-block;">
                    Item changes in: <span id="lotteryTimer" style="font-family: monospace; font-weight: bold; color: #fff;">00h 00m 00s</span>
                </div>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 30px;">
                <div class="lottery-window">
                    <div class="lottery-pointer"></div>
                    <div id="lotteryReel" class="lottery-reel"></div>
                </div>
            </div>

            <div class="action-buttons" style="justify-content: center; gap: 20px;">
                <button id="buyTicketBtn" class="primary" style="background: var(--gold); color: #000; font-size: 18px; padding: 15px 30px;">
                    Buy Ticket (10k Gold)
                </button>
                <button id="hubLottery_ReturnBtn" class="primary" style="background:#666;">Return</button>
            </div>
            <div id="lotteryResultMsg" style="text-align: center; margin-top: 15px; font-weight: bold; font-size: 18px; min-height: 24px;"></div>
          </div>

          <div id="hubActiveCombat" class="hub-screen">
            <div id="combat-main-container">
              
              <div id="combat-enemy-area">
                <img id="combat-enemy-img" src="" alt="Enemy">
                <div id="combat-enemy-hp-bar">
                  <div id="combat-enemy-hp-fill" style="width:100%"></div>
                  <div id="combat-enemy-hp-text">10 / 10 HP</div>
                </div>
              </div>
              
              <div id="combat-player-area">
                <div id="combat-action-panel">
                  <p style="margin: 0 0 10px 0; font-weight: bold;">Combat Style:</p>
                  <div id="combat-styles">
                    <button id="style-attack" class="primary" onclick="setAttackStyle('attack')">Accurate</button>
                    <button id="style-strength" class="primary" onclick="setAttackStyle('strength')">Aggressive</button>
                    <button id="style-defence" class="primary" onclick="setAttackStyle('defence')">Defensive</button>
                  </div>
                  
                  <div id="combat-main-actions">
                    <button id="combat-fight-btn" class="primary" style="background:#900;" onclick="beginCombat()">Fight</button>
                    <button id="combat-run-btn" class="primary" style="background:#080; display:none;" onclick="runFromCombat()">Run</button>
                    <button id="combat-return-btn" class="primary" style="background:#555;" onclick="returnToCombatArea()">Return</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
          
          </div> 
      </div>

      <div class="sidebar" id="leaderboardPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h2>Leaderboard</h2>
          <button id="refreshLeaderboardBtn" class="primary" style="padding: 6px 10px; font-size: 12px;">Refresh</button>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid var(--accent); margin-bottom: 2px;">
          <span style="font-weight: bold;">TOTAL XP</span>
          <span style="font-weight: bold;">NAME</span>
        </div>
        <div id="leaderboardContent">
          <div style="text-align:center; margin-top: 10px; color: #fff; opacity: 0.7;">Loading leaderboard...</div>
        </div>

        <h3 style="margin: 5px 0 5px 0; font-size: 18px; color: #fff; border-top: 2px solid var(--accent); padding-top: 5px;">Latest Updates</h3>
        <div id="updatesContent">
          <div style="text-align:center; margin-top: 10px; color: #fff; opacity: 0.7;">Loading updates...</div>
        </div>
        
        <div style="height: 24px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
          
          <a href="https://discord.gg/XMAB2e5Xd4" target="_blank" style="display: flex; align-items: center; height: 100%;">
            <img src="images/discordbutton.png" alt="Join Discord" style="height: 24px; width: auto; border-radius: 4px; cursor: pointer;">
          </a>

          <div id="saveTimerText" style="visibility: hidden; font-size: 11px; color: #aaffaa; font-weight: bold;">
              Progress Saved!
          </div>

        </div>
        
        </div>

    </div> 
    
    <div id="bottom-row-chat">

      <div id="statsPanel">
        <div id="statsPanelHeader">Player Stats</div>
        <div id="statsPanelContent">
          <!-- Left Column: Offense -->
          <div class="stats-column">
            <div class="stat-row"><span class="stat-label">Melee Strength</span><span class="stat-value" id="stat-m-str" style="color:#ff4d4d;">0</span></div>
            <div class="stat-row"><span class="stat-label">Ranged Strength</span><span class="stat-value" id="stat-r-str" style="color:#44aa44;">0</span></div>
            <div class="stat-row"><span class="stat-label">Magic Damage</span><span class="stat-value" id="stat-mag-dmg" style="color:#4da6ff;">0</span></div>
          </div>
          
          <!-- Right Column: Defense -->
          <div class="stats-column" style="border-left: 1px solid rgba(109, 69, 45, 0.5); padding-left: 10px;">
            <div class="stat-row"><span class="stat-label">Melee Defense</span><span class="stat-value" id="stat-m-def" style="color:#e38a42;">0</span></div>
            <div class="stat-row"><span class="stat-label">Ranged Defense</span><span class="stat-value" id="stat-r-def" style="color:#aaffaa;">0</span></div>
            <div class="stat-row"><span class="stat-label">Magic Defense</span><span class="stat-value" id="stat-mag-def" style="color:#6dafff;">0</span></div>
          </div>
        </div>
        <div id="statsPanelFooter">
          <!-- The button is now pushed to the right by the CSS change above -->
          <button id="closeStatsBtn" class="primary" style="background:#666;">Close</button>
        </div>
      </div>

      <div class="chat-panel" id="chatPanel">
        <div id="chatMessages">
          </div>
        
        <div id="chatInputContainer">
          <input id="chatInput" type="text" placeholder="Type message...">
          <button id="chatSendBtn" class="primary" style="padding: 8px 12px;">Send</button>
        </div>
      </div>

      <div id="spellsPanel"> 
          <div id="spellsPanelHeader">Magic Spells</div>
          <div id="spellsPanelContent">
              <div id="spellsIconsContainer" style="display: flex; gap: 10px; justify-content: center;">
              </div>
          </div>
          <div id="spellsPanelFooter">
              <div id="autocastText" style="font-size: 14px; font-weight: bold; color: var(--gold);">None</div>
              <button id="closeSpellsBtn" class="primary" style="background:#666;">Close</button>
          </div>
      </div>

    </div> 
    
  </div> 
</div>
<div id="tooltip" class="tooltip" style="display:none;"></div>


<div id="sessionLockOverlay" style="display: none;">
  <div>
    <h2>Session Active Elsewhere</h2>
    <p>This account is already being played in another tab or browser. To prevent data corruption, this tab has been disabled.</p>
    <button id="takeControlButton" class="primary">Take Control Here</button>
  </div>
</div>

<div id="deathOverlay" style="display: none;">
  <div>
    <h2>You died!</h2>
    <p>You lost all your inventory and gold.</p>
    <button id="reviveBtn" class="primary" onclick="revivePlayer()">Revive</button>
  </div>
</div>

<div id="levelUpOverlay">
  <div class="levelup-card">
    <div class="levelup-rays"></div>
    <div class="levelup-content">
      <div class="levelup-title">Level Up!</div>
      <div class="levelup-icon-frame">
        <img id="levelUpIcon" src="" alt="Skill Icon">
      </div>
      <div class="levelup-text">You reached <span id="levelUpSkillName">Mining</span> Level</div>
      <div class="levelup-level" id="levelUpValue">10</div>
    </div>
  </div>
</div>

<!-- NEW: Settings Modal -->
<div id="settingsModalOverlay">
  <div class="settings-modal">
    <div class="settings-modal-title">Settings</div>
    
    <div class="setting-row">
      <label for="sfxVolumeSlider">Sound Effects</label>
      <input type="range" id="sfxVolumeSlider" class="volume-slider" min="0" max="1" step="0.05">
      <button id="sfxMuteBtn" class="primary setting-mute-btn">Mute</button>
    </div>

    <div class="setting-row">
      <label for="musicVolumeSlider">Music</label>
      <input type="range" id="musicVolumeSlider" class="volume-slider" min="0" max="1" step="0.05">
      <button id="musicMuteBtn" class="primary setting-mute-btn">Mute</button>
    </div>

    <div class="action-buttons" style="margin-top: 10px; justify-content: flex-end; gap: 10px;">
      <button onclick="firebaseLogout()" class="primary" style="background: #900; margin-right: auto;">Log Out</button>
      <button id="closeSettingsBtn" class="primary" style="background:#666;">Close</button>
    </div>
  </div>
</div> <div id="broadcastOverlay" style="display: none; z-index: 5002;"> <div>
    <h2 style="color: var(--gold);">System Update</h2>
    <p id="broadcastMessage" style="font-size: 16px; line-height: 1.5;">
      A new game update is live! Please refresh your browser to continue.
    </p>
    </div>
</div>

<div id="playerInspectOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 4000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
    <div class="game-modal" style="max-width: 450px;">
        <div class="game-modal-title">Inspecting <span id="inspectPlayerName">Player</span></div>
        <div id="inspectEquipmentPanel" class="game-modal-content">
            <div class="equipment-character" style="border-bottom: 2px solid var(--accent); padding-bottom: 15px;">
                <div class="character-frame" id="inspectEquipmentFrame">
                    </div>
            </div>

            <div style="margin-top: 15px;">
                <div id="inspectStatsPanel" style="padding: 10px; background: rgba(0,0,0,0.15); border-radius: 6px; width: 100%; box-sizing: border-box;">
                    </div>
            </div>
            
        </div>
        <div class="game-modal-buttons">
            <button id="closeInspectBtn" class="primary" style="background:#666;">Close</button>
        </div>
    </div>
</div>

<!-- NEW: Enchant Overlay -->
<div id="enchantOverlay"></div>
<script>
// --- Game State (MODIFIED) ---
const game = {
  name: '',
  hp: 10,
  maxHP: 10,
  settings: { 
    sfxVolume: 0.5, 
    isSfxMuted: false, 
    musicVolume: 0.15,  // <--- Changed this from 0.3
    isMusicMuted: false 
  },
  inventory: [], 
  inventoryCapacity: 40, // <--- Changed 39 to 40
  gold: 0,
  // --- NEW BANK PROPERTIES ---
  bank: [], // Kept for backward compatibility during migration
  bankTabs: [], // Array of Arrays (The actual storage now)
  activeBankTabIndex: 0, // Which tab is open?
  bankCapacity: 60, // Slots per tab
  bankGold: 0,
  // --- END NEW ---
  equipment: {
    necklace: null, // <-- NEW
    helmet: null,
    cape: null,     // <-- NEW
    weapon: null,
    chest: null,
    shield: null,   // <-- NEW
    ring1: null,    // <-- NEW
    legs: null,     // <-- NEW
    ring2: null,    // <-- NEW
    arrows: null,   // <-- NEW
    boots: null,
    pet: null       // <-- NEW PET SLOT
  },
  mining: { level: 1, xp: 0, totalXP: 0 },
  blacksmith: { level: 1, xp: 0, totalXP: 0 },
  attack: { level: 1, xp: 0, totalXP: 0 }, 
  strength: { level: 1, xp: 0, totalXP: 0 }, 
  defence: { level: 1, xp: 0, totalXP: 0 }, 
  vitality: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW VITALITY SKILL +++
  cooking: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW COOKING SKILL +++
  woodcutting: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW WOODCUTTING SKILL +++
  miningActive: false,
  blacksmithingActive: false,
  cookingActive: false,
  woodcuttingActive: false, // +++ NEW WOODCUTTING STATE +++
  progressFrame: null,
  wasMiningBeforeTrade: false,
  shopOpen: false, 
  isAdmin: false,
  inCombat: false,
  playerAttackStyle: 'strength', // Default to strength
  currentEnemy: null,
  playerCombatInterval: null,
  enemyCombatInterval: null,
  wasMiningBeforeCombat: false, // Renamed from 'wasMiningBeforeTrade'
  wasSmithingBeforeCombat: false,
  wasWoodcuttingBeforeCombat: false,
  fletching: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW FLETCHING SKILL +++
  fletchingActive: false, // +++ NEW FLETCHING STATE +++
  wasFletchingBeforeCombat: false, // +++ NEW FLETCHING STATE +++

  // +++ NEW CRAFTING SKILL +++
  crafting: { level: 1, xp: 0, totalXP: 0 },
  craftingActive: false,
  wasCraftingBeforeCombat: false,
  
  // +++ NEW RANGED SKILL +++
  ranged: { level: 1, xp: 0, totalXP: 0 },
  
  // +++ NEW FISHING SKILL +++
  fishing: { level: 1, xp: 0, totalXP: 0 },
  fishingActive: false,
  wasFishingBeforeCombat: false,

  // +++ NEW MAGIC SKILL +++
  magic: { level: 1, xp: 0, totalXP: 0 },
  
  // +++ NEW STONE FORGING SKILL +++
  stoneforging: { level: 1, xp: 0, totalXP: 0 },
  stoneforgingActive: false,
  wasStoneForgingBeforeCombat: false,

  gatheringWaterActive: false, // +++ NEW WELL STATE +++

  // +++ NEW BOUNTY HUNTING SKILL +++
  bountyhunting: { level: 1, xp: 0, totalXP: 0 },
  activeBounty: null, 

// +++ NEW PET SYSTEM STATE +++
  petmastery: { level: 1, xp: 0, totalXP: 0 },
  pets: [], // Array of pet objects { id, type, name, level, xp, hp, lastCalcTime }
  incubator: { active: false, startTime: 0, eggType: null }, 
  // +++ END NEW STATE +++

  // +++ NEW FARMING SKILL +++
  farming: { level: 1, xp: 0, totalXP: 0 },
  alchemy: { level: 1, xp: 0, totalXP: 0 },
  tailoring: { level: 1, xp: 0, totalXP: 0 },
  thieving: { level: 1, xp: 0, totalXP: 0 },
  thievingTargets: [],
  alchemyActive: false,
  tailoringActive: false,
  wasAlchemyBeforeCombat: false, 
  wasTailoringBeforeCombat: false, 
  
  // Stores progress: { 'tutorial': { completed: ['tut_1'], activeQuestId: 'tut_2', kills: 0 } }
  questLines: {},
  
  lastSmithingTab: 'copper',
  lastCombatAreaHub: 'hubActions', // +++ NEW +++

  // +++ NEW FARM STATE +++
  farm: {
    chickens: [], 
    cows: [],
    garden: new Array(16).fill(null), // 16 Crop Tiles
    cellar: new Array(16).fill(null)  // 16 Mushroom Tiles
  },
  
  // +++ NEW MAGIC STATE +++
  autocastSpell: null, 
  lastAttackTime: 0, 
  // +++ END NEW MAGIC STATE +++

  // +++ NEW AUTO EAT STATE +++
  autoEatSlot: null, 
  autoEatUnlocked: false,
  autoEatThreshold: 20,
  lastAutoHealTime: 0, // Track the last time a potion was used
  // +++ END NEW STATE +++
  
  // +++ NEW SESSION LOCK +++
  // This is a unique ID for this specific tab
  sessionLockId: (function() {
  let id = sessionStorage.getItem('gameSessionId');
  if (!id) {
    // No ID exists, so this is a new tab. Create one.
    id = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
    sessionStorage.setItem('gameSessionId', id);
  }
  // Return the persistent ID for this tab
  return id;
})(),
lockHeartbeat: null,    
isSessionActive: false, 
isDragging: false,      
  enchantSlot: null,      
  enchantingActive: false,
  isDirty: false
};

const MATERIAL_TIERS = {
    // Tier 1
    'Bronze': 1, 'Softwood': 1,
    // Tier 2
    'Copper': 2, 'Leather': 2,
    // Tier 3
    'Iron': 3, 'Cloth': 3, 'Wizard': 3, 'Oak': 3,
    // Tier 4
    'Silver': 4, 'Birch': 4,
    // Tier 5
    'Gold': 5, 'Maple': 5, 'Mahogany': 5, 'Ring': 5
};
// +++ END MODIFICATION +++

game.inventory = new Array(game.inventoryCapacity).fill(null);
game.bank = new Array(game.bankCapacity).fill(null);

// --- NEW: Music Player State ---
const musicPlaylist = [
  'sounds/music/music1.mp3',
  'sounds/music/music2.mp3',
  'sounds/music/music3.mp3',
  'sounds/music/music4.mp3'
];
let currentTrackIndex = 0;
const musicPlayer = new Audio(); 
musicPlayer.loop = false;
let audioAutoplayBlocked = false; // We handle the loop to change tracks
// --- END NEW ---

/**
 * Finds the highest tier tool of a specific type in the player's inventory.
 * @param {('pickaxe'|'axe')} toolType - The type of tool to look for.
 * @returns {number} The tier level (0 for none, 1 for Bronze, 2 for Copper, etc.)
 */
function getBestTool(toolType) {
  const tiers = (toolType === 'pickaxe') ? PICKAXE_TIERS : AXE_TIERS;
  let bestTier = 0;

  for (const slot of game.inventory) {
    if (slot && tiers[slot.name]) {
      if (tiers[slot.name] > bestTier) {
        bestTier = tiers[slot.name];
      }
    }
  }
  return bestTier;
}

/**
 * Updates the music player's volume/mute state from game.settings
 */
function updateMusicPlayerState() {
  if (game.settings.isMusicMuted) {
    musicPlayer.volume = 0;
  } else {
    musicPlayer.volume = game.settings.musicVolume;
  }
}

/**
 * Plays the next track in the playlist.
 */
function playNextTrack() {
  if (musicPlaylist.length === 0) return; 

  currentTrackIndex = (currentTrackIndex + 1) % musicPlaylist.length;
  musicPlayer.src = musicPlaylist[currentTrackIndex];

  updateMusicPlayerState(); // Apply current volume settings

  const playPromise = musicPlayer.play();

  if (playPromise !== undefined) {
    playPromise.catch(error => {
      console.warn("Music autoplay blocked. User must interact to enable sound.");

      // --- NEW "CLICK ANYWHERE" FIX ---
      if (!audioAutoplayBlocked) { // Only add this listener ONCE
        audioAutoplayBlocked = true;

        // Listen for the *first* click or tap anywhere
        const interactionListener = () => {
          resumeMusicAfterInteraction();
          // Clean up this listener so it doesn't run again
          document.removeEventListener('click', interactionListener);
          document.removeEventListener('touchstart', interactionListener);
        };

        document.addEventListener('click', interactionListener);
        document.addEventListener('touchstart', interactionListener);
      }
      // --- END NEW ---

    });
  }
}

/**
 * Starts the music playlist for the first time.
 */
function startMusicPlaylist() {
  // Set up the listener for *all future songs*
  musicPlayer.addEventListener('ended', playNextTrack);

  // Set the volume before playing
  updateMusicPlayerState(); 

  // --- NEW: Pick a random song to start ---
  currentTrackIndex = Math.floor(Math.random() * musicPlaylist.length);
  musicPlayer.src = musicPlaylist[currentTrackIndex];
  // --- END NEW ---

  // Manually start the first song (we copy this logic from playNextTrack)
  const playPromise = musicPlayer.play();

  if (playPromise !== undefined) {
    playPromise.catch(error => {
      console.warn("Music autoplay blocked. User must interact to enable sound.");

      // --- This is the "click anywhere" fix ---
      if (!audioAutoplayBlocked) { 
        audioAutoplayBlocked = true;

        const interactionListener = () => {
          resumeMusicAfterInteraction();
          document.removeEventListener('click', interactionListener);
          document.removeEventListener('touchstart', interactionListener);
        };

        document.addEventListener('click', interactionListener);
        document.addEventListener('touchstart', interactionListener);
      }
      // --- End fix ---

    });
  }
}

/**
 * Tries to resume music playback after a user interaction.
 */
function resumeMusicAfterInteraction() {
  // Check if music is supposed to be on but is paused
  if (!game.settings.isMusicMuted && musicPlayer.paused) {
    const resumePromise = musicPlayer.play();

    if (resumePromise !== undefined) {
      resumePromise.then(() => {
        // SUCCESS! Autoplay is now unblocked.
        audioAutoplayBlocked = false; 
      }).catch(e => {
        // Still failed? Oh well.
        console.warn("Could not resume music.", e);
      });
    }
  }
}

const VALID_ITEMS = [
  'Bronze Pickaxe', // +++ NEW +++
  'Bronze Axe',     // +++ NEW +++
  'Copper Pickaxe', // +++ NEW +++
  'Copper Axe',     // +++ NEW +++
  'Iron Pickaxe',   // +++ NEW +++
  'Iron Axe',       // +++ NEW +++
  'Silver Pickaxe',
  'Silver Axe',
  'Softwood',
  'Oak',
  'Birch',
  'Maple',
  'Mahogany',
  'Copper Ore',
  'Copper Bar',
  'Copper Chestplate',
  'Copper Shortsword',
  'Copper Helmet', 
  'Copper Boots', 
  'Raw Chicken',
  'Cooked Chicken',
  'Burnt Chicken',
  'Coal Ore',
  'Iron Ore',
  'Iron Bar',
  'Iron Helmet',
  'Iron Chestplate',
  'Iron Boots',
  'Iron Shortsword',
  'Silver Ore',
  'Gold Ore',
  'Silver Bar', // +++ NEW +++
  'Gold Bar',   // +++ NEW +++
  'Feather',
  'Arrow Shaft', // +++ NEW +++
  'Copper Arrow Tip', // +++ NEW +++
  'Unbound Arrow', // +++ NEW +++
  'Copper Arrow', // +++ NEW +++
  'Copper Platelegs', // +++ NEW +++
  'Iron Platelegs', // +++ NEW +++
  'Silk', // +++ NEW +++
  
  // +++ NEW CLOTH & WIZARD ITEMS +++
  'Cloth',
  'Wizard Hat',
  'Wizard Robe',
  'Wizard Trousers',
  'Wizard Boots',
  
  // +++ NEW CRYSTAL ITEMS +++
  'Earth Crystal Shard',
  'Air Crystal Shard',
  'Water Crystal Shard',
  
  // +++ NEW ELEMENTAL STONES +++
  'Earthstone',
  'Airstone',
  'Waterstone',

  // +++ NEW CRAFTING/FLETCHING ITEMS +++
  'Bow String',
  'Unstrung Softwood Bow',
  'Unstrung Oak Bow',
  'Softwood Bow',
  'Oak Bow',
  
  // +++ NEW LEATHER ITEMS +++
  'Cow Hide',
  'Leather',
  'Leather Hood',
  'Leather Body',
  'Leather Chaps',
  'Leather Boots',
  
  // +++ NEW FISHING ITEMS +++
  'Herring',
  'Trout',
  'Salmon',
  'Fishing Pole',
  'Fishing Bait',

  // +++ NEW COOKED FISH +++
  'Cooked Herring',
  'Burnt Herring',
  'Cooked Trout',
  'Burnt Trout',
  'Cooked Salmon',
  'Burnt Salmon',
  'Beef',
  'Cooked Beef',
  'Burnt Beef',
  'Magic Staff',
  'Gold Crown',
  'Elegant Black Cape', // +++ NEW CAPE +++
  '1tapper', // +++ NEW ADMIN ITEM +++
  'Rat Tail', // +++ NEW ITEM +++
  'Pet Spider Egg', // +++ NEW PET EGG +++
  'Sand', // +++ NEW +++
  'Empty Vial', // +++ NEW +++
  'Venom', // +++ NEW +++
  'Lottery Ticket', // +++ NEW +++
  'Empty Bucket', // +++ NEW +++
  'Bucket of Milk', // +++ NEW +++
  'Bucket of Water', // +++ NEW +++
  'Grass Seed',      // +++ NEW +++
  'Grass',
  'Corn Seed',
  'Corn',
  'Dirt Shroom',
  'Wild Herb',
  'Vitality Potion', // +++ NEW ITEM +++
  'Uncut Topaz',
  'Uncut Diamond',
  'Uncut Emerald',
  'Uncut Jade',
  'Uncut Ruby',
  'Uncut Sapphire',
  'Topaz',
  'Diamond',
  'Emerald',
  'Jade',
  'Ruby',
  'Sapphire',
  'Gold Ring',
  'Diamond Ring',
  'Emerald Ring',
  'Ruby Ring',
  'Sapphire Ring',
  'Topaz Ring',
  'Silver Fangs of the Fallen Monarch'
];

const XP_TABLE = [
  0,        // Level 1
  83,       // Level 2
  174,      // Level 3
  276,      // Level 4
  388,      // Level 5
  512,      // Level 6
  650,      // Level 7
  801,      // Level 8
  969,      // Level 9
  1154,     // Level 10
  1358,     // Level 11
  1584,     // Level 12
  1833,     // Level 13
  2107,     // Level 14
  2411,     // Level 15
  2746,     // Level 16
  3115,     // Level 17
  3523,     // Level 18
  3973,     // Level 19
  4470,     // Level 20
  5018,     // Level 21
  5624,     // Level 22
  6291,     // Level 23
  7028,     // Level 24
  7842,     // Level 25
  8740,     // Level 26
  9730,     // Level 27
  10824,    // Level 28
  12031,    // Level 29
  13363,    // Level 30
  14833,    // Level 31
  16456,    // Level 32
  18247,    // Level 33
  20224,    // Level 34
  22436,    // Level 35
  24898,    // Level 36
  27673,    // Level 37
  30779,    // Level 38
  33648,    // Level 39
  37224,    // Level 40
  41171,    // Level 41
  45542,    // Level 42
  50339,    // Level 43
  55649,    // Level 44
  61512,    // Level 45
  67983,    // Level 46
  75127,    // Level 47
  83014,    // Level 48
  91721,    // Level 49
  101333,   // Level 50
  111945,   // Level 51
  123660,   // Level 52
  136615,   // Level 53
  150872,   // Level 54
  166636,   // Level 55
  184040,   // Level 56
  203254,   // Level 57
  224446,   // Level 58
  247866,   // Level 59
  273742,   // Level 60
  302288,   // Level 61
  333804,   // Level 62
  368599,   // Level 63
  407015,   // Level 64
  449426,   // Level 65
  496254,   // Level 66
  547953,   // Level 67
  605032,   // Level 68
  668051,   // Level 69
  737637,   // Level 70
  814445,   // Level 71
  899252,   // Level 72
  992895,   // Level 73
  1096245,  // Level 74
  1210210,  // Level 75
  1336486,  // Level 76
  1475581,  // Level 77 (Using 1,475,581)
  1629200,  // Level 78 (Using 1,629,200)
  1798808,  // Level 79
  1986068,  // Level 80
  2192818,  // Level 81
  2421027,  // Level 82
  2673114,  // Level 83
  2951373,  // Level 84 (Using 2,951,373)
  3258594,  // Level 85
  3597292,  // Level 86
  3972294,  // Level 87 (Using 3,972,294)
  4385776,  // Level 88
  4842295,  // Level 89
  5346332,  // Level 90 (Using 5,346,332)
  5902831,  // Level 91
  6517253,  // Level 92
  7195629,  // Level 93
  7944614,  // Level 94
  8771588,  // Level 95
  9684577,  // Level 96
  10692629, // Level 97
  11805606, // Level 98
  13034031, // Level 99
  15000000  // Level 100: Custom value
];

// --- NEW: Fishing Level Requirements ---
const HERRING_FISH_LVL = 1;
const TROUT_FISH_LVL = 5;
const SALMON_FISH_LVL = 10;

// --- NEW: Fishing Action Constants ---
const FISHING_TIME_MS = 20000; // 20 seconds per fish

// +++ NEW MAGIC SPELL CONSTANTS +++
const EARTH_BOLT = { name: 'Earth Bolt', level: 1, damage: 2, xp: 5 };
const AIR_BOLT = { name: 'Air Bolt', level: 10, damage: 3, xp: 10 };
const WATER_BOLT = { name: 'Water Bolt', level: 15, damage: 4, xp: 15 };
const SPELL_LIST = [EARTH_BOLT, AIR_BOLT, WATER_BOLT];
// +++ END NEW MAGIC SPELL CONSTANTS +++

const HERRING_FISH_XP = 10;
const TROUT_FISH_XP = 20;
const SALMON_FISH_XP = 35;


const CHESTPLATE_BAR_COST = 10;
const CHESTPLATE_XP = 50; // Defining a standard XP gain for the item

// +++ NEW SHORTSWORD CONSTANTS +++
const SHORTSWORD_BAR_COST = 5;
const SHORTSWORD_XP = 32;
const SHORTSWORD_TIME_MS = 5000;
// +++ END NEW CONSTANTS +++
const HELMET_BAR_COST = 5;
const HELMET_XP = 32; // Same as shortsword
const HELMET_TIME_MS = 5000; // Same as shortsword
// +++ END NEW CONSTANTS +++

// +++ NEW BOOTS CONSTANTS +++
// +++ NEW BOOTS CONSTANTS +++
const BOOTS_BAR_COST = 4;
const BOOTS_XP = 26; // 4 bars (~6.5xp/bar)
const BOOTS_TIME_MS = 4000; // 4 bars (1s/bar)

// +++ NEW PLATELEGS CONSTANTS +++
const COPPER_PLATELEGS_BAR_COST = 6;
const COPPER_PLATELEGS_XP = 39; // 6 bars (~6.5xp/bar)
const COPPER_PLATELEGS_TIME_MS = 6000; // 6 bars (1s/bar)
// +++ END NEW CONSTANTS +++

// --- NEW: Mining Level Requirements ---
const COAL_MINE_LVL = 5;
const IRON_MINE_LVL = 10;

// --- NEW: Coal/Iron Mining Constants ---
const COAL_MINE_TIME_MS = 2000;
const COAL_MINE_XP = 20;
const COAL_MINE_ITEM = 'Coal Ore';

const IRON_MINE_TIME_MS = 3000;
const IRON_MINE_XP = 35;
const IRON_MINE_ITEM = 'Iron Ore';

const SILVER_MINE_LVL = 20;
const SILVER_MINE_TIME_MS = 4000;
const SILVER_MINE_XP = 50;
const SILVER_MINE_ITEM = 'Silver Ore';

const GOLD_MINE_LVL = 30;
const GOLD_MINE_TIME_MS = 5000;
const GOLD_MINE_XP = 75;
const GOLD_MINE_ITEM = 'Gold Ore';

// --- NEW: Crystal Mining Constants ---
const EARTH_CRYSTAL_LVL = 20;
const EARTH_CRYSTAL_TIME_MS = 4000;
const EARTH_CRYSTAL_XP = 50;
const EARTH_CRYSTAL_ITEM = 'Earth Crystal Shard';

const AIR_CRYSTAL_LVL = 30;
const AIR_CRYSTAL_TIME_MS = 5000;
const AIR_CRYSTAL_XP = 65;
const AIR_CRYSTAL_ITEM = 'Air Crystal Shard';

const WATER_CRYSTAL_LVL = 40;
const WATER_CRYSTAL_TIME_MS = 6000;
const WATER_CRYSTAL_XP = 80;
const WATER_CRYSTAL_ITEM = 'Water Crystal Shard';

const MINE_COOLDOWN_COPPER_MS = 1000; // 1.0s
const MINE_COOLDOWN_COAL_MS = 1500;   // 1.5s
const MINE_COOLDOWN_IRON_MS = 1500;   // 1.5s
const MINE_COOLDOWN_SILVER_MS = 1500; // 1.5s
const MINE_COOLDOWN_GOLD_MS = 1500;   // 1.5s

// --- NEW: Blacksmith Level Requirements ---
const COPPER_BAR_LVL = 1;
const COPPER_PICKAXE_LVL = 2;
const COPPER_AXE_LVL = 2;
const COPPER_SWORD_LVL = 3;
const BLACKSMITH_COPPER_TIPS_LVL = 4; // +++ NEW +++
const COPPER_BOOTS_LVL = 5;
const COPPER_HELMET_LVL = 6;
const COPPER_PLATELEGS_LVL = 7; // +++ NEW +++
const COPPER_CHEST_LVL = 8;

const IRON_BAR_LVL = 11;
const IRON_PICKAXE_LVL = 12;
const IRON_AXE_LVL = 12;
const IRON_SWORD_LVL = 13;
const IRON_BOOTS_LVL = 15;
const IRON_HELMET_LVL = 16;
const IRON_PLATELEGS_LVL = 17; // +++ NEW +++
const IRON_CHEST_LVL = 18;
const SILVER_BAR_LVL = 21;
const GOLD_BAR_LVL = 31;

const SILVER_BAR_ORE_COST = 1;
const SILVER_BAR_COAL_COST = 2;
const SILVER_BAR_XP = 50;
const SILVER_BAR_TIME_MS = 8000;

const GOLD_BAR_ORE_COST = 1;
const GOLD_BAR_COAL_COST = 2;
const GOLD_BAR_XP = 80;
const GOLD_BAR_TIME_MS = 10000;

// --- NEW: Fletching Level Requirements ---
const FLETCHING_SHAFT_LVL = 1;
const FLETCHING_UNBOUND_LVL = 1;
const FLETCHING_COPPER_ARROW_LVL = 1;
const FLETCHING_UNSTRUNG_SOFTWOOD_LVL = 5; // +++ NEW +++
const FLETCHING_SOFTWOOD_BOW_LVL = 7;      // +++ NEW +++
const FLETCHING_UNSTRUNG_OAK_LVL = 15;     // +++ NEW +++
const FLETCHING_OAK_BOW_LVL = 17;          // +++ NEW +++

// --- NEW: Fletching Crafting Constants ---
const ARROW_SHAFT_WOOD_COST = 4;
const ARROW_SHAFT_YIELD = 10;
const ARROW_SHAFT_XP = 10;
const ARROW_SHAFT_TIME_MS = 3000;

const UNBOUND_ARROW_SHAFT_COST = 10;
const UNBOUND_ARROW_FEATHER_COST = 10;
const UNBOUND_ARROW_YIELD = 10;
const UNBOUND_ARROW_XP = 20;
const UNBOUND_ARROW_TIME_MS = 4000;

const COPPER_ARROW_UNBOUND_COST = 10;
const COPPER_ARROW_TIP_COST = 10;
const COPPER_ARROW_YIELD = 10;
const COPPER_ARROW_XP = 30;
const COPPER_ARROW_TIME_MS = 4000;

// +++ NEW: Bow Fletching Constants +++
const UNSTRUNG_SOFTWOOD_WOOD_COST = 1;
const UNSTRUNG_SOFTWOOD_YIELD = 1;
const UNSTRUNG_SOFTWOOD_XP = 20;
const UNSTRUNG_SOFTWOOD_TIME_MS = 3000;

const UNSTRUNG_OAK_WOOD_COST = 1;
const UNSTRUNG_OAK_YIELD = 1;
const UNSTRUNG_OAK_XP = 35;
const UNSTRUNG_OAK_TIME_MS = 4000;

const SOFTWOOD_BOW_UNSTRUNG_COST = 1;
const SOFTWOOD_BOW_STRING_COST = 1;
const SOFTWOOD_BOW_YIELD = 1;
const SOFTWOOD_BOW_XP = 25;
const SOFTWOOD_BOW_TIME_MS = 3000;

const OAK_BOW_UNSTRUNG_COST = 1;
const OAK_BOW_STRING_COST = 1;
const OAK_BOW_YIELD = 1;
const OAK_BOW_XP = 45;
const OAK_BOW_TIME_MS = 4000;

// --- NEW: Smithing Constants (Arrow Tips) ---
const COPPER_ARROW_TIP_BAR_COST = 4;
const COPPER_ARROW_TIP_YIELD = 10;
const COPPER_ARROW_TIP_XP = 20;
const COPPER_ARROW_TIP_TIME_MS = 3000;

// +++ NEW: Crafting Skill Constants +++
const CRAFTING_BUCKET_LVL = 1;
const BUCKET_OAK_COST = 5;
const BUCKET_XP = 15;
const BUCKET_TIME_MS = 2000;

const CRAFTING_BOW_STRING_LVL = 1;
const BOW_STRING_SILK_COST = 2;
const BOW_STRING_YIELD = 1;
const BOW_STRING_XP = 15;
const BOW_STRING_TIME_MS = 2500;

const CRAFTING_EMPTY_VIAL_LVL = 5;
const EMPTY_VIAL_SAND_COST = 10;
const EMPTY_VIAL_COAL_COST = 3;
const EMPTY_VIAL_XP = 40;
const EMPTY_VIAL_TIME_MS = 4000;

// +++ NEW: Sand Mining Constants +++
const SAND_MINE_TIME_MS = 1500; // Fast to mine
const SAND_MINE_XP = 10;
const SAND_MINE_ITEM = 'Sand';
const MINE_COOLDOWN_SAND_MS = 1000;

// +++ NEW: Leather Crafting Constants +++
const CRAFTING_LEATHER_LVL = 1;
const LEATHER_HIDE_COST = 1;
const LEATHER_XP = 5;
const LEATHER_TIME_MS = 1500;

const CRAFTING_LEATHER_HOOD_LVL = 3;
const LEATHER_HOOD_LEATHER_COST = 5; 
const LEATHER_HOOD_XP = 20;
const LEATHER_HOOD_TIME_MS = 3000;

const CRAFTING_LEATHER_BODY_LVL = 7;
const LEATHER_BODY_LEATHER_COST = 10; 
const LEATHER_BODY_XP = 50;
const LEATHER_BODY_TIME_MS = 6000;

const CRAFTING_LEATHER_CHAPS_LVL = 5;
const LEATHER_CHAPS_LEATHER_COST = 10; 
const LEATHER_CHAPS_XP = 30;
const LEATHER_CHAPS_TIME_MS = 4000;

const CRAFTING_LEATHER_BOOTS_LVL = 1;
const LEATHER_BOOTS_LEATHER_COST = 5; 
const LEATHER_BOOTS_XP = 10;
const LEATHER_BOOTS_TIME_MS = 2000;

// +++ NEW: Cloth Crafting Constants +++
const CRAFTING_CLOTH_LVL = 1;
const CLOTH_SILK_COST = 5;
const CLOTH_YIELD = 1;
const CLOTH_XP = 20;
const CLOTH_TIME_MS = 2000;

// +++ NEW: Wizard Gear Crafting Constants +++
const CRAFTING_WIZARD_BOOTS_LVL = 2;
const WIZARD_BOOTS_CLOTH_COST = 5;
const WIZARD_BOOTS_XP = 10;
const WIZARD_BOOTS_TIME_MS = 2000;

const CRAFTING_WIZARD_HAT_LVL = 4;
const WIZARD_HAT_CLOTH_COST = 5;
const WIZARD_HAT_XP = 20;
const WIZARD_HAT_TIME_MS = 3000;

const CRAFTING_WIZARD_TROUSERS_LVL = 6;
const WIZARD_TROUSERS_CLOTH_COST = 10;
const WIZARD_TROUSERS_XP = 30;
const WIZARD_TROUSERS_TIME_MS = 4000;

const CRAFTING_WIZARD_ROBE_LVL = 8;
const WIZARD_ROBE_CLOTH_COST = 10;
const WIZARD_ROBE_XP = 50;
const WIZARD_ROBE_TIME_MS = 6000;

// +++ NEW: Magic Staff Crafting Constants +++
const CRAFTING_MAGIC_STAFF_LVL = 20;
const MAGIC_STAFF_OAK_COST = 10;
const MAGIC_STAFF_EARTH_COST = 10;
const MAGIC_STAFF_AIR_COST = 10;
const MAGIC_STAFF_WATER_COST = 10;
const MAGIC_STAFF_XP = 100;
const MAGIC_STAFF_TIME_MS = 8000;

// +++ NEW: GOLD RING CRAFTING CONSTANTS +++
const CRAFTING_GOLD_RING_LVL = 38;
const GOLD_RING_BAR_COST = 2;
const GOLD_RING_XP = 150;
const GOLD_RING_TIME_MS = 4000;

// --- NEW: Iron Smithing Constants ---
const IRON_BAR_ORE_COST = 1; // 1 Iron Ore
const IRON_BAR_COAL_COST = 2; // 1 Coal Ore
const IRON_BAR_XP = 30;
const IRON_BAR_TIME_MS = 6000;

const IRON_HELMET_BAR_COST = 5;
const IRON_HELMET_XP = 150; 
const IRON_HELMET_TIME_MS = 7000; 

const IRON_CHESTPLATE_BAR_COST = 10;
const IRON_CHESTPLATE_XP = 300; 
const IRON_CHESTPLATE_TIME_MS = 12000; 

const IRON_BOOTS_BAR_COST = 4;
const IRON_BOOTS_XP = 120; 
const IRON_BOOTS_TIME_MS = 6000; 

// +++ NEW PLATELEGS CONSTANTS +++
const IRON_PLATELEGS_BAR_COST = 6;
const IRON_PLATELEGS_XP = 180; // 6 bars (30xp/bar)
const IRON_PLATELEGS_TIME_MS = 9000; // 6 bars (1.5s/bar)
// +++ END NEW CONSTANTS +++ 

const IRON_SHORTSWORD_BAR_COST = 5;
const IRON_SHORTSWORD_XP = 150;
const IRON_SHORTSWORD_TIME_MS = 7000;

// --- NEW: Woodcutting Level Requirements ---
const SOFTWOOD_TREE_LVL = 1;
const OAK_TREE_LVL = 10;

// --- NEW: Woodcutting Chop Constants ---
const SOFTWOOD_CHOP_TIME_MS = 1500;
const SOFTWOOD_CHOP_XP = 15;
const SOFTWOOD_CHOP_ITEM = 'Softwood';

const OAK_CHOP_TIME_MS = 3000;
const OAK_CHOP_XP = 35;
const OAK_CHOP_ITEM = 'Oak';

const CHOP_COOLDOWN_SOFTWOOD_MS = 1000;
const CHOP_COOLDOWN_OAK_MS = 1500;

// --- NEW: Tool Crafting Requirements ---
const COPPER_AXE_BAR_COST = 3;
const COPPER_AXE_WOOD_COST = 2;
const COPPER_AXE_XP = 25;
const COPPER_AXE_TIME_MS = 4000;

const COPPER_PICKAXE_BAR_COST = 4;
const COPPER_PICKAXE_WOOD_COST = 2;
const COPPER_PICKAXE_XP = 30;
const COPPER_PICKAXE_TIME_MS = 4500;

const IRON_AXE_BAR_COST = 3;
const IRON_AXE_WOOD_COST = 2;
const IRON_AXE_XP = 120;
const IRON_AXE_TIME_MS = 6000;

const IRON_PICKAXE_BAR_COST = 4;
const IRON_PICKAXE_WOOD_COST = 2;
const IRON_PICKAXE_XP = 140;
const IRON_PICKAXE_TIME_MS = 6500;

// --- SILVER TOOLS ---
const SILVER_AXE_BAR_COST = 3;
const SILVER_AXE_WOOD_COST = 2; // Birch
const SILVER_AXE_XP = 250;
const SILVER_AXE_TIME_MS = 8000;

const SILVER_PICKAXE_BAR_COST = 4;
const SILVER_PICKAXE_WOOD_COST = 2; // Birch
const SILVER_PICKAXE_XP = 300;
const SILVER_PICKAXE_TIME_MS = 9000;

// --- NEW: Tool Tier Definitions ---
const PICKAXE_TIERS = { "Bronze Pickaxe": 1, "Copper Pickaxe": 2, "Iron Pickaxe": 3, "Silver Pickaxe": 4 };
const AXE_TIERS = { "Bronze Axe": 1, "Copper Axe": 2, "Iron Axe": 3, "Silver Axe": 4 };

// --- NEW: OSRS Style Item Definitions ---
const ITEM_STATS = {
  // --- MELEE GEAR (High Melee Def, 0 or Low Magic Def, Negative Magic/Range Atk) ---
  'Copper Helmet': { meleeDef: 3, rangedDef: 4, magicDef: 0, magicAtk: -3, rangedAtk: -2, armorType: 'melee' },
  'Copper Chestplate': { meleeDef: 8, rangedDef: 9, magicDef: 0, magicAtk: -10, rangedAtk: -6, armorType: 'melee' },
  'Copper Platelegs': { meleeDef: 5, rangedDef: 6, magicDef: 0, magicAtk: -7, rangedAtk: -4, armorType: 'melee' },
  'Copper Boots': { meleeDef: 2, rangedDef: 2, magicDef: 0, magicAtk: -3, rangedAtk: -1, armorType: 'melee' },
  'Copper Shortsword': { meleeStr: 4, meleeAtk: 5, weaponType: 'melee', speed: 2000 },

  'Iron Helmet': { meleeDef: 5, rangedDef: 6, magicDef: 1, magicAtk: -4, rangedAtk: -2, armorType: 'melee' },
  'Iron Chestplate': { meleeDef: 12, rangedDef: 13, magicDef: 2, magicAtk: -15, rangedAtk: -10, armorType: 'melee' },
  'Iron Platelegs': { meleeDef: 8, rangedDef: 9, magicDef: 1, magicAtk: -10, rangedAtk: -6, armorType: 'melee' },
  'Iron Boots': { meleeDef: 3, rangedDef: 3, magicDef: 1, magicAtk: -3, rangedAtk: -1, armorType: 'melee' },
  'Iron Shortsword': { meleeStr: 7, meleeAtk: 9, weaponType: 'melee', speed: 2000 },
  'Silver Fangs of the Fallen Monarch': { meleeStr: 9, meleeAtk: 15, weaponType: 'melee', speed: 1500 },

  // --- RANGED GEAR (High Magic Def, Positive Range Atk) ---
  'Leather Hood': { meleeDef: 1, rangedDef: 2, magicDef: 4, rangedAtk: 2, magicAtk: -1, armorType: 'ranged' },
  'Leather Body': { meleeDef: 3, rangedDef: 4, magicDef: 8, rangedAtk: 5, magicAtk: -2, armorType: 'ranged' },
  'Leather Chaps': { meleeDef: 2, rangedDef: 3, magicDef: 6, rangedAtk: 3, magicAtk: -1, armorType: 'ranged' },
  'Leather Boots': { meleeDef: 1, rangedDef: 1, magicDef: 2, rangedAtk: 1, armorType: 'ranged' },
  
  'Softwood Bow': { rangedStr: 4, rangedAtk: 5, weaponType: 'ranged', twoHanded: true, speed: 2400 },
  'Oak Bow': { rangedStr: 8, rangedAtk: 10, weaponType: 'ranged', twoHanded: true, speed: 2400 },
  'Copper Arrow': { rangedStr: 2 }, 

  // --- MAGIC GEAR (Low Melee Def, High Magic Atk/Def) ---
  'Wizard Hat': { meleeDef: 1, rangedDef: 1, magicDef: 3, magicAtk: 3, armorType: 'magic' },
  'Wizard Robe': { meleeDef: 2, rangedDef: 2, magicDef: 6, magicAtk: 6, armorType: 'magic' },
  'Wizard Trousers': { meleeDef: 1, rangedDef: 1, magicDef: 4, magicAtk: 4, armorType: 'magic' },
  'Wizard Boots': { meleeDef: 1, rangedDef: 1, magicDef: 2, magicAtk: 2, armorType: 'magic' },
  
  'Magic Staff': { magicAtk: 10, magicDmg: 2, weaponType: 'magic', twoHanded: true, speed: 3000 },

  // --- COSMETICS / SPECIALS ---
  'Gold Crown': { meleeDef: 5, rangedDef: 5, magicDef: 5, magicAtk: 2, rangedAtk: 2, meleeAtk: 2, armorType: 'hybrid' },
  'Elegant Black Cape': { meleeDef: 2, armorType: 'melee' },
  '1tapper': { meleeStr: 999, meleeAtk: 999, weaponType: 'melee', speed: 500 },
  'Pet Spider': { type: 'pet' },
  'Gold Ring': { armorType: 'jewelry' },
  'Diamond Ring': { meleeDef: 2, armorType: 'jewelry' },
  'Emerald Ring': { rangedStr: 2, armorType: 'jewelry' },
  'Ruby Ring': { meleeStr: 2, armorType: 'jewelry' },
  'Sapphire Ring': { magicDmg: 2, armorType: 'jewelry' },
  'Topaz Ring': { maxHPBonus: 2, armorType: 'jewelry' }
};
window.ITEM_STATS = ITEM_STATS;

const SHOP_INVENTORY = new Array(24).fill(null);
SHOP_INVENTORY[0] = { name: 'Bronze Pickaxe', price: 10 };
SHOP_INVENTORY[1] = { name: 'Bronze Axe', price: 10 };
SHOP_INVENTORY[2] = { name: 'Fishing Pole', price: 2500 };
SHOP_INVENTORY[3] = { name: 'Fishing Bait', price: 10 };
// Empty Bucket removed from shop
SHOP_INVENTORY[4] = { name: 'Grass Seed', price: 15 };
SHOP_INVENTORY[5] = { name: 'Corn Seed', price: 30 };

// --- NEW: Item Sell Prices ---
const ITEM_SELL_PRICES = {
  'Silk': 2,
  'Cloth': 12,
  'Wizard Hat': 30,
  'Wizard Robe': 70,
  'Wizard Trousers': 45,
  'Wizard Boots': 30,
  'Copper Ore': 1,
  'Coal Ore': 2,
  'Iron Ore': 4,
  'Silver Ore': 7,
  'Gold Ore': 12,
  'Softwood': 1,
  'Oak': 3,
  'Copper Bar': 3,
  'Iron Bar': 10,
  'Raw Chicken': 1,
  'Cooked Chicken': 2,
  'Burnt Chicken': 1,
  'Beef': 2,
  'Cooked Beef': 3,
  'Burnt Beef': 1,
  'Bronze Pickaxe': 4,
  'Bronze Axe': 4,
  'Copper Pickaxe': 15,
  'Copper Axe': 15,
  'Copper Helmet': 20,
  'Copper Chestplate': 40,
  'Copper Platelegs': 25,
  'Copper Boots': 15,
  'Copper Shortsword': 20,
  'Iron Pickaxe': 50,
  'Iron Axe': 50,
  'Iron Helmet': 60,
  'Iron Chestplate': 120,
  'Iron Platelegs': 75,
  'Iron Boots': 55,
  'Iron Shortsword': 65,
  'Silver Pickaxe': 150,
  'Silver Axe': 150,
  'Feather': 1,
  'Arrow Shaft': 1,
  'Copper Arrow Tip': 2,
  'Unbound Arrow': 3,
  'Copper Arrow': 5,
  'Earth Crystal Shard': 5,
  'Air Crystal Shard': 8,
  'Water Crystal Shard': 12,
  'Bow String': 3,
  'Unstrung Softwood Bow': 5,
  'Unstrung Oak Bow': 10,
  'Softwood Bow': 10,
  'Oak Bow': 20,
  'Cow Hide': 4,
  'Leather': 6,
  'Leather Hood': 10,
  'Leather Body': 25,
  'Leather Chaps': 15,
  'Leather Boots': 8,
  'Herring': 2,
  'Trout': 4,
  'Salmon': 8,
  'Cooked Herring': 3,
  'Burnt Herring': 1,
  'Cooked Trout': 6,
  'Burnt Trout': 2,
  'Cooked Salmon': 10,
  'Burnt Salmon': 4,
  'Fishing Pole': 1000,
  'Fishing Bait': 4,
  'Magic Staff': 50,
  'Earthstone': 10,
  'Airstone': 15,
  'Waterstone': 20,
  'Gold Crown': 50000,
  'Elegant Black Cape': 50000,
  'Gold Bar': 250,
  'Diamond': 2500,
  '1tapper': 0,
  'Rat Tail': 3,
  'Sand': 1,
  'Empty Vial': 5,
  'Venom': 15,
  'Lottery Ticket': 100,
  'Empty Bucket': 2,
  'Bucket of Milk': 250,
  'Bucket of Water': 5,
  'Grass Seed': 2,
  'Grass': 150,
  'Corn Seed': 5,
  'Corn': 80,
  'Wild Herb': 25,
  'Vitality Potion': 150,
  'Uncut Topaz': 25,
  'Uncut Diamond': 25,
  'Uncut Emerald': 25,
  'Uncut Jade': 25,
  'Uncut Ruby': 25,
  'Uncut Sapphire': 25,
  'Topaz': 100,
  'Diamond': 100,
  'Emerald': 100,
  'Jade': 100,
  'Ruby': 100,
  'Sapphire': 100,
  'Gold Ring': 500,
  'Diamond Ring': 1200,
  'Emerald Ring': 1200,
  'Ruby Ring': 1200,
  'Sapphire Ring': 1200,
  'Topaz Ring': 1200,
  'Silver Fangs of the Fallen Monarch': 25000
};

const CRAFTING_GEM_RING_LVL = 40;
const GEM_RING_CRAFT_XP = 250;
const GEM_RING_CRAFT_TIME_MS = 5000;

const WELL_GATHER_TIME_MS = 2000;

// +++ NEW: Farming Constants ---
// 5 Hours, 10 Hours, 12 Hours (in milliseconds)
const FARM_STAGE_2_TIME = 18000000; // 5 Hours (Visual update to stage 2)
const FARM_STAGE_3_TIME = 36000000; // 10 Hours (Visual update to stage 3)
const FARM_HARVEST_TIME = 43200000; // 12 Hours (Ready to harvest + Glow)

const GRASS_SEEDS_REQ = 5;

// +++ FARMING XP CONSTANTS +++
const HARVEST_GRASS_XP = 15;
const HARVEST_CORN_XP = 35;
const COLLECT_MILK_XP = 50; // Per bucket
const COLLECT_EGG_XP = 25;  // Per egg
const MAX_EGG_COLLECT_LIMIT = 30; // Cap for "Collect All"
const GRASS_HARVEST_YIELD_MIN = 3;
const GRASS_HARVEST_YIELD_MAX = 6;

const CORN_SEEDS_REQ = 3;
const CORN_HARVEST_YIELD_MIN = 3;
const CORN_HARVEST_YIELD_MAX = 5;

// +++ NEW PET CONSTANTS +++
const PET_EGG_DROP_RATE = 25000;
const PET_HATCH_TIME_MS = 7200000; // 2 Hours
const PET_HP_DECAY_MS = 43200000; // 12 Hours
const PET_MAX_HP = 10;
const PET_FEED_XP = 25; // Pet Mastery XP for feeding
const PET_HATCH_XP = 500; // Pet Mastery XP for hatching

// +++ NEW: EGG CONFIGURATION +++
const EGG_TYPES = {
    'Pet Spider Egg': 'Spider'
    // Future examples:
    // 'Pet Dragon Egg': 'Dragon',
    // 'Pet Rock Egg': 'Rock'
};

const PET_DATA = {
    'Spider': {
        name: 'Spider',
        foodItem: 'Rat Tail',
        img: 'petspider', // Requires images/petspider.png
        bonus: (level) => {
            let dmg = 0;
            if (level >= 20) dmg += 1;
            if (level >= 40) dmg += 1;
            return { physicalDamage: dmg };
        }
    }
};

const CROPS = {
  'Grass': {
    seedName: 'Grass Seed',
    productName: 'Grass',
    levelReq: 20, // <--- UPDATED to Level 20
    stages: 3,
    images: ['grassfirststage.png', 'grasssecondstage.png', 'grassthirdstage.png'],
    seedImage: 'grassseed.png'
  },
  'Corn': {
    seedName: 'Corn Seed',
    productName: 'Corn',
    levelReq: 1, 
    stages: 3,
    images: ['cornfirststage.png', 'cornsecondstage.png', 'cornthirdstage.png'],
    seedImage: 'cornseed.png',
    // +++ NEW: Manual adjustments for stage positions [Stage 1, Stage 2, Stage 3] +++
    // Change y: -10 to move UP, y: 10 to move DOWN. x: -10 LEFT, x: 10 RIGHT.
    stageOffsets: [
        { x: 0, y: 0 },   // Stage 1: No change (Perfect)
        { x: 0, y: -10 }, // Stage 2: Moves UP 10px (Adjust this number)
        { x: 0, y: -10 }  // Stage 3: Moves UP 20px (Adjust this number)
    ]
  }
};

const DIRT_SHROOM_PLANT_COST = 10;
const DIRT_SHROOM_HARVEST_MIN = 80;
const DIRT_SHROOM_HARVEST_MAX = 120;
const HARVEST_SHROOM_XP = 50;

const MUSHROOMS = {
  'Dirt Shroom': {
    productName: 'Dirt Shroom',
    levelReq: 1, 
    stages: 3,
    images: ['dirtshroomfirststage.png', 'dirtshroomsecondstage.png', 'dirtshroomthirdstage.png'],
    // Default global offsets for all tiles
    stageOffsets: [ {x:0,y:0}, {x:0,y:0}, {x:0,y:0} ],
    
    // TILE SPECIFIC OFFSETS (Stage 1, Stage 2, Stage 3)
    tileSpecificOffsets: {
      0:  [ {x:-2, y:0}, {x:0, y:0}, {x:-5, y:0} ],
      1:  [ {x:-2, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      2:  [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      3:  [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      4:  [ {x:-2, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      5:  [ {x:-2, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      6:  [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      7:  [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      8:  [ {x:-2, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      9:  [ {x:-2, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      10: [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      11: [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      12: [ {x:-4, y:0}, {x:0, y:0}, {x:-3, y:0} ],
      13: [ {x:-5, y:0}, {x:0, y:0}, {x:-5, y:0} ],
      14: [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ],
      15: [ {x:0, y:0}, {x:0, y:0}, {x:0, y:0} ]
    }
  }
};


// --- QUEST LINES DATABASE ---
const QUEST_LINES = {
  'tutorial': {
    name: "The Beginning",
    desc: "Learn the basics of survival and combat.",
    quests: [
      {
        id: "tut_1",
        name: "The Foundation",
        desc: "We need to reinforce the camp. Bring me materials to build better defenses.",
        type: 'gather',
        reqItems: [
          { name: 'Copper Ore', qty: 100 },
          { name: 'Softwood', qty: 100 }
        ],
        rewards: { gold: 500 }
      },
      {
        id: "tut_2",
        name: "Feathered Fury",
        desc: "The chickens at the farm are getting aggressive. Thin their numbers.",
        type: 'kill',
        targetEnemy: 'Chicken',
        targetCount: 50,
        reqSkill: { skill: 'attack', level: 10 },
        rewards: { gold: 1000 }
      },
      
      // --- River Bounty (Moved Up) ---
      {
        id: "tut_2_fishing",
        name: "River Bounty",
        desc: "The camp needs food supplies. The river is teeming with Trout.",
        type: 'gather',
        reqItems: [
          { name: 'Trout', qty: 200 }
        ],
        reqSkill: { skill: 'fishing', level: 5 },
        rewards: { gold: 1500 }
      },

      // --- Beefy Business (Cows) ---
      {
        id: "tut_2_cows",
        name: "Beefy Business",
        desc: "The cows have gone mad! Put them to rest before they stampede the camp.",
        type: 'kill',
        targetEnemy: 'Cow',
        targetCount: 30,
        rewards: { gold: 1200 }
      },

      // --- Suit Up (Leather) ---
      {
        id: "tut_2_leather",
        name: "Suit Up",
        desc: "We need armor for our scouts to fight off intruders. Bring me a full set of Leather Armor.",
        type: 'gather',
        reqSkill: { skill: 'crafting', level: 7 },
        reqItems: [
          { name: 'Leather Hood', qty: 1 },
          { name: 'Leather Body', qty: 1 },
          { name: 'Leather Chaps', qty: 1 },
          { name: 'Leather Boots', qty: 1 }
        ],
        rewards: { gold: 2500 }
      },

      {
        id: "tut_3",
        name: "Web of Lies",
        desc: "The cave spiders are spinning webs all over our equipment. Clear them out!",
        type: 'kill',
        targetEnemy: 'Spider',
        targetCount: 100,
        rewards: { 
            gold: 1000, 
            items: [{ name: 'Cooked Herring', qty: 25 }] 
        }
      },
      // +++ NEW QUEST: Vials (Does not consume items) +++
      {
        id: "tut_4",
        name: "Glass Reserves",
        desc: "We need to ensure we have enough glassware for alchemy. Show me you have a stock of Empty Vials.",
        type: 'gather',
        consume: false, // <--- This flag prevents item removal
        reqItems: [
          { name: 'Empty Vial', qty: 100 }
        ],
        rewards: { gold: 2500 }
      },
      // +++ NEW QUEST: Venom (Consumes items) +++
      {
        id: "tut_5",
        name: "Potent Poison",
        desc: "The Centipedes carry a deadly toxin. Bring me their Venom so we can study it.",
        type: 'gather',
        // consume defaults to true
        reqItems: [
          { name: 'Venom', qty: 100 }
        ],
        rewards: { gold: 2500 }
      }
    ]
  }
};

function setText(id, text){ const el=document.getElementById(id); if(el) el.innerText=text; }

function formatAmount(n) {
  if (n < 1000) return n.toString();
  if (n < 1000000) return parseFloat((n / 1000).toFixed(2)) + 'k';
  return parseFloat((n / 1000000).toFixed(2)) + 'M';
}

function createCharacter(){
  const name = document.getElementById('playerName').value.trim();
  if(!name) return; 
  game.name = name;
  game.isDirty = true; // Flag for save
  document.getElementById('charName').innerText = name;
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'block';
  updateHPUI();
  renderInventoryGrid();
  updateSkillUI();
  updateGoldUI();
  renderEquipment(); 
  backToActions(); 
}

function updateHPUI(){
  // 1. Calculate base maxHP based on Vitality level
  let baseMax = 10 + (game.vitality ? (game.vitality.level - 1) : 0);
  
  // 2. Add scaling equipment bonuses (Enchanted Topaz Rings, etc)
  const stats = getPlayerCombatStats();
  baseMax += stats.maxHPBonus;

  game.maxHP = baseMax;
  
  // Auto-heal if HP is higher than new Max
  if (game.hp > game.maxHP) game.hp = game.maxHP;
  game.hp = Math.min(game.hp, game.maxHP); 
  
  const percent = Math.min(100, Math.round((game.hp / game.maxHP) * 100));
  const hpFill = document.getElementById('hpFill');
  if (hpFill) hpFill.style.width = percent + '%';
  setText('hpText', `${game.hp} / ${game.maxHP} HP`);
}


/**
 * Calculates player stats based on Levels + Equipment Bonuses.
 * No more speed penalties; uses Accuracy/Defense rolls.
 */
function getPlayerCombatStats() {
  const stats = {
    meleeAtk: 0, rangedAtk: 0, magicAtk: 0,
    meleeStr: 0, rangedStr: 0, magicDmg: 0,
    meleeDef: 0, rangedDef: 0, magicDef: 0,
    maxHPBonus: 0,
    attackSpeed: 2400 
  };

  let equippedWeaponType = 'melee'; 

  for (const [slotType, item] of Object.entries(game.equipment)) {
    if (item && ITEM_STATS[item.name]) {
      const def = ITEM_STATS[item.name];
      const enchantLvl = item.enchantLevel || 0;
      
      // Calculate two different types of scaling
      const standardBonus = enchantLvl;
      const penalizedBonus = Math.floor(enchantLvl / 2);

      stats.meleeAtk += def.meleeAtk || 0;
      stats.rangedAtk += def.rangedAtk || 0;
      stats.magicAtk += def.magicAtk || 0;
      
      // Offense and HP always use standard scaling
      stats.meleeStr += (def.meleeStr || 0) + (def.meleeStr ? standardBonus : 0);
      stats.rangedStr += (def.rangedStr || 0) + (def.rangedStr ? standardBonus : 0);
      stats.magicDmg += (def.magicDmg || 0) + (def.magicDmg ? standardBonus : 0);
      stats.maxHPBonus += (def.maxHPBonus || 0) + (def.maxHPBonus ? standardBonus : 0);
      
      // DEFENSE SCALING BASED ON ARMOR TYPE
      if (def.armorType === 'melee') {
          stats.meleeDef += (def.meleeDef || 0) + standardBonus;
          stats.rangedDef += (def.rangedDef || 0) + standardBonus;
          stats.magicDef += (def.magicDef || 0) + penalizedBonus; // Penalized
      } else if (def.armorType === 'ranged') {
          stats.meleeDef += (def.meleeDef || 0) + penalizedBonus; // Penalized
          stats.rangedDef += (def.rangedDef || 0) + standardBonus;
          stats.magicDef += (def.magicDef || 0) + standardBonus;
      } else if (def.armorType === 'magic') {
          stats.meleeDef += (def.meleeDef || 0) + penalizedBonus; // Penalized
          stats.rangedDef += (def.rangedDef || 0) + standardBonus;
          stats.magicDef += (def.magicDef || 0) + standardBonus;
      } else {
          // Jewelry or hybrid gear uses standard for all
          stats.meleeDef += (def.meleeDef || 0) + standardBonus;
          stats.rangedDef += (def.rangedDef || 0) + standardBonus;
          stats.magicDef += (def.magicDef || 0) + standardBonus;
      }

      if (slotType === 'weapon') {
        if (def.speed) stats.attackSpeed = def.speed;
        if (def.weaponType) equippedWeaponType = def.weaponType;
      }
    }
  }

  if (game.equipment.pet) {
      const petData = game.pets.find(p => p.id === game.equipment.pet.id);
      if (petData && petData.hp > 0) {
          const def = PET_DATA[petData.type];
          if (def && def.bonus) {
              const bonuses = def.bonus(petData.level);
              if (bonuses.physicalDamage) stats.meleeStr += bonuses.physicalDamage;
          }
      }
  }

  if (game.playerAttackStyle === 'attack') {
      if (equippedWeaponType === 'melee') stats.meleeAtk += 3;
      if (equippedWeaponType === 'ranged') stats.rangedAtk += 3;
      if (equippedWeaponType === 'magic') stats.magicAtk += 3;
  } 
  else if (game.playerAttackStyle === 'strength') {
      if (equippedWeaponType === 'melee') stats.meleeStr += 3;
      if (equippedWeaponType === 'ranged') stats.rangedStr += 3;
      if (equippedWeaponType === 'magic') stats.magicDmg += 3;
  } 
  else if (game.playerAttackStyle === 'defence') {
      stats.meleeDef += 3;
      stats.rangedDef += 3;
      stats.magicDef += 3;
  }

  return { ...stats, equippedWeaponType };
}


function renderEquipment() {
  const stats = getPlayerCombatStats();
  
  // Update Offense Stats (Colors are handled by CSS/HTML styles)
  setText('stat-m-str', `+${stats.meleeStr}`);
  setText('stat-r-str', `+${stats.rangedStr}`);
  setText('stat-mag-dmg', `+${stats.magicDmg}`);

  // Update Defense Stats
  setText('stat-m-def', `+${stats.meleeDef}`);
  setText('stat-r-def', `+${stats.rangedDef}`);
  setText('stat-mag-def', `+${stats.magicDef}`);

  // (The rest of the function remains the same...)

  const physDmgEl = document.getElementById('stat-phys-dmg-panel');
  if (physDmgEl) {
      const parentRow = physDmgEl.closest('.stat-row');
      const label = parentRow.querySelector('.stat-label');
      if (label) label.innerText = "Melee Strength";

      let rangeRow = document.getElementById('stat-range-str-row');
      if (!rangeRow) {
          rangeRow = document.createElement('div');
          rangeRow.id = 'stat-range-str-row';
          rangeRow.className = 'stat-row';
          rangeRow.innerHTML = `<span class="stat-label">Ranged Strength</span><span class="stat-value" id="stat-range-str-val">+0</span>`;
          parentRow.parentNode.insertBefore(rangeRow, parentRow.nextSibling);
      }
      setText('stat-range-str-val', `+${stats.rangedStr}`);
  }

  const slots = ['necklace', 'helmet', 'cape', 'weapon', 'chest', 'shield', 'ring1', 'legs', 'ring2', 'arrows', 'boots', 'pet'];
  
  const itemImageMap = {
    'Copper Helmet': 'copperhelmet', 'Copper Chestplate': 'copperchestplate', 'Copper Shortsword': 'coppershortsword', 'Copper Boots': 'copperboots',
    'Iron Helmet': 'ironhelmet', 'Iron Chestplate': 'ironchestplate', 'Iron Shortsword': 'ironshortsword', 'Iron Boots': 'ironboots',
    'Copper Platelegs': 'copperplatelegs', 'Iron Platelegs': 'ironplatelegs', 
    'Softwood Bow': 'softwoodbow', 'Oak Bow': 'oakbow', 'Copper Arrow': 'copperarrow',
    'Leather Hood': 'leatherhood', 'Leather Body': 'leatherarmor', 'Leather Chaps': 'leatherpants', 'Leather Boots': 'leatherboots',
    'Wizard Hat': 'wizardhat', 'Wizard Robe': 'wizardrobe', 'Wizard Trousers': 'wizardtrousers', 'Wizard Boots': 'wizardboots', 'Magic Staff': 'magicstaff',
    'Gold Crown': 'goldcrown', 'Elegant Black Cape': 'elegantblackcape', '1tapper': '1tapper', 'Pet Spider': 'petspider',
    'Gold Ring': 'goldring', 'Diamond Ring': 'diamondring', 'Emerald Ring': 'emeraldring', 'Ruby Ring': 'rubyring', 'Sapphire Ring': 'sapphirering', 'Topaz Ring': 'topazring',
    'Silver Fangs of the Fallen Monarch': 'silverfangsofthefallenmonarch'
  };

  slots.forEach(slotType => {
    const item = game.equipment[slotType];
    const mainSlotEl = document.getElementById(slotType);
    if (!mainSlotEl) return;

    mainSlotEl.className = 'equipment-slot'; 
    mainSlotEl.innerHTML = '';
    
    let imgName = item ? (itemImageMap[item.name] || 'helmet') : slotType; 
    if (!item) {
        if (slotType === 'chest') imgName = 'chestplate';
        if (slotType === 'ring1' || slotType === 'ring2') imgName = 'ring';
    }
    
    let isTwoHandedBlock = false;
    if (slotType === 'shield' && !item && game.equipment.weapon && ITEM_STATS[game.equipment.weapon.name]?.twoHanded) {
        isTwoHandedBlock = true;
        imgName = itemImageMap[game.equipment.weapon.name];
    }

    let img = document.createElement('img');
    img.src = `images/${imgName}.png`;
    img.alt = slotType;
    if (isTwoHandedBlock) { img.style.opacity = '0.5'; img.style.filter = 'grayscale(100%)'; }
    mainSlotEl.appendChild(img);

    if (item && item.qty > 1) {
        const amt = document.createElement('div');
        amt.className = 'inv-amount';
        amt.innerText = formatAmount(item.qty); 
        mainSlotEl.appendChild(amt);
    }

    if (item) {
        const eLvl = item.enchantLevel || 0;
        // Apply Gold Aura for Legendary items, otherwise apply Enchantment glows
        if (item.name === 'Gold Crown' || item.name === 'Elegant Black Cape') {
            mainSlotEl.classList.add('legendary-glow');
        } else if (eLvl > 0) {
            mainSlotEl.classList.add(`enchant-glow-${eLvl}`);
        }

        if (eLvl > 0) {
            const badge = document.createElement('div');
            badge.className = 'enchant-level-badge';
            badge.innerText = `+${eLvl}`;
            mainSlotEl.appendChild(badge);
        }

        const def = ITEM_STATS[item.name];
        let html = `<div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${item.name} ${eLvl > 0 ? `+${eLvl}` : ''}</div>`;
        
        if (def) {
            // Standard Bonus: +1 per upgrade level
            const stdB = eLvl; 
            // Penalized Bonus: +1 every 2 upgrades
            const penB = Math.floor(eLvl / 2); 

            if (def.meleeStr) html += `<div style="color:#ff4d4d;">+${def.meleeStr + stdB} Melee Strength</div>`;
            if (def.rangedStr) html += `<div style="color:#44aa44;">+${def.rangedStr + stdB} Ranged Strength</div>`;
            if (def.magicDmg) html += `<div style="color:#4da6ff;">+${def.magicDmg + stdB} Magic Damage</div>`;
            
            // Logic to decide which stats are penalized based on the armor type
            let mBonus = stdB, rBonus = stdB, magBonus = stdB;
            if (def.armorType === 'melee') {
                magBonus = penB; // Melee armor is bad at Magic Def
            } else if (def.armorType === 'ranged' || def.armorType === 'magic') {
                mBonus = penB;   // Ranged/Magic armor is bad at Melee Def
            }

            if (def.meleeDef !== undefined) html += `<div style="color:#e38a42;">+${def.meleeDef + mBonus} Melee Def</div>`;
            if (def.rangedDef !== undefined) html += `<div style="color:#aaffaa;">+${def.rangedDef + rBonus} Ranged Def</div>`;
            if (def.magicDef !== undefined) html += `<div style="color:#6dafff;">+${def.magicDef + magBonus} Magic Def</div>`;

            // Attack penalties (Red lines)
            if (def.maxHPBonus) html += `<div style="color:#ffaaaa;">+${def.maxHPBonus + stdB} Max HP</div>`;
            if (def.speed) html += `<div style="color:var(--gold);">Speed: ${(def.speed / 1000).toFixed(1)}s</div>`;
        }
        html += `<div style="color:#ffaaaa; margin-top:5px; font-size:11px;">Click to unequip</div>`;
        
        mainSlotEl.onclick = () => unequipItem(slotType);
        mainSlotEl.onmouseenter = (e) => showTooltip(e, html);
        mainSlotEl.onmouseleave = hideTooltip;
    } else if (isTwoHandedBlock) {
        mainSlotEl.onclick = () => unequipItem('weapon');
        mainSlotEl.onmouseenter = (e) => showTooltip(e, "Occupied by 2H Weapon");
        mainSlotEl.onmouseleave = hideTooltip;
    } else {
        mainSlotEl.onclick = null;
        mainSlotEl.onmouseenter = null;
    }
  });
}

function updateGoldUI() {
  setText('goldAmountText', formatAmount(game.gold));

  // +++ NEW: Tooltip for exact amount +++
  const container = document.getElementById('goldDisplay');
  if (container) {
    container.style.cursor = 'help'; 
    container.onmouseenter = (e) => showTooltip(e, `<div style="color:var(--gold); font-weight:bold; font-size:14px;">${game.gold.toLocaleString()} Gold</div>`);
    container.onmouseleave = hideTooltip;
  }
}

function addGold(amount) {
  game.gold = Math.max(0, game.gold + amount);
  game.isDirty = true;
  updateGoldUI();
}

function showTab(tab){
  document.getElementById('equipmentTab').style.display = 'none';
  document.getElementById('inventoryTab').style.display = 'none';
  document.getElementById('skillsTab').style.display = 'none';
  document.getElementById('questsTab').style.display = 'none'; 
  
  if (tab === 'quests') {
      renderQuestTabContent();
      // Ensure the correct sub-tab is shown on load
      const isMissionActive = document.getElementById('missionsSubTabContent').style.display === 'block';
      showQuestSubTab(isMissionActive ? 'missions' : 'quests');
  }
  
  document.getElementById(tab + 'Tab').style.display = 'block';
}

/**
 * Toggles between the Quests and Missions sub-tabs.
 * @param {('quests'|'missions')} subTab - The ID prefix of the sub-tab to show.
 */
function showQuestSubTab(subTab) {
  const questsContent = document.getElementById('questsSubTabContent');
  const missionsContent = document.getElementById('missionsSubTabContent');
  const questsBtn = document.getElementById('showQuestsBtn');
  const missionsBtn = document.getElementById('showMissionsBtn');

  if (subTab === 'missions') {
    questsContent.style.display = 'none';
    missionsContent.style.display = 'block';
    questsBtn.classList.remove('active');
    missionsBtn.classList.add('active');
    renderBountyDetails(); // <-- NEW: Render bounty when mission tab is opened
  } else {
    questsContent.style.display = 'block';
    missionsContent.style.display = 'none';
    questsBtn.classList.add('active');
    missionsBtn.classList.remove('active');
    renderActiveQuestDetails(); // <-- NEW: Render quest when quest tab is opened
  }
}

/**
 * Toggles between the Quests and Missions sub-tabs.
 * @param {('quests'|'missions')} subTab - The ID prefix of the sub-tab to show.
 */
function showQuestSubTab(subTab) {
  const questsContent = document.getElementById('questsSubTabContent');
  const missionsContent = document.getElementById('missionsSubTabContent');
  const questsBtn = document.getElementById('showQuestsBtn');
  const missionsBtn = document.getElementById('showMissionsBtn');

  if (subTab === 'missions') {
    questsContent.style.display = 'none';
    missionsContent.style.display = 'block';
    questsBtn.classList.remove('active');
    missionsBtn.classList.add('active');
  } else {
    questsContent.style.display = 'block';
    missionsContent.style.display = 'none';
    questsBtn.classList.add('active');
    missionsBtn.classList.remove('active');
  }
}

// +++ NEW AUTO EAT FUNCTIONS +++

function renderAutoEatSlot() {
    const slotEl = document.getElementById('autoEatSlot');
    if (!slotEl) return;
    
    slotEl.innerHTML = '';
    
    // Check if locked
    if (!game.autoEatUnlocked) {
        slotEl.innerHTML = `<div style="font-size: 20px; color: #777; pointer-events:none;"></div>`;
        slotEl.style.border = "2px solid #553322";
        slotEl.style.background = "rgba(0,0,0,0.5)";
        
        slotEl.onclick = (e) => {
            e.stopPropagation();
            buyAutoEat();
        };

        slotEl.onmouseenter = (e) => showTooltip(e, `<div style='color:var(--gold); font-weight:bold;'>Unlock Auto-Heal Slot</div>Cost: 200,000 Gold<br><span style='font-size:11px; color:#ccc;'>Automatically consumes Vitality Potions when HP is low.</span><br><br><span style='color:#aaffaa;'>Click to Purchase</span>`);
        slotEl.onmouseleave = hideTooltip;
        return;
    }

    // Normal logic for unlocked slot
    slotEl.onclick = unequipAutoEat;

    if (game.autoEatSlot) {
        let imgName = 'vitalitypotion'; // Since you only allow potions
        slotEl.innerHTML = `
            <img src="images/${imgName}.png">
            <div class="inv-amount">${game.autoEatSlot.qty}</div>
        `;
        slotEl.style.border = "2px solid var(--gold)";
        slotEl.onmouseenter = (e) => showTooltip(e, `<div style='color:var(--gold); font-weight:bold;'>${game.autoEatSlot.name}</div><div style='font-size:11px'>Auto-eats when HP < 20%</div><div style='color:#ffaaaa; font-size:10px;'>Click to Unequip</div>`);
    } else {
        slotEl.style.border = "2px dashed #555";
        slotEl.onmouseenter = (e) => showTooltip(e, "Auto Heal Slot<br><span style='color:#aaa; font-size:11px'>Equip potions via Inventory</span>");
    }
    slotEl.onmouseleave = hideTooltip;
}

function equipToAutoEat(itemName) {
    hideItemContextMenu();

    if (!game.autoEatUnlocked) {
        showWarningPopup("You must unlock the Auto-Heal slot first!");
        return;
    }
    
    // Only allow potions in the Auto-Heal slot
    if (itemName !== 'Vitality Potion') {
        showWarningPopup("Only potions can be placed in the Auto-Heal slot!");
        return;
    }
    
    // Check if item exists in inventory
    const invIndex = game.inventory.findIndex(i => i && i.name === itemName);
    if (invIndex === -1) return;
    const invItem = game.inventory[invIndex];

    // If slot is occupied, unequip first
    if (game.autoEatSlot) {
        // If same item, just stack it
        if (game.autoEatSlot.name === itemName) {
            game.autoEatSlot.qty += invItem.qty;
            game.inventory[invIndex] = null;
            renderInventoryGrid();
            renderAutoEatSlot();
            game.isDirty = true;
            return;
        } else {
            // Swap: Return current to inv
            addItem(game.autoEatSlot.name, game.autoEatSlot.qty);
            game.autoEatSlot = null;
        }
    }

    // Move to slot
    game.autoEatSlot = { name: invItem.name, qty: invItem.qty };
    game.inventory[invIndex] = null;
    
    renderInventoryGrid();
    renderAutoEatSlot();
    playGlobalSound('sounds/soundeffects/itemequipsoundeffect.mp3');
    game.isDirty = true;
}

async function buyAutoEat() {
    const cost = 200000;
    const confirmed = await showGameConfirm("Unlock Auto-Heal", `Would you like to unlock the Auto-Potion slot for ${cost.toLocaleString()} Gold?`);

    if (confirmed) {
        if (game.gold >= cost) {
            addGold(-cost);
            game.autoEatUnlocked = true;
            playGlobalSound('sounds/soundeffects/levelupsound.mp3');
            renderAutoEatSlot();
            game.isDirty = true;
            await showGameAlert("Unlocked!", "The Auto-Heal slot is now available. Equip Vitality Potions from your inventory to use it.");
        } else {
            await showGameAlert("Insufficient Gold", `You need ${cost.toLocaleString()} Gold to unlock this slot.`);
        }
    }
}

function unequipAutoEat() {
    if (!game.autoEatSlot) return;
    
    // Check if we can receive the item BEFORE adding it
    if (canReceiveItem(game.autoEatSlot.name)) {
        // 1. Add to inventory
        addItem(game.autoEatSlot.name, game.autoEatSlot.qty);
        
        // 2. Clear the slot (This was being skipped before!)
        game.autoEatSlot = null;
        
        // 3. Update UI & Save
        renderAutoEatSlot();
        renderInventoryGrid();
        hideTooltip();
        game.isDirty = true;
    } else {
        showGameAlert("Inventory Full", "No space to unequip food.");
    }
}

function triggerAutoEat() {
    if (!game.autoEatSlot || game.hp <= 0) return false;

    // Check for 1 second (1000ms) cooldown
    const now = Date.now();
    if (now - (game.lastAutoHealTime || 0) < 1000) {
        return false; 
    }

    // Only handle Vitality Potions
    if (game.autoEatSlot.name === 'Vitality Potion') {
        const heal = 10;
        game.hp = Math.min(game.maxHP, game.hp + heal);
        
        game.autoEatSlot.qty--;
        addItem('Empty Vial', 1); // Return the bottle

        if (game.autoEatSlot.qty <= 0) {
            game.autoEatSlot = null;
        }

        game.lastAutoHealTime = now; // Update the cooldown timer
        updateHPUI();
        renderAutoEatSlot();
        playGlobalSound('sounds/soundeffects/wellsoundeffect.mp3');
        return true; 
    }
    
    return false; 
}


function renderInventoryGrid(){
  const grid = document.getElementById('inventoryGrid');
  grid.innerHTML = '';
  const capacity = game.inventoryCapacity;

  for(let i = 0; i < capacity; i++){
    const slotData = game.inventory[i];
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    slot.dataset.slotIndex = i;
    
    if(slotData){
      slot.draggable = true;
      const item = slotData;
      const img = document.createElement('img');
              let imgName = item.name.toLowerCase().replace(/\s+/g,'_');
              if (item.name === 'Copper Bar') imgName = 'copperbar';
              else if (item.name === 'Copper Chestplate') imgName = 'copperchestplate';
              else if (item.name === 'Silver Ore') imgName = 'silverore';
              else if (item.name === 'Gold Ore') imgName = 'goldore';
              else if (item.name === 'Copper Shortsword') imgName = 'coppershortsword';
              else if (item.name === 'Copper Helmet') imgName = 'copperhelmet';
              else if (item.name === 'Copper Boots') imgName = 'copperboots';
              else if (item.name === 'Raw Chicken') imgName = 'rawchicken';
              else if (item.name === 'Cooked Chicken') imgName = 'cookedchicken';
              else if (item.name === 'Burnt Chicken') imgName = 'burntchicken';
              else if (item.name === 'Cooked Herring') imgName = 'cookedherring';
              else if (item.name === 'Burnt Herring') imgName = 'burntherring';
              else if (item.name === 'Cooked Trout') imgName = 'cookedtrout';
              else if (item.name === 'Burnt Trout') imgName = 'burnttrout';
              else if (item.name === 'Cooked Salmon') imgName = 'cookedsalmon';
              else if (item.name === 'Burnt Salmon') imgName = 'burntsalmon';
              else if (item.name === 'Beef') imgName = 'beef';
              else if (item.name === 'Cooked Beef') imgName = 'cookedbeef';
              else if (item.name === 'Burnt Beef') imgName = 'burntbeef';
              else if (item.name === 'Gold Crown') imgName = 'goldcrown'; 
              else if (item.name === 'Elegant Black Cape') imgName = 'elegantblackcape';
              else if (item.name === 'Coal Ore') imgName = 'coalore';
              else if (item.name === 'Iron Ore') imgName = 'ironore';
              else if (item.name === 'Iron Bar') imgName = 'ironbar';
              else if (item.name === 'Silver Bar') imgName = 'silverbar';
              else if (item.name === 'Gold Bar') imgName = 'goldbar';
              else if (item.name === 'Iron Helmet') imgName = 'ironhelmet';
              else if (item.name === 'Iron Chestplate') imgName = 'ironchestplate';
              else if (item.name === 'Iron Boots') imgName = 'ironboots';
              else if (item.name === 'Iron Shortsword') imgName = 'ironshortsword';
              else if (item.name === 'Copper Platelegs') imgName = 'copperplatelegs';
              else if (item.name === 'Iron Platelegs') imgName = 'ironplatelegs';
              else if (item.name === 'Softwood') imgName = 'softwood';
              else if (item.name === 'Oak') imgName = 'oak';
              else if (item.name === 'Bronze Pickaxe') imgName = 'bronzepickaxe';
              else if (item.name === 'Bronze Axe') imgName = 'bronzeaxe';
              else if (item.name === 'Copper Pickaxe') imgName = 'copperpickaxe';
              else if (item.name === 'Copper Axe') imgName = 'copperaxe';
              else if (item.name === 'Iron Pickaxe') imgName = 'ironpickaxe';
              else if (item.name === 'Iron Axe') imgName = 'ironaxe';
              else if (item.name === 'Silver Pickaxe') imgName = 'silverpickaxe';
              else if (item.name === 'Silver Axe') imgName = 'silveraxe';
              else if (item.name === 'Feather') imgName = 'feather';
              else if (item.name === 'Arrow Shaft') imgName = 'arrowshaft';
              else if (item.name === 'Copper Arrow Tip') imgName = 'copperarrowtip';
              else if (item.name === 'Unbound Arrow') imgName = 'unboundarrow';
              else if (item.name === 'Copper Arrow') imgName = 'copperarrow';
              else if (item.name === 'Silk') imgName = 'silk';
              else if (item.name === 'Cloth') imgName = 'cloth';
              else if (item.name === 'Wizard Hat') imgName = 'wizardhat';
              else if (item.name === 'Wizard Robe') imgName = 'wizardrobe';
              else if (item.name === 'Wizard Trousers') imgName = 'wizardtrousers';
              else if (item.name === 'Wizard Boots') imgName = 'wizardboots';
              else if (item.name === 'Magic Staff') imgName = 'magicstaff';
              else if (item.name === 'Pet Spider Egg') imgName = 'petegg1';
              else if (item.name === 'Rat Tail') imgName = 'rattail';
              else if (item.name === 'Sand') imgName = 'sand';
              else if (item.name === 'Empty Vial') imgName = 'emptyvial';
              else if (item.name === 'Venom') imgName = 'venom';
              else if (item.name === 'Lottery Ticket') imgName = 'lotteryticket';
              else if (item.name === 'Earth Crystal Shard') imgName = 'earthcrystalshard';
              else if (item.name === 'Air Crystal Shard') imgName = 'aircrystalshard';
              else if (item.name === 'Water Crystal Shard') imgName = 'watercrystalshard';
              else if (item.name === 'Bow String') imgName = 'bowstring';
              else if (item.name === 'Unstrung Softwood Bow') imgName = 'unstrungsoftwoodbow';
              else if (item.name === 'Unstrung Oak Bow') imgName = 'unstrungoakbow';
              else if (item.name === 'Softwood Bow') imgName = 'softwoodbow';
              else if (item.name === 'Oak Bow') imgName = 'oakbow';
              else if (item.name === 'Cow Hide') imgName = 'cowhide';
              else if (item.name === 'Leather') imgName = 'leather';
              else if (item.name === 'Leather Hood') imgName = 'leatherhood';
              else if (item.name === 'Leather Body') imgName = 'leatherarmor';
              else if (item.name === 'Leather Chaps') imgName = 'leatherpants';
              else if (item.name === 'Leather Boots') imgName = 'leatherboots';
              else if (item.name === 'Herring') imgName = 'herring';
              else if (item.name === 'Trout') imgName = 'trout';
              else if (item.name === 'Salmon') imgName = 'salmon';
              else if (item.name === 'Fishing Pole') imgName = 'fishingpole';
              else if (item.name === 'Fishing Bait') imgName = 'fishingbait';
              else if (item.name === 'Empty Bucket') imgName = 'emptybucket';
              else if (item.name === 'Bucket of Milk') imgName = 'bucketofmilk';
              else if (item.name === 'Bucket of Water') imgName = 'bucketofwater';
              else if (item.name === 'Grass Seed') imgName = 'grassseed';
              else if (item.name === 'Grass') imgName = 'grass';
              else if (item.name === 'Corn Seed') imgName = 'cornseed';
              else if (item.name === 'Corn') imgName = 'corn';
              else if (item.name === 'Dirt Shroom') imgName = 'dirtshroom';
              else if (item.name === 'Wild Herb') imgName = 'wildherb';
              else if (item.name === 'Vitality Potion') imgName = 'vitalitypotion';
              else if (item.name === 'Uncut Topaz') imgName = 'uncuttopaz';
              else if (item.name === 'Uncut Diamond') imgName = 'uncutdiamond';
              else if (item.name === 'Uncut Emerald') imgName = 'uncutemerald';
              else if (item.name === 'Uncut Jade') imgName = 'uncutjade';
              else if (item.name === 'Uncut Ruby') imgName = 'uncutruby';
              else if (item.name === 'Uncut Sapphire') imgName = 'uncutsapphire';
              else if (item.name === 'Topaz') imgName = 'topaz';
              else if (item.name === 'Diamond') imgName = 'diamond';
              else if (item.name === 'Emerald') imgName = 'emerald';
              else if (item.name === 'Jade') imgName = 'jade';
              else if (item.name === 'Ruby') imgName = 'ruby';
              else if (item.name === 'Sapphire') imgName = 'sapphire';
              else if (item.name === 'Gold Ring') imgName = 'goldring';
              else if (item.name === 'Diamond Ring') imgName = 'diamondring';
              else if (item.name === 'Emerald Ring') imgName = 'emeraldring';
              else if (item.name === 'Ruby Ring') imgName = 'rubyring';
              else if (item.name === 'Sapphire Ring') imgName = 'sapphirering';
              else if (item.name === 'Topaz Ring') imgName = 'topazring';
              else if (item.name === 'Silver Fangs of the Fallen Monarch') imgName = 'silverfangsofthefallenmonarch';

      img.src = `images/${imgName}.png`;
      img.alt = item.name;
      
      const eLvl = item.enchantLevel || 0;
      if (item.name === 'Gold Crown' || item.name === 'Elegant Black Cape') {
          slot.classList.add('legendary-glow');
      } else if (eLvl > 0) {
          slot.classList.add(`enchant-glow-${eLvl}`);
      }

      if (eLvl > 0) {
          const badge = document.createElement('div');
          badge.className = 'enchant-level-badge';
          badge.innerText = `+${eLvl}`;
          slot.appendChild(badge);
      }

      if (item.name === 'Diamond' || item.name === 'Uncut Diamond') {
          img.style.transform = 'scale(0.93)';
      }
      img.onerror = function(){ this.style.opacity='0.08'; this.style.filter='grayscale(90%)'; };
      slot.appendChild(img);
      
      const amt = document.createElement('div');
      amt.className = 'inv-amount';
      amt.innerText = formatAmount(item.qty); 
      slot.appendChild(amt);
      
      const itemName = item.name;
      const stats = ITEM_STATS[itemName];
      let itemStats = '';
      let clickAction = '';

      if (stats) {
        const enchantLvl = item.enchantLevel || 0;
        const stdB = enchantLvl;
        const penB = Math.floor(enchantLvl / 2);

        if (stats.meleeStr) itemStats += `<div style="color:#ff4d4d;">+${stats.meleeStr + stdB} Melee Strength</div>`;
        if (stats.rangedStr) itemStats += `<div style="color:#44aa44;">+${stats.rangedStr + stdB} Ranged Strength</div>`;
        if (stats.magicDmg) itemStats += `<div style="color:#4da6ff;">+${stats.magicDmg + stdB} Magic Damage</div>`;
        
        // Define which bonus to use per stat based on armor type
        let mBonus = stdB, rBonus = stdB, magBonus = stdB;
        if (stats.armorType === 'melee') magBonus = penB;
        else if (stats.armorType === 'ranged' || stats.armorType === 'magic') mBonus = penB;

        if (stats.meleeDef !== undefined) itemStats += `<div style="color:#e38a42;">+${stats.meleeDef + mBonus} Melee Def</div>`;
        if (stats.rangedDef !== undefined) itemStats += `<div style="color:#aaffaa;">+${stats.rangedDef + rBonus} Ranged Def</div>`;
        if (stats.magicDef !== undefined) itemStats += `<div style="color:#6dafff;">+${stats.magicDef + magBonus} Magic Def</div>`;

        if (stats.maxHPBonus) itemStats += `<div style="color:#ffaaaa;">+${stats.maxHPBonus + stdB} Max HP</div>`;
        // --- ADDED SPEED DISPLAY ---
        if (stats.speed) itemStats += `<div style="color:var(--gold);">Speed: ${(stats.speed / 1000).toFixed(1)}s</div>`;
        
        clickAction = '<div style="color:#aaa; margin-top: 5px; font-size:11px;">Click to equip</div>';
      } else if (itemName.includes('Cooked')) {
        // Consumables logic
        let healAmt = 0;
        if (itemName === 'Cooked Chicken') healAmt = COOK_CHICKEN_HEAL;
        else if (itemName === 'Cooked Beef') healAmt = COOK_BEEF_HEAL;
        else if (itemName === 'Cooked Herring') healAmt = COOK_HERRING_HEAL;
        else if (itemName === 'Cooked Trout') healAmt = COOK_TROUT_HEAL;
        else if (itemName === 'Cooked Salmon') healAmt = COOK_SALMON_HEAL;
        
        itemStats = `<div style="color:#aaffaa;">+${healAmt} HP</div>`;
        clickAction = '<div style="color:#aaffaa; margin-top: 5px; font-size:11px;">Click to eat</div>';
      } else if (itemName === 'Vitality Potion') {
        itemStats = `<div style="color:#aaffaa;">+10 HP</div>`;
        clickAction = '<div style="color:#aaffaa; margin-top: 5px; font-size:11px;">Click to drink</div>';
      }

      const tooltipContent = `
        <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${itemName} ${item.enchantLevel > 0 ? '+' + item.enchantLevel : ''}</div>
        <div style="color:#fff; font-size:12px;">Amount: ${item.qty.toLocaleString()}</div>
        ${itemStats}
        ${clickAction}
      `;

      slot.onmouseenter = (evt) => showTooltip(evt, tooltipContent);
      slot.onmouseleave = () => hideTooltip();
      
      const itemQty = item.qty; 
      const slotIndex = i; 
      slot.onclick = (event) => handleItemClick(event, itemName, itemQty, slotIndex);
    } else {
      slot.draggable = false;
    }
    grid.appendChild(slot);
  }
}

// =================================================================
// --- 1. REPLACED 'addItem' FUNCTION (non-module script) ---
// This function now correctly handles multiple stacks.
// =================================================================
// =================================================================
// --- 6. Inventory Logic (Stacking & Enchanting) ---
// =================================================================

function addItem(name, qty = 1, enchantLevel = 0) {
  game.isDirty = true;
  let amountToAdd = qty;

  // 1. Try to stack in existing slots first 
  // IMPORTANT: Items only stack if Name AND Enchant Level match exactly
  for (const slot of game.inventory) {
    if (slot && slot.name === name && (slot.enchantLevel || 0) === enchantLevel) {
      slot.qty += amountToAdd;
      amountToAdd = 0;
      break; 
    }
  }

  // 2. If items are left, find an empty slot
  if (amountToAdd > 0) {
    let emptySlotIndex = game.inventory.findIndex(slot => slot === null);
    if (emptySlotIndex > -1) {
      game.inventory[emptySlotIndex] = { 
        name: name, 
        qty: amountToAdd, 
        enchantLevel: enchantLevel 
      };
      amountToAdd = 0;
    } else {
      console.warn(`Inventory full! Could not add ${amountToAdd} ${name}`);
    }
  }

  // Always render to ensure UI is in sync
  renderInventoryGrid();
}

function removeItem(name, qty = 1, enchantLevel = 0) {
  game.isDirty = true;
  let amountToRemove = qty;
  let totalAvailable = 0;

  // Ensure enchantLevel is treated as a number
  const targetEnchant = Number(enchantLevel || 0);

  // 1. Check availability
  for (const slot of game.inventory) {
    if (slot && slot.name === name && Number(slot.enchantLevel || 0) === targetEnchant) {
      totalAvailable += slot.qty;
    }
  }

  if (totalAvailable < amountToRemove) return false; 

  // 2. Remove items
  for (let i = game.inventory.length - 1; i >= 0; i--) {
    const slot = game.inventory[i];
    if (slot && slot.name === name && Number(slot.enchantLevel || 0) === targetEnchant) {
      if (slot.qty > amountToRemove) {
        slot.qty -= amountToRemove;
        amountToRemove = 0;
      } else {
        amountToRemove -= slot.qty;
        game.inventory[i] = null; 
      }
    }
    if (amountToRemove === 0) break;
  }
  
  renderInventoryGrid();
  return true; 
}

function canReceiveItem(itemName, enchantLevel = 0) {
  let hasEmptySlot = false;
  let hasStack = false;

  for (const slot of game.inventory) {
    if (slot === null) {
      hasEmptySlot = true;
      break; 
    }
    // Stacks only if the enchant level matches
    if (slot.name === itemName && (slot.enchantLevel || 0) === enchantLevel) {
      hasStack = true;
      break; 
    }
  }
  return hasEmptySlot || hasStack;
}
// =================================================================
// --- END OF REPLACEMENTS IN THIS SCRIPT BLOCK ---
// =================================================================

async function handleSellItemClick(slotIndex) {
  if (!game.shopOpen) return;
  
  const item = game.inventory[slotIndex];
  if (!item) return;

  const itemName = item.name;
  const enchant = item.enchantLevel || 0;
  
  let baseSellPrice = ITEM_SELL_PRICES[itemName] || 0;

  if (baseSellPrice <= 0) {
    await showGameAlert("Cannot Sell", "This shop doesn't buy that item.");
    return;
  }

  // --- NEW SCALING PRICE LOGIC ---
  // 1. Get the total gold it cost to reach this enchant level
  const totalInvestment = getCumulativeEnchantInvestment(itemName, enchant);
  
  // 2. New Price = Base Price + (50% of the gold spent on enchanting)
  const pricePerItem = Math.floor(baseSellPrice + (totalInvestment / 2));
  
  // 3. Determine Quantity
  let qtyToSell = 0;
  if (item.qty === 1) {
    qtyToSell = 1;
  } else {
    const input = await showGamePrompt(
      `Sell ${itemName} ${enchant > 0 ? '+' + enchant : ''}`, 
      `How many? (Stack: ${item.qty}) (Price: ${pricePerItem.toLocaleString()}ea)`, 
      item.qty
    );
    if (input === null) return;
    qtyToSell = parseInt(input);
  }

  if (isNaN(qtyToSell) || qtyToSell <= 0 || qtyToSell > item.qty) return;
  
  const totalGold = qtyToSell * pricePerItem;
  
  const confirmed = await showGameConfirm(
    "Confirm Sale", 
    `Sell ${qtyToSell}x ${itemName} ${enchant > 0 ? '+' + enchant : ''} for ${totalGold.toLocaleString()} Gold?`
  );
  
  if (confirmed) {
    if (removeItem(itemName, qtyToSell, enchant)) {
        addGold(totalGold);
        hideTooltip(); 
        renderInventoryGrid();
        if (document.getElementById('hubBank').classList.contains('active')) renderBankGrid();
        
        await showGameAlert("Sale Complete", `You received ${totalGold.toLocaleString()} Gold.`);
        game.isDirty = true;
    } else {
        await showGameAlert("Error", "Something went wrong, the sale did not complete.");
    }
  }
}

function handleItemClick(event, itemName, itemQty, slotIndex) {
  hideItemContextMenu();

  if (document.getElementById('hubEnchanting').classList.contains('active')) {
      const itemData = game.inventory[slotIndex];
      if (handleEnchantItemClick(itemData, slotIndex)) return;
  }

  const equipableItems = {
    'Copper Helmet': 'helmet', 'Copper Chestplate': 'chest', 'Copper Shortsword': 'weapon', 'Copper Boots': 'boots',
    'Iron Helmet': 'helmet', 'Iron Chestplate': 'chest', 'Iron Shortsword': 'weapon', 'Iron Boots': 'boots',
    'Copper Platelegs': 'legs', 'Iron Platelegs': 'legs', 'Softwood Bow': 'weapon', 'Oak Bow': 'weapon',
    'Copper Arrow': 'arrows', 'Leather Hood': 'helmet', 'Leather Body': 'chest', 'Leather Chaps': 'legs',
    'Leather Boots': 'boots', 'Wizard Hat': 'helmet', 'Wizard Robe': 'chest', 'Wizard Trousers': 'legs',
    'Wizard Boots': 'boots', 'Magic Staff': 'weapon', 'Gold Crown': 'helmet', 'Elegant Black Cape': 'cape',
    '1tapper': 'weapon', 'Gold Ring': 'ring_choice', 'Diamond Ring': 'ring_choice', 'Emerald Ring': 'ring_choice',
    'Ruby Ring': 'ring_choice', 'Sapphire Ring': 'ring_choice', 'Topaz Ring': 'ring_choice',
    'Silver Fangs of the Fallen Monarch': 'weapon'
  };
  const itemSlotType = equipableItems[itemName];

  if (game.shopOpen) {
    // Pass the slotIndex so the shop knows exactly which item (and enchant level) you are selling
    handleSellItemClick(slotIndex);
  } else if (itemSlotType) {
    equipItem(itemSlotType, slotIndex);
  } else if (itemName.includes('Cooked') || itemName === 'Vitality Potion') {
    showItemContextMenu(event, itemName);
  }
}

// NEW: Shows the right-click-style menu
function showItemContextMenu(event, itemName) {
  const menu = document.getElementById('itemContextMenu');
  let menuContent = '';

  if (itemName === 'Cooked Chicken') {
    menuContent += `<button class="context-menu-btn" onclick="eatCookedChicken()">Eat</button>`;
  } else if (itemName === 'Cooked Beef') {
    menuContent += `<button class="context-menu-btn" onclick="eatCookedBeef()">Eat</button>`;
  } else if (itemName === 'Cooked Herring') {
    menuContent += `<button class="context-menu-btn" onclick="eatCookedHerring()">Eat</button>`;
  } else if (itemName === 'Cooked Trout') {
    menuContent += `<button class="context-menu-btn" onclick="eatCookedTrout()">Eat</button>`;
  } else if (itemName === 'Cooked Salmon') {
    menuContent += `<button class="context-menu-btn" onclick="eatCookedSalmon()">Eat</button>`;
  } else if (itemName === 'Vitality Potion') {
    menuContent += `<button class="context-menu-btn" onclick="drinkVitalityPotion()">Drink</button>`;
    menuContent += `<button class="context-menu-btn" onclick="equipToAutoEat('Vitality Potion')">Equip Auto-Heal</button>`;
  }
  
  // We can add other options here later (e.g., "Drop")
  
  if (menuContent) {
    menu.innerHTML = menuContent;
    menu.style.display = 'block';
    
    // Position menu near the cursor
    const rect = document.body.getBoundingClientRect();
    menu.style.left = (event.clientX - rect.left + 5) + 'px';
    menu.style.top = (event.clientY - rect.top + 5) + 'px';

    // Add a one-time listener to close the menu
    // Use setTimeout to skip this current click event
    setTimeout(() => {
      document.addEventListener('click', hideItemContextMenu, { once: true });
    }, 0);
  }
}

// NEW: Hides the item context menu
function hideItemContextMenu() {
  const menu = document.getElementById('itemContextMenu');
  if (menu) menu.style.display = 'none';
  // Remove the listener just in case (though {once: true} should handle it)
  document.removeEventListener('click', hideItemContextMenu);
}

// NEW: The logic for eating the chicken
async function eatCookedChicken() {
  hideItemContextMenu(); // Close the menu

  // Check if HP is full
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }

  // Try to remove the item. If successful, heal the player.
  if (removeItem('Cooked Chicken', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + COOK_CHICKEN_HEAL); // <-- Use constant
    updateHPUI();
    
    // --- NEW FIX: Re-render inventory and save ---
    renderInventoryGrid();
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
    // --- END FIX ---

  } else {
    console.warn('Tried to eat Cooked Chicken, but removeItem failed.');
  }
}

// +++ NEW: Logic for eating Beef +++
async function eatCookedBeef() {
  hideItemContextMenu(); 
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }
  if (removeItem('Cooked Beef', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + COOK_BEEF_HEAL);
    updateHPUI();
    renderInventoryGrid();
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
  } else {
    console.warn('Tried to eat Cooked Beef, but removeItem failed.');
  }
}

// +++ NEW: Logic for eating Herring +++
async function eatCookedHerring() {
  hideItemContextMenu(); 
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }
  if (removeItem('Cooked Herring', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + COOK_HERRING_HEAL);
    updateHPUI();
    renderInventoryGrid();
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
  } else {
    console.warn('Tried to eat Cooked Herring, but removeItem failed.');
  }
}

// +++ NEW: Logic for eating Trout +++
async function eatCookedTrout() {
  hideItemContextMenu(); 
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }
  if (removeItem('Cooked Trout', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + COOK_TROUT_HEAL);
    updateHPUI();
    renderInventoryGrid();
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
  } else {
    console.warn('Tried to eat Cooked Trout, but removeItem failed.');
  }
}

// +++ NEW: Logic for eating Salmon +++
async function eatCookedSalmon() {
  hideItemContextMenu(); 
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }
  if (removeItem('Cooked Salmon', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + COOK_SALMON_HEAL);
    updateHPUI();
    renderInventoryGrid();
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
  } else {
    console.warn('Tried to eat Cooked Salmon, but removeItem failed.');
  }
}

// +++ NEW: DRINK VITALITY POTION +++
async function drinkVitalityPotion() {
  hideItemContextMenu(); 
  if (game.hp >= game.maxHP) {
    await showGameAlert("HP Full", "Your HP is already full.");
    return;
  }
  if (removeItem('Vitality Potion', 1)) {
    game.hp = Math.min(game.maxHP, game.hp + 10); // Heals 10 HP
    addItem('Empty Vial', 1); // +++ NEW: GIVE VIAL BACK +++
    updateHPUI();
    renderInventoryGrid();
    playGlobalSound('sounds/soundeffects/wellsoundeffect.mp3'); 
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
  }
}

/**
 * Equips an item from the inventory.
 * @param {string} slotType - The type of slot ('helmet', 'chest', 'weapon', 'boots')
 * @param {number} fromInvIndex - The inventory index the item is coming from
 */
/**
 * Equips an item from the inventory.
 * @param {string} slotType - The type of slot ('helmet', 'chest', 'weapon', 'boots')
 * @param {number} fromInvIndex - The inventory index the item is coming from
 */
async function equipItem(slotType, fromInvIndex) {
  const itemStack = game.inventory[fromInvIndex];
  if (!itemStack) return;

  if (slotType === 'ring_choice') {
    if (!game.equipment.ring1) {
      slotType = 'ring1';
    } else if (!game.equipment.ring2) {
      slotType = 'ring2';
    } else {
      const choice = await _createModal("Equip Ring", "<p>Which ring slot would you like to replace?</p>", [
        { text: "Ring Slot 1", value: "ring1", class: "primary" },
        { text: "Ring Slot 2", value: "ring2", class: "primary" },
        { text: "Cancel", value: null, class: "primary", style: "#666" }
      ]);
      if (choice === null) return;
      slotType = choice;
    }
  }

  const stats = ITEM_STATS[itemStack.name];
  const isTwoHanded = stats && stats.twoHanded;

  if (slotType === 'weapon') {
    if (itemStack.name === 'Magic Staff') setAttackStyle('magic', true);
    else if (game.equipment.weapon && game.equipment.weapon.name === 'Magic Staff') setAttackStyle('strength', true);
  }

  if (slotType === 'weapon' && isTwoHanded && game.equipment.shield) {
      const success = await unequipItem('shield');
      if (!success) return;
  }
  
  if (slotType === 'shield' && game.equipment.weapon && ITEM_STATS[game.equipment.weapon.name]?.twoHanded) {
       const success = await unequipItem('weapon');
       if (!success) return;
  }

  const itemBeingWorn = game.equipment[slotType];

  if (slotType === 'arrows') {
    if (itemBeingWorn && itemBeingWorn.name === itemStack.name) {
      game.equipment[slotType].qty += itemStack.qty;
      game.inventory[fromInvIndex] = null;
    } else {
      game.equipment[slotType] = { ...itemStack }; // Copy whole object
      game.inventory[fromInvIndex] = itemBeingWorn;
    }
  } else {
    // Check if we can safely unequip existing item
    if (itemBeingWorn && itemStack.qty > 1) {
      const hasRoom = game.inventory.some(s => s === null || (s.name === itemBeingWorn.name && (s.enchantLevel || 0) === (itemBeingWorn.enchantLevel || 0)));
      if (!hasRoom) {
        await showGameAlert("Inventory Full", "No room to swap equipment.");
        return;
      }
    }

    // EQUIP NEW ITEM (Maintaining Enchantment)
    const newItem = { 
      name: itemStack.name, 
      qty: 1, 
      enchantLevel: itemStack.enchantLevel || 0 
    };
    
    game.equipment[slotType] = newItem;
    itemStack.qty -= 1;

    if (itemStack.qty <= 0) {
      game.inventory[fromInvIndex] = itemBeingWorn;
    } else if (itemBeingWorn) {
      // Put old item back using the fixed addItem logic
      addItem(itemBeingWorn.name, 1, itemBeingWorn.enchantLevel || 0);
    }
  }
  
  updateHPUI();
  renderEquipment(); 
  renderInventoryGrid();
  hideTooltip();
  playGlobalSound('sounds/soundeffects/itemequipsoundeffect.mp3');
  game.isDirty = true;
}

/**
 * Unequips an item from the equipment slot.
 * @param {string} slotType - The type of slot ('helmet', 'chest', 'weapon', 'boots')
 */
/**
 * Unequips an item from the equipment slot.
 * @param {string} slotType - The type of slot ('helmet', 'chest', 'weapon', 'boots')
 */
async function unequipItem(slotType) {
  if (slotType === 'pet') return false;

  const item = game.equipment[slotType];
  if (!item) return true;

  // Check room using our logic: can it stack or is there an empty slot?
  const hasRoom = game.inventory.some(s => s === null || (s.name === item.name && (s.enchantLevel || 0) === (item.enchantLevel || 0)));
  
  if (!hasRoom) {
    await showGameAlert("Inventory Full", "Your inventory is full.");
    return false;
  }

  // Use the fixed addItem function to handle stacking vs new slot automatically
  addItem(item.name, item.qty, item.enchantLevel || 0);

  if (slotType === 'weapon' && item.name === 'Magic Staff') {
    setAttackStyle('strength', true);
    if (typeof renderSpellsPanel === 'function') renderSpellsPanel();
  }
  
  game.equipment[slotType] = null; 
  
  updateHPUI();
  renderEquipment(); 
  renderInventoryGrid();
  hideTooltip();
  playGlobalSound('sounds/soundeffects/itemequipsoundeffect.mp3');
  game.isDirty = true;
  
  return true;
}

const tooltip = document.getElementById('tooltip');

function showTooltip(evt, content) {
  // +++ FIX: Strictly prevent tooltip if dragging +++
  if (!tooltip || game.isDragging) return; 
  
  tooltip.innerHTML = content;
  tooltip.style.display = 'block';
  moveTooltip(evt);
}

let tooltipInterval = null; // Global variable for tooltip timer

function hideTooltip() {
  // Stop any active tooltip updates
  if (tooltipInterval) {
    clearInterval(tooltipInterval);
    tooltipInterval = null;
  }
  if (!tooltip) return;
  tooltip.style.display = 'none';
}

function moveTooltip(evt) {
  // +++ FIX: Ensure it stays hidden if dragging +++
  if (!tooltip || tooltip.style.display === 'none' || game.isDragging) {
      if (tooltip && game.isDragging) tooltip.style.display = 'none';
      return;
  }

  const tooltipRect = tooltip.getBoundingClientRect();
  let x = evt.clientX + 10;
  let y = evt.clientY + 10;
  
  if (x + tooltipRect.width > window.innerWidth) {
    x = evt.clientX - tooltipRect.width - 10;
  }
  if (y + tooltipRect.height > window.innerHeight) {
    y = evt.clientY - tooltipRect.height - 10;
  }
  
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function getNextXP(level){
    // level is the CURRENT level (1-100)
    
    // Safety check for levels beyond the table
    if (level >= XP_TABLE.length) {
        return 0; 
    }

    // XP_TABLE[level] holds the total XP for level + 1
    const xpNeededForNextLevel = XP_TABLE[level]; 
    
    // XP_TABLE[level - 1] holds the total XP for the current level
    const xpAlreadyGained = XP_TABLE[level - 1] || 0; 

    return xpNeededForNextLevel - xpAlreadyGained;
}

function getTotalXPForLevel(level) {
    // level is the level we want the *cumulative* XP for (1-100)

    // The XP_TABLE is 0-indexed: Lvl 1 total XP is at index 0.
    const index = Math.min(level - 1, XP_TABLE.length - 1);

    return XP_TABLE[index] || 0;
}

// +++ NEW MAGIC SPELL FUNCTIONS +++

/**
 * Calculates the spell's damage based on player level and equipment.
 */
function getSpellStats(spell) {
    const magicLevel = game.magic.level;
    
    // Get actual equipped magic damage (which is now just +1 from the staff)
    const playerStats = getPlayerCombatStats();
    const equipmentMagicDamage = playerStats.equipmentMagicDamage || 0;

    // Formula: (Magic Level / 4) + Equipment Bonus (+1) + Spell Bonus (+2/3/4)
    const baseMaxHit = 1 + Math.floor(magicLevel / 4);
    const maxHit = baseMaxHit + equipmentMagicDamage + spell.damage;
    
    return {
        maxHit: Math.max(1, maxHit),
        xp: spell.xp 
    };
}

/**
 * Opens the Spells modal/panel
 */
function openSpells() {
  const panel = document.getElementById('spellsPanel');
  if (panel) {
    renderSpellsPanel(); // Render content before showing
    panel.style.visibility = (panel.style.visibility === 'visible') ? 'hidden' : 'visible';
  }
}

/**
 * Renders the spell icons in the spell panel.
 */
function renderSpellsPanel() {
    const container = document.getElementById('spellsIconsContainer');
    const autocastTextEl = document.getElementById('autocastText');
    if (!container || !autocastTextEl) return;
    
    container.innerHTML = '';
    const magicLvl = game.magic.level;

    SPELL_LIST.forEach(spell => {
        const isLocked = magicLvl < spell.level;
        const isActive = game.autocastSpell === spell.name;
        const iconWrapper = document.createElement('button');
        
        iconWrapper.id = `spell-btn-${spell.name.replace(/\s+/g, '')}`;
        iconWrapper.className = `primary ${isLocked ? 'locked-item' : ''}`;
        iconWrapper.style.cssText = `
            width: 50px; 
            height: 50px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0;
            border: 2px solid ${isActive ? 'var(--gold)' : 'var(--accent)'}; /* Highlight active spell */
            box-shadow: ${isActive ? '0 0 10px var(--gold)' : 'none'};
            transition: all 0.15s ease;
        `;

        // Tooltip Content
        const stats = getSpellStats(spell);
        const tooltipContent = `
            <div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">${spell.name}</div>
            ${isLocked ? `<div style="color:#ff8888;">Requires Magic Lvl: ${spell.level}</div>` : `
                <div style="color:#aaffaa;">${spell.damage} Magic Damage</div>
                <div style="color:#fff;">Requires Magic Lvl: ${spell.level}</div>
                <div style="color:#ffaaaa; margin-top: 5px;">Right-click for Autocast...</div>
            `}
        `;

        // Image
        const img = document.createElement('img');
        const imgName = spell.name.toLowerCase().replace(/\s+/g, '');
        img.src = `images/${imgName}.jpeg`;
        img.alt = spell.name;
        img.style.cssText = 'width: 100%; height: 100%; object-fit: contain; pointer-events: none;';
        iconWrapper.appendChild(img);

        // Click Handlers
        if (!isLocked) {
            // Left-Click: Single cast in combat
            iconWrapper.onclick = (e) => {
                // Prevent right-click menu from showing if a spell is cast
                e.preventDefault(); 
                handleSpellClick(spell);
            };
            // Right-Click: Autocast menu
            iconWrapper.oncontextmenu = (e) => {
                e.preventDefault();
                showAutocastContextMenu(e, spell.name);
            };
        }
        
        // FIX: Tooltip handlers moved OUTSIDE the isLocked check
        iconWrapper.onmouseenter = (evt) => showTooltip(evt, tooltipContent);
        iconWrapper.onmouseleave = hideTooltip;

        container.appendChild(iconWrapper);
    });
    
    // Update footer text
    autocastTextEl.textContent = game.autocastSpell ? `Autocasting: ${game.autocastSpell}` : 'None';
    autocastTextEl.style.color = game.autocastSpell ? 'var(--gold)' : '#fff';
}

/**
 * Shows the right-click menu for autocasting spells.
 */
function showAutocastContextMenu(event, spellName) {
    const menu = document.getElementById('itemContextMenu');
    let menuContent = '';
    
    if (game.autocastSpell === spellName) {
        menuContent += `<button class="context-menu-btn" onclick="setAutocastSpell(null)">Deactivate Autocast</button>`;
    } else {
        menuContent += `<button class="context-menu-btn" onclick="setAutocastSpell('${spellName}')">Autocast</button>`;
    }

    if (menuContent) {
        menu.innerHTML = menuContent;
        menu.style.display = 'block';
        
        const rect = document.body.getBoundingClientRect();
        // FIX: Subtract 145px to show further left of the cursor
        menu.style.left = (event.clientX - rect.left - 145) + 'px';
        menu.style.top = (event.clientY - rect.top + 5) + 'px';

        setTimeout(() => {
            document.addEventListener('click', hideItemContextMenu, { once: true });
        }, 0);
    }
}

/**
 * Sets the currently active autocast spell.
 */
window.setAutocastSpell = function(spellName) {
    hideItemContextMenu();
    game.autocastSpell = spellName;
    renderSpellsPanel(); // Re-render to update border highlight
    
    // If setting autocast, and currently in combat, try to restart the attack
    if (spellName && game.inCombat) {
        restartPlayerAttackInterval();
    }

    // --- FIX: Save immediately so it persists on refresh ---
    if (typeof window.savePlayerData === 'function') {
        window.savePlayerData();
    }
}

/**
 * Handles a left-click on a spell icon.
 */
function handleSpellClick(spell) {
    if (!game.inCombat || !game.currentEnemy) return;

    // 1. Get current stats to know our attack speed
    const stats = getPlayerCombatStats();
    const now = Date.now();
    // Use the time tracking variable we just added
    const timeSinceLast = now - (game.lastAttackTime || 0);

    // 2. Check Cooldown based on Time, NOT interval existence
    if (timeSinceLast < stats.attackSpeed) {
        // Cooldown active: do nothing, just return silent.
        return; 
    }
    
    // 3. Execute the one-shot attack with the chosen spell
    playerAttackTurn(spell);

    // 4. Reset the automatic loop
    // We clear the pending "idle" check and restart it so you don't double-attack immediately
    if (game.playerCombatInterval) clearTimeout(game.playerCombatInterval);
    
    // Disable Run button briefly (visual cooldown feedback)
    const runBtn = document.getElementById('combat-run-btn');
    if (runBtn) runBtn.disabled = true;

    // Schedule the NEXT auto-turn (or idle check)
    game.playerCombatInterval = setTimeout(() => {
        // Re-enable run button when cooldown finishes
        if (runBtn) runBtn.disabled = false; 
        playerCombatLoop();
    }, stats.attackSpeed);
}

// +++ END NEW MAGIC SPELL FUNCTIONS +++


function updateSkillUI(){
  const skillsTab = document.getElementById('skillsTab');
  if (!skillsTab) return;
  
  // Clear the tab and set up the header/container
  skillsTab.innerHTML = `
    <div id="skillIconsContainer" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; justify-content: center; margin-top: 12px;">
      </div>
  `;

  const container = document.getElementById('skillIconsContainer');

  /**
   * Helper function to create a skill icon with a tooltip
   * @param {string} skillName - The display name (e.g., "Mining")
   * @param {string} skillDataKey - The key in the game object (e.g., "mining")
   * @param {string} iconFileName - The name of the icon file in /images/
   */
  const createSkillIcon = (skillName, skillDataKey, iconFileName) => {
    const data = game[skillDataKey];
    const iconWrapper = document.createElement('button');
    iconWrapper.className = ''; // <-- FIX: Removed 'primary' class
    iconWrapper.style.cssText = `
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 5px; 
      /* padding: 8px 10px; -- REMOVED */
      /* height: 80px; -- REMOVED */
      /* width: 80px; -- REMOVED */
      justify-content: center;
      font-size: 13px;
      background: transparent; /* <-- FIX: No background */
      border: none; /* <-- FIX: No border */
      cursor: pointer; /* <-- Keep this for hover/tooltip */
      transition: all 0.15s ease;
    `;
    
    // --- Create the tooltip content ---
    let progressPercent = 0;
    let xpText = "";
    let barColor = "#4caf50"; // Green

    if (data.level >= 100) {
        // +++ MAX LEVEL LOGIC +++
        progressPercent = 100;
        xpText = `XP: ${data.totalXP.toLocaleString()} (Maxed)`;
        barColor = "var(--gold)"; // Gold bar for max level
    } else {
        // Normal Logic
        const nextXP = getNextXP(data.level);
        progressPercent = Math.min(100, (data.xp / nextXP) * 100);
        xpText = `XP: ${data.xp.toLocaleString()} / ${nextXP.toLocaleString()}`;
    }
    
    const tooltipContent = `
      <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${skillName}</div>
      <div style="font-size: 14px; margin-bottom: 6px;">Level: <span style="font-weight: bold;">${data.level}</span></div>
      <div>${xpText}</div>
      ${data.level >= 100 ? '' : `<div>(Total XP: ${data.totalXP.toLocaleString()})</div>`}
      
      <div style="width: 100%; height: 8px; background: #555; border-radius: 4px; margin-top: 8px; border: 1px solid #333;">
        <div style="height: 100%; width: ${progressPercent}%; background: ${barColor}; border-radius: 4px; transition: width 0.2s;"></div>
      </div>
    `;

    // Set up hover/tooltip events
    iconWrapper.onmouseenter = (evt) => showTooltip(evt, tooltipContent);
    iconWrapper.onmouseleave = hideTooltip;

    // Create and append icon image
    const img = document.createElement('img');
    img.src = `images/${iconFileName}`;
    img.alt = skillName;
    img.style.cssText = 'width: 40px; height: 40px; object-fit: contain; margin-bottom: 2px; pointer-events: none;';
    img.onerror = function(){ this.style.opacity='0.1'; this.style.filter='grayscale(100%)'; }; // Fallback
    iconWrapper.appendChild(img);

    // Append level text
    const levelText = document.createElement('span');
    levelText.innerText = data.level; // <-- FIX: Removed "Lvl "
    levelText.style.fontWeight = 'bold';
    levelText.style.pointerEvents = 'none';
    levelText.style.color = '#fff'; // <-- THIS IS THE FIX
    iconWrapper.appendChild(levelText);

    container.appendChild(iconWrapper);
  };

  // --- Call the function for each of your skills ---
  createSkillIcon('Mining', 'mining', 'miningskillicon.png');
  createSkillIcon('Blacksmith', 'blacksmith', 'blacksmithskillicon.png');
  createSkillIcon('Attack', 'attack', 'attackskillicon.jpeg'); 
  createSkillIcon('Strength', 'strength', 'strengthskillicon.png'); 
  createSkillIcon('Defence', 'defence', 'defenseskillicon.png'); 
  createSkillIcon('Vitality', 'vitality', 'vitalityskillicon.png'); // +++ NEW VITALITY SKILL CALL +++
  createSkillIcon('Cooking', 'cooking', 'cookingskillicon.png'); // +++ NEW COOKING SKILL CALL +++
  createSkillIcon('Woodcutting', 'woodcutting', 'woodcuttingskillicon.jpeg'); // +++ NEW WOODCUTTING SKILL CALL +++
  createSkillIcon('Fletching', 'fletching', 'fletchingskillicon.jpeg'); // +++ NEW FLETCHING SKILL CALL +++
  
  // +++ NEW SKILL ICONS +++
  createSkillIcon('Crafting', 'crafting', 'craftingskillicon.png');
  createSkillIcon('Ranged', 'ranged', 'rangedskillicon.jpeg');
  
  // +++ NEW FISHING SKILL ICON +++
  createSkillIcon('Fishing', 'fishing', 'fishingskillicon.jpeg');
  
  // +++ NEW MAGIC SKILL ICON +++
  createSkillIcon('Magic', 'magic', 'magicskillicon.jpeg');
  // +++ NEW STONE FORGING ICON +++
  createSkillIcon('Stone Forging', 'stoneforging', 'stoneforgingskillicon.jpeg');
  // +++ NEW BOUNTY HUNTING ICON +++
  createSkillIcon('Bounty Hunting', 'bountyhunting', 'bountyhunterskillicon.jpeg');
  
  // +++ NEW FARMING ICON +++
  createSkillIcon('Farming', 'farming', 'farmingskillicon.jpeg');
  createSkillIcon('Pet Mastery', 'petmastery', 'petmasteryskillicon.jpeg');
  createSkillIcon('Alchemy', 'alchemy', 'alchemyskillicon.jpeg'); 
  createSkillIcon('Tailoring', 'tailoring', 'tailoringskillicon.jpeg');
  createSkillIcon('Thieving', 'thieving', 'thievingskillicon.jpeg');
}

// +++ NEW: Level Up Popup Logic +++
function showLevelUpPopup(skill, newLevel) {
hideTooltip();
  const overlay = document.getElementById('levelUpOverlay');
  const iconEl = document.getElementById('levelUpIcon');
  const skillNameEl = document.getElementById('levelUpSkillName');
  const levelValEl = document.getElementById('levelUpValue');
  
  // Map internal skill keys to the specific file names provided in updateSkillUI
  const skillIcons = {
    'mining': 'miningskillicon.png',
    'blacksmith': 'blacksmithskillicon.png',
    'attack': 'attackskillicon.jpeg',
    'strength': 'strengthskillicon.png',
    'defence': 'defenseskillicon.png',
    'vitality': 'vitalityskillicon.png',
    'cooking': 'cookingskillicon.png',
    'woodcutting': 'woodcuttingskillicon.jpeg',
    'fletching': 'fletchingskillicon.jpeg',
    'crafting': 'craftingskillicon.png',
    'ranged': 'rangedskillicon.jpeg',
    'fishing': 'fishingskillicon.jpeg',
    'magic': 'magicskillicon.jpeg',
    'stoneforging': 'stoneforgingskillicon.jpeg',
    'bountyhunting': 'bountyhunterskillicon.jpeg',
    'farming': 'farmingskillicon.jpeg',
    'petmastery': 'petmasteryskillicon.jpeg',
    'alchemy': 'alchemyskillicon.jpeg',
    'thieving': 'thievingskillicon.jpeg'
  };

  // Format Skill Name (capitalize first letter)
  const formattedName = skill.charAt(0).toUpperCase() + skill.slice(1);

  // Update DOM
  if(iconEl) iconEl.src = `images/${skillIcons[skill] || 'gearicon.png'}`;
  if(skillNameEl) skillNameEl.innerText = formattedName;
  if(levelValEl) levelValEl.innerText = newLevel;

  // Play Sound
  playGlobalSound('sounds/soundeffects/levelupsoundeffect.mp3');

  // Show Overlay with Fade Logic
  if(overlay) {
    // 1. Reset state (in case it was fading out)
    overlay.style.display = 'flex';
    
    // Force a reflow so the browser realizes display is now 'flex' before we change opacity
    void overlay.offsetWidth; 
    
    // 2. Fade In
    overlay.classList.add('visible');
    
    // Clear any existing timeout to prevent early closing logic from running twice
    if (game.levelUpTimeout) clearTimeout(game.levelUpTimeout);
    if (game.levelUpFadeTimeout) clearTimeout(game.levelUpFadeTimeout);

    // --- NEW: Helper function to close the popup ---
    const closePopup = () => {
        // Clear timers so they don't fire later if we clicked early
        if (game.levelUpTimeout) clearTimeout(game.levelUpTimeout);
        if (game.levelUpFadeTimeout) clearTimeout(game.levelUpFadeTimeout);
        
        // Start Fade Out
        overlay.classList.remove('visible');
        
        // Remove from display after transition completes (0.5s)
        game.levelUpFadeTimeout = setTimeout(() => {
            overlay.style.display = 'none';
            overlay.onclick = null; // Clean up listener
        }, 500); 
    };

    // --- NEW: Click anywhere on overlay to close ---
    overlay.onclick = (e) => {
        e.stopPropagation(); // Prevent clicking elements behind it
        closePopup();
    };
    
    // 3. Set auto-close timer (Fallback if user doesn't click)
    // 4.5 seconds visible + 0.5s fade = 5s total
    game.levelUpTimeout = setTimeout(closePopup, 4500);
  }
}



function showItemPopup(text, progressElementId, delay = 0) {
    const main = document.getElementById('mainArea');
    if (!main) return;
    const popup = document.createElement('div');
    popup.className = 'xp-popup';
    popup.innerHTML = text; // Allow HTML
popup.style.lineHeight = '1.4';
    const bar = document.getElementById(progressElementId);
    if (bar) {
        const barRect = bar.getBoundingClientRect();
        const mainRect = main.getBoundingClientRect();
        const relativeX = barRect.left - mainRect.left;
        const relativeY = barRect.top - mainRect.top;
        popup.style.left = (relativeX + barRect.width / 2 - 40) + 'px';
        popup.style.top = (relativeY - 30) + 'px';
    } else {
        popup.style.left = '50%';
        popup.style.top = '120px';
        popup.style.transform = 'translateX(-50%)';
    }
    if (delay > 0) {
    setTimeout(() => {
      main.appendChild(popup);
      setTimeout(() => popup.remove(), 850); // 850 to match splat
    }, delay);
  } else {
    main.appendChild(popup);
    setTimeout(() => popup.remove(), 850); // 850 to match splat
  }
}

// --- NEW WARNING POPUP FUNCTION ---
/**
 * Shows a short-lived warning popup in the main area.
 * @param {string} text - The warning message to display.
 */
function showWarningPopup(text) {
    const main = document.getElementById('mainArea');
    if (!main) return;
    const popup = document.createElement('div');
    popup.className = 'warning-popup';
    popup.innerHTML = text;
    
    // Position it in the top-center of the main panel
    popup.style.left = '50%';
    popup.style.top = '60px'; // A bit lower than XP popups
    popup.style.transform = 'translateX(-50%)';
    
    main.appendChild(popup);
    
    // Remove after animation (3s)
    setTimeout(() => popup.remove(), 2950);
}
// --- END NEW ---

function addXP(skill, amount, delay = 0) {
  if (!game[skill]) {
    console.warn(`Skill "${skill}" does not exist.`);
    return;
  }
  game.isDirty = true;
  game[skill].totalXP += amount;
  game[skill].xp += amount;

  let leveledUp = false;

  // Cap at level 100
  while (game[skill].level < 100 && game[skill].xp >= getNextXP(game[skill].level)) {
    game[skill].xp -= getNextXP(game[skill].level);
    game[skill].level++;
    leveledUp = true;
  }

  if (leveledUp && skill === 'vitality') {
    updateHPUI();
  }

  if (leveledUp) {
    showLevelUpPopup(skill, game[skill].level);
  }

  updateSkillUI();

  // Progress Bars
  let barId = '';
  if (skill === 'mining') barId = 'mineProgress';
  if (skill === 'blacksmith') barId = 'smithProgress';
  if (skill === 'woodcutting') barId = 'woodcutProgress';
  if (skill === 'crafting') barId = 'craftProgress';
  if (skill === 'alchemy') barId = 'brewProgress';

  // --- FIX: Exclude ALL combat skills from auto-popups ---
  // We will handle their timing manually in playerAttackTurn
  const excludedSkills = [
    'strength', 'attack', 'defence', 'vitality', 'ranged', 'magic', // Combat
    'blacksmith', 'mining', 'cooking', 'woodcutting', 'crafting', 'fletching',
    'fishing', 'stoneforging', 'farming', 'alchemy', 'thieving', 'tailoring' // Skilling loops handle these
  ];

  if (!excludedSkills.includes(skill)) {
    // --- FIX: Map compound skill names for display ---
    const skillNameMap = {
        'bountyhunting': 'Bounty Hunting',
        'stoneforging': 'Stone Forging',
        'petmastery': 'Pet Mastery'
    };

    // Use map if exists, otherwise capitalize first letter
    const displaySkill = skillNameMap[skill] || (skill.charAt(0).toUpperCase() + skill.slice(1));
    const text = `+${amount} ${displaySkill} XP`;

    if (delay > 0) {
      setTimeout(() => showItemPopup(text, barId), delay);
    } else {
      showItemPopup(text, barId);
    }
  }
}

const MINE_TIME_MS = 1500;
const MINE_XP = 15;
const MINE_ITEM = 'Copper Ore';

/**
* NEW: A reusable loop to show a cooldown timer in the mining UI.
 * @param {number} timestamp - The current frame's timestamp.
 * @param {number} startTime - The timestamp when the cooldown began.
 * @param {number} duration - The total duration of the cooldown (in ms).
 * @param {string} progressTextId - The ID of the text element (e.g., 'mineProgressText').
 * @param {function} nextLoopFunction - The mining loop to call when finished (e.g., miningLoop).
 */

function miningCooldownLoop(timestamp, startTime, duration, progressTextId, nextLoopFunction) {
  if (!game.miningActive) { // Check if stop was pressed
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = '';
    return;
  }

  const elapsed = Date.now() - startTime; // Use Date.now() for real time
  const remainingMs = duration - elapsed;

  if (remainingMs <= 0) {
    // --- COOLDOWN IS COMPLETE ---
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = '';
    
    // --- NEW: Calculate "overdue" time ---
    const overdueTime = -remainingMs; // (elapsed - duration)
    const newActionStartTime = Date.now() - overdueTime;
            
    // --- THIS IS THE FIX: Immediately call the next loop ---
    return nextLoopFunction(Date.now(), newActionStartTime);
    
  } else {
    // --- COOLDOWN IN PROGRESS ---
    const remainingSecs = (remainingMs / 1000).toFixed(1);
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = `${remainingSecs}s`;
    
    // This is now the ONLY setTimeout, for when we are actively waiting
    game.progressFrame = setTimeout(() => 
      miningCooldownLoop(Date.now(), startTime, duration, progressTextId, nextLoopFunction)
    , 16);
  }
}

// --- MODIFIED: Added Session Lock Check ---
async function startMining() {
  // +++ NEW: Tool Check +++
  const bestPickaxe = getBestTool('pickaxe');
  if (bestPickaxe < 1) { // Requires Bronze (Tier 1)
    await showGameAlert("Tool Required", "You need at least a Bronze Pickaxe in your inventory to mine this.");
    return;
  }
  // +++ END NEW +++

  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(MINE_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to mine this.");
    return;
  }
  // +++ END NEW +++

  if (game.miningActive) return; 
  game.miningActive = true;
  const startBtn = document.getElementById('startMineBtn');
  const stopBtn = document.getElementById('stopMineBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => miningLoop(Date.now(), Date.now()), 16);
}

function miningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime; // Use Date.now() for real time

  if (elapsed >= MINE_TIME_MS) {
    // --- ACTION IS COMPLETE ---
    addItem(MINE_ITEM, 1); 
    addXP('mining', MINE_XP); 
    showItemPopup(`+${MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 Copper Ore`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) { // 1/100 Chance
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }
    
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = '0%';
    
    // --- NEW: Calculate "overdue" time ---
    const overdueTime = elapsed - MINE_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;
            
    // --- THIS IS THE FIX: Immediately call the cooldown loop ---
    return miningCooldownLoop(Date.now(), newCooldownStartTime, MINE_COOLDOWN_COPPER_MS, 'mineProgressText', miningLoop);
    
  } else {
    // --- ACTION IN PROGRESS ---
    const progress = (elapsed / MINE_TIME_MS) * 100;
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = progress + '%';
    
    // This is now the ONLY setTimeout
    game.progressFrame = setTimeout(() => miningLoop(Date.now(), startTime), 16);
  }
}

function stopMining(){
  game.miningActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame); // <-- MODIFIED
  
  const textEl = document.getElementById('mineProgressText');
  if (textEl) textEl.innerText = '';

  const bar = document.getElementById('mineProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startMineBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopMineBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

// +++ NEW CRAFTING FUNCTION BLOCK TO INSERT +++
const CHESTPLATE_TIME_MS = 10000; 

// +++ END NEW CRAFTING FUNCTION +++


// +++ END NEW SHORTSWORD CRAFTING FUNCTION +++

function openCopperHelmetSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Copper Helmet</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${HELMET_BAR_COST} Copper Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="helmetProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startHelmetBtn" class="primary">Start Crafting</button>
      <button id="stopHelmetBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startHelmetBtn').onclick = startHelmetCrafting;
  document.getElementById('stopHelmetBtn').onclick = () => stopBlacksmithing('helmetProgress', 'startHelmetBtn', 'stopHelmetBtn'); 
  showMainScreen('hubDynamic');
}
// +++ END NEW HELMET CRAFTING FUNCTION +++

async function startHelmetCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Helmet')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < HELMET_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${HELMET_BAR_COST} Copper Bars to craft a helmet.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startHelmetBtn');
  const stopBtn = document.getElementById('stopHelmetBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => helmetCraftingLoop(Date.now(), Date.now()), 16);
}

async function helmetCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= HELMET_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < HELMET_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing('helmetProgress', 'startHelmetBtn', 'stopHelmetBtn');
        return;
    }
    
    removeItem('Copper Bar', HELMET_BAR_COST);
    addItem('Copper Helmet', 1);
    addXP('blacksmith', HELMET_XP);
    showItemPopup(`+${HELMET_XP} Blacksmith XP`, 'helmetProgress', 0);
    showItemPopup(`+1 Copper Helmet`, 'helmetProgress', 450);
    
    const bar = document.getElementById('helmetProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - HELMET_TIME_MS;
    const newStartTime = Date.now() - overdueTime;

    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < HELMET_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another helmet.");
        stopBlacksmithing('helmetProgress', 'startHelmetBtn', 'stopHelmetBtn');
        return;
    }
    
    // --- THIS IS THE FIX: Immediately call self to catch up ---
    return helmetCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / HELMET_TIME_MS) * 100;
    const bar = document.getElementById('helmetProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => helmetCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW COPPER BOOTS UI +++
function openCopperBootsSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Boots</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${BOOTS_BAR_COST} Copper Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="bootsProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startBootsBtn" class="primary">Start Crafting</button>
      <button id="stopBootsBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startBootsBtn').onclick = startBootsCrafting;
  document.getElementById('stopBootsBtn').onclick = () => stopBlacksmithing('bootsProgress', 'startBootsBtn', 'stopBootsBtn'); 
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

async function startBootsCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Boots')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < BOOTS_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${BOOTS_BAR_COST} Copper Bars to craft boots.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startBootsBtn');
  const stopBtn = document.getElementById('stopBootsBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => bootsCraftingLoop(Date.now(), Date.now()), 16);
}

async function bootsCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= BOOTS_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < BOOTS_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Copper Bar', BOOTS_BAR_COST);
    addItem('Copper Boots', 1);
    addXP('blacksmith', BOOTS_XP);
    showItemPopup(`+${BOOTS_XP} Blacksmith XP`, 'bootsProgress', 0);
    showItemPopup(`+1 Copper Boots`, 'bootsProgress', 450);
    
    const bar = document.getElementById('bootsProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - BOOTS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < BOOTS_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft more boots.");
        stopBlacksmithing();
        return;
    }
    
    return bootsCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / BOOTS_TIME_MS) * 100;
    const bar = document.getElementById('bootsProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => bootsCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW COPPER PLATELEGS UI +++
function openCopperPlatelegsSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Copper Platelegs</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${COPPER_PLATELEGS_BAR_COST} Copper Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="platelegsProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startPlatelegsBtn" class="primary">Start Crafting</button>
      <button id="stopPlatelegsBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startPlatelegsBtn').onclick = startCopperPlatelegsCrafting;
  document.getElementById('stopPlatelegsBtn').onclick = () => stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn'); 
  showMainScreen('hubDynamic');
}

async function startCopperPlatelegsCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Platelegs')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < COPPER_PLATELEGS_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${COPPER_PLATELEGS_BAR_COST} Copper Bars to craft platelegs.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startPlatelegsBtn');
  const stopBtn = document.getElementById('stopPlatelegsBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => copperPlatelegsCraftingLoop(Date.now(), Date.now()), 16);
}

async function copperPlatelegsCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COPPER_PLATELEGS_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < COPPER_PLATELEGS_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn');
        return;
    }
    
    removeItem('Copper Bar', COPPER_PLATELEGS_BAR_COST);
    addItem('Copper Platelegs', 1);
    addXP('blacksmith', COPPER_PLATELEGS_XP);
    showItemPopup(`+${COPPER_PLATELEGS_XP} Blacksmith XP`, 'platelegsProgress', 0);
    showItemPopup(`+1 Copper Platelegs`, 'platelegsProgress', 450);
    
    const bar = document.getElementById('platelegsProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COPPER_PLATELEGS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < COPPER_PLATELEGS_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft more platelegs.");
        stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn');
        return;
    }
    
    return copperPlatelegsCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COPPER_PLATELEGS_TIME_MS) * 100;
    const bar = document.getElementById('platelegsProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => copperPlatelegsCraftingLoop(Date.now(), startTime), 16);
  }
}
// +++ END NEW COPPER PLATELEGS +++

// --- NEW: Iron Bar Crafting Logic ---
async function startIronBarCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Bar')) {
    await showGameAlert("Inventory Full", "You have no room to smith this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalIronOre = 0;
  let totalCoalOre = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Ore') totalIronOre += slot.qty;
      if (slot && slot.name === 'Coal Ore') totalCoalOre += slot.qty;
  }

  if (totalIronOre < IRON_BAR_ORE_COST || totalCoalOre < IRON_BAR_COAL_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_BAR_ORE_COST} Iron Ore and ${IRON_BAR_COAL_COST} Coal Ore.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startSmithBtn');
  const stopBtn = document.getElementById('stopSmithBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironBarCraftingLoop(Date.now(), Date.now()), 16);
}


async function ironBarCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_BAR_TIME_MS) {
    let totalIronOre = 0;
    let totalCoalOre = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Ore') totalIronOre += slot.qty;
        if (slot && slot.name === 'Coal Ore') totalCoalOre += slot.qty;
    }
    if (totalIronOre < IRON_BAR_ORE_COST || totalCoalOre < IRON_BAR_COAL_COST) {
        await showGameAlert("Out of Materials", "You've run out of ore.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Iron Ore', IRON_BAR_ORE_COST);
    removeItem('Coal Ore', IRON_BAR_COAL_COST);
    addItem('Iron Bar', 1);
    addXP('blacksmith', IRON_BAR_XP);
    showItemPopup(`+${IRON_BAR_XP} Blacksmith XP`, 'smithProgress', 0);
    showItemPopup(`+1 Iron Bar`, 'smithProgress', 450);
    
    const bar = document.getElementById('smithProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_BAR_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalIronAfter = 0;
    let totalCoalAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Ore') totalIronAfter += slot.qty;
        if (slot && slot.name === 'Coal Ore') totalCoalAfter += slot.qty;
    }
    if (totalIronAfter < IRON_BAR_ORE_COST || totalCoalAfter < IRON_BAR_COAL_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough ore to smith another bar.");
        stopBlacksmithing();
        return;
    }
    
    return ironBarCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_BAR_TIME_MS) * 100;
    const bar = document.getElementById('smithProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironBarCraftingLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Helmet Crafting Logic ---
async function startIronHelmetCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Helmet')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
  }

  if (totalBars < IRON_HELMET_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_HELMET_BAR_COST} Iron Bars.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startHelmetBtn');
  const stopBtn = document.getElementById('stopHelmetBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironHelmetCraftingLoop(Date.now(), Date.now()), 16);
}


async function ironHelmetCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_HELMET_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
    }
    if (totalBars < IRON_HELMET_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Iron Bars.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Iron Bar', IRON_HELMET_BAR_COST);
    addItem('Iron Helmet', 1);
    addXP('blacksmith', IRON_HELMET_XP);
    showItemPopup(`+${IRON_HELMET_XP} Blacksmith XP`, 'helmetProgress', 0);
    showItemPopup(`+1 Iron Helmet`, 'helmetProgress', 450);
    
    const bar = document.getElementById('helmetProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_HELMET_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBarsAfter += slot.qty;
    }
    if (totalBarsAfter < IRON_HELMET_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another helmet.");
        stopBlacksmithing();
        return;
    }
    
    return ironHelmetCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_HELMET_TIME_MS) * 100;
    const bar = document.getElementById('helmetProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironHelmetCraftingLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Chestplate Crafting Logic ---
async function startIronChestplateCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Chestplate')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
  }

  if (totalBars < IRON_CHESTPLATE_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_CHESTPLATE_BAR_COST} Iron Bars.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startChestplateBtn');
  const stopBtn = document.getElementById('stopChestplateBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironChestplateCraftingLoop(Date.now(), Date.now()), 16);
}

async function ironChestplateCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_CHESTPLATE_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
    }
    if (totalBars < IRON_CHESTPLATE_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Iron Bars.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Iron Bar', IRON_CHESTPLATE_BAR_COST);
    addItem('Iron Chestplate', 1);
    addXP('blacksmith', IRON_CHESTPLATE_XP);
    showItemPopup(`+${IRON_CHESTPLATE_XP} Blacksmith XP`, 'chestplateProgress', 0);
    showItemPopup(`+1 Iron Chestplate`, 'chestplateProgress', 450);
    
    const bar = document.getElementById('chestplateProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_CHESTPLATE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBarsAfter += slot.qty;
    }
    if (totalBarsAfter < IRON_CHESTPLATE_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another chestplate.");
        stopBlacksmithing();
        return;
    }
    
    return ironChestplateCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_CHESTPLATE_TIME_MS) * 100;
    const bar = document.getElementById('chestplateProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironChestplateCraftingLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Boots Crafting Logic ---
async function startIronBootsCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Boots')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
  }

  if (totalBars < IRON_BOOTS_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_BOOTS_BAR_COST} Iron Bars.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startBootsBtn');
  const stopBtn = document.getElementById('stopBootsBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironBootsCraftingLoop(Date.now(), Date.now()), 16);
}


async function ironBootsCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_BOOTS_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
    }
    if (totalBars < IRON_BOOTS_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Iron Bars.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Iron Bar', IRON_BOOTS_BAR_COST);
    addItem('Iron Boots', 1);
    addXP('blacksmith', IRON_BOOTS_XP);
    showItemPopup(`+${IRON_BOOTS_XP} Blacksmith XP`, 'bootsProgress', 0);
    showItemPopup(`+1 Iron Boots`, 'bootsProgress', 450);
    
    const bar = document.getElementById('bootsProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_BOOTS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBarsAfter += slot.qty;
    }
    if (totalBarsAfter < IRON_BOOTS_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft more boots.");
        stopBlacksmithing();
        return;
    }
    
    return ironBootsCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_BOOTS_TIME_MS) * 100;
    const bar = document.getElementById('bootsProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironBootsCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW IRON PLATELEGS UI +++
function openIronPlatelegsSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Iron Platelegs</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_PLATELEGS_BAR_COST} Iron Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="platelegsProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startPlatelegsBtn" class="primary">Start Crafting</button>
      <button id="stopPlatelegsBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startPlatelegsBtn').onclick = startIronPlatelegsCrafting;
  document.getElementById('stopPlatelegsBtn').onclick = () => stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn'); 
  showMainScreen('hubDynamic');
}

async function startIronPlatelegsCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Platelegs')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < IRON_PLATELEGS_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_PLATELEGS_BAR_COST} Iron Bars to craft platelegs.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startPlatelegsBtn');
  const stopBtn = document.getElementById('stopPlatelegsBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironPlatelegsCraftingLoop(Date.now(), Date.now()), 16);
}

async function ironPlatelegsCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_PLATELEGS_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < IRON_PLATELEGS_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Iron Bars.");
        stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn');
        return;
    }
    
    removeItem('Iron Bar', IRON_PLATELEGS_BAR_COST);
    addItem('Iron Platelegs', 1);
    addXP('blacksmith', IRON_PLATELEGS_XP);
    showItemPopup(`+${IRON_PLATELEGS_XP} Blacksmith XP`, 'platelegsProgress', 0);
    showItemPopup(`+1 Iron Platelegs`, 'platelegsProgress', 450);
    
    const bar = document.getElementById('platelegsProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_PLATELEGS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < IRON_PLATELEGS_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft more platelegs.");
        stopBlacksmithing('platelegsProgress', 'startPlatelegsBtn', 'stopPlatelegsBtn');
        return;
    }
    
    return ironPlatelegsCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_PLATELEGS_TIME_MS) * 100;
    const bar = document.getElementById('platelegsProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironPlatelegsCraftingLoop(Date.now(), startTime), 16);
  }
}
// +++ END NEW IRON PLATELEGS +++

// --- NEW: Iron Shortsword Crafting Logic ---
async function startIronShortswordCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Shortsword')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
  }

  if (totalBars < IRON_SHORTSWORD_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${IRON_SHORTSWORD_BAR_COST} Iron Bars.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startShortswordBtn');
  const stopBtn = document.getElementById('stopShortswordBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironShortswordCraftingLoop(Date.now(), Date.now()), 16);
}


async function ironShortswordCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_SHORTSWORD_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
    }
    if (totalBars < IRON_SHORTSWORD_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Iron Bars.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Iron Bar', IRON_SHORTSWORD_BAR_COST);
    addItem('Iron Shortsword', 1);
    addXP('blacksmith', IRON_SHORTSWORD_XP);
    showItemPopup(`+${IRON_SHORTSWORD_XP} Blacksmith XP`, 'shortswordProgress', 0);
    showItemPopup(`+1 Iron Shortsword`, 'shortswordProgress', 450);
    
    const bar = document.getElementById('shortswordProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_SHORTSWORD_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
   
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < IRON_SHORTSWORD_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another shortsword.");
        stopBlacksmithing();
        return;
    }
    
    return ironShortswordCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_SHORTSWORD_TIME_MS) * 100;
    const bar = document.getElementById('shortswordProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironShortswordCraftingLoop(Date.now(), startTime), 16);
  }
}

const SMITH_TIME_MS = 5000;
const SMITH_XP = 25;
const SMITH_ORE_COST = 2;
const SMITH_BAR_ITEM = 'Copper Bar';

// --- MODIFIED: Added Session Lock Check ---
async function startBlacksmithing() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(SMITH_BAR_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to smith this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalOre = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Ore') {
          totalOre += slot.qty;
      }
  }

  if (totalOre < SMITH_ORE_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${SMITH_ORE_COST} Copper Ore to smith a bar.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startSmithBtn');
  const stopBtn = document.getElementById('stopSmithBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => blacksmithingLoop(Date.now(), Date.now()), 16);
}

async function blacksmithingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= SMITH_TIME_MS) {
    let totalOre = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Ore') {
            totalOre += slot.qty;
        }
    }
    if (totalOre < SMITH_ORE_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Ore.");
        stopBlacksmithing();
        return;
    }
    
    removeItem('Copper Ore', SMITH_ORE_COST);
    addItem(SMITH_BAR_ITEM, 1);
    addXP('blacksmith', SMITH_XP);
    showItemPopup(`+${SMITH_XP} Blacksmith XP`, 'smithProgress', 0);
    showItemPopup(`+1 Copper Bar`, 'smithProgress', 450);
    
    const bar = document.getElementById('smithProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - SMITH_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalOreAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Ore') {
            totalOreAfter += slot.qty;
        }
    }
    if (totalOreAfter < SMITH_ORE_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough ore to smith another bar.");
        stopBlacksmithing();
        return;
    }
    
    return blacksmithingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / SMITH_TIME_MS) * 100;
    const bar = document.getElementById('smithProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => blacksmithingLoop(Date.now(), startTime), 16);
  }
}

function stopBlacksmithing(progressId = 'smithProgress', startBtnId = 'startSmithBtn', stopBtnId = 'stopSmithBtn'){
  game.blacksmithingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  const bar = document.getElementById(progressId);
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById(startBtnId);
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById(stopBtnId);
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

const COOK_CHICKEN_TIME_MS = 3000;
const COOK_CHICKEN_XP = 30;
const COOK_CHICKEN_HEAL = 3; // <-- ADD THIS

// --- NEW: Beef Cooking Constants ---
const COOK_BEEF_LVL = 1;
const COOK_BEEF_TIME_MS = 3000;
const COOK_BEEF_XP = 35;
const COOK_BEEF_HEAL = 4; // Heals 4 HP
const COOK_BEEF_ITEM_RAW = 'Beef';
const COOK_BEEF_ITEM_COOKED = 'Cooked Beef';
const COOK_BEEF_ITEM_BURNT = 'Burnt Beef';

// --- NEW: Herring Cooking Constants ---
const COOK_HERRING_LVL = 1;
const COOK_HERRING_TIME_MS = 3000; // Same as chicken
const COOK_HERRING_XP = 30;        // Same as chicken
const COOK_HERRING_HEAL = 3;
const COOK_HERRING_ITEM_RAW = 'Herring';
const COOK_HERRING_ITEM_COOKED = 'Cooked Herring';
const COOK_HERRING_ITEM_BURNT = 'Burnt Herring';

// --- NEW: Trout Cooking Constants ---
const COOK_TROUT_LVL = 5;
const COOK_TROUT_TIME_MS = 3500; // Slightly longer
const COOK_TROUT_XP = 40;        // 4 HP heal
const COOK_TROUT_HEAL = 4;
const COOK_TROUT_ITEM_RAW = 'Trout';
const COOK_TROUT_ITEM_COOKED = 'Cooked Trout';
const COOK_TROUT_ITEM_BURNT = 'Burnt Trout';

// --- NEW: Salmon Cooking Constants ---
const COOK_SALMON_LVL = 10;
const COOK_SALMON_TIME_MS = 3500; // Same as trout
const COOK_SALMON_XP = 45;        // 4 HP heal
const COOK_SALMON_HEAL = 4;
const COOK_SALMON_ITEM_RAW = 'Salmon';
const COOK_SALMON_ITEM_COOKED = 'Cooked Salmon';
const COOK_SALMON_ITEM_BURNT = 'Burnt Salmon';


// --- NEW COOKING FUNCTIONS ---
async function startCookingChicken() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK (checks for both outcomes) +++
  if (!canReceiveItem('Cooked Chicken') && !canReceiveItem('Burnt Chicken')) {
    await showGameAlert("Inventory Full", "You have no room to cook this. Make space for the cooked or burnt item.");
    return;
  }
  // +++ END NEW +++
  
  if (game.cookingActive) return;

  // --- Check for Raw Chicken ---
  let totalRaw = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Raw Chicken') {
          totalRaw += slot.qty;
      }
  }

  if (totalRaw < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 Raw Chicken to cook.`);
      return;
  }
  
  game.cookingActive = true;
  const startBtn = document.getElementById('startCookBtn');
  const stopBtn = document.getElementById('stopCookBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => cookingChickenLoop(Date.now(), Date.now()), 16);
}

async function cookingChickenLoop(timestamp, startTime) {
  if (!game.cookingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COOK_CHICKEN_TIME_MS) {
    let totalRaw = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Raw Chicken') {
            totalRaw += slot.qty;
        }
    }
    if (totalRaw < 1) {
        await showGameAlert("Out of Materials", "You've run out of Raw Chicken.");
        stopCookingChicken();
        return;
    }
    
    removeItem('Raw Chicken', 1);
    addXP('cooking', COOK_CHICKEN_XP);
    
    const successRate = Math.min(100, 50 + ((game.cooking.level - 1) * (50/9)));
    
    if (Math.random() * 100 < successRate) {
      addItem('Cooked Chicken', 1);
      showItemPopup(`+${COOK_CHICKEN_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 Cooked Chicken`, 'cookProgress', 450);
    } else {
      addItem('Burnt Chicken', 1);
      showItemPopup(`+${COOK_CHICKEN_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 Burnt Chicken`, 'cookProgress', 450);
    }
    
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COOK_CHICKEN_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalRawAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Raw Chicken') {
            totalRawAfter += slot.qty;
        }
    }
    if (totalRawAfter < 1) {
        await showGameAlert("Not Enough Materials", "You don't have any more Raw Chicken to cook.");
        stopCookingChicken();
        return;
    }
    
    return cookingChickenLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COOK_CHICKEN_TIME_MS) * 100;
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => cookingChickenLoop(Date.now(), startTime), 16);
  }
}

function stopCookingChicken(){
  game.cookingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  const bar = document.getElementById('cookProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startCookBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopCookBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

// +++ NEW: BEEF COOKING UI +++
function openCookBeef(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Cooking - Beef</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 ${COOK_BEEF_ITEM_RAW}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="cookProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCookBtn" class="primary">Start Cooking</button>
      <button id="stopCookBtn" class="primary" style="background:#555; display:none;">Stop Cooking</button>
      <button onclick="openKitchenHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCookBtn').onclick = startCookingBeef;
  document.getElementById('stopCookBtn').onclick = stopCookingChicken; // Re-uses same stop function
  showMainScreen('hubDynamic');
}

async function startCookingBeef() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // Check Inventory Space
  if (!canReceiveItem(COOK_BEEF_ITEM_COOKED) && !canReceiveItem(COOK_BEEF_ITEM_BURNT)) {
    await showGameAlert("Inventory Full", "You have no room to cook this.");
    return;
  }
  
  if (game.cookingActive) return;

  // Check for Raw Beef
  let totalRaw = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === COOK_BEEF_ITEM_RAW) {
          totalRaw += slot.qty;
      }
  }
  if (totalRaw < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 ${COOK_BEEF_ITEM_RAW} to cook.`);
      return;
  }
  
  game.cookingActive = true;
  document.getElementById('startCookBtn').style.display = 'none';
  document.getElementById('stopCookBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => cookingBeefLoop(Date.now(), Date.now()), 16);
}

async function cookingBeefLoop(timestamp, startTime) {
  if (!game.cookingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COOK_BEEF_TIME_MS) {
    let totalRaw = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_BEEF_ITEM_RAW) {
            totalRaw += slot.qty;
        }
    }
    if (totalRaw < 1) {
        await showGameAlert("Out of Materials", `You've run out of ${COOK_BEEF_ITEM_RAW}.`);
        stopCookingChicken();
        return;
    }
    
    removeItem(COOK_BEEF_ITEM_RAW, 1);
    addXP('cooking', COOK_BEEF_XP);
    
    // Burning Formula: Starts at 50% success, reaches 100% at Level 10 (same as Chicken roughly)
    const successRate = Math.min(100, 50 + ((game.cooking.level - 1) * (50/9)));
    
    if (Math.random() * 100 < successRate) {
      addItem(COOK_BEEF_ITEM_COOKED, 1);
      showItemPopup(`+${COOK_BEEF_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_BEEF_ITEM_COOKED}`, 'cookProgress', 450);
    } else {
      addItem(COOK_BEEF_ITEM_BURNT, 1);
      showItemPopup(`+${COOK_BEEF_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_BEEF_ITEM_BURNT}`, 'cookProgress', 450);
    }
    
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COOK_BEEF_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalRawAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_BEEF_ITEM_RAW) {
            totalRawAfter += slot.qty;
        }
    }
    if (totalRawAfter < 1) {
        await showGameAlert("Not Enough Materials", `You don't have any more ${COOK_BEEF_ITEM_RAW} to cook.`);
        stopCookingChicken();
        return;
    }
    
    return cookingBeefLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COOK_BEEF_TIME_MS) * 100;
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => cookingBeefLoop(Date.now(), startTime), 16);
  }
}


function openCookChicken(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing(); // Also stop smithing
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Cooking - Chicken</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 Raw Chicken.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="cookProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCookBtn" class="primary">Start Cooking</button>
      <button id="stopCookBtn" class="primary" style="background:#555; display:none;">Stop Cooking</button>
      <button onclick="openKitchenHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCookBtn').onclick = startCookingChicken;
  document.getElementById('stopCookBtn').onclick = stopCookingChicken;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// +++ NEW: HERRING COOKING UI +++
function openCookHerring(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Cooking - Herring</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 ${COOK_HERRING_ITEM_RAW}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="cookProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCookBtn" class="primary">Start Cooking</button>
      <button id="stopCookBtn" class="primary" style="background:#555; display:none;">Stop Cooking</button>
      <button onclick="openKitchenHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCookBtn').onclick = startCookingHerring;
  document.getElementById('stopCookBtn').onclick = stopCookingChicken; // Re-uses the same stop function
  showMainScreen('hubDynamic');
}

// +++ NEW: TROUT COOKING UI +++
function openCookTrout(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Cooking - Trout</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 ${COOK_TROUT_ITEM_RAW}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="cookProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCookBtn" class="primary">Start Cooking</button>
      <button id="stopCookBtn" class="primary" style="background:#555; display:none;">Stop Cooking</button>
      <button onclick="openKitchenHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCookBtn').onclick = startCookingTrout;
  document.getElementById('stopCookBtn').onclick = stopCookingChicken; // Re-uses the same stop function
  showMainScreen('hubDynamic');
}

// +++ NEW: SALMON COOKING UI +++
function openCookSalmon(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Cooking - Salmon</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 ${COOK_SALMON_ITEM_RAW}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="cookProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCookBtn" class="primary">Start Cooking</button>
      <button id="stopCookBtn" class="primary" style="background:#555; display:none;">Stop Cooking</button>
      <button onclick="openKitchenHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCookBtn').onclick = startCookingSalmon;
  document.getElementById('stopCookBtn').onclick = stopCookingChicken; // Re-uses the same stop function
  showMainScreen('hubDynamic');
}

// +++ NEW: HERRING COOKING LOGIC +++
async function startCookingHerring() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK (checks for both outcomes) +++
  if (!canReceiveItem(COOK_HERRING_ITEM_COOKED) && !canReceiveItem(COOK_HERRING_ITEM_BURNT)) {
    await showGameAlert("Inventory Full", "You have no room to cook this. Make space for the cooked or burnt item.");
    return;
  }
  // +++ END NEW +++
  
  if (game.cookingActive) return;

  // Check level
  if (game.cooking.level < COOK_HERRING_LVL) {
    await showGameAlert("Level Required", `You need a Cooking level of ${COOK_HERRING_LVL} to cook this.`);
    return;
  }
  
  // Check for Raw Item
  let totalRaw = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === COOK_HERRING_ITEM_RAW) {
          totalRaw += slot.qty;
      }
  }
  if (totalRaw < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 ${COOK_HERRING_ITEM_RAW} to cook.`);
      return;
  }
  
  game.cookingActive = true;
  const startBtn = document.getElementById('startCookBtn');
  const stopBtn = document.getElementById('stopCookBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => cookingHerringLoop(Date.now(), Date.now()), 16);
}

async function cookingHerringLoop(timestamp, startTime) {
  if (!game.cookingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COOK_HERRING_TIME_MS) {
    let totalRaw = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_HERRING_ITEM_RAW) {
            totalRaw += slot.qty;
        }
    }
    if (totalRaw < 1) {
        await showGameAlert("Out of Materials", `You've run out of ${COOK_HERRING_ITEM_RAW}.`);
        stopCookingChicken();
        return;
    }
    
    removeItem(COOK_HERRING_ITEM_RAW, 1);
    addXP('cooking', COOK_HERRING_XP);
    
    const successRate = Math.min(100, 50 + ((game.cooking.level - 1) * (50/9)));
    
    if (Math.random() * 100 < successRate) {
      addItem(COOK_HERRING_ITEM_COOKED, 1);
      showItemPopup(`+${COOK_HERRING_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_HERRING_ITEM_COOKED}`, 'cookProgress', 450);
    } else {
      addItem(COOK_HERRING_ITEM_BURNT, 1);
      showItemPopup(`+${COOK_HERRING_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_HERRING_ITEM_BURNT}`, 'cookProgress', 450);
    }
    
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COOK_HERRING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalRawAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_HERRING_ITEM_RAW) {
            totalRawAfter += slot.qty;
        }
    }
    if (totalRawAfter < 1) {
        await showGameAlert("Not Enough Materials", `You don't have any more ${COOK_HERRING_ITEM_RAW} to cook.`);
        stopCookingChicken();
        return;
    }
    
    return cookingHerringLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COOK_HERRING_TIME_MS) * 100;
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => cookingHerringLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: TROUT COOKING LOGIC +++
async function startCookingTrout() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK (checks for both outcomes) +++
  if (!canReceiveItem(COOK_TROUT_ITEM_COOKED) && !canReceiveItem(COOK_TROUT_ITEM_BURNT)) {
    await showGameAlert("Inventory Full", "You have no room to cook this. Make space for the cooked or burnt item.");
    return;
  }
  // +++ END NEW +++
  
  if (game.cookingActive) return;

  // Check level
  if (game.cooking.level < COOK_TROUT_LVL) {
    await showGameAlert("Level Required", `You need a Cooking level of ${COOK_TROUT_LVL} to cook this.`);
    return;
  }
  
  // Check for Raw Item
  let totalRaw = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === COOK_TROUT_ITEM_RAW) {
          totalRaw += slot.qty;
      }
  }
  if (totalRaw < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 ${COOK_TROUT_ITEM_RAW} to cook.`);
      return;
  }
  
  game.cookingActive = true;
  const startBtn = document.getElementById('startCookBtn');
  const stopBtn = document.getElementById('stopCookBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => cookingTroutLoop(Date.now(), Date.now()), 16);
}

async function cookingTroutLoop(timestamp, startTime) {
  if (!game.cookingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COOK_TROUT_TIME_MS) {
    let totalRaw = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_TROUT_ITEM_RAW) {
            totalRaw += slot.qty;
        }
    }
    if (totalRaw < 1) {
        await showGameAlert("Out of Materials", `You've run out of ${COOK_TROUT_ITEM_RAW}.`);
        stopCookingChicken();
        return;
    }
    
    removeItem(COOK_TROUT_ITEM_RAW, 1);
    addXP('cooking', COOK_TROUT_XP);
    
    const successRate = Math.min(100, 50 + ((game.cooking.level - 5) * (50/9)));
    
    if (Math.random() * 100 < successRate || game.cooking.level < COOK_TROUT_LVL) {
      addItem(COOK_TROUT_ITEM_COOKED, 1);
      showItemPopup(`+${COOK_TROUT_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_TROUT_ITEM_COOKED}`, 'cookProgress', 450);
    } else {
      addItem(COOK_TROUT_ITEM_BURNT, 1);
      showItemPopup(`+${COOK_TROUT_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_TROUT_ITEM_BURNT}`, 'cookProgress', 450);
    }
    
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COOK_TROUT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalRawAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_TROUT_ITEM_RAW) {
            totalRawAfter += slot.qty;
        }
    }
    if (totalRawAfter < 1) {
        await showGameAlert("Not Enough Materials", `You don't have any more ${COOK_TROUT_ITEM_RAW} to cook.`);
        stopCookingChicken();
        return;
    }
    
    return cookingTroutLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COOK_TROUT_TIME_MS) * 100;
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => cookingTroutLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: SALMON COOKING LOGIC +++
async function startCookingSalmon() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK (checks for both outcomes) +++
  if (!canReceiveItem(COOK_SALMON_ITEM_COOKED) && !canReceiveItem(COOK_SALMON_ITEM_BURNT)) {
    await showGameAlert("Inventory Full", "You have no room to cook this. Make space for the cooked or burnt item.");
    return;
  }
  // +++ END NEW +++
  
  if (game.cookingActive) return;

  // Check level
  if (game.cooking.level < COOK_SALMON_LVL) {
    await showGameAlert("Level Required", `You need a Cooking level of ${COOK_SALMON_LVL} to cook this.`);
    return;
  }
  
  // Check for Raw Item
  let totalRaw = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === COOK_SALMON_ITEM_RAW) {
          totalRaw += slot.qty;
      }
  }
  if (totalRaw < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 ${COOK_SALMON_ITEM_RAW} to cook.`);
      return;
  }
  
  game.cookingActive = true;
  const startBtn = document.getElementById('startCookBtn');
  const stopBtn = document.getElementById('stopCookBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => cookingSalmonLoop(Date.now(), Date.now()), 16);
}

async function cookingSalmonLoop(timestamp, startTime) {
  if (!game.cookingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COOK_SALMON_TIME_MS) {
    let totalRaw = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_SALMON_ITEM_RAW) {
            totalRaw += slot.qty;
        }
    }
    if (totalRaw < 1) {
        await showGameAlert("Out of Materials", `You've run out of ${COOK_SALMON_ITEM_RAW}.`);
        stopCookingChicken();
        return;
    }
    
    removeItem(COOK_SALMON_ITEM_RAW, 1);
    addXP('cooking', COOK_SALMON_XP);
    
    const successRate = Math.min(100, 50 + ((game.cooking.level - 10) * (50/9)));
    
    if (Math.random() * 100 < successRate || game.cooking.level < COOK_SALMON_LVL) {
      addItem(COOK_SALMON_ITEM_COOKED, 1);
      showItemPopup(`+${COOK_SALMON_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_SALMON_ITEM_COOKED}`, 'cookProgress', 450);
    } else {
      addItem(COOK_SALMON_ITEM_BURNT, 1);
      showItemPopup(`+${COOK_SALMON_XP} Cooking XP`, 'cookProgress', 0);
      showItemPopup(`+1 ${COOK_SALMON_ITEM_BURNT}`, 'cookProgress', 450);
    }
    
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COOK_SALMON_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalRawAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === COOK_SALMON_ITEM_RAW) {
            totalRawAfter += slot.qty;
        }
    }
    if (totalRawAfter < 1) {
        await showGameAlert("Not Enough Materials", `You don't have any more ${COOK_SALMON_ITEM_RAW} to cook.`);
        stopCookingChicken();
        return;
    }
    
    return cookingSalmonLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COOK_SALMON_TIME_MS) * 100;
    const bar = document.getElementById('cookProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => cookingSalmonLoop(Date.now(), startTime), 16);
  }
}


function openKitchenHub() {
  showMainScreen('hubKitchen');
}

function openCopperBarSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Bar</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 2 Copper Ore.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="smithProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startSmithBtn" class="primary">Start Smithing</button>
      <button id="stopSmithBtn" class="primary" style="background:#555; display:none;">Stop Smithing</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startSmithBtn').onclick = startBlacksmithing;
  document.getElementById('stopSmithBtn').onclick = stopBlacksmithing;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// +++ NEW COPPER CHESTPLATE UI +++
function openCopperChestplateSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Chestplate</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${CHESTPLATE_BAR_COST} Copper Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="chestplateProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startChestplateBtn" class="primary">Start Crafting</button>
      <button id="stopChestplateBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startChestplateBtn').onclick = startChestplateCrafting;
  document.getElementById('stopChestplateBtn').onclick = () => stopBlacksmithing('chestplateProgress', 'startChestplateBtn', 'stopChestplateBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}
// +++ END NEW COPPER CHESTPLATE UI +++

async function startChestplateCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Chestplate')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < CHESTPLATE_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${CHESTPLATE_BAR_COST} Copper Bars to craft a chestplate.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startChestplateBtn');
  const stopBtn = document.getElementById('stopChestplateBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => chestplateCraftingLoop(Date.now(), Date.now()), 16);
}

async function chestplateCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= CHESTPLATE_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < CHESTPLATE_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing('chestplateProgress', 'startChestplateBtn', 'stopChestplateBtn');
        return;
    }
    
    removeItem('Copper Bar', CHESTPLATE_BAR_COST);
    addItem('Copper Chestplate', 1);
    addXP('blacksmith', CHESTPLATE_XP);
    showItemPopup(`+${CHESTPLATE_XP} Blacksmith XP`, 'chestplateProgress', 0);
    showItemPopup(`+1 Copper Chestplate`, 'chestplateProgress', 450);
    
    const bar = document.getElementById('chestplateProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - CHESTPLATE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < CHESTPLATE_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another chestplate.");
        stopBlacksmithing('chestplateProgress', 'startChestplateBtn', 'stopChestplateBtn');
        return;
    }
    
    return chestplateCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / CHESTPLATE_TIME_MS) * 100;
    const bar = document.getElementById('chestplateProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => chestplateCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW COPPER SHORTSWORD UI +++
function openCopperShortswordSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Shortsword</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${SHORTSWORD_BAR_COST} Copper Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="shortswordProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startShortswordBtn" class="primary">Start Crafting</button>
      <button id="stopShortswordBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startShortswordBtn').onclick = startShortswordCrafting;
  document.getElementById('stopShortswordBtn').onclick = () => stopBlacksmithing('shortswordProgress', 'startShortswordBtn', 'stopShortswordBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}
// +++ END NEW COPPER SHORTSWORD UI +++

async function startShortswordCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Shortsword')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < SHORTSWORD_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${SHORTSWORD_BAR_COST} Copper Bars to craft a shortsword.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startShortswordBtn');
  const stopBtn = document.getElementById('stopShortswordBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => shortswordCraftingLoop(Date.now(), Date.now()), 16);
}

async function shortswordCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= SHORTSWORD_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < SHORTSWORD_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing('shortswordProgress', 'startShortswordBtn', 'stopShortswordBtn');
        return;
    }
    
    removeItem('Copper Bar', SHORTSWORD_BAR_COST);
    addItem('Copper Shortsword', 1);
    addXP('blacksmith', SHORTSWORD_XP);
    showItemPopup(`+${SHORTSWORD_XP} Blacksmith XP`, 'shortswordProgress', 0);
    showItemPopup(`+1 Copper Shortsword`, 'shortswordProgress', 450);
    
    const bar = document.getElementById('shortswordProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - SHORTSWORD_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < SHORTSWORD_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft another shortsword.");
        stopBlacksmithing('shortswordProgress', 'startShortswordBtn', 'stopShortswordBtn');
        return;
    }
    
    return shortswordCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / SHORTSWORD_TIME_MS) * 100;
    const bar = document.getElementById('shortswordProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => shortswordCraftingLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Bar UI ---
function openIronBarSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Bar</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_BAR_ORE_COST} Iron Ore, ${IRON_BAR_COAL_COST} Coal Ore.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="smithProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startSmithBtn" class="primary">Start Smithing</button>
      <button id="stopSmithBtn" class="primary" style="background:#555; display:none;">Stop Smithing</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startSmithBtn').onclick = startIronBarCrafting;
  document.getElementById('stopSmithBtn').onclick = stopBlacksmithing;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Iron Helmet UI ---
function openIronHelmetSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Helmet</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_HELMET_BAR_COST} Iron Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="helmetProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startHelmetBtn" class="primary">Start Crafting</button>
      <button id="stopHelmetBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startHelmetBtn').onclick = startIronHelmetCrafting;
  document.getElementById('stopHelmetBtn').onclick = () => stopBlacksmithing('helmetProgress', 'startHelmetBtn', 'stopHelmetBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Iron Chestplate UI ---
function openIronChestplateSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Chestplate</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_CHESTPLATE_BAR_COST} Iron Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="chestplateProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startChestplateBtn" class="primary">Start Crafting</button>
      <button id="stopChestplateBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startChestplateBtn').onclick = startIronChestplateCrafting;
  document.getElementById('stopChestplateBtn').onclick = () => stopBlacksmithing('chestplateProgress', 'startChestplateBtn', 'stopChestplateBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Iron Boots UI ---
function openIronBootsSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Boots</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_BOOTS_BAR_COST} Iron Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="bootsProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startBootsBtn" class="primary">Start Crafting</button>
      <button id="stopBootsBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startBootsBtn').onclick = startIronBootsCrafting;
  document.getElementById('stopBootsBtn').onclick = () => stopBlacksmithing('bootsProgress', 'startBootsBtn', 'stopBootsBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Iron Shortsword UI ---
function openIronShortswordSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Shortsword</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_SHORTSWORD_BAR_COST} Iron Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="shortswordProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startShortswordBtn" class="primary">Start Crafting</button>
      <button id="stopShortswordBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startShortswordBtn').onclick = startIronShortswordCrafting;
  document.getElementById('stopShortswordBtn').onclick = () => stopBlacksmithing('shortswordProgress', 'startShortswordBtn', 'stopShortswordBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
  }

  // --- SILVER BAR SMITHING ---
// --- SILVER BAR SMITHING ---
function openSilverBarSmith(){
  game.shopOpen = false; 
  hideTooltip(); 
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Silver Bar</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${SILVER_BAR_ORE_COST} Silver Ore, ${SILVER_BAR_COAL_COST} Coal Ore.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="smithProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startSmithBtn" class="primary">Start Smithing</button>
      <button id="stopSmithBtn" class="primary" style="background:#555; display:none;">Stop Smithing</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> 
    </div>
  `;
  document.getElementById('startSmithBtn').onclick = startSilverBarCrafting;
  document.getElementById('stopSmithBtn').onclick = stopBlacksmithing;
  showMainScreen('hubDynamic');
}

async function startSilverBarCrafting() {
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Take control to act."); return; }
  if (!canReceiveItem('Silver Bar')) { await showGameAlert("Inventory Full", "No room in inventory."); return; }
  
  if (game.blacksmithingActive) return;

  let silver = 0, coal = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Ore') silver += slot.qty;
      if (slot && slot.name === 'Coal Ore') coal += slot.qty;
  }

  if (silver < SILVER_BAR_ORE_COST || coal < SILVER_BAR_COAL_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${SILVER_BAR_ORE_COST} Silver Ore and ${SILVER_BAR_COAL_COST} Coal Ore.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startSmithBtn').style.display = 'none';
  document.getElementById('stopSmithBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => silverBarLoop(Date.now(), Date.now()), 16);
}

async function silverBarLoop(ts, startTime) {
  if (!game.blacksmithingActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= SILVER_BAR_TIME_MS) {
    let silver = 0, coal = 0;
    for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Ore') silver += slot.qty;
      if (slot && slot.name === 'Coal Ore') coal += slot.qty;
    }

    if (silver >= SILVER_BAR_ORE_COST && coal >= SILVER_BAR_COAL_COST) {
      removeItem('Silver Ore', SILVER_BAR_ORE_COST);
      removeItem('Coal Ore', SILVER_BAR_COAL_COST);
      addItem('Silver Bar', 1);
      
      // AWARD XP
      addXP('blacksmith', SILVER_BAR_XP);
      
      // VISUAL FEEDBACK (Since addXP hides blacksmith popups)
      showItemPopup(`+${SILVER_BAR_XP} Blacksmith XP`, 'smithProgress', 0);
      showItemPopup(`+1 Silver Bar`, 'smithProgress', 450);
      
      document.getElementById('smithProgress').style.width = '0%';

      // Check for next loop
      let nextSilver = 0, nextCoal = 0;
      for (const slot of game.inventory) {
        if (slot && slot.name === 'Silver Ore') nextSilver += slot.qty;
        if (slot && slot.name === 'Coal Ore') nextCoal += slot.qty;
      }

      if (nextSilver >= SILVER_BAR_ORE_COST && nextCoal >= SILVER_BAR_COAL_COST) {
        return silverBarLoop(Date.now(), Date.now());
      } else {
        stopBlacksmithing();
        showGameAlert("Out of Materials", "You don't have enough materials to smith another Silver Bar.");
      }
    } else {
      stopBlacksmithing();
      await showGameAlert("Not Enough Materials", `You need at least ${SILVER_BAR_ORE_COST} Silver Ore and ${SILVER_BAR_COAL_COST} Coal Ore.`);
    }
  } else {
    document.getElementById('smithProgress').style.width = (elapsed / SILVER_BAR_TIME_MS) * 100 + '%';
    game.progressFrame = setTimeout(() => silverBarLoop(Date.now(), startTime), 16);
  }
}

// --- GOLD BAR SMITHING ---
function openGoldBarSmith(){
  game.shopOpen = false; 
  hideTooltip(); 
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Gold Bar</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${GOLD_BAR_ORE_COST} Gold Ore, ${GOLD_BAR_COAL_COST} Coal Ore.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="smithProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startSmithBtn" class="primary">Start Smithing</button>
      <button id="stopSmithBtn" class="primary" style="background:#555; display:none;">Stop Smithing</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> 
    </div>
  `;
  document.getElementById('startSmithBtn').onclick = startGoldBarCrafting;
  document.getElementById('stopSmithBtn').onclick = stopBlacksmithing;
  showMainScreen('hubDynamic');
}

async function startGoldBarCrafting() {
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Take control to act."); return; }
  if (!canReceiveItem('Gold Bar')) { await showGameAlert("Inventory Full", "No room in inventory."); return; }
  
  if (game.blacksmithingActive) return;

  let goldOre = 0, coal = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Gold Ore') goldOre += slot.qty;
      if (slot && slot.name === 'Coal Ore') coal += slot.qty;
  }

  if (goldOre < GOLD_BAR_ORE_COST || coal < GOLD_BAR_COAL_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${GOLD_BAR_ORE_COST} Gold Ore and ${GOLD_BAR_COAL_COST} Coal Ore.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startSmithBtn').style.display = 'none';
  document.getElementById('stopSmithBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => goldBarLoop(Date.now(), Date.now()), 16);
}

async function goldBarLoop(ts, startTime) {
  if (!game.blacksmithingActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= GOLD_BAR_TIME_MS) {
    let goldOre = 0, coal = 0;
    for (const slot of game.inventory) {
      if (slot && slot.name === 'Gold Ore') goldOre += slot.qty;
      if (slot && slot.name === 'Coal Ore') coal += slot.qty;
    }

    if (goldOre >= GOLD_BAR_ORE_COST && coal >= GOLD_BAR_COAL_COST) {
      removeItem('Gold Ore', GOLD_BAR_ORE_COST);
      removeItem('Coal Ore', GOLD_BAR_COAL_COST);
      addItem('Gold Bar', 1);
      
      // AWARD XP
      addXP('blacksmith', GOLD_BAR_XP);
      
      // VISUAL FEEDBACK
      showItemPopup(`+${GOLD_BAR_XP} Blacksmith XP`, 'smithProgress', 0);
      showItemPopup(`+1 Gold Bar`, 'smithProgress', 450);
      
      document.getElementById('smithProgress').style.width = '0%';

      // Check for next loop
      let nextGold = 0, nextCoal = 0;
      for (const slot of game.inventory) {
        if (slot && slot.name === 'Gold Ore') nextGold += slot.qty;
        if (slot && slot.name === 'Coal Ore') nextCoal += slot.qty;
      }

      if (nextGold >= GOLD_BAR_ORE_COST && nextCoal >= GOLD_BAR_COAL_COST) {
        return goldBarLoop(Date.now(), Date.now());
      } else {
        stopBlacksmithing();
        showGameAlert("Out of Materials", "You don't have enough materials to smith another Gold Bar.");
      }
    } else {
      stopBlacksmithing();
      await showGameAlert("Not Enough Materials", `You need at least ${GOLD_BAR_ORE_COST} Gold Ore and ${GOLD_BAR_COAL_COST} Coal Ore.`);
    }
  } else {
    document.getElementById('smithProgress').style.width = (elapsed / GOLD_BAR_TIME_MS) * 100 + '%';
    game.progressFrame = setTimeout(() => goldBarLoop(Date.now(), startTime), 16);
  }
}

// --- SILVER AXE UI ---
function openSilverAxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Silver Axe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${SILVER_AXE_BAR_COST} Silver Bars, ${SILVER_AXE_WOOD_COST} Birch.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="axeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startAxeBtn" class="primary">Start Crafting</button>
      <button id="stopAxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startAxeBtn').onclick = startSilverAxeCrafting;
  document.getElementById('stopAxeBtn').onclick = () => stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
  showMainScreen('hubDynamic');
}

async function startSilverAxeCrafting() {
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Take control to act."); return; }
  if (!canReceiveItem('Silver Axe')) { await showGameAlert("Inventory Full", "No room in inventory."); return; }
  
  if (game.blacksmithingActive) return;

  let bars = 0, birch = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Bar') bars += slot.qty;
      if (slot && slot.name === 'Birch') birch += slot.qty;
  }

  if (bars < SILVER_AXE_BAR_COST || birch < SILVER_AXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${SILVER_AXE_BAR_COST} Silver Bars and ${SILVER_AXE_WOOD_COST} Birch.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startAxeBtn').style.display = 'none';
  document.getElementById('stopAxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => silverAxeLoop(Date.now(), Date.now()), 16);
}

async function silverAxeLoop(ts, startTime) {
  if (!game.blacksmithingActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= SILVER_AXE_TIME_MS) {
    let bars = 0, birch = 0;
    for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Bar') bars += slot.qty;
      if (slot && slot.name === 'Birch') birch += slot.qty;
    }

    if (bars >= SILVER_AXE_BAR_COST && birch >= SILVER_AXE_WOOD_COST) {
      removeItem('Silver Bar', SILVER_AXE_BAR_COST);
      removeItem('Birch', SILVER_AXE_WOOD_COST);
      addItem('Silver Axe', 1);
      addXP('blacksmith', SILVER_AXE_XP);
      showItemPopup(`+${SILVER_AXE_XP} Blacksmith XP`, 'axeProgress', 0);
      showItemPopup(`+1 Silver Axe`, 'axeProgress', 450);
      document.getElementById('axeProgress').style.width = '0%';

      let nextBars = 0, nextBirch = 0;
      for (const slot of game.inventory) {
        if (slot && slot.name === 'Silver Bar') nextBars += slot.qty;
        if (slot && slot.name === 'Birch') nextBirch += slot.qty;
      }

      if (nextBars >= SILVER_AXE_BAR_COST && nextBirch >= SILVER_AXE_WOOD_COST) {
        return silverAxeLoop(Date.now(), Date.now());
      } else {
        stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
        showGameAlert("Out of Materials", "You don't have enough materials to craft another Silver Axe.");
      }
    } else {
      stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
    }
  } else {
    document.getElementById('axeProgress').style.width = (elapsed / SILVER_AXE_TIME_MS) * 100 + '%';
    game.progressFrame = setTimeout(() => silverAxeLoop(Date.now(), startTime), 16);
  }
}

// --- SILVER PICKAXE UI ---
function openSilverPickaxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Silver Pickaxe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${SILVER_PICKAXE_BAR_COST} Silver Bars, ${SILVER_PICKAXE_WOOD_COST} Birch.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="pickaxeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startPickaxeBtn" class="primary">Start Crafting</button>
      <button id="stopPickaxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startPickaxeBtn').onclick = startSilverPickaxeCrafting;
  document.getElementById('stopPickaxeBtn').onclick = () => stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
  showMainScreen('hubDynamic');
}

async function startSilverPickaxeCrafting() {
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Take control to act."); return; }
  if (!canReceiveItem('Silver Pickaxe')) { await showGameAlert("Inventory Full", "No room in inventory."); return; }
  
  if (game.blacksmithingActive) return;

  let bars = 0, birch = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Bar') bars += slot.qty;
      if (slot && slot.name === 'Birch') birch += slot.qty;
  }

  if (bars < SILVER_PICKAXE_BAR_COST || birch < SILVER_PICKAXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${SILVER_PICKAXE_BAR_COST} Silver Bars and ${SILVER_PICKAXE_WOOD_COST} Birch.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startPickaxeBtn').style.display = 'none';
  document.getElementById('stopPickaxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => silverPickaxeLoop(Date.now(), Date.now()), 16);
}

async function silverPickaxeLoop(ts, startTime) {
  if (!game.blacksmithingActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= SILVER_PICKAXE_TIME_MS) {
    let bars = 0, birch = 0;
    for (const slot of game.inventory) {
      if (slot && slot.name === 'Silver Bar') bars += slot.qty;
      if (slot && slot.name === 'Birch') birch += slot.qty;
    }

    if (bars >= SILVER_PICKAXE_BAR_COST && birch >= SILVER_PICKAXE_WOOD_COST) {
      removeItem('Silver Bar', SILVER_PICKAXE_BAR_COST);
      removeItem('Birch', SILVER_PICKAXE_WOOD_COST);
      addItem('Silver Pickaxe', 1);
      addXP('blacksmith', SILVER_PICKAXE_XP);
      showItemPopup(`+${SILVER_PICKAXE_XP} Blacksmith XP`, 'pickaxeProgress', 0);
      showItemPopup(`+1 Silver Pickaxe`, 'pickaxeProgress', 450);
      document.getElementById('pickaxeProgress').style.width = '0%';

      let nextBars = 0, nextBirch = 0;
      for (const slot of game.inventory) {
        if (slot && slot.name === 'Silver Bar') nextBars += slot.qty;
        if (slot && slot.name === 'Birch') nextBirch += slot.qty;
      }

      if (nextBars >= SILVER_PICKAXE_BAR_COST && nextBirch >= SILVER_PICKAXE_WOOD_COST) {
        return silverPickaxeLoop(Date.now(), Date.now());
      } else {
        stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
        showGameAlert("Out of Materials", "You don't have enough materials to craft another Silver Pickaxe.");
      }
    } else {
      stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
    }
  } else {
    document.getElementById('pickaxeProgress').style.width = (elapsed / SILVER_PICKAXE_TIME_MS) * 100 + '%';
    game.progressFrame = setTimeout(() => silverPickaxeLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: COPPER AXE UI +++
function openCopperAxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Axe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${COPPER_AXE_BAR_COST} Copper Bars, ${COPPER_AXE_WOOD_COST} Softwood.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="axeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startAxeBtn" class="primary">Start Crafting</button>
      <button id="stopAxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startAxeBtn').onclick = startCopperAxeCrafting;
  document.getElementById('stopAxeBtn').onclick = () => stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// This is the logic function, now separate
async function startCopperAxeCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Axe')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') totalBars += slot.qty;
      if (slot && slot.name === 'Softwood') totalWood += slot.qty;
  }

  if (totalBars < COPPER_AXE_BAR_COST || totalWood < COPPER_AXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${COPPER_AXE_BAR_COST} Copper Bars and ${COPPER_AXE_WOOD_COST} Softwood.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startAxeBtn').style.display = 'none';
  document.getElementById('stopAxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => copperAxeCraftingLoop(Date.now(), Date.now()), 16);
}

async function copperAxeCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COPPER_AXE_TIME_MS) {
    let totalBars = 0;
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') totalBars += slot.qty;
        if (slot && slot.name === 'Softwood') totalWood += slot.qty;
    }
    if (totalBars < COPPER_AXE_BAR_COST || totalWood < COPPER_AXE_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
        return;
    }
    
    removeItem('Copper Bar', COPPER_AXE_BAR_COST);
    removeItem('Softwood', COPPER_AXE_WOOD_COST);
    addItem('Copper Axe', 1);
    addXP('blacksmith', COPPER_AXE_XP);
    showItemPopup(`+${COPPER_AXE_XP} Blacksmith XP`, 'axeProgress', 0);
    showItemPopup(`+1 Copper Axe`, 'axeProgress', 450);
    
    document.getElementById('axeProgress').style.width = '0%';
    
    const overdueTime = elapsed - COPPER_AXE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') totalBarsAfter += slot.qty;
        if (slot && slot.name === 'Softwood') totalWoodAfter += slot.qty;
    }
    if (totalBarsAfter < COPPER_AXE_BAR_COST || totalWoodAfter < COPPER_AXE_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to craft another.");
        stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
        return;
    }
    
    return copperAxeCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COPPER_AXE_TIME_MS) * 100;
    document.getElementById('axeProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => copperAxeCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: COPPER PICKAXE UI +++
function openCopperPickaxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Copper Pickaxe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${COPPER_PICKAXE_BAR_COST} Copper Bars, ${COPPER_PICKAXE_WOOD_COST} Softwood.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="pickaxeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startPickaxeBtn" class="primary">Start Crafting</button>
      <button id="stopPickaxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startPickaxeBtn').onclick = startCopperPickaxeCrafting;
  document.getElementById('stopPickaxeBtn').onclick = () => stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

async function startCopperPickaxeCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Pickaxe')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') totalBars += slot.qty;
      if (slot && slot.name === 'Softwood') totalWood += slot.qty;
  }

  if (totalBars < COPPER_PICKAXE_BAR_COST || totalWood < COPPER_PICKAXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${COPPER_PICKAXE_BAR_COST} Copper Bars and ${COPPER_PICKAXE_WOOD_COST} Softwood.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startPickaxeBtn').style.display = 'none';
  document.getElementById('stopPickaxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => copperPickaxeCraftingLoop(Date.now(), Date.now()), 16);
}

async function copperPickaxeCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COPPER_PICKAXE_TIME_MS) {
    let totalBars = 0;
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') totalBars += slot.qty;
        if (slot && slot.name === 'Softwood') totalWood += slot.qty;
    }
    if (totalBars < COPPER_PICKAXE_BAR_COST || totalWood < COPPER_PICKAXE_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
        return;
    }
    
    removeItem('Copper Bar', COPPER_PICKAXE_BAR_COST);
    removeItem('Softwood', COPPER_PICKAXE_WOOD_COST);
    addItem('Copper Pickaxe', 1);
    addXP('blacksmith', COPPER_PICKAXE_XP);
    showItemPopup(`+${COPPER_PICKAXE_XP} Blacksmith XP`, 'pickaxeProgress', 0);
    showItemPopup(`+1 Copper Pickaxe`, 'pickaxeProgress', 450);
    
    document.getElementById('pickaxeProgress').style.width = '0%';
    
    const overdueTime = elapsed - COPPER_PICKAXE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') totalBarsAfter += slot.qty;
        if (slot && slot.name === 'Softwood') totalWoodAfter += slot.qty;
    }
    if (totalBarsAfter < COPPER_PICKAXE_BAR_COST || totalWoodAfter < COPPER_PICKAXE_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to craft another.");
        stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
        return;
    }
    
    return copperPickaxeCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COPPER_PICKAXE_TIME_MS) * 100;
    document.getElementById('pickaxeProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => copperPickaxeCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: IRON AXE UI +++
function openIronAxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Axe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_AXE_BAR_COST} Iron Bars, ${IRON_AXE_WOOD_COST} Oak.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="axeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startAxeBtn" class="primary">Start Crafting</button>
      <button id="stopAxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startAxeBtn').onclick = startIronAxeCrafting;
  document.getElementById('stopAxeBtn').onclick = () => stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

async function startIronAxeCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Axe')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
      if (slot && slot.name === 'Oak') totalWood += slot.qty;
  }

  if (totalBars < IRON_AXE_BAR_COST || totalWood < IRON_AXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${IRON_AXE_BAR_COST} Iron Bars and ${IRON_AXE_WOOD_COST} Oak.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startAxeBtn').style.display = 'none';
  document.getElementById('stopAxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironAxeCraftingLoop(Date.now(), Date.now()), 16);
}

async function ironAxeCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_AXE_TIME_MS) {
    let totalBars = 0;
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
        if (slot && slot.name === 'Oak') totalWood += slot.qty;
    }
    if (totalBars < IRON_AXE_BAR_COST || totalWood < IRON_AXE_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
        return;
    }
    
    removeItem('Iron Bar', IRON_AXE_BAR_COST);
    removeItem('Oak', IRON_AXE_WOOD_COST);
    addItem('Iron Axe', 1);
    addXP('blacksmith', IRON_AXE_XP);
    showItemPopup(`+${IRON_AXE_XP} Blacksmith XP`, 'axeProgress', 0);
    showItemPopup(`+1 Iron Axe`, 'axeProgress', 450);
    
    document.getElementById('axeProgress').style.width = '0%';
    
    const overdueTime = elapsed - IRON_AXE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBarsAfter += slot.qty;
        if (slot && slot.name === 'Oak') totalWoodAfter += slot.qty;
    }
    if (totalBarsAfter < IRON_AXE_BAR_COST || totalWoodAfter < IRON_AXE_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to craft another.");
        stopBlacksmithing('axeProgress', 'startAxeBtn', 'stopAxeBtn');
        return;
    }
    
    return ironAxeCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_AXE_TIME_MS) * 100;
    document.getElementById('axeProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironAxeCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: IRON PICKAXE UI +++
function openIronPickaxeSmith(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Smithing - Iron Pickaxe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${IRON_PICKAXE_BAR_COST} Iron Bars, ${IRON_PICKAXE_WOOD_COST} Oak.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="pickaxeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startPickaxeBtn" class="primary">Start Crafting</button>
      <button id="stopPickaxeBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startPickaxeBtn').onclick = startIronPickaxeCrafting;
  document.getElementById('stopPickaxeBtn').onclick = () => stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

async function startIronPickaxeCrafting() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Iron Pickaxe')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
      if (slot && slot.name === 'Oak') totalWood += slot.qty;
  }

  if (totalBars < IRON_PICKAXE_BAR_COST || totalWood < IRON_PICKAXE_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need ${IRON_PICKAXE_BAR_COST} Iron Bars and ${IRON_PICKAXE_WOOD_COST} Oak.`);
      return;
  }
  
  game.blacksmithingActive = true;
  document.getElementById('startPickaxeBtn').style.display = 'none';
  document.getElementById('stopPickaxeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironPickaxeCraftingLoop(Date.now(), Date.now()), 16);
}

async function ironPickaxeCraftingLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_PICKAXE_TIME_MS) {
    let totalBars = 0;
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBars += slot.qty;
        if (slot && slot.name === 'Oak') totalWood += slot.qty;
    }
    if (totalBars < IRON_PICKAXE_BAR_COST || totalWood < IRON_PICKAXE_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
        return;
    }
    
    removeItem('Iron Bar', IRON_PICKAXE_BAR_COST);
    removeItem('Oak', IRON_PICKAXE_WOOD_COST);
    addItem('Iron Pickaxe', 1);
    addXP('blacksmith', IRON_PICKAXE_XP);
    showItemPopup(`+${IRON_PICKAXE_XP} Blacksmith XP`, 'pickaxeProgress', 0);
    showItemPopup(`+1 Iron Pickaxe`, 'pickaxeProgress', 450);
    
    document.getElementById('pickaxeProgress').style.width = '0%';
    
    const overdueTime = elapsed - IRON_PICKAXE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Iron Bar') totalBarsAfter += slot.qty;
        if (slot && slot.name === 'Oak') totalWoodAfter += slot.qty;
    }
    if (totalBarsAfter < IRON_PICKAXE_BAR_COST || totalWoodAfter < IRON_PICKAXE_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to craft another.");
        stopBlacksmithing('pickaxeProgress', 'startPickaxeBtn', 'stopPickaxeBtn');
        return;
    }
    
    return ironPickaxeCraftingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / IRON_PICKAXE_TIME_MS) * 100;
    document.getElementById('pickaxeProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironPickaxeCraftingLoop(Date.now(), startTime), 16);
  }
}

// +++ END NEW COPPER SHORTSWORD UI +++

function openBlacksmithHub() {
  showMainScreen('hubBlacksmith');
}

// +++ NEW: COPPER ARROW TIP UI (Blacksmith) +++
function openSmithCopperArrowTip(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Smithing - Copper Arrow Tip</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${COPPER_ARROW_TIP_BAR_COST} Copper Bars. Yields ${COPPER_ARROW_TIP_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="arrowTipProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startArrowTipBtn" class="primary">Start Crafting</button>
      <button id="stopArrowTipBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openBlacksmithHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startArrowTipBtn').onclick = startSmithingCopperArrowTip;
  document.getElementById('stopArrowTipBtn').onclick = () => stopBlacksmithing('arrowTipProgress', 'startArrowTipBtn', 'stopArrowTipBtn');
  showMainScreen('hubDynamic');
}

async function startSmithingCopperArrowTip() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Arrow Tip')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.blacksmithingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Copper Bar') {
          totalBars += slot.qty;
      }
  }

  if (totalBars < COPPER_ARROW_TIP_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${COPPER_ARROW_TIP_BAR_COST} Copper Bars.`);
      return;
  }
  
  game.blacksmithingActive = true;
  const startBtn = document.getElementById('startArrowTipBtn');
  const stopBtn = document.getElementById('stopArrowTipBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => smithingCopperArrowTipLoop(Date.now(), Date.now()), 16);
}

async function smithingCopperArrowTipLoop(timestamp, startTime) {
  if (!game.blacksmithingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COPPER_ARROW_TIP_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBars += slot.qty;
        }
    }
    if (totalBars < COPPER_ARROW_TIP_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Copper Bars.");
        stopBlacksmithing('arrowTipProgress', 'startArrowTipBtn', 'stopArrowTipBtn');
        return;
    }
    
    removeItem('Copper Bar', COPPER_ARROW_TIP_BAR_COST);
    addItem('Copper Arrow Tip', COPPER_ARROW_TIP_YIELD);
    addXP('blacksmith', COPPER_ARROW_TIP_XP);
    showItemPopup(`+${COPPER_ARROW_TIP_XP} Blacksmith XP`, 'arrowTipProgress', 0);
    showItemPopup(`+${COPPER_ARROW_TIP_YIELD} Copper Arrow Tip`, 'arrowTipProgress', 450);
    
    const bar = document.getElementById('arrowTipProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COPPER_ARROW_TIP_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Copper Bar') {
            totalBarsAfter += slot.qty;
        }
    }
    if (totalBarsAfter < COPPER_ARROW_TIP_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough bars to craft more.");
        stopBlacksmithing('arrowTipProgress', 'startArrowTipBtn', 'stopArrowTipBtn');
        return;
    }
    
    return smithingCopperArrowTipLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COPPER_ARROW_TIP_TIME_MS) * 100;
    const bar = document.getElementById('arrowTipProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => smithingCopperArrowTipLoop(Date.now(), startTime), 16);
  }
}
// +++ END: COPPER ARROW TIP UI (Blacksmith) +++


// +++ NEW: FLETCHING HUB FUNCTIONS +++
function openFletchingHub() {
  showMainScreen('hubFletching');
  // Render the items for the hub
  renderFletchingItems();
}

function stopFletching(progressId = 'fletchProgress', startBtnId = 'startFletchBtn', stopBtnId = 'stopFletchBtn'){
  game.fletchingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  const bar = document.getElementById(progressId);
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById(startBtnId);
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById(stopBtnId);
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

function renderFletchingItems() {
  const container = document.getElementById('fletchingItemsContainer');
  if (!container) return;
  
  const fletchLvl = game.fletching.level;
  
  const setupFletchButton = (btnId, locked, onclick, levelReq, tooltipText, itemName) => {
    const btn = document.getElementById(btnId);
    if (btn) {
      const nameHtml = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">${itemName}</div>`;
      if (locked) {
        btn.onclick = null;
        // FIX: Added red color to requirement
        const lockedTT = nameHtml + `<div style="color:#ff8888;">Requires Fletching Lvl: ${levelReq}</div>`;
        btn.onmouseenter = (event) => showTooltip(event, lockedTT);
      } else {
        btn.onclick = onclick;
        const unlockedTT = nameHtml + tooltipText;
        btn.onmouseenter = (event) => showTooltip(event, unlockedTT);
      }
      btn.onmouseleave = hideTooltip;
    }
  };
  
  // --- Fletching Level Locks ---
  const shaftLocked = fletchLvl < FLETCHING_SHAFT_LVL;
  const unboundLocked = fletchLvl < FLETCHING_UNBOUND_LVL;
  const copperArrowLocked = fletchLvl < FLETCHING_COPPER_ARROW_LVL;
  const unstrungSoftwoodLocked = fletchLvl < FLETCHING_UNSTRUNG_SOFTWOOD_LVL; // +++ NEW +++
  const softwoodBowLocked = fletchLvl < FLETCHING_SOFTWOOD_BOW_LVL;         // +++ NEW +++
  const unstrungOakLocked = fletchLvl < FLETCHING_UNSTRUNG_OAK_LVL;         // +++ NEW +++
  const oakBowLocked = fletchLvl < FLETCHING_OAK_BOW_LVL;                 // +++ NEW +++
  
  container.innerHTML = `
    <button id="fletchShaftBtn" class="primary ${shaftLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/arrowshaft.png" alt="Arrow Shaft" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="fletchUnboundBtn" class="primary ${unboundLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/unboundarrow.png" alt="Unbound Arrow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="fletchCopperArrowBtn" class="primary ${copperArrowLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/copperarrow.png" alt="Copper Arrow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    
    <button id="fletchUnstrungSoftwoodBtn" class="primary ${unstrungSoftwoodLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/unstrungsoftwoodbow.png" alt="Unstrung Softwood Bow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="fletchSoftwoodBowBtn" class="primary ${softwoodBowLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/softwoodbow.png" alt="Softwood Bow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="fletchUnstrungOakBtn" class="primary ${unstrungOakLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/unstrungoakbow.png" alt="Unstrung Oak Bow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="fletchOakBowBtn" class="primary ${oakBowLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/oakbow.png" alt="Oak Bow" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
  `;
  
  // --- Re-attach listeners for fletching items ---
  setupFletchButton('fletchShaftBtn', shaftLocked, openFletchArrowShaft, FLETCHING_SHAFT_LVL, `Requires: ${ARROW_SHAFT_WOOD_COST} Softwood`, `Arrow Shaft x${ARROW_SHAFT_YIELD}`);
  setupFletchButton('fletchUnboundBtn', unboundLocked, openFletchUnboundArrow, FLETCHING_UNBOUND_LVL, `Requires: ${UNBOUND_ARROW_SHAFT_COST} Arrow Shafts, <br>${UNBOUND_ARROW_FEATHER_COST} Feathers`, `Unbound Arrow x${UNBOUND_ARROW_YIELD}`);
  setupFletchButton('fletchCopperArrowBtn', copperArrowLocked, openFletchCopperArrow, FLETCHING_COPPER_ARROW_LVL, `Requires: ${COPPER_ARROW_UNBOUND_COST} Unbound Arrows, <br>${COPPER_ARROW_TIP_COST} Copper Arrow Tips`, `Copper Arrow x${COPPER_ARROW_YIELD}`);

  // +++ NEW: Bow Listeners +++
  setupFletchButton('fletchUnstrungSoftwoodBtn', unstrungSoftwoodLocked, openFletchUnstrungSoftwoodBow, FLETCHING_UNSTRUNG_SOFTWOOD_LVL, `Requires: ${UNSTRUNG_SOFTWOOD_WOOD_COST} Softwood`, `Unstrung Softwood Bow x${UNSTRUNG_SOFTWOOD_YIELD}`);
  setupFletchButton('fletchSoftwoodBowBtn', softwoodBowLocked, openFletchSoftwoodBow, FLETCHING_SOFTWOOD_BOW_LVL, `Requires: ${SOFTWOOD_BOW_UNSTRUNG_COST} Unstrung Softwood Bow, <br>${SOFTWOOD_BOW_STRING_COST} Bow String`, `Softwood Bow x${SOFTWOOD_BOW_YIELD}`);
  setupFletchButton('fletchUnstrungOakBtn', unstrungOakLocked, openFletchUnstrungOakBow, FLETCHING_UNSTRUNG_OAK_LVL, `Requires: ${UNSTRUNG_OAK_WOOD_COST} Oak`, `Unstrung Oak Bow x${UNSTRUNG_OAK_YIELD}`);
  setupFletchButton('fletchOakBowBtn', oakBowLocked, openFletchOakBow, FLETCHING_OAK_BOW_LVL, `Requires: ${OAK_BOW_UNSTRUNG_COST} Unstrung Oak Bow, <br>${OAK_BOW_STRING_COST} Bow String`, `Oak Bow x${OAK_BOW_YIELD}`);
}

// --- Arrow Shaft UI & Logic ---
function openFletchArrowShaft(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Arrow Shaft</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${ARROW_SHAFT_WOOD_COST} Softwood. Yields ${ARROW_SHAFT_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingArrowShaft;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingArrowShaft() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Arrow Shaft')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Softwood') totalWood += slot.qty;
  }

  if (totalWood < ARROW_SHAFT_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${ARROW_SHAFT_WOOD_COST} Softwood.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingArrowShaftLoop(Date.now(), Date.now()), 16);
}

async function fletchingArrowShaftLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= ARROW_SHAFT_TIME_MS) {
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Softwood') totalWood += slot.qty;
    }
    if (totalWood < ARROW_SHAFT_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of Softwood.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Softwood', ARROW_SHAFT_WOOD_COST);
    addItem('Arrow Shaft', ARROW_SHAFT_YIELD);
    addXP('fletching', ARROW_SHAFT_XP);
    showItemPopup(`+${ARROW_SHAFT_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${ARROW_SHAFT_YIELD} Arrow Shaft`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - ARROW_SHAFT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Softwood') totalWoodAfter += slot.qty;
    }
    if (totalWoodAfter < ARROW_SHAFT_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Softwood to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingArrowShaftLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / ARROW_SHAFT_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingArrowShaftLoop(Date.now(), startTime), 16);
  }
}

// --- Unbound Arrow UI & Logic ---
function openFletchUnboundArrow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Unbound Arrow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${UNBOUND_ARROW_SHAFT_COST} Arrow Shaft, ${UNBOUND_ARROW_FEATHER_COST} Feather. Yields ${UNBOUND_ARROW_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingUnboundArrow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingUnboundArrow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Unbound Arrow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalShafts = 0;
  let totalFeathers = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Arrow Shaft') totalShafts += slot.qty;
      if (slot && slot.name === 'Feather') totalFeathers += slot.qty;
  }

  if (totalShafts < UNBOUND_ARROW_SHAFT_COST || totalFeathers < UNBOUND_ARROW_FEATHER_COST) {
      await showGameAlert("Not Enough Materials", `You need ${UNBOUND_ARROW_SHAFT_COST} Arrow Shafts and ${UNBOUND_ARROW_FEATHER_COST} Feathers.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingUnboundArrowLoop(Date.now(), Date.now()), 16);
}

async function fletchingUnboundArrowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= UNBOUND_ARROW_TIME_MS) {
    let totalShafts = 0;
    let totalFeathers = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Arrow Shaft') totalShafts += slot.qty;
        if (slot && slot.name === 'Feather') totalFeathers += slot.qty;
    }
    if (totalShafts < UNBOUND_ARROW_SHAFT_COST || totalFeathers < UNBOUND_ARROW_FEATHER_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Arrow Shaft', UNBOUND_ARROW_SHAFT_COST);
    removeItem('Feather', UNBOUND_ARROW_FEATHER_COST);
    addItem('Unbound Arrow', UNBOUND_ARROW_YIELD);
    addXP('fletching', UNBOUND_ARROW_XP);
    showItemPopup(`+${UNBOUND_ARROW_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${UNBOUND_ARROW_YIELD} Unbound Arrow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - UNBOUND_ARROW_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalShaftsAfter = 0;
    let totalFeathersAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Arrow Shaft') totalShaftsAfter += slot.qty;
        if (slot && slot.name === 'Feather') totalFeathersAfter += slot.qty;
    }
    if (totalShaftsAfter < UNBOUND_ARROW_SHAFT_COST || totalFeathersAfter < UNBOUND_ARROW_FEATHER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingUnboundArrowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / UNBOUND_ARROW_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingUnboundArrowLoop(Date.now(), startTime), 16);
  }
}

// --- Copper Arrow UI & Logic ---
function openFletchCopperArrow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Copper Arrow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${COPPER_ARROW_UNBOUND_COST} Unbound Arrow, ${COPPER_ARROW_TIP_COST} Copper Arrow Tip. Yields ${COPPER_ARROW_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingCopperArrow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingCopperArrow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Copper Arrow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalUnbound = 0;
  let totalTips = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Unbound Arrow') totalUnbound += slot.qty;
      if (slot && slot.name === 'Copper Arrow Tip') totalTips += slot.qty;
  }

  if (totalUnbound < COPPER_ARROW_UNBOUND_COST || totalTips < COPPER_ARROW_TIP_COST) {
      await showGameAlert("Not Enough Materials", `You need ${COPPER_ARROW_UNBOUND_COST} Unbound Arrows and ${COPPER_ARROW_TIP_COST} Copper Arrow Tips.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingCopperArrowLoop(Date.now(), Date.now()), 16);
}

async function fletchingCopperArrowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COPPER_ARROW_TIME_MS) {
    let totalUnbound = 0;
    let totalTips = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unbound Arrow') totalUnbound += slot.qty;
        if (slot && slot.name === 'Copper Arrow Tip') totalTips += slot.qty;
    }
    if (totalUnbound < COPPER_ARROW_UNBOUND_COST || totalTips < COPPER_ARROW_TIP_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Unbound Arrow', COPPER_ARROW_UNBOUND_COST);
    removeItem('Copper Arrow Tip', COPPER_ARROW_TIP_COST);
    addItem('Copper Arrow', COPPER_ARROW_YIELD);
    addXP('fletching', COPPER_ARROW_XP);
    showItemPopup(`+${COPPER_ARROW_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${COPPER_ARROW_YIELD} Copper Arrow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - COPPER_ARROW_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalUnboundAfter = 0;
    let totalTipsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unbound Arrow') totalUnboundAfter += slot.qty;
        if (slot && slot.name === 'Copper Arrow Tip') totalTipsAfter += slot.qty;
    }
    if (totalUnboundAfter < COPPER_ARROW_UNBOUND_COST || totalTipsAfter < COPPER_ARROW_TIP_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingCopperArrowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / COPPER_ARROW_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingCopperArrowLoop(Date.now(), startTime), 16);
  }
}
// +++ END: FLETCHING HUB FUNCTIONS +++

// +++ NEW: CRAFTING HUB FUNCTIONS +++
function openCraftingHub() {
  showMainScreen('hubCrafting');
  // Render the items for the hub
  renderCraftingItems();
}

/**
 * Stops the bow string crafting loop (used by other functions)
 */
window.stopCraftingBowString = function(){
  game.craftingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const bar = document.getElementById('craftProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startCraftBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopCraftBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}


// +++ NEW: GEM CRAFTING CONSTANTS +++
const CRAFTING_GEM_LVL = 30;
const GEM_CUT_XP = 150; // Decent XP for rare items
const GEM_CUT_TIME_MS = 3000;

/**
 * Renders the items available at the Crafting Bench
 */
function renderCraftingItems() {
  const container = document.getElementById('craftingItemsContainer');
  if (!container) return;
  
  const craftLvl = game.crafting.level;
  
  const setupCraftButton = (btnId, locked, onclick, levelReq, tooltipText, itemName) => {
    const btn = document.getElementById(btnId);
    if (btn) {
      const nameHtml = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">${itemName}</div>`;
      if (locked) {
        btn.onclick = null;
        const lockedTT = nameHtml + `<div style="color:#ff8888;">Requires Crafting Lvl: ${levelReq}</div>`;
        btn.onmouseenter = (event) => showTooltip(event, lockedTT);
      } else {
        btn.onclick = onclick;
        const unlockedTT = nameHtml + tooltipText;
        btn.onmouseenter = (event) => showTooltip(event, unlockedTT);
      }
      btn.onmouseleave = hideTooltip;
    }
  };
  
  const bucketLocked = craftLvl < CRAFTING_BUCKET_LVL;
  const bowStringLocked = craftLvl < CRAFTING_BOW_STRING_LVL;
  const emptyVialLocked = craftLvl < CRAFTING_EMPTY_VIAL_LVL;
  const magicStaffLocked = craftLvl < CRAFTING_MAGIC_STAFF_LVL;
  const goldRingLocked = craftLvl < CRAFTING_GOLD_RING_LVL;
  const gemLocked = craftLvl < CRAFTING_GEM_LVL;

  container.innerHTML = `
    <button id="craftBucketBtn" class="primary ${bucketLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/emptybucket.png" alt="Empty Bucket" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftBowStringBtn" class="primary ${bowStringLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/bowstring.png" alt="Bow String" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftEmptyVialBtn" class="primary ${emptyVialLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/emptyvial.png" alt="Empty Vial" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftMagicStaffBtn" class="primary ${magicStaffLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/magicstaff.png" alt="Magic Staff" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftTopazBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/topaz.png" alt="Topaz" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftDiamondBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/diamond.png" alt="Diamond" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain; transform: scale(0.93);">
    </button>
    <button id="craftEmeraldBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/emerald.png" alt="Emerald" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftJadeBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/jade.png" alt="Jade" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftRubyBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/ruby.png" alt="Ruby" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftSapphireBtn" class="primary ${gemLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/sapphire.png" alt="Sapphire" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftGoldRingBtn" class="primary ${goldRingLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/goldring.png" alt="Gold Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftDiamondRingBtn" class="primary ${craftLvl < 40 ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/diamondring.png" alt="Diamond Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftEmeraldRingBtn" class="primary ${craftLvl < 40 ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/emeraldring.png" alt="Emerald Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftRubyRingBtn" class="primary ${craftLvl < 40 ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/rubyring.png" alt="Ruby Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftSapphireRingBtn" class="primary ${craftLvl < 40 ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/sapphirering.png" alt="Sapphire Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="craftTopazRingBtn" class="primary ${craftLvl < 40 ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/topazring.png" alt="Topaz Ring" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
  `;
  
  setupCraftButton('craftBucketBtn', bucketLocked, openCraftBucket, CRAFTING_BUCKET_LVL, `Requires: ${BUCKET_OAK_COST} Oak`, `Empty Bucket`);
  setupCraftButton('craftBowStringBtn', bowStringLocked, openCraftBowString, CRAFTING_BOW_STRING_LVL, `Requires: ${BOW_STRING_SILK_COST} Silk`, `Bow String`);
  setupCraftButton('craftEmptyVialBtn', emptyVialLocked, openCraftEmptyVial, CRAFTING_EMPTY_VIAL_LVL, `Requires: ${EMPTY_VIAL_SAND_COST} Sand, ${EMPTY_VIAL_COAL_COST} Coal Ore`, `Empty Vial`);
  setupCraftButton('craftMagicStaffBtn', magicStaffLocked, openCraftMagicStaff, CRAFTING_MAGIC_STAFF_LVL, `Requires: 10 Oak, 10 Earth/Air/Water Crystals`, 'Magic Staff');
  setupCraftButton('craftTopazBtn', gemLocked, () => openCraftGem('Topaz'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Topaz`, 'Topaz');
  setupCraftButton('craftDiamondBtn', gemLocked, () => openCraftGem('Diamond'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Diamond`, 'Diamond');
  setupCraftButton('craftEmeraldBtn', gemLocked, () => openCraftGem('Emerald'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Emerald`, 'Emerald');
  setupCraftButton('craftJadeBtn', gemLocked, () => openCraftGem('Jade'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Jade`, 'Jade');
  setupCraftButton('craftRubyBtn', gemLocked, () => openCraftGem('Ruby'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Ruby`, 'Ruby');
  setupCraftButton('craftSapphireBtn', gemLocked, () => openCraftGem('Sapphire'), CRAFTING_GEM_LVL, `Requires: 1 Uncut Sapphire`, 'Sapphire');
  setupCraftButton('craftGoldRingBtn', goldRingLocked, openCraftGoldRing, CRAFTING_GOLD_RING_LVL, `Requires: ${GOLD_RING_BAR_COST} Gold Bars`, 'Gold Ring');
  setupCraftButton('craftDiamondRingBtn', craftLvl < 40, () => openCraftGemRing('Diamond'), 40, `Requires: 1 Gold Ring, 1 Diamond`, 'Diamond Ring');
  setupCraftButton('craftEmeraldRingBtn', craftLvl < 40, () => openCraftGemRing('Emerald'), 40, `Requires: 1 Gold Ring, 1 Emerald`, 'Emerald Ring');
  setupCraftButton('craftRubyRingBtn', craftLvl < 40, () => openCraftGemRing('Ruby'), 40, `Requires: 1 Gold Ring, 1 Ruby`, 'Ruby Ring');
  setupCraftButton('craftSapphireRingBtn', craftLvl < 40, () => openCraftGemRing('Sapphire'), 40, `Requires: 1 Gold Ring, 1 Sapphire`, 'Sapphire Ring');
  setupCraftButton('craftTopazRingBtn', craftLvl < 40, () => openCraftGemRing('Topaz'), 40, `Requires: 1 Gold Ring, 1 Topaz`, 'Topaz Ring');
}

// =================================================================
// +++ NEW: GEM CRAFTING LOGIC +++
// =================================================================

function openCraftGem(gemType) {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching(); 
  
  const uncutName = `Uncut ${gemType}`;
  const cutName = gemType;

  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - ${cutName}</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 ${uncutName}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Cutting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  
  document.getElementById('startCraftBtn').onclick = () => startCraftingGem(gemType);
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Re-use generic stop
  showMainScreen('hubDynamic');
}

async function startCraftingGem(gemType) {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active.");
    return;
  }
  
  const uncutName = `Uncut ${gemType}`;
  const cutName = gemType;

  // Inventory Check
  if (!canReceiveItem(cutName)) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  // Material Check
  let totalUncut = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === uncutName) totalUncut += slot.qty;
  }

  if (totalUncut < 1) {
      await showGameAlert("Not Enough Materials", `You need at least 1 ${uncutName}.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingGemLoop(Date.now(), Date.now(), gemType), 16);
}

async function craftingGemLoop(timestamp, startTime, gemType) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  const uncutName = `Uncut ${gemType}`;
  const cutName = gemType;

  if (elapsed >= GEM_CUT_TIME_MS) {
    let totalUncut = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === uncutName) totalUncut += slot.qty;
    }
    if (totalUncut < 1) {
        await showGameAlert("Out of Materials", `You've run out of ${uncutName}.`);
        stopCraftingBowString();
        return;
    }
    
    removeItem(uncutName, 1);
    addItem(cutName, 1);
    addXP('crafting', GEM_CUT_XP);
    
    showItemPopup(`+${GEM_CUT_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 ${cutName}`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - GEM_CUT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    // Check for next iteration
    let totalUncutAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === uncutName) totalUncutAfter += slot.qty;
    }
    if (totalUncutAfter < 1) {
        await showGameAlert("Not Enough Materials", `You don't have enough ${uncutName} to make more.`);
        stopCraftingBowString();
        return;
    }
    
    return craftingGemLoop(Date.now(), newStartTime, gemType);

  } else {
    const progress = (elapsed / GEM_CUT_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingGemLoop(Date.now(), startTime, gemType), 16);
  }
}


// --- Empty Vial UI & Logic ---
function openCraftEmptyVial(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching(); 
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Empty Vial</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${EMPTY_VIAL_SAND_COST} Sand, ${EMPTY_VIAL_COAL_COST} Coal Ore.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingEmptyVial;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Reuse generic stop
  showMainScreen('hubDynamic');
}

async function startCraftingEmptyVial() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  
  if (!canReceiveItem('Empty Vial')) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalSand = 0;
  let totalCoal = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Sand') totalSand += slot.qty;
      if (slot && slot.name === 'Coal Ore') totalCoal += slot.qty;
  }

  if (totalSand < EMPTY_VIAL_SAND_COST || totalCoal < EMPTY_VIAL_COAL_COST) {
      await showGameAlert("Not Enough Materials", `You need ${EMPTY_VIAL_SAND_COST} Sand and ${EMPTY_VIAL_COAL_COST} Coal Ore.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingEmptyVialLoop(Date.now(), Date.now()), 16);
}

async function craftingEmptyVialLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= EMPTY_VIAL_TIME_MS) {
    let totalSand = 0;
    let totalCoal = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Sand') totalSand += slot.qty;
        if (slot && slot.name === 'Coal Ore') totalCoal += slot.qty;
    }
    if (totalSand < EMPTY_VIAL_SAND_COST || totalCoal < EMPTY_VIAL_COAL_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Sand', EMPTY_VIAL_SAND_COST);
    removeItem('Coal Ore', EMPTY_VIAL_COAL_COST);
    addItem('Empty Vial', 1);
    addXP('crafting', EMPTY_VIAL_XP);
    showItemPopup(`+${EMPTY_VIAL_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 Empty Vial`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - EMPTY_VIAL_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalSandAfter = 0;
    let totalCoalAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Sand') totalSandAfter += slot.qty;
        if (slot && slot.name === 'Coal Ore') totalCoalAfter += slot.qty;
    }
    if (totalSandAfter < EMPTY_VIAL_SAND_COST || totalCoalAfter < EMPTY_VIAL_COAL_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingEmptyVialLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / EMPTY_VIAL_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingEmptyVialLoop(Date.now(), startTime), 16);
  }
}

// --- Empty Bucket UI & Logic ---
function openCraftBucket(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching(); 
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Empty Bucket</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${BUCKET_OAK_COST} Oak.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingBucket;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Reuse generic stop
  showMainScreen('hubDynamic');
}

async function startCraftingBucket() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  
  if (!canReceiveItem('Empty Bucket')) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalOak = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Oak') totalOak += slot.qty;
  }

  if (totalOak < BUCKET_OAK_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${BUCKET_OAK_COST} Oak.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingBucketLoop(Date.now(), Date.now()), 16);
}

async function craftingBucketLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= BUCKET_TIME_MS) {
    let totalOak = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalOak += slot.qty;
    }
    if (totalOak < BUCKET_OAK_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Oak', BUCKET_OAK_COST);
    addItem('Empty Bucket', 1);
    addXP('crafting', BUCKET_XP);
    showItemPopup(`+${BUCKET_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 Empty Bucket`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - BUCKET_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalOakAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalOakAfter += slot.qty;
    }
    if (totalOakAfter < BUCKET_OAK_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingBucketLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / BUCKET_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingBucketLoop(Date.now(), startTime), 16);
  }
}

// --- Bow String UI & Logic ---
function openCraftBowString(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching(); // Stop other skills
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Bow String</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${BOW_STRING_SILK_COST} Silk. Yields ${BOW_STRING_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingBowString;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Use the global-scoped function
  showMainScreen('hubDynamic');
}

async function startCraftingBowString() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Bow String')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalSilk = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Silk') totalSilk += slot.qty;
  }

  if (totalSilk < BOW_STRING_SILK_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${BOW_STRING_SILK_COST} Silk.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingBowStringLoop(Date.now(), Date.now()), 16);
}

async function craftingBowStringLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= BOW_STRING_TIME_MS) {
    let totalSilk = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Silk') totalSilk += slot.qty;
    }
    if (totalSilk < BOW_STRING_SILK_COST) {
        await showGameAlert("Out of Materials", "You've run out of Silk.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Silk', BOW_STRING_SILK_COST);
    addItem('Bow String', BOW_STRING_YIELD);
    addXP('crafting', BOW_STRING_XP);
    showItemPopup(`+${BOW_STRING_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+${BOW_STRING_YIELD} Bow String`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - BOW_STRING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalSilkAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Silk') totalSilkAfter += slot.qty;
    }
    if (totalSilkAfter < BOW_STRING_SILK_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Silk to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingBowStringLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / BOW_STRING_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingBowStringLoop(Date.now(), startTime), 16);
  }
}
// +++ END: CRAFTING HUB FUNCTIONS +++

// +++ NEW: LEATHER CRAFTING FUNCTIONS +++

// --- Leather Boots UI & Logic ---
function openCraftLeatherBoots(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Leather Boots</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${LEATHER_BOOTS_LEATHER_COST} Leather.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingLeatherBoots;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Can reuse the same stop function
  showMainScreen('hubDynamic');
}

async function startCraftingLeatherBoots() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Leather Boots')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalLeather = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Leather') totalLeather += slot.qty;
  }

  if (totalLeather < LEATHER_BOOTS_LEATHER_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${LEATHER_BOOTS_LEATHER_COST} Leather.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingLeatherBootsLoop(Date.now(), Date.now()), 16);
}

async function craftingLeatherBootsLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= LEATHER_BOOTS_TIME_MS) {
    let totalLeather = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeather += slot.qty;
    }
    if (totalLeather < LEATHER_BOOTS_LEATHER_COST) {
        await showGameAlert("Out of Materials", "You've run out of Leather.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Leather', LEATHER_BOOTS_LEATHER_COST);
    addItem('Leather Boots', 1);
    addXP('tailoring', LEATHER_BOOTS_XP);
    showItemPopup(`+${LEATHER_BOOTS_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Leather Boots`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - LEATHER_BOOTS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalLeatherAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeatherAfter += slot.qty;
    }
    if (totalLeatherAfter < LEATHER_BOOTS_LEATHER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Leather to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingLeatherBootsLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / LEATHER_BOOTS_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingLeatherBootsLoop(Date.now(), startTime), 16);
  }
}

// --- Leather Hood UI & Logic ---
function openCraftLeatherHood(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Leather Hood</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${LEATHER_HOOD_LEATHER_COST} Leather.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingLeatherHood;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingLeatherHood() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Leather Hood')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalLeather = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Leather') totalLeather += slot.qty;
  }

  if (totalLeather < LEATHER_HOOD_LEATHER_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${LEATHER_HOOD_LEATHER_COST} Leather.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingLeatherHoodLoop(Date.now(), Date.now()), 16);
}

async function craftingLeatherHoodLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= LEATHER_HOOD_TIME_MS) {
    let totalLeather = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeather += slot.qty;
    }
    if (totalLeather < LEATHER_HOOD_LEATHER_COST) {
        await showGameAlert("Out of Materials", "You've run out of Leather.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Leather', LEATHER_HOOD_LEATHER_COST);
    addItem('Leather Hood', 1);
    addXP('tailoring', LEATHER_HOOD_XP);
    showItemPopup(`+${LEATHER_HOOD_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Leather Hood`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - LEATHER_HOOD_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalLeatherAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeatherAfter += slot.qty;
    }
    if (totalLeatherAfter < LEATHER_HOOD_LEATHER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Leather to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingLeatherHoodLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / LEATHER_HOOD_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingLeatherHoodLoop(Date.now(), startTime), 16);
  }
}

// --- Leather Chaps UI & Logic ---
function openCraftLeatherChaps(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Leather Chaps</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${LEATHER_CHAPS_LEATHER_COST} Leather.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingLeatherChaps;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingLeatherChaps() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Leather Chaps')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalLeather = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Leather') totalLeather += slot.qty;
  }

  if (totalLeather < LEATHER_CHAPS_LEATHER_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${LEATHER_CHAPS_LEATHER_COST} Leather.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingLeatherChapsLoop(Date.now(), Date.now()), 16);
}

async function craftingLeatherChapsLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= LEATHER_CHAPS_TIME_MS) {
    let totalLeather = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeather += slot.qty;
    }
    if (totalLeather < LEATHER_CHAPS_LEATHER_COST) {
        await showGameAlert("Out of Materials", "You've run out of Leather.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Leather', LEATHER_CHAPS_LEATHER_COST);
    addItem('Leather Chaps', 1);
    addXP('tailoring', LEATHER_CHAPS_XP);
    showItemPopup(`+${LEATHER_CHAPS_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Leather Chaps`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - LEATHER_CHAPS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalLeatherAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeatherAfter += slot.qty;
    }
    if (totalLeatherAfter < LEATHER_CHAPS_LEATHER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Leather to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingLeatherChapsLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / LEATHER_CHAPS_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingLeatherChapsLoop(Date.now(), startTime), 16);
  }
}

// --- Leather Body UI & Logic ---
function openCraftLeatherBody(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Leather Body</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${LEATHER_BODY_LEATHER_COST} Leather.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingLeatherBody;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingLeatherBody() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Leather Body')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalLeather = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Leather') totalLeather += slot.qty;
  }

  if (totalLeather < LEATHER_BODY_LEATHER_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${LEATHER_BODY_LEATHER_COST} Leather.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingLeatherBodyLoop(Date.now(), Date.now()), 16);
}

async function craftingLeatherBodyLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= LEATHER_BODY_TIME_MS) {
    let totalLeather = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeather += slot.qty;
    }
    if (totalLeather < LEATHER_BODY_LEATHER_COST) {
        await showGameAlert("Out of Materials", "You've run out of Leather.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Leather', LEATHER_BODY_LEATHER_COST);
    addItem('Leather Body', 1);
    addXP('tailoring', LEATHER_BODY_XP);
    showItemPopup(`+${LEATHER_BODY_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Leather Body`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - LEATHER_BODY_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalLeatherAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Leather') totalLeatherAfter += slot.qty;
    }
    if (totalLeatherAfter < LEATHER_BODY_LEATHER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Leather to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingLeatherBodyLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / LEATHER_BODY_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingLeatherBodyLoop(Date.now(), startTime), 16);
  }
}

// --- Craft Leather (from Hide) UI & Logic ---
function openCraftLeather(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Leather</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${LEATHER_HIDE_COST} Cow Hide.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingLeather;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingLeather() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Leather')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.craftingActive) return;

  let totalHide = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Cow Hide') totalHide += slot.qty;
  }

  if (totalHide < LEATHER_HIDE_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${LEATHER_HIDE_COST} Cow Hide.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingLeatherLoop(Date.now(), Date.now()), 16);
}

async function craftingLeatherLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= LEATHER_TIME_MS) {
    let totalHide = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cow Hide') totalHide += slot.qty;
    }
    if (totalHide < LEATHER_HIDE_COST) {
        await showGameAlert("Out of Materials", "You've run out of Cow Hide.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Cow Hide', LEATHER_HIDE_COST);
    addItem('Leather', 1);
    addXP('tailoring', LEATHER_XP);
    showItemPopup(`+${LEATHER_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Leather`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - LEATHER_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalHideAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cow Hide') totalHideAfter += slot.qty;
    }
    if (totalHideAfter < LEATHER_HIDE_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Cow Hide to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingLeatherLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / LEATHER_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingLeatherLoop(Date.now(), startTime), 16);
  }
}

// +++ END: LEATHER CRAFTING FUNCTIONS +++


// +++ NEW: CLOTH & WIZARD GEAR CRAFTING FUNCTIONS +++

// --- Craft Cloth (from Silk) UI & Logic ---
function openCraftCloth(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Cloth</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${CLOTH_SILK_COST} Silk. Yields ${CLOTH_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingCloth;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString; // Generic stop
  showMainScreen('hubDynamic');
}

async function startCraftingCloth() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Cloth')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalSilk = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Silk') totalSilk += slot.qty;
  }

  if (totalSilk < CLOTH_SILK_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${CLOTH_SILK_COST} Silk.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingClothLoop(Date.now(), Date.now()), 16);
}

async function craftingClothLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= CLOTH_TIME_MS) {
    let totalSilk = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Silk') totalSilk += slot.qty;
    }
    if (totalSilk < CLOTH_SILK_COST) {
        await showGameAlert("Out of Materials", "You've run out of Silk.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Silk', CLOTH_SILK_COST);
    addItem('Cloth', CLOTH_YIELD);
    addXP('tailoring', CLOTH_XP);
    showItemPopup(`+${CLOTH_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+${CLOTH_YIELD} Cloth`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - CLOTH_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalSilkAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Silk') totalSilkAfter += slot.qty;
    }
    if (totalSilkAfter < CLOTH_SILK_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Silk to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingClothLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / CLOTH_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingClothLoop(Date.now(), startTime), 16);
  }
}

// --- Wizard Boots UI & Logic ---
function openCraftWizardBoots(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Wizard Boots</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${WIZARD_BOOTS_CLOTH_COST} Cloth.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingWizardBoots;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingWizardBoots() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Wizard Boots')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalCloth = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
  }

  if (totalCloth < WIZARD_BOOTS_CLOTH_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${WIZARD_BOOTS_CLOTH_COST} Cloth.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingWizardBootsLoop(Date.now(), Date.now()), 16);
}

async function craftingWizardBootsLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= WIZARD_BOOTS_TIME_MS) {
    let totalCloth = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
    }
    if (totalCloth < WIZARD_BOOTS_CLOTH_COST) {
        await showGameAlert("Out of Materials", "You've run out of Cloth.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Cloth', WIZARD_BOOTS_CLOTH_COST);
    addItem('Wizard Boots', 1);
    addXP('tailoring', WIZARD_BOOTS_XP);
    showItemPopup(`+${WIZARD_BOOTS_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Wizard Boots`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - WIZARD_BOOTS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalClothAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalClothAfter += slot.qty;
    }
    if (totalClothAfter < WIZARD_BOOTS_CLOTH_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Cloth to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingWizardBootsLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / WIZARD_BOOTS_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingWizardBootsLoop(Date.now(), startTime), 16);
  }
}

// --- Wizard Hat UI & Logic ---
function openCraftWizardHat(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Wizard Hat</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${WIZARD_HAT_CLOTH_COST} Cloth.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingWizardHat;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingWizardHat() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Wizard Hat')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalCloth = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
  }

  if (totalCloth < WIZARD_HAT_CLOTH_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${WIZARD_HAT_CLOTH_COST} Cloth.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingWizardHatLoop(Date.now(), Date.now()), 16);
}

async function craftingWizardHatLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= WIZARD_HAT_TIME_MS) {
    let totalCloth = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
    }
    if (totalCloth < WIZARD_HAT_CLOTH_COST) {
        await showGameAlert("Out of Materials", "You've run out of Cloth.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Cloth', WIZARD_HAT_CLOTH_COST);
    addItem('Wizard Hat', 1);
    addXP('tailoring', WIZARD_HAT_XP);
    showItemPopup(`+${WIZARD_HAT_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Wizard Hat`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - WIZARD_HAT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalClothAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalClothAfter += slot.qty;
    }
    if (totalClothAfter < WIZARD_HAT_CLOTH_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Cloth to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingWizardHatLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / WIZARD_HAT_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingWizardHatLoop(Date.now(), startTime), 16);
  }
}

// --- Wizard Trousers UI & Logic ---
function openCraftWizardTrousers(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Wizard Trousers</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${WIZARD_TROUSERS_CLOTH_COST} Cloth.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingWizardTrousers;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingWizardTrousers() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Wizard Trousers')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalCloth = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
  }

  if (totalCloth < WIZARD_TROUSERS_CLOTH_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${WIZARD_TROUSERS_CLOTH_COST} Cloth.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingWizardTrousersLoop(Date.now(), Date.now()), 16);
}

async function craftingWizardTrousersLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= WIZARD_TROUSERS_TIME_MS) {
    let totalCloth = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
    }
    if (totalCloth < WIZARD_TROUSERS_CLOTH_COST) {
        await showGameAlert("Out of Materials", "You've run out of Cloth.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Cloth', WIZARD_TROUSERS_CLOTH_COST);
    addItem('Wizard Trousers', 1);
    addXP('tailoring', WIZARD_TROUSERS_XP);
    showItemPopup(`+${WIZARD_TROUSERS_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Wizard Trousers`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - WIZARD_TROUSERS_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalClothAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalClothAfter += slot.qty;
    }
    if (totalClothAfter < WIZARD_TROUSERS_CLOTH_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Cloth to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingWizardTrousersLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / WIZARD_TROUSERS_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingWizardTrousersLoop(Date.now(), startTime), 16);
  }
}

// --- Wizard Robe UI & Logic ---
function openCraftWizardRobe(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Wizard Robe</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${WIZARD_ROBE_CLOTH_COST} Cloth.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openTailoringHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingWizardRobe;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingWizardRobe() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Wizard Robe')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalCloth = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
  }

  if (totalCloth < WIZARD_ROBE_CLOTH_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${WIZARD_ROBE_CLOTH_COST} Cloth.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingWizardRobeLoop(Date.now(), Date.now()), 16);
}

async function craftingWizardRobeLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= WIZARD_ROBE_TIME_MS) {
    let totalCloth = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalCloth += slot.qty;
    }
    if (totalCloth < WIZARD_ROBE_CLOTH_COST) {
        await showGameAlert("Out of Materials", "You've run out of Cloth.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Cloth', WIZARD_ROBE_CLOTH_COST);
    addItem('Wizard Robe', 1);
    addXP('tailoring', WIZARD_ROBE_XP);
    showItemPopup(`+${WIZARD_ROBE_XP} Tailoring XP`, 'craftProgress', 0);
    showItemPopup(`+1 Wizard Robe`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - WIZARD_ROBE_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalClothAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Cloth') totalClothAfter += slot.qty;
    }
    if (totalClothAfter < WIZARD_ROBE_CLOTH_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Cloth to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingWizardRobeLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / WIZARD_ROBE_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingWizardRobeLoop(Date.now(), startTime), 16);
  }
}

// +++ NEW: Magic Staff Crafting Functions +++
function openCraftMagicStaff(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Magic Staff</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 10 Oak, 10 Earth Crystal, 10 Air Crystal, 10 Water Crystal.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingMagicStaff;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingMagicStaff() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  if (!canReceiveItem('Magic Staff')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.craftingActive) return;

  let totalOak = 0, totalEarth = 0, totalAir = 0, totalWater = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Oak') totalOak += slot.qty;
      if (slot && slot.name === 'Earth Crystal Shard') totalEarth += slot.qty;
      if (slot && slot.name === 'Air Crystal Shard') totalAir += slot.qty;
      if (slot && slot.name === 'Water Crystal Shard') totalWater += slot.qty;
  }

  if (totalOak < MAGIC_STAFF_OAK_COST || totalEarth < MAGIC_STAFF_EARTH_COST || totalAir < MAGIC_STAFF_AIR_COST || totalWater < MAGIC_STAFF_WATER_COST) {
      await showGameAlert("Not Enough Materials", `You need 10 Oak, 10 Earth, 10 Air, and 10 Water Crystals.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingMagicStaffLoop(Date.now(), Date.now()), 16);
}

function openCraftGemRing(gemType) {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const ringName = `${gemType} Ring`;
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - ${ringName}</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 1 Gold Ring and 1 ${gemType}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = () => startCraftingGemRing(gemType);
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingGemRing(gemType) {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active.");
    return;
  }
  const ringName = `${gemType} Ring`;
  if (!canReceiveItem(ringName)) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  if (game.craftingActive) return;

  let hasGoldRing = false;
  let hasGem = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Gold Ring') hasGoldRing = true;
      if (slot && slot.name === gemType) hasGem = true;
  }

  if (!hasGoldRing || !hasGem) {
      await showGameAlert("Not Enough Materials", `You need 1 Gold Ring and 1 ${gemType}.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingGemRingLoop(Date.now(), Date.now(), gemType), 16);
}

async function craftingGemRingLoop(timestamp, startTime, gemType) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;
  const ringName = `${gemType} Ring`;

  if (elapsed >= GEM_RING_CRAFT_TIME_MS) {
    let hasGoldRing = false;
    let hasGem = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Gold Ring') hasGoldRing = true;
        if (slot && slot.name === gemType) hasGem = true;
    }

    if (!hasGoldRing || !hasGem) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        window.stopCraftingBowString();
        return;
    }
    
    removeItem('Gold Ring', 1);
    removeItem(gemType, 1);
    addItem(ringName, 1);
    addXP('crafting', GEM_RING_CRAFT_XP);
    showItemPopup(`+${GEM_RING_CRAFT_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 ${ringName}`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    const overdueTime = elapsed - GEM_RING_CRAFT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    return craftingGemRingLoop(Date.now(), newStartTime, gemType);
  } else {
    const progress = (elapsed / GEM_RING_CRAFT_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingGemRingLoop(Date.now(), startTime, gemType), 16);
  }
}


function openCraftGoldRing() {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Crafting - Gold Ring</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${GOLD_RING_BAR_COST} Gold Bars.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="craftProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startCraftBtn" class="primary">Start Crafting</button>
      <button id="stopCraftBtn" class="primary" style="background:#555; display:none;">Stop Crafting</button>
      <button onclick="openCraftingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startCraftBtn').onclick = startCraftingGoldRing;
  document.getElementById('stopCraftBtn').onclick = window.stopCraftingBowString;
  showMainScreen('hubDynamic');
}

async function startCraftingGoldRing() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  if (!canReceiveItem('Gold Ring')) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  if (game.craftingActive) return;

  let totalBars = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Gold Bar') totalBars += slot.qty;
  }

  if (totalBars < GOLD_RING_BAR_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${GOLD_RING_BAR_COST} Gold Bars.`);
      return;
  }
  
  game.craftingActive = true;
  document.getElementById('startCraftBtn').style.display = 'none';
  document.getElementById('stopCraftBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => craftingGoldRingLoop(Date.now(), Date.now()), 16);
}

async function craftingGoldRingLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= GOLD_RING_TIME_MS) {
    let totalBars = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Gold Bar') totalBars += slot.qty;
    }
    if (totalBars < GOLD_RING_BAR_COST) {
        await showGameAlert("Out of Materials", "You've run out of Gold Bars.");
        window.stopCraftingBowString();
        return;
    }
    
    removeItem('Gold Bar', GOLD_RING_BAR_COST);
    addItem('Gold Ring', 1);
    addXP('crafting', GOLD_RING_XP);
    showItemPopup(`+${GOLD_RING_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 Gold Ring`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - GOLD_RING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalBarsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Gold Bar') totalBarsAfter += slot.qty;
    }
    if (totalBarsAfter < GOLD_RING_BAR_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Gold Bars to make more.");
        window.stopCraftingBowString();
        return;
    }
    
    return craftingGoldRingLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / GOLD_RING_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingGoldRingLoop(Date.now(), startTime), 16);
  }
}


async function craftingMagicStaffLoop(timestamp, startTime) {
  if (!game.craftingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= MAGIC_STAFF_TIME_MS) {
    let totalOak = 0, totalEarth = 0, totalAir = 0, totalWater = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalOak += slot.qty;
        if (slot && slot.name === 'Earth Crystal Shard') totalEarth += slot.qty;
        if (slot && slot.name === 'Air Crystal Shard') totalAir += slot.qty;
        if (slot && slot.name === 'Water Crystal Shard') totalWater += slot.qty;
    }

    if (totalOak < MAGIC_STAFF_OAK_COST || totalEarth < MAGIC_STAFF_EARTH_COST || totalAir < MAGIC_STAFF_AIR_COST || totalWater < MAGIC_STAFF_WATER_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopCraftingBowString();
        return;
    }
    
    removeItem('Oak', MAGIC_STAFF_OAK_COST);
    removeItem('Earth Crystal Shard', MAGIC_STAFF_EARTH_COST);
    removeItem('Air Crystal Shard', MAGIC_STAFF_AIR_COST);
    removeItem('Water Crystal Shard', MAGIC_STAFF_WATER_COST);
    
    addItem('Magic Staff', 1);
    addXP('crafting', MAGIC_STAFF_XP);
    showItemPopup(`+${MAGIC_STAFF_XP} Crafting XP`, 'craftProgress', 0);
    showItemPopup(`+1 Magic Staff`, 'craftProgress', 450);
    
    document.getElementById('craftProgress').style.width = '0%';
    
    const overdueTime = elapsed - MAGIC_STAFF_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    // Check again for next loop
    let totalOakAfter = 0, totalEarthAfter = 0, totalAirAfter = 0, totalWaterAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalOakAfter += slot.qty;
        if (slot && slot.name === 'Earth Crystal Shard') totalEarthAfter += slot.qty;
        if (slot && slot.name === 'Air Crystal Shard') totalAirAfter += slot.qty;
        if (slot && slot.name === 'Water Crystal Shard') totalWaterAfter += slot.qty;
    }

    if (totalOakAfter < MAGIC_STAFF_OAK_COST || totalEarthAfter < MAGIC_STAFF_EARTH_COST || totalAirAfter < MAGIC_STAFF_AIR_COST || totalWaterAfter < MAGIC_STAFF_WATER_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopCraftingBowString();
        return;
    }
    
    return craftingMagicStaffLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / MAGIC_STAFF_TIME_MS) * 100;
    document.getElementById('craftProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => craftingMagicStaffLoop(Date.now(), startTime), 16);
  }
}

// =================================================================
// +++ NEW: STONE FORGING FUNCTIONS +++
// =================================================================

const STONE_CRAFT_TIME_MS = 3000;
const STONE_CRAFT_XP = 40; 
const STONE_SHARD_COST = 5;

// +++ NEW LEVEL REQUIREMENTS +++
const STONE_FORGE_EARTH_LVL = 1;
const STONE_FORGE_AIR_LVL = 20;
const STONE_FORGE_WATER_LVL = 40;

const CHICKEN_COST = 500;
const CHICKEN_MAX_HP = 10;
const CHICKEN_HP_DECAY_MS = 43200000; // 12 Hours (43,200,000 ms)
const CHICKEN_EGG_TIMER_MS = 43200000; // 12 Hours (43,200,000 ms)
const CHICKEN_SICK_THRESHOLD = 5;
const MAX_CHICKENS = 5; 

// +++ NEW COW CONSTANTS +++
const COW_COST = 1500;
const COW_MAX_HP = 15; // Cows are tougher
const COW_HP_DECAY_MS = 43200000; // 12 Hours
const COW_MILK_TIMER_MS = 43200000; // 12 Hours
const COW_SICK_THRESHOLD = 5;
const MAX_COWS = 5;

// +++ NEW: FARM BUILDING COSTS +++
const COOP_COST = 75000;
const BARN_COST = 150000;
const WELL_COST = 30000;
const GARDEN_COST = 75000;
const CELLAR_BUILDING_COST = 60000; // Added Cellar Cost // +++ NEW +++

// +++ NEW BOUNTY HUNTING CONSTANTS +++
const BOUNTY_TIER_1_TARGETS = ['Rat', 'Spider', 'Chicken', 'Cow', 'Centipede', 'Goblin', 'Crazy Platypus'];
const BOUNTY_TIER_2_TARGETS = ['Crazy Owl', 'The Witch']; 
const BOUNTY_KILL_XP = 8; 
const BOUNTY_REQ_COUNT = 100;

function openTailoringHub() {
  showMainScreen('hubTailoring');
  renderTailoringItems();
}

function stopTailoring() {
  game.tailoringActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const bar = document.getElementById('craftProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startCraftBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopCraftBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

function renderTailoringItems() {
  const container = document.getElementById('tailoringItemsContainer');
  if (!container) return;
  
  const tailLvl = game.tailoring.level;
  
  const setupTailorBtn = (id, locked, onclick, levelReq, tooltipText, itemName) => {
    const btn = document.getElementById(id);
    if (btn) {
      const nameHtml = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">${itemName}</div>`;
      if (locked) {
        btn.onclick = null;
        const lockedTT = nameHtml + `<div style="color:#ff8888;">Requires Tailoring Lvl: ${levelReq}</div>`;
        btn.onmouseenter = (event) => showTooltip(event, lockedTT);
      } else {
        btn.onclick = onclick;
        const unlockedTT = nameHtml + tooltipText;
        btn.onmouseenter = (event) => showTooltip(event, unlockedTT);
      }
      btn.onmouseleave = hideTooltip;
    }
  };

  const leatherLocked = tailLvl < CRAFTING_LEATHER_LVL;
  const clothLocked = tailLvl < CRAFTING_CLOTH_LVL;
  const lBootsLocked = tailLvl < CRAFTING_LEATHER_BOOTS_LVL;
  const lHoodLocked = tailLvl < CRAFTING_LEATHER_HOOD_LVL;
  const lChapsLocked = tailLvl < CRAFTING_LEATHER_CHAPS_LVL;
  const lBodyLocked = tailLvl < CRAFTING_LEATHER_BODY_LVL;
  const wBootsLocked = tailLvl < CRAFTING_WIZARD_BOOTS_LVL;
  const wHatLocked = tailLvl < CRAFTING_WIZARD_HAT_LVL;
  const wTrouLocked = tailLvl < CRAFTING_WIZARD_TROUSERS_LVL;
  const wRobeLocked = tailLvl < CRAFTING_WIZARD_ROBE_LVL;

  container.innerHTML = `
    <button id="tailorLeatherBtn" class="primary ${leatherLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/leather.png" style="width:60px;"></button>
    <button id="tailorClothBtn" class="primary ${clothLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/cloth.png" style="width:60px;"></button>
    <button id="tailorLBootsBtn" class="primary ${lBootsLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/leatherboots.png" style="width:60px;"></button>
    <button id="tailorLHoodBtn" class="primary ${lHoodLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/leatherhood.png" style="width:60px;"></button>
    <button id="tailorLChapsBtn" class="primary ${lChapsLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/leatherpants.png" style="width:60px;"></button>
    <button id="tailorLBodyBtn" class="primary ${lBodyLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/leatherarmor.png" style="width:60px;"></button>
    <button id="tailorWBootsBtn" class="primary ${wBootsLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/wizardboots.png" style="width:60px;"></button>
    <button id="tailorWHatBtn" class="primary ${wHatLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/wizardhat.png" style="width:60px;"></button>
    <button id="tailorWTrouBtn" class="primary ${wTrouLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/wizardtrousers.png" style="width:60px;"></button>
    <button id="tailorWRobeBtn" class="primary ${wRobeLocked ? 'locked-item' : ''}" style="width:var(--slot-size); height:var(--slot-size); padding:0;"><img src="images/wizardrobe.png" style="width:60px;"></button>
  `;

  setupTailorBtn('tailorLeatherBtn', leatherLocked, openCraftLeather, CRAFTING_LEATHER_LVL, `Requires: 1 Cow Hide`, 'Leather');
  setupTailorBtn('tailorClothBtn', clothLocked, openCraftCloth, CRAFTING_CLOTH_LVL, `Requires: 5 Silk`, 'Cloth');
  setupTailorBtn('tailorLBootsBtn', lBootsLocked, openCraftLeatherBoots, CRAFTING_LEATHER_BOOTS_LVL, `Requires: 5 Leather`, 'Leather Boots');
  setupTailorBtn('tailorLHoodBtn', lHoodLocked, openCraftLeatherHood, CRAFTING_LEATHER_HOOD_LVL, `Requires: 5 Leather`, 'Leather Hood');
  setupTailorBtn('tailorLChapsBtn', lChapsLocked, openCraftLeatherChaps, CRAFTING_LEATHER_CHAPS_LVL, `Requires: 10 Leather`, 'Leather Chaps');
  setupTailorBtn('tailorLBodyBtn', lBodyLocked, openCraftLeatherBody, CRAFTING_LEATHER_BODY_LVL, `Requires: 10 Leather`, 'Leather Body');
  setupTailorBtn('tailorWBootsBtn', wBootsLocked, openCraftWizardBoots, CRAFTING_WIZARD_BOOTS_LVL, `Requires: 5 Cloth`, 'Wizard Boots');
  setupTailorBtn('tailorWHatBtn', wHatLocked, openCraftWizardHat, CRAFTING_WIZARD_HAT_LVL, `Requires: 5 Cloth`, 'Wizard Hat');
  setupTailorBtn('tailorWTrouBtn', wTrouLocked, openCraftWizardTrousers, CRAFTING_WIZARD_TROUSERS_LVL, `Requires: 10 Cloth`, 'Wizard Trousers');
  setupTailorBtn('tailorWRobeBtn', wRobeLocked, openCraftWizardRobe, CRAFTING_WIZARD_ROBE_LVL, `Requires: 10 Cloth`, 'Wizard Robe');
}

function openElementalForgeHub() {
  showMainScreen('hubElementalForge');
  renderElementalForgeItems();
}

function renderElementalForgeItems() {
  const container = document.getElementById('elementalForgeItemsContainer');
  if (!container) return;

  const sfLvl = game.stoneforging.level;

  // Check locks
  const earthLocked = sfLvl < STONE_FORGE_EARTH_LVL;
  const airLocked = sfLvl < STONE_FORGE_AIR_LVL;
  const waterLocked = sfLvl < STONE_FORGE_WATER_LVL;
  
  container.innerHTML = `
    <button id="forgeEarthstoneBtn" class="primary ${earthLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/earthstone.png" alt="Earthstone" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="forgeAirstoneBtn" class="primary ${airLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/airstone.png" alt="Airstone" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
    <button id="forgeWaterstoneBtn" class="primary ${waterLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
      <img src="images/waterstone.png" alt="Waterstone" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
    </button>
  `;

  const setupBtn = (id, name, shardsName, func, locked, levelReq) => {
      const btn = document.getElementById(id);
      if(btn) {
        const nameHtml = `<div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${name}</div>`;
        
        // Set color: Red if locked, White if unlocked
        const reqColor = locked ? '#ff8888' : '#fff';
        const levelHtml = `<div style="color:${reqColor};">Requires Stone Forging Lvl: ${levelReq}</div>`;
        
        if (locked) {
          btn.onclick = null;
          // Locked: Show Name + Red Level Requirement
          btn.onmouseenter = (e) => showTooltip(e, nameHtml + levelHtml);
        } else {
          btn.onclick = func;
          // Unlocked: Show Name + White Level Requirement + Materials
          const materialHtml = `Requires: 5 ${shardsName}`;
          btn.onmouseenter = (e) => showTooltip(e, nameHtml + levelHtml + materialHtml);
        }
        btn.onmouseleave = hideTooltip;
      }
  };

  setupBtn('forgeEarthstoneBtn', 'Earthstone', 'Earth Crystal Shards', () => openForgeStone('Earth'), earthLocked, STONE_FORGE_EARTH_LVL);
  setupBtn('forgeAirstoneBtn', 'Airstone', 'Air Crystal Shards', () => openForgeStone('Air'), airLocked, STONE_FORGE_AIR_LVL);
  setupBtn('forgeWaterstoneBtn', 'Waterstone', 'Water Crystal Shards', () => openForgeStone('Water'), waterLocked, STONE_FORGE_WATER_LVL);
}

function stopStoneForging() {
  game.stoneforgingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const bar = document.getElementById('forgeProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startForgeBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopForgeBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

// =================================================================
// +++ NEW: BOUNTY HUNTING FUNCTIONS +++
// =================================================================

// +++ NEW: PERSONAL FARM FUNCTION +++
function openPersonalFarmHub() {
  showMainScreen('hubPersonalFarm');
}

function openPetYardHub() {
  showMainScreen('hubPetYard');
  renderPetYard('pets'); // Default to pets tab
}

function formatPetTime(ms) {
    if (ms < 0) ms = 0;
    const totalSec = Math.ceil(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    return `${h}h ${m}m`;
}

function updatePetTimers() {
    if (!game.pets) return;
    
    // Only run if Pet Yard is open and on "My Pets" tab
    const yard = document.getElementById('hubPetYard');
    const petsContent = document.getElementById('petYardContent');
    // Simple check: if the yard is active and we see a timer element, update them
    if (!yard.classList.contains('active')) return;

    const now = Date.now();
    
    game.pets.forEach(pet => {
        const el = document.getElementById(`pet-timer-${pet.id}`);
        if (el) {
            if (pet.hp <= 0) {
                el.innerHTML = "Status: <span style='color:#ff4d4d'>Sick (Paused)</span>";
            } else {
                const elapsed = now - (pet.lastCalcTime || now);
                const remaining = Math.max(0, PET_HP_DECAY_MS - elapsed);
                const timeStr = formatPetTime(remaining);
                
                // Color it red if less than 1 hour remains
                const color = remaining < 3600000 ? "#ffaaaa" : "#ccc";
                el.innerHTML = `Hunger in: <span style='color:${color}'>${timeStr}</span>`;
            }
        }
    });
}

function renderPetYard(tab) {
    const container = document.getElementById('petYardContent');
    if (!container) return;

    let html = `
        <div class="sub-tabs" style="justify-content: center; margin-bottom: 20px;">
            <button class="${tab === 'pets' ? 'active' : ''}" onclick="renderPetYard('pets')">My Pets</button>
            <button class="${tab === 'hatchery' ? 'active' : ''}" onclick="renderPetYard('hatchery')">Hatchery</button>
        </div>
    `;

    if (tab === 'pets') {
        if (!game.pets || game.pets.length === 0) {
            html += `<div style="text-align:center; color:#888; padding: 20px;">You have no pets yet. Visit the Hatchery!</div>`;
        } else {
            html += `<div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">`;
            
            game.pets.forEach((pet, index) => {
                const config = PET_DATA[pet.type];
                const isEquipped = game.equipment.pet && game.equipment.pet.id === pet.id;
                const hpPercent = (pet.hp / PET_MAX_HP) * 100;
                const hpColor = pet.hp <= 0 ? '#555' : (pet.hp <= 3 ? '#d22' : '#44aa44');
                const status = pet.hp <= 0 ? '<div style="color:#ff4d4d; font-size:10px;">(SICK)</div>' : '';
                
                // Bonus Text
                let bonusText = "No bonus";
                if (pet.type === 'Spider') {
                    if (pet.level >= 40) bonusText = "+2 Phys Dmg";
                    else if (pet.level >= 20) bonusText = "+1 Phys Dmg";
                }

                // Compact Card Style (Timer moved to Tooltip)
                html += `
                <div 
                    style="background:rgba(0,0,0,0.3); border:2px solid ${isEquipped ? 'var(--gold)' : '#553322'}; border-radius:6px; padding:6px; width:110px; text-align:center;"
                    onmouseenter="showPetTooltip(event, '${pet.id}')" 
                    onmouseleave="hideTooltip()"
                >
                    <div style="font-weight:bold; color:var(--gold); font-size:12px; margin-bottom:2px;">${pet.type} Lvl ${pet.level}</div>
                    
                    <img src="images/${config.img}.png" style="width:48px; height:48px; object-fit:contain; opacity:${pet.hp <= 0 ? '0.5' : '1'};">
                    ${status}
                    
                    <div style="background:#333; width:100%; height:4px; border-radius:2px; margin:4px 0;">
                        <div style="background:${hpColor}; width:${hpPercent}%; height:100%; border-radius:2px;"></div>
                    </div>
                    
                    <div style="font-size:10px; color:#aaa; margin-top:-2px;">${pet.hp}/${PET_MAX_HP} HP</div>
                    <div style="font-size:10px; color:#aaffaa; margin:2px 0;">${bonusText}</div>

                    <div style="display:flex; flex-wrap: wrap; gap:4px; justify-content:center; margin-top:6px;">
                        <button class="primary" style="padding:4px 8px; font-size:11px; flex: 1;" onclick="event.stopPropagation(); feedPet('${pet.id}')">Feed</button>
                        <button class="primary" style="padding:4px 8px; font-size:11px; flex: 1; background:${isEquipped ? '#900' : 'var(--accent)'};" onclick="event.stopPropagation(); equipPetFromYard('${pet.id}')">
                            ${isEquipped ? 'Unequip' : 'Equip'}
                        </button>
                        <button class="primary" style="padding:4px 8px; font-size:11px; width: 100%; background:#553322; border: 1px solid #774422;" onclick="event.stopPropagation(); sellPet('${pet.id}')">
                            Sell
                        </button>
                    </div>
                </div>`;
            });
            html += `</div>`;
        }
    } else if (tab === 'hatchery') {
        // Incubator Logic
        const now = Date.now();
        const isActive = game.incubator.active;
        const elapsed = isActive ? now - game.incubator.startTime : 0;
        const isReady = isActive && elapsed >= PET_HATCH_TIME_MS;
        
        let displayImg = isActive ? 'incubator_active.png' : 'incubator_empty.png';
        let buttonHtml = '';
        let timerHtml = '';
        let imgClass = ''; // +++ NEW variable for animation class +++

        if (!isActive) {
            // +++ NEW: DYNAMIC EGG DETECTION +++
            // 1. Find which eggs the player actually has
            const availableEggs = [];
            if (game.inventory) {
                game.inventory.forEach(slot => {
                    // If item is in our EGG_TYPES list and not already added to our button list
                    if (slot && EGG_TYPES[slot.name] && !availableEggs.includes(slot.name)) {
                        availableEggs.push(slot.name);
                    }
                });
            }

            if (availableEggs.length === 0) {
                // No eggs found: Generic message
                timerHtml = `<div style="color:#aaa; margin-bottom:10px;">Requires: Pet Egg</div>`;
                buttonHtml = `<button class="primary" disabled style="background:#555; opacity:0.7;">Incubate Pet Egg</button>`;
            } else {
                // Eggs found: Create a button for each type
                timerHtml = `<div style="color:#efe3cf; margin-bottom:10px;">Select an egg to incubate:</div>`;
                buttonHtml = `<div style="display:flex; flex-direction:column; gap:5px; align-items:center;">`;
                
                availableEggs.forEach(eggName => {
                    // Passes the specific Item Name to the start function
                    buttonHtml += `<button class="primary" onclick="startIncubation('${eggName}')">Incubate ${eggName}</button>`;
                });
                
                buttonHtml += `</div>`;
            }
            // +++ END NEW +++
            
        } else if (isReady) {
            buttonHtml = `<button class="primary" style="background:#44aa44; box-shadow:0 0 10px #44aa44;" onclick="hatchEgg()">HATCH!</button>`;
            timerHtml = `<div style="color:#aaffaa; font-weight:bold; margin-bottom:10px;">Ready to Hatch!</div>`;
            imgClass = 'shake-animation'; // +++ NEW: Add shake class +++
        } else {
            const remaining = PET_HATCH_TIME_MS - elapsed;
            const mins = Math.ceil(remaining / 60000);
            buttonHtml = `<button class="primary" disabled style="background:#555; opacity:0.7;">Incubating...</button>`;
            timerHtml = `<div style="color:var(--gold); font-weight:bold; margin-bottom:10px;">Time left: ${mins}m</div>`;
        }

        // Vertical Center Fix: Height 320px matches the inventory grid exactly
        html += `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 320px;">
                <img src="images/${displayImg}" class="${imgClass}" style="width:120px; height:120px; object-fit:contain; margin-bottom:15px; display: block;">
                ${timerHtml}
                ${buttonHtml}
            </div>
        `;
        
        // Auto-refresh UI if incubating
        if(isActive && !isReady) {
            setTimeout(() => {
                if(document.getElementById('hubPetYard').classList.contains('active')) renderPetYard('hatchery');
            }, 10000); // Refresh every 10s
        }
    }

    container.innerHTML = html;
}

function startIncubation(eggItemName) {
    // Look up the Pet Type (e.g. 'Spider') from the Item Name (e.g. 'Pet Spider Egg')
    const petType = EGG_TYPES[eggItemName];
    
    if (petType) {
        if (removeItem(eggItemName, 1)) {
            game.incubator.active = true;
            game.incubator.startTime = Date.now();
            game.incubator.eggType = petType;
            renderPetYard('hatchery');
            game.isDirty = true;
        } else {
            showGameAlert("Requirement", `You need a ${eggItemName}.`);
        }
    }
}

function hatchEgg() {
    if (!game.incubator.active) return;

    // +++ NEW: MAX PET LIMIT +++
    if (game.pets.length >= 6) {
        showGameAlert("Pet Yard Full", "You can only house 6 pets at a time.");
        return;
    }
    
    // Create new Pet
    const newPet = {
        id: 'pet_' + Date.now(),
        type: game.incubator.eggType,
        level: 1,
        xp: 0,
        hp: PET_MAX_HP,
        lastCalcTime: Date.now()
    };
    
    game.pets.push(newPet);
    
    // Reset Incubator
    game.incubator.active = false;
    game.incubator.eggType = null;
    game.incubator.startTime = 0;
    
    addXP('petmastery', PET_HATCH_XP);
    playGlobalSound('sounds/soundeffects/levelupsound.mp3');
    showGameAlert("Hatched!", `You hatched a level 1 ${newPet.type}!`);
    
    renderPetYard('pets'); // Switch to pets tab
    game.isDirty = true;
}

function feedPet(petId) {
    const pet = game.pets.find(p => p.id === petId);
    if (!pet) return;
    
    if (pet.hp >= PET_MAX_HP) {
        showGameAlert("Full", "This pet is not hungry.");
        return;
    }
    
    const config = PET_DATA[pet.type];
    const food = config.foodItem;
    
    if (removeItem(food, 1)) {
        pet.hp++;
        addXP('petmastery', PET_FEED_XP);
        playGlobalSound('sounds/soundeffects/inventorysound.mp3');
        renderPetYard('pets');
        game.isDirty = true;
    } else {
        showGameAlert("No Food", `This pet eats ${food}.`);
    }
}

function equipPetFromYard(petId) {
    const pet = game.pets.find(p => p.id === petId);
    if (!pet) return;
    
    if (game.equipment.pet && game.equipment.pet.id === petId) {
        // Unequip
        game.equipment.pet = null;
    } else {
        // Equip (Simple reference, not an inventory item)
        game.equipment.pet = { id: pet.id, name: "Pet " + pet.type, type: 'pet' }; 
    }
    
    renderPetYard('pets');
    renderEquipment(); // Update sidebar slot
    game.isDirty = true;
}

async function sellPet(petId) {
    const petIndex = game.pets.findIndex(p => p.id === petId);
    if (petIndex === -1) return;
    
    const pet = game.pets[petIndex];
    
    // Formula: 100 Gold per Level (e.g. Lvl 1 = 100g, Lvl 50 = 5000g)
    const sellPrice = pet.level * 100;
    
    const confirmed = await showGameConfirm("Sell Pet", `Are you sure you want to sell your Lvl ${pet.level} ${pet.type} for ${sellPrice} Gold?`);
    
    if (confirmed) {
        // 1. Unequip if currently equipped
        if (game.equipment.pet && game.equipment.pet.id === petId) {
            game.equipment.pet = null;
            renderEquipment();
        }
        
        // 2. Remove from array
        game.pets.splice(petIndex, 1);
        
        // 3. Add Gold
        addGold(sellPrice);
        
        // 4. Save & Update
        game.isDirty = true;
        renderPetYard('pets');
        await showGameAlert("Pet Sold", `You sold your pet for ${sellPrice} Gold.`);
    }
}

function stopCombat() {
  // Check if we are in combat, then run away/stop
  if (game.inCombat) {
    runFromCombat(false);
  }
}

// --- CELLAR FUNCTIONS ---

async function handleCellarClick() {
   // Initialize if missing (backward compatibility)
   if (!game.farm.buildings) game.farm.buildings = { coop: false, barn: false, well: false, garden: false, cellar: false };

   if (!game.farm.buildings.cellar) {
       // Requirement check
       if (game.farming.level < 1) {
           await showGameAlert("Level Required", "You need Farming Level 1 to clear the Cellar.");
           return;
       }

       const confirmed = await showGameConfirm("Buy Cellar", `Clear and repair the Cellar for ${formatAmount(CELLAR_BUILDING_COST)} Gold?`);
       if (confirmed) {
           if (game.gold >= CELLAR_BUILDING_COST) {
               addGold(-CELLAR_BUILDING_COST);
               game.farm.buildings.cellar = true;
               game.isDirty = true;
               await showGameAlert("Success", "You now have access to the Cellar!");
               
               // Open after purchase
               stopMining();
               stopBlacksmithing();
               stopCombat();
               openCellarHub();
           } else {
               await showGameAlert("Not Enough Gold", `You need ${formatAmount(CELLAR_BUILDING_COST)} Gold.`);
           }
       }
       return;
   }

   // If already owned
   stopMining();
   stopBlacksmithing();
   stopCombat();
   openCellarHub();
}

function openCellarHub() {
  // Attach button listener for the main return button
  const returnBtn = document.getElementById('hubCellar_ReturnBtn');
  if (returnBtn) returnBtn.onclick = openPersonalFarmHub;

  showMainScreen('hubCellar');
}



// +++ NEW: FARM INTERACTION FUNCTIONS +++

async function handleChickenCoopClick() {
   // Initialize if missing (backward compatibility)
   if (!game.farm.buildings) game.farm.buildings = { coop: false, barn: false, well: false };

   if (!game.farm.buildings.coop) {
       // +++ NEW: Level Requirement Check +++
       if (game.farming.level < 1) {
           await showGameAlert("Level Required", "You need Farming Level 1 to buy the Chicken Coop.");
           return;
       }
       // +++ END NEW +++

       const confirmed = await showGameConfirm("Buy Chicken Coop", `Purchase the Chicken Coop for ${formatAmount(COOP_COST)} Gold?`);
       if (confirmed) {
           if (game.gold >= COOP_COST) {
               addGold(-COOP_COST);
               game.farm.buildings.coop = true;
               game.isDirty = true;
               await showGameAlert("Success", "You purchased the Chicken Coop!");
               
               // Open after purchase
               showMainScreen('hubChickenCoop');
               updateCoopUI(); 
           } else {
               await showGameAlert("Not Enough Gold", `You need ${formatAmount(COOP_COST)} Gold.`);
           }
       }
       return;
   }

   showMainScreen('hubChickenCoop');
   updateCoopUI(); 
}

// --- CHICKEN COOP LOGIC ---

function buyChicken() {
    // Ensure array exists
    if (!game.farm.chickens) game.farm.chickens = [];

    if (game.farm.chickens.length >= MAX_CHICKENS) {
        showGameAlert("Coop Full", "You cannot have more than 5 chickens.");
        return;
    }
    if (game.gold < CHICKEN_COST) {
        showGameAlert("Not Enough Gold", `You need ${CHICKEN_COST} Gold.`);
        return;
    }
    
    addGold(-CHICKEN_COST);
    
    // Add new chicken object to array
    game.farm.chickens.push({
        id: Date.now() + Math.random(), // Unique ID
        hp: 10,
        lastCalcTime: Date.now(),
        eggTimer: 0,
        hpDecayAcc: 0,
        storedEggs: 0
    });
    
    game.isDirty = true;
    updateCoopUI();
}

function feedChicken(index) {
    if (!game.farm.chickens || !game.farm.chickens[index]) return;
    
    const c = game.farm.chickens[index];
    
    if (c.hp >= CHICKEN_MAX_HP) {
        showGameAlert("Full Health", "This chicken is already healthy.");
        return;
    }

    // Remove 3 Corn
    if (removeItem('Corn', 3)) {
        c.hp = Math.min(CHICKEN_MAX_HP, c.hp + 1); // Heal 1 HP
        
        // Visual feedback
        playGlobalSound('sounds/soundeffects/inventorysound.mp3'); // Using generic eat sound
        updateCoopUI();
        game.isDirty = true;
    } else {
        showGameAlert("No Food", "You need 3 Corn to feed the chicken.");
    }
}

function collectEggs() {
    if (!game.farm.chickens) return;

    let eggsToCollect = 0;
    let remainingCap = MAX_EGG_COLLECT_LIMIT; // 30

    // 1. Calculate how many we can take (max 30) and update chickens
    game.farm.chickens.forEach(c => {
        if (remainingCap > 0) {
            const available = Math.floor(c.storedEggs);
            const take = Math.min(available, remainingCap);
            
            if (take > 0) {
                c.storedEggs -= take; // Remove taken eggs
                remainingCap -= take;
                eggsToCollect += take;
            }
        }
    });
    
    if (eggsToCollect <= 0) return;
    
    // 2. Check inventory space
    // Note: This simple check assumes 1 slot is enough. 
    // If you collect 30 and stack limit is lower, standard addItem handles the overflow logic.
    if (!canReceiveItem('Egg')) { 
        showGameAlert("Inventory Full", "Make space to collect eggs.");
        // In a real scenario, we might revert the eggs to chickens here, 
        // but for simplicity, we assume visual feedback is enough.
        return;
    }
    
    // 3. Process Rewards
    addItem('Egg', eggsToCollect);
    
    // Award Farming XP
    const xpGained = eggsToCollect * COLLECT_EGG_XP;
    addXP('farming', xpGained);
    showItemPopup(`+${xpGained} Farming XP`, 'collectEggsBtn', 0);
    showItemPopup(`+${eggsToCollect} Eggs`, 'collectEggsBtn', 450);
    
    if (eggsToCollect === MAX_EGG_COLLECT_LIMIT) {
        showWarningPopup("Egg Basket Full (Max 30)");
    }
    
    playGlobalSound('sounds/soundeffects/inventorysound.mp3');
    updateCoopUI();
    game.isDirty = true;
}

function updateCoopUI() {
    const container = document.getElementById('coopSlotsContainer');
    if (!container) return;
    
    // Ensure array exists
    if (!game.farm.chickens) game.farm.chickens = [];

    container.innerHTML = '';

    // 1. Render Active Chickens
    game.farm.chickens.forEach((c, index) => {
        // Calculate visuals
        const hpPercent = (c.hp / CHICKEN_MAX_HP) * 100;
        const hpColor = c.hp < 5 ? "#d22" : "#44aa44";
        
        const div = document.createElement('div');
        div.className = 'chicken-slot';
        div.innerHTML = `
            <div style="background: #333; width: 80px; height: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #000;">
                <div style="width: ${hpPercent}%; height: 100%; background: ${hpColor}; border-radius: 4px;"></div>
            </div>
            
            <img src="images/personalchicken.png" class="chicken-img-active"
                 onmouseenter="showChickenTooltip(event, ${index})" 
                 onmouseleave="hideTooltip()">
            
            <button class="primary feed-btn" onclick="feedChicken(${index})" 
                    onmouseenter="showTooltip(event, 'Feed 3 Corn')" onmouseleave="hideTooltip()">
                Feed
            </button>
        `;
        container.appendChild(div);
    });

    // 2. Render "Buy New" Slot (If under limit)
    if (game.farm.chickens.length < MAX_CHICKENS) {
        const div = document.createElement('div');
        div.className = 'chicken-slot';
        div.style.borderColor = "#444"; // Dimmer border to indicate inactive
        
        div.innerHTML = `
            <div style="height: 8px; margin-bottom: 5px;"></div> <img src="images/personalchicken.png" class="chicken-img-locked">
            <button class="primary feed-btn" style="background:var(--gold); color:black; font-weight:bold;" onclick="buyChicken()">
                Buy (${CHICKEN_COST}g)
            </button>
        `;
        container.appendChild(div);
    }

    // 3. Update Global Egg Counter
    let globalEggs = 0;
    game.farm.chickens.forEach(c => {
        globalEggs += Math.floor(c.storedEggs);
    });
    
    const eggDisplay = document.getElementById('eggCountDisplay');
    const colBtn = document.getElementById('collectEggsBtn');
    if (eggDisplay) eggDisplay.innerText = globalEggs;
    if (colBtn) colBtn.disabled = (globalEggs < 1);
}

// --- COW BARN LOGIC ---

async function handleBarnClick() {
   // Initialize if missing
   if (!game.farm.buildings) game.farm.buildings = { coop: false, barn: false, well: false };

   if (!game.farm.buildings.barn) {
       // +++ NEW: Level Requirement Check +++
       if (game.farming.level < 20) {
           await showGameAlert("Level Required", "You need Farming Level 20 to buy the Barn.");
           return;
       }
       // +++ END NEW +++

       const confirmed = await showGameConfirm("Buy The Barn", `Purchase the Barn for ${formatAmount(BARN_COST)} Gold?`);
       if (confirmed) {
           if (game.gold >= BARN_COST) {
               addGold(-BARN_COST);
               game.farm.buildings.barn = true;
               game.isDirty = true;
               await showGameAlert("Success", "You purchased the Barn!");
               
               // Open after purchase
               showMainScreen('hubBarn');
               updateBarnUI();
           } else {
               await showGameAlert("Not Enough Gold", `You need ${formatAmount(BARN_COST)} Gold.`);
           }
       }
       return;
   }

   showMainScreen('hubBarn');
   updateBarnUI();
}

function buyCow() {
    // Ensure array exists
    if (!game.farm.cows) game.farm.cows = [];

    if (game.farm.cows.length >= MAX_COWS) {
        showGameAlert("Barn Full", "You cannot have more than 5 cows.");
        return;
    }
    if (game.gold < COW_COST) {
        showGameAlert("Not Enough Gold", `You need ${COW_COST} Gold.`);
        return;
    }
    
    addGold(-COW_COST);
    
    game.farm.cows.push({
        id: Date.now() + Math.random(),
        hp: 15,
        lastCalcTime: Date.now(),
        milkTimer: 0,
        hpDecayAcc: 0,
        hasMilk: false // Cows don't stack milk, they just "have it" or not
    });
    
    game.isDirty = true;
    updateBarnUI();
}

function feedCow(index) {
    if (!game.farm.cows || !game.farm.cows[index]) return;
    
    const c = game.farm.cows[index];
    
    if (c.hp >= COW_MAX_HP) {
        showGameAlert("Full Health", "This cow is already healthy.");
        return;
    }

    // Remove 5 Grass
    if (removeItem('Grass', 5)) {
        c.hp = Math.min(COW_MAX_HP, c.hp + 2); // Heals 2 HP because it's bigger
        playGlobalSound('sounds/soundeffects/inventorysound.mp3');
        updateBarnUI();
        game.isDirty = true;
    } else {
        showGameAlert("No Food", "You need 5 Grass to feed the cow.");
    }
}

function collectMilk() {
    if (!game.farm.cows) return;

    // 1. Count cows that have milk ready
    let milkReadyCount = 0;
    game.farm.cows.forEach(c => {
        if (c.hasMilk) milkReadyCount++;
    });

    if (milkReadyCount <= 0) {
        showGameAlert("No Milk", "None of your cows are ready to be milked yet.");
        return;
    }

    // 2. Check for Empty Buckets
    let emptyBuckets = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Empty Bucket') emptyBuckets += slot.qty;
    }

    if (emptyBuckets < 1) {
        showGameAlert("No Buckets", "You need an Empty Bucket to gather milk.");
        return;
    }

    // 3. Calculate how many we can gather (limited by available milk OR available buckets)
    const amountToGather = Math.min(milkReadyCount, emptyBuckets);

    // 4. Process logic
    if (removeItem('Empty Bucket', amountToGather)) {
        addItem('Bucket of Milk', amountToGather);
        
        // Award Farming XP
        const xpGained = amountToGather * COLLECT_MILK_XP;
        addXP('farming', xpGained);
        showItemPopup(`+${xpGained} Farming XP`, 'collectMilkBtn', 0);
        showItemPopup(`+${amountToGather} Milk`, 'collectMilkBtn', 450);

        // Reset the specific cows that were milked
        let gatheredCount = 0;
        for (let c of game.farm.cows) {
            if (c.hasMilk && gatheredCount < amountToGather) {
                c.hasMilk = false;
                c.milkTimer = 0; // Reset timer
                gatheredCount++;
            }
        }

        playGlobalSound('sounds/soundeffects/inventorysound.mp3');
        updateBarnUI();
        game.isDirty = true;
        
        if (amountToGather < milkReadyCount) {
             showGameAlert("Partial Collection", `You collected ${amountToGather} milk, but ran out of buckets for the rest.`);
        }
    }
}

function updateBarnUI() {
    const container = document.getElementById('barnSlotsContainer');
    if (!container) return;
    
    if (!game.farm.cows) game.farm.cows = [];

    container.innerHTML = '';

    // 1. Render Cows
    game.farm.cows.forEach((c, index) => {
        const hpPercent = (c.hp / COW_MAX_HP) * 100;
        const hpColor = c.hp < 5 ? "#d22" : "#44aa44";
        
        // Milk Status Visual
        let statusIndicator = "";
        if (c.hasMilk) {
            // Changed top from 5px to 25px to sit below the HP bar
            statusIndicator = `<div style="position:absolute; top:25px; right:5px; background:#fff; border-radius:50%; width:12px; height:12px; border:2px solid var(--gold); box-shadow:0 0 5px var(--gold);"></div>`;
        }

        const div = document.createElement('div');
        div.className = 'cow-slot';
        div.innerHTML = `
            ${statusIndicator}
            <div style="background: #333; width: 80px; height: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #000;">
                <div style="width: ${hpPercent}%; height: 100%; background: ${hpColor}; border-radius: 4px;"></div>
            </div>
            
            <img src="images/personalcow.png" class="cow-img-active"
                 onmouseenter="showCowTooltip(event, ${index})" 
                 onmouseleave="hideTooltip()">
            
            <button class="primary feed-btn" onclick="feedCow(${index})" 
                    onmouseenter="showTooltip(event, 'Feed 5 Grass')" onmouseleave="hideTooltip()">
                Feed
            </button>
        `;
        container.appendChild(div);
    });

    // 2. Render "Buy New" Slot
    if (game.farm.cows.length < MAX_COWS) {
        const div = document.createElement('div');
        div.className = 'cow-slot';
        div.style.borderColor = "#444";
        div.innerHTML = `
            <div style="height: 8px; margin-bottom: 5px;"></div>
            <img src="images/personalcow.png" class="cow-img-locked">
            <button class="primary feed-btn" style="background:var(--gold); color:black; font-weight:bold;" onclick="buyCow()">
                Buy (${COW_COST}g)
            </button>
        `;
        container.appendChild(div);
    }

    // 3. Update Global Milk Counter
    let milkReady = 0;
    game.farm.cows.forEach(c => { if(c.hasMilk) milkReady++; });
    
    const milkDisplay = document.getElementById('milkReadyDisplay');
    const colBtn = document.getElementById('collectMilkBtn');
    if (milkDisplay) milkDisplay.innerText = `${milkReady} Ready`;
    if (colBtn) colBtn.disabled = (milkReady < 1);
}

// =================================================================
// +++ NEW: GARDEN SYSTEM LOGIC (SVG VERSION) +++
// =================================================================

function renderGarden() {
  if (!game.farm.garden) game.farm.garden = new Array(16).fill(null);

  game.farm.garden.forEach((slotData, index) => {
    const poly = document.getElementById(`garden-poly-${index}`);
    const imgEl = document.getElementById(`garden-img-${index}`);

    if (!poly || !imgEl) return; 

    poly.onmouseleave = hideTooltip;

    if (slotData && slotData.watered) {
        poly.classList.add('watered-soil');
    } else {
        poly.classList.remove('watered-soil');
    }

    if (slotData) {
      const cropDef = CROPS[slotData.crop];
      
      if (!slotData.watered) {
         if (imgEl) imgEl.style.display = 'none';
         poly.onmouseenter = (e) => showTooltip(e, `<div style="color:#ffaaaa;">Needs Water!</div>Click to water`);
      } else {
        const elapsed = Date.now() - slotData.waterTime;
        let stageIndex = 0;
        if (elapsed >= FARM_STAGE_3_TIME) stageIndex = 2;
        else if (elapsed >= FARM_STAGE_2_TIME) stageIndex = 1;
        stageIndex = Math.min(stageIndex, cropDef.stages - 1);
        
        const imgName = cropDef.images[stageIndex];

        if (!imgEl.hasAttribute('data-base-x')) {
            imgEl.setAttribute('data-base-x', imgEl.getAttribute('x'));
            imgEl.setAttribute('data-base-y', imgEl.getAttribute('y'));
        }

        let osX = 0;
        let osY = 0;
        // FIXED: Now correctly checks cropDef instead of shroomDef
        if (cropDef.stageOffsets && cropDef.stageOffsets[stageIndex]) {
            osX = cropDef.stageOffsets[stageIndex].x;
            osY = cropDef.stageOffsets[stageIndex].y;
        }

        const baseX = parseFloat(imgEl.getAttribute('data-base-x'));
        const baseY = parseFloat(imgEl.getAttribute('data-base-y'));
        imgEl.setAttribute('x', baseX + osX);
        imgEl.setAttribute('y', baseY + osY);

        imgEl.style.display = 'block';
        imgEl.setAttribute('href', `images/${imgName}`); 
        
        if (elapsed >= FARM_HARVEST_TIME) {
           imgEl.style.filter = "drop-shadow(0 0 3px #44aa44)";
        } else {
           imgEl.style.filter = "none";
        }
        poly.onmouseenter = (e) => showCropTooltip(e, index);
      }
    } else {
      if (imgEl) imgEl.style.display = 'none';
      poly.onmouseenter = (e) => showTooltip(e, "Empty Plot<br><span style='color:#aaffaa'>Click to plant</span>");
    }
  });
}

// =================================================================
// +++ NEW: CELLAR MUSHROOM SYSTEM +++
// =================================================================

function renderCellar() {
  if (!game.farm.cellar) game.farm.cellar = new Array(16).fill(null);

  game.farm.cellar.forEach((slotData, index) => {
    const poly = document.getElementById(`cellar-poly-${index}`);
    const imgEl = document.getElementById(`cellar-img-${index}`);
    if (!poly || !imgEl) return;

    poly.onmouseleave = hideTooltip;

    if (slotData) {
      const shroomDef = MUSHROOMS[slotData.crop];
      const elapsed = Date.now() - slotData.waterTime; 
      let stageIndex = 0;

      if (elapsed >= FARM_STAGE_3_TIME) stageIndex = 2;
      else if (elapsed >= FARM_STAGE_2_TIME) stageIndex = 1;
      
      const imgName = shroomDef.images[stageIndex];

      // --- COORDINATE LOGIC ---
      if (!imgEl.hasAttribute('data-base-x')) {
          imgEl.setAttribute('data-base-x', imgEl.getAttribute('x'));
          imgEl.setAttribute('data-base-y', imgEl.getAttribute('y'));
      }

      let osX = 0;
      let osY = 0;

      // 1. Check for tile specific offset
      if (shroomDef.tileSpecificOffsets && shroomDef.tileSpecificOffsets[index] && shroomDef.tileSpecificOffsets[index][stageIndex]) {
          osX = shroomDef.tileSpecificOffsets[index][stageIndex].x;
          osY = shroomDef.tileSpecificOffsets[index][stageIndex].y;
      } 
      // 2. Otherwise use global stage offset
      else if (shroomDef.stageOffsets && shroomDef.stageOffsets[stageIndex]) {
          osX = shroomDef.stageOffsets[stageIndex].x;
          osY = shroomDef.stageOffsets[stageIndex].y;
      }

      const baseX = parseFloat(imgEl.getAttribute('data-base-x'));
      const baseY = parseFloat(imgEl.getAttribute('data-base-y'));
      imgEl.setAttribute('x', baseX + osX);
      imgEl.setAttribute('y', baseY + osY);

      // --- VISUALS ---
      imgEl.style.display = 'block';
      imgEl.setAttribute('href', `images/${imgName}`); 
      
      if (elapsed >= FARM_HARVEST_TIME) {
         imgEl.style.filter = "drop-shadow(0 0 5px #b300ff)"; 
      } else {
         imgEl.style.filter = "none";
      }
      poly.onmouseenter = (e) => showShroomTooltip(e, index);
    } else {
      if (imgEl) imgEl.style.display = 'none';
      poly.onmouseenter = (e) => showTooltip(e, "Dark Damp Soil<br><span style='color:#aaffaa'>Click to plant Mushroom</span>");
    }
  });
}

function handleCellarSlotClick(e, index) {
  hideItemContextMenu();
  const slotData = game.farm.cellar[index];
  if (!slotData) {
    showMushroomMenu(e, index);
  } else {
    const elapsed = Date.now() - slotData.waterTime;
    if (elapsed >= FARM_HARVEST_TIME) { 
      harvestMushroom(index);
    }
  }
}

function showMushroomMenu(event, index) {
  const menu = document.getElementById('itemContextMenu');
  let menuContent = `<div style="padding:5px 8px; font-weight:bold; color:var(--gold); border-bottom:1px solid #555;">Plant Mushroom</div>`;
  
  let shroomCount = 0;
  for(const slot of game.inventory) {
    if(slot && slot.name === 'Dirt Shroom') shroomCount += slot.qty;
  }

  if (shroomCount >= DIRT_SHROOM_PLANT_COST) {
     menuContent += `
       <div class="planting-menu-item" onclick="plantMushroom(${index}, 'Dirt Shroom')" style="display:flex; align-items:center; gap:10px; padding:8px; cursor:pointer;">
          <img src="images/dirtshroom.png" style="width:32px; height:32px;">
          <div>
            <div>Dirt Shroom</div>
            <div style="font-size:11px; color:#aaa;">Cost: ${DIRT_SHROOM_PLANT_COST} Shrooms</div>
          </div>
       </div>
     `;
  } else {
    menuContent += `<div style="padding:10px; font-style:italic; color:#ffaaaa; font-size:12px;">Need 10 Dirt Shrooms to plant.</div>`;
  }

  menu.innerHTML = menuContent;
  menu.style.display = 'block';
  const rect = document.body.getBoundingClientRect();
  menu.style.left = (event.clientX - rect.left + 5) + 'px';
  menu.style.top = (event.clientY - rect.top + 5) + 'px';

  setTimeout(() => {
    document.addEventListener('click', hideItemContextMenu, { once: true });
  }, 0);
}

function plantMushroom(index, name) {
  if (!removeItem('Dirt Shroom', DIRT_SHROOM_PLANT_COST)) return;

  game.farm.cellar[index] = {
    crop: name,
    stage: 0,
    watered: true, // Shrooms start "watered" (growing) automatically
    plantTime: Date.now(),
    waterTime: Date.now() 
  };

  playGlobalSound('sounds/soundeffects/inventorysound.mp3');
  renderCellar();
  game.isDirty = true;
}

function harvestMushroom(index) {
  const slotData = game.farm.cellar[index];
  if (!slotData) return;

  if (!canReceiveItem('Dirt Shroom')) {
    showGameAlert("Inventory Full", "Clear space to harvest.");
    return;
  }

  const yieldAmount = Math.floor(Math.random() * (DIRT_SHROOM_HARVEST_MAX - DIRT_SHROOM_HARVEST_MIN + 1)) + DIRT_SHROOM_HARVEST_MIN;
  addItem('Dirt Shroom', yieldAmount);
  addXP('farming', HARVEST_SHROOM_XP);
  
  showItemPopup(`+${HARVEST_SHROOM_XP} Farming XP`, null, 0);
  showItemPopup(`+${yieldAmount} Dirt Shrooms`, null, 450);

  game.farm.cellar[index] = null;
  playGlobalSound('sounds/soundeffects/inventorysound.mp3');
  renderCellar();
  game.isDirty = true;
}

function showShroomTooltip(e, index) {
    const getTooltipContent = () => {
        const slot = (game.farm.cellar && game.farm.cellar[index]) ? game.farm.cellar[index] : null;
        if (!slot) return null;

        const elapsed = Date.now() - slot.waterTime;
        let remaining = 0;
        let statusText = "";

        if (elapsed >= FARM_HARVEST_TIME) {
            statusText = `<span style="color:#aaffaa; font-weight:bold;">Ready to Harvest!</span>`;
        } else {
            statusText = `<span style="color:#ccc;">Fungus Spreading...</span>`;
            remaining = FARM_HARVEST_TIME - elapsed;
        }

        const formatTimer = (ms) => {
            if (ms < 0) ms = 0;
            const totalSec = Math.ceil(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h}h ${m}m ${s}s`;
        };

        return `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">${slot.crop}</div>
            <div style="margin-bottom:5px;">${statusText}</div>
            ${elapsed < FARM_HARVEST_TIME ? `<div style="font-size:12px;">Harvest in: <span style="color:#fff; font-family:monospace;">${formatTimer(remaining)}</span></div>` : ''}
        `;
    };

    const initialContent = getTooltipContent();
    if (initialContent) showTooltip(e, initialContent);

    if (tooltipInterval) clearInterval(tooltipInterval);
    tooltipInterval = setInterval(() => {
        const newContent = getTooltipContent();
        const tooltipEl = document.getElementById('tooltip');
        if (newContent && tooltipEl && tooltipEl.style.display !== 'none') {
            tooltipEl.innerHTML = newContent;
        } else {
            hideTooltip();
        }
    }, 1000);
}

function handleGardenSlotClick(e, index) {
  hideItemContextMenu();
  const slotData = game.farm.garden[index];

  if (!slotData) {
    showPlantingMenu(e, index);
  } else if (!slotData.watered) {
    waterCrop(e, index);
  } else {
    // +++ NEW: Check 12 Hours using new constant +++
    const elapsed = Date.now() - slotData.waterTime;

    if (elapsed >= FARM_HARVEST_TIME) { 
      harvestCrop(index);
    }
  }
}

function showPlantingMenu(event, index) {
  const menu = document.getElementById('itemContextMenu');
  let menuContent = `<div style="padding:5px 8px; font-weight:bold; color:var(--gold); border-bottom:1px solid #555;">Select Seed</div>`;
  let hasOptions = false;

  const options = [
      { name: 'Grass', seed: 'Grass Seed', cost: GRASS_SEEDS_REQ, img: 'grassseed.png' },
      { name: 'Corn', seed: 'Corn Seed', cost: CORN_SEEDS_REQ, img: 'cornseed.png' }
  ];

  // +++ NEW: Sort options by Level Requirement (Lowest first) +++
  options.sort((a, b) => {
      const levelA = CROPS[a.name] ? CROPS[a.name].levelReq : 1;
      const levelB = CROPS[b.name] ? CROPS[b.name].levelReq : 1;
      return levelA - levelB;
  });

  options.forEach(opt => {
      let seedCount = 0;
      for(const slot of game.inventory) {
        if(slot && slot.name === opt.seed) seedCount += slot.qty;
      }

      if (seedCount >= opt.cost) {
         hasOptions = true;
         
         // +++ Level Requirement Logic +++
         const reqLevel = CROPS[opt.name] ? CROPS[opt.name].levelReq : 1;
         const playerLevel = game.farming.level;
         const isLocked = playerLevel < reqLevel;
         const reqColor = isLocked ? '#ff8888' : '#fff'; // Red if locked, White if valid
         
         // Disable click if locked
         const clickAction = isLocked ? '' : `onclick="plantSeed(${index}, '${opt.name}', '${opt.seed}', ${opt.cost})"`;
         const styleAttr = isLocked ? 'cursor:not-allowed; opacity:0.6;' : '';

         menuContent += `
           <div class="planting-menu-item" ${clickAction} style="${styleAttr}">
              <img src="images/${opt.img}">
              <div>
                <div>${opt.name}</div>
                <div style="font-size:11px; color:#aaa;">Cost: ${opt.cost} Seeds</div>
                <div style="font-size:11px; color:${reqColor};">(Requires Farming Lvl:${reqLevel})</div>
              </div>
           </div>
         `;
      }
  });

  if (!hasOptions) {
    menuContent += `<div style="padding:10px; font-style:italic; color:#999; font-size:12px;">No available seeds.</div>`;
  }

  menu.innerHTML = menuContent;
  menu.style.display = 'block';
  
  const rect = document.body.getBoundingClientRect();
  menu.style.left = (event.clientX - rect.left + 5) + 'px';
  menu.style.top = (event.clientY - rect.top + 5) + 'px';

  setTimeout(() => {
    document.addEventListener('click', hideItemContextMenu, { once: true });
  }, 0);
}

function plantSeed(index, cropName, seedItemName, cost) {
  if (!removeItem(seedItemName, cost)) {
    showGameAlert("Error", "Not enough seeds.");
    return;
  }

  game.farm.garden[index] = {
    crop: cropName,
    stage: 0,
    watered: false,
    plantTime: Date.now(),
    waterTime: 0
  };

  playGlobalSound('sounds/soundeffects/inventorysound.mp3');
  renderGarden();
  game.isDirty = true;
}

function waterCrop(e, index) {
  const slotData = game.farm.garden[index];
  if (!slotData || slotData.watered) return;

  if (!removeItem('Bucket of Water', 1)) {
    showGameAlert("Water Required", "You need a Bucket of Water.");
    return;
  }
  addItem('Empty Bucket', 1);

  slotData.watered = true;
  slotData.waterTime = Date.now(); 

  playGlobalSound('sounds/soundeffects/wellsoundeffect.mp3');
  renderGarden();
  
  // +++ NEW: Instantly switch tooltip to the timer +++
  showCropTooltip(e, index);

  game.isDirty = true;
}

function harvestCrop(index) {
  const slotData = game.farm.garden[index];
  if (!slotData) return;

  const cropDef = CROPS[slotData.crop];
  
  // +++ NEW: Check 12 Hour Requirement +++
  const elapsed = Date.now() - slotData.waterTime;
  if (elapsed < FARM_HARVEST_TIME) return;

  if (!canReceiveItem(cropDef.productName)) {
    showGameAlert("Inventory Full", "Clear space to harvest.");
    return;
  }

  let min = 1, max = 1;
  if (slotData.crop === 'Grass') {
      min = GRASS_HARVEST_YIELD_MIN;
      max = GRASS_HARVEST_YIELD_MAX;
  } else if (slotData.crop === 'Corn') {
      min = CORN_HARVEST_YIELD_MIN;
      max = CORN_HARVEST_YIELD_MAX;
  }

  const yieldAmount = Math.floor(Math.random() * (max - min + 1)) + min;
  addItem(cropDef.productName, yieldAmount);
  
  // Award Farming XP
  let xp = 0;
  if (slotData.crop === 'Grass') xp = HARVEST_GRASS_XP;
  else if (slotData.crop === 'Corn') xp = HARVEST_CORN_XP;
  
  addXP('farming', xp);
  
  showItemPopup(`+${xp} Farming XP`, null, 0);
  showItemPopup(`+${yieldAmount} ${cropDef.productName}`, null, 450);

  game.farm.garden[index] = null;

  playGlobalSound('sounds/soundeffects/inventorysound.mp3');
  renderGarden();
  game.isDirty = true;
}

function processGardenGrowth(now) {
  if (!game.farm.garden) return;
  
  const isGardenOpen = document.getElementById('hubGarden').classList.contains('active');
  let needsUpdate = false;

  game.farm.garden.forEach(slot => {
    if (slot && slot.watered) {
      const elapsed = now - slot.waterTime;
      let calculatedStage = 0;
      
      // Map time to integer stage for save data consistency
      if (elapsed >= FARM_STAGE_3_TIME) calculatedStage = 2;
      else if (elapsed >= FARM_STAGE_2_TIME) calculatedStage = 1;
      else calculatedStage = 0;

      if (calculatedStage > slot.stage) {
          slot.stage = calculatedStage;
          needsUpdate = true;
      }
    }
  });

  if (isGardenOpen) {
    renderGarden();
  }
}

// +++ NEW: Real-Time Pet Tooltip +++
function showPetTooltip(e, petId) {
    // Helper to generate the HTML based on CURRENT pet data
    const getTooltipContent = () => {
        const pet = game.pets.find(p => p.id === petId);
        if (!pet) return null;

        // Calculate Hunger Timer
        const now = Date.now();
        const elapsed = now - (pet.lastCalcTime || now);
        const remaining = Math.max(0, PET_HP_DECAY_MS - elapsed);
        
        // Format time logic (replicated here for safety)
        const totalSec = Math.ceil(remaining / 1000);
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const timeStr = `${h}h ${m}m`;
        const timeColor = remaining < 3600000 ? "#ffaaaa" : "#ccc"; // Red if < 1 hour

        const xpNeeded = pet.level * 100;
        const xpPercent = Math.min(100, (pet.xp / xpNeeded) * 100);
        
        // HP Color Logic
        const hpColor = pet.hp <= 0 ? '#ff4d4d' : (pet.hp <= 3 ? '#d22' : '#44aa44');
        
        // Bonus Text Logic
        let bonusStr = "No bonus";
        const petDef = PET_DATA[pet.type];
        if (petDef && petDef.bonus) {
            const b = petDef.bonus(pet.level);
            if (b.physicalDamage) bonusStr = `+${b.physicalDamage} Phys Dmg`;
        }
        
        // Override bonus text if sick
        if (pet.hp <= 0) bonusStr = "<span style='color:#ff4d4d;'>Sick (Inactive)</span>";
        else bonusStr = `<span style='color:#aaffaa;'>${bonusStr}</span>`;

        return `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${pet.type}</div>
            <div style="margin-top:2px; font-size:12px; color:#efe3cf;">Lvl ${pet.level}</div>
            <div style="font-size:12px; color:#ccc;">HP: <span style="color:${hpColor}">${pet.hp}/${PET_MAX_HP}</span></div>
            <div style="font-size:12px; margin-bottom:6px;">${bonusStr}</div>
            <div style="font-size:11px; color:#ccc; margin-bottom:6px;">Hunger in: <span style="color:${timeColor}">${timeStr}</span></div>
            
            <div style="font-size:10px; color:#aaa; display:flex; justify-content:space-between;">
                <span>XP</span>
                <span>${Math.floor(pet.xp)} / ${xpNeeded}</span>
            </div>
            <div style="width:100%; height:4px; background:#333; border:1px solid #000; border-radius:2px; margin-bottom:5px;">
                <div style="height:100%; width:${xpPercent}%; background:var(--gold); transition: width 0.1s linear;"></div>
            </div>
            <div style="color:#666; margin-top: 5px; font-style:italic; font-size:11px;">(Manage in Pet Yard)</div>
        `;
    };

    // 1. Show immediately
    const initialContent = getTooltipContent();
    if (initialContent) showTooltip(e, initialContent);

    // 2. Start refreshing every 100ms
    if (tooltipInterval) clearInterval(tooltipInterval);
    tooltipInterval = setInterval(() => {
        const newContent = getTooltipContent();
        const tooltipEl = document.getElementById('tooltip');
        // Only update if tooltip is still visible
        if (newContent && tooltipEl && tooltipEl.style.display !== 'none') {
            tooltipEl.innerHTML = newContent;
        } else {
            hideTooltip();
        }
    }, 100); 
}

function showCowTooltip(e, index) {
    // 1. Define Content Generator
    const getTooltipContent = () => {
        const c = (game.farm.cows && game.farm.cows[index]) ? game.farm.cows[index] : null;
        if (!c) return null;

        const timeSinceLastTick = Date.now() - (c.lastCalcTime || Date.now());

        const formatTimer = (ms) => {
            if (ms < 0) ms = 0;
            const totalSec = Math.ceil(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h}h ${m < 10 ? '0'+m : m}m ${s < 10 ? '0'+s : s}s`;
        };

        const currentHpAcc = (c.hpDecayAcc || 0) + timeSinceLastTick;
        const hpDecayRem = COW_HP_DECAY_MS - currentHpAcc;
        const nextHunger = formatTimer(hpDecayRem);

        let nextMilk = '';
        if (c.hasMilk) {
            nextMilk = "<span style='color:#fff; font-weight:bold;'>Ready to Milk!</span>";
        } else if (c.hp < COW_SICK_THRESHOLD) {
            nextMilk = "<span style='color:#ff4d4d;'>Sick (Paused)</span>";
        } else {
            const currentMilkAcc = (c.milkTimer || 0) + timeSinceLastTick;
            const milkRem = COW_MILK_TIMER_MS - currentMilkAcc;
            nextMilk = formatTimer(milkRem);
        }

        return `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">Cow #${index + 1}</div>
            <div style="font-size:12px; color:#ccc; margin-bottom:5px;">HP: ${c.hp} / ${COW_MAX_HP}</div>
            <div style="display:flex; justify-content:space-between; gap:15px;">
                <span>Next Hunger:</span> <span style="color:#fff;">${nextHunger}</span>
            </div>
            <div style="display:flex; justify-content:space-between; gap:15px;">
                <span>Next Milk:</span> <span style="color:#aaffaa;">${nextMilk}</span>
            </div>
        `;
    };

    // 2. Initial Show
    const initialContent = getTooltipContent();
    if (initialContent) showTooltip(e, initialContent);

    // 3. Loop
    if (tooltipInterval) clearInterval(tooltipInterval);
    tooltipInterval = setInterval(() => {
        const newContent = getTooltipContent();
        const tooltipEl = document.getElementById('tooltip');
        if (newContent && tooltipEl && tooltipEl.style.display !== 'none') {
            tooltipEl.innerHTML = newContent;
        } else {
            hideTooltip();
        }
    }, 100);
}

// +++ NEW: Real-Time Crop Tooltip +++
function showCropTooltip(e, index) {
    const getTooltipContent = () => {
        const slot = (game.farm.garden && game.farm.garden[index]) ? game.farm.garden[index] : null;
        if (!slot || !slot.watered) return null;

        const cropDef = CROPS[slot.crop];
        const elapsed = Date.now() - slot.waterTime;
        
        let remaining = 0;
        let statusText = "";
        let timerColor = "#fff";

        if (elapsed >= FARM_HARVEST_TIME) {
            statusText = `<span style="color:#aaffaa; font-weight:bold;">Ready to Harvest!</span>`;
            timerColor = "#aaffaa";
            remaining = 0;
        } else if (elapsed >= FARM_STAGE_3_TIME) {
            // Between 10 and 12 hours
            statusText = `<span style="color:#ccc;">Ripening... (Stage 3/3)</span>`;
            remaining = FARM_HARVEST_TIME - elapsed;
        } else if (elapsed >= FARM_STAGE_2_TIME) {
            // Between 5 and 10 hours
            statusText = `<span style="color:#ccc;">Growing... (Stage 2/3)</span>`;
            remaining = FARM_STAGE_3_TIME - elapsed;
        } else {
            // Less than 5 hours
            statusText = `<span style="color:#ccc;">Sprouting... (Stage 1/3)</span>`;
            remaining = FARM_STAGE_2_TIME - elapsed;
        }

        const formatTimer = (ms) => {
            if (ms < 0) ms = 0;
            const totalSec = Math.ceil(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h}h ${m}m ${s}s`;
        };

        return `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">${slot.crop}</div>
            <div style="margin-bottom:5px;">${statusText}</div>
            <div style="display:flex; justify-content:space-between; gap:15px; font-size:12px;">
                <span>Next Stage:</span> <span style="color:${timerColor}; font-family:monospace; font-size:14px;">${remaining <= 0 ? 'Ready' : formatTimer(remaining)}</span>
            </div>
        `;
    };

    // Initial Show
    const initialContent = getTooltipContent();
    if (initialContent) showTooltip(e, initialContent);

    // Loop
    if (tooltipInterval) clearInterval(tooltipInterval);
    tooltipInterval = setInterval(() => {
        const newContent = getTooltipContent();
        const tooltipEl = document.getElementById('tooltip');
        if (newContent && tooltipEl && tooltipEl.style.display !== 'none') {
            tooltipEl.innerHTML = newContent;
        } else {
            hideTooltip();
        }
    }, 1000); // Update once a second since times are long
}

// +++ NEW: Chicken Tooltip Logic (Multi-Chicken) +++
function showChickenTooltip(e, index) {
    // 1. Define the function that generates the HTML content
    const getTooltipContent = () => {
        // Check if chicken exists at index
        const c = (game.farm.chickens && game.farm.chickens[index]) ? game.farm.chickens[index] : null;
        if (!c) return null;

        const timeSinceLastTick = Date.now() - (c.lastCalcTime || Date.now());

        // Updated to show Hours : Minutes : Seconds
        const formatTimer = (ms) => {
            if (ms < 0) ms = 0;
            const totalSec = Math.ceil(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            // Format: 1h 05m 09s
            return `${h}h ${m < 10 ? '0'+m : m}m ${s < 10 ? '0'+s : s}s`;
        };

        const currentHpAcc = (c.hpDecayAcc || 0) + timeSinceLastTick;
        const hpDecayRem = CHICKEN_HP_DECAY_MS - currentHpAcc;
        const nextHunger = formatTimer(hpDecayRem);

        let nextEgg = '';
        if (c.hp < CHICKEN_SICK_THRESHOLD) {
            nextEgg = "<span style='color:#ff4d4d;'>Sick (Paused)</span>";
        } else {
            const currentEggAcc = (c.eggTimer || 0) + timeSinceLastTick;
            const eggRem = CHICKEN_EGG_TIMER_MS - currentEggAcc;
            nextEgg = formatTimer(eggRem);
        }

        return `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">Chicken #${index + 1}</div>
            <div style="font-size:12px; color:#ccc; margin-bottom:5px;">HP: ${c.hp} / ${CHICKEN_MAX_HP}</div>
            <div style="display:flex; justify-content:space-between; gap:15px;">
                <span>Next Hunger:</span> <span style="color:#fff;">${nextHunger}</span>
            </div>
            <div style="display:flex; justify-content:space-between; gap:15px;">
                <span>Next Egg:</span> <span style="color:#aaffaa;">${nextEgg}</span>
            </div>
        `;
    };

    // 2. Initial Show
    const initialContent = getTooltipContent();
    if (initialContent) showTooltip(e, initialContent);

    // 3. Clear & Start Interval
    if (tooltipInterval) clearInterval(tooltipInterval);

    tooltipInterval = setInterval(() => {
        const newContent = getTooltipContent();
        const tooltipEl = document.getElementById('tooltip');
        
        if (newContent && tooltipEl && tooltipEl.style.display !== 'none') {
            tooltipEl.innerHTML = newContent;
        } else {
            hideTooltip();
        }
    }, 100);
}

// --- FARM LOOP (Runs every 1s via master loop) ---
function processFarmLogic() {
    const now = Date.now();
    
    // 1. Process Chickens
    if (game.farm.chickens && game.farm.chickens.length > 0) {
        let needsUpdate = false;
        for (let i = game.farm.chickens.length - 1; i >= 0; i--) {
            const c = game.farm.chickens[i];
            const elapsed = now - (c.lastCalcTime || now);
            if (elapsed < 1000) continue;

            c.lastCalcTime = now;
            if (!c.hpDecayAcc) c.hpDecayAcc = 0;
            c.hpDecayAcc += elapsed;

            if (c.hpDecayAcc >= CHICKEN_HP_DECAY_MS) {
                c.hp -= 1;
                c.hpDecayAcc -= CHICKEN_HP_DECAY_MS;
                needsUpdate = true;
                if (c.hp <= 0) {
                    game.farm.chickens.splice(i, 1);
                    game.isDirty = true;
                    showGameAlert("Chicken Died", "One of your chickens starved to death.");
                    continue; 
                }
            }
            if (c.hp >= CHICKEN_SICK_THRESHOLD) {
                if (!c.eggTimer) c.eggTimer = 0;
                c.eggTimer += elapsed;
                if (c.eggTimer >= CHICKEN_EGG_TIMER_MS) {
                    c.storedEggs += 1;
                    c.eggTimer -= CHICKEN_EGG_TIMER_MS;
                    needsUpdate = true;
                }
            }
        }
        if (needsUpdate) updateCoopUI();
    }

    // 2. Process Cows
    if (game.farm.cows && game.farm.cows.length > 0) {
        let cowUpdate = false;
        for (let i = game.farm.cows.length - 1; i >= 0; i--) {
            const c = game.farm.cows[i];
            const elapsed = now - (c.lastCalcTime || now);
            if (elapsed < 1000) continue;

            c.lastCalcTime = now;
            if (!c.hpDecayAcc) c.hpDecayAcc = 0;
            c.hpDecayAcc += elapsed;

            if (c.hpDecayAcc >= COW_HP_DECAY_MS) {
                c.hp -= 1;
                c.hpDecayAcc -= COW_HP_DECAY_MS;
                cowUpdate = true;
                if (c.hp <= 0) {
                    game.farm.cows.splice(i, 1);
                    game.isDirty = true;
                    showGameAlert("Cow Died", "One of your cows starved to death.");
                    continue; 
                }
            }
            if (c.hp >= COW_SICK_THRESHOLD && !c.hasMilk) {
                if (!c.milkTimer) c.milkTimer = 0;
                c.milkTimer += elapsed;
                if (c.milkTimer >= COW_MILK_TIMER_MS) {
                    c.hasMilk = true;
                    c.milkTimer = 0;
                    cowUpdate = true;
                }
            }
        }
        if (cowUpdate) updateBarnUI();
    }

    // 3. Process Garden & Cellar
    processGardenGrowth(now);
    processCellarGrowth(now);
}

function processCellarGrowth(now) {
  if (!game.farm.cellar) return;
  const isCellarOpen = document.getElementById('hubCellar').classList.contains('active');
  game.farm.cellar.forEach(slot => {
    if (slot) {
      const elapsed = now - slot.waterTime;
      let calculatedStage = 0;
      if (elapsed >= FARM_STAGE_3_TIME) calculatedStage = 2;
      else if (elapsed >= FARM_STAGE_2_TIME) calculatedStage = 1;
      else calculatedStage = 0;
      slot.stage = calculatedStage;
    }
  });
  if (isCellarOpen) renderCellar();
}

function handleWindmillClick() {
   showMainScreen('hubWindmill');
}

async function handleWellClick() {
   // Initialize if missing
   if (!game.farm.buildings) game.farm.buildings = { coop: false, barn: false, well: false };

   if (!game.farm.buildings.well) {
       // +++ NEW: Level Requirement Check +++
       if (game.farming.level < 1) {
           await showGameAlert("Level Required", "You need Farming Level 1 to restore the Well.");
           return;
       }
       // +++ END NEW +++

       const confirmed = await showGameConfirm("Buy The Well", `Restore the Well for ${formatAmount(WELL_COST)} Gold?`);
       if (confirmed) {
           if (game.gold >= WELL_COST) {
               addGold(-WELL_COST);
               game.farm.buildings.well = true;
               game.isDirty = true;
               await showGameAlert("Success", "You restored the Well!");
               
               // Open after purchase
               openWellHub();
           } else {
               await showGameAlert("Not Enough Gold", `You need ${formatAmount(WELL_COST)} Gold.`);
           }
       }
       return;
   }

   openWellHub();
}

// +++ NEW: GARDEN PURCHASE LOGIC +++
async function handleGardenClick() {
   // Initialize if missing
   if (!game.farm.buildings) game.farm.buildings = { coop: false, barn: false, well: false, garden: false };

   if (!game.farm.buildings.garden) {
       // +++ NEW: Level Requirement Check +++
       if (game.farming.level < 1) {
           await showGameAlert("Level Required", "You need Farming Level 1 to buy the Garden.");
           return;
       }
       // +++ END NEW +++

       const confirmed = await showGameConfirm("Buy The Garden", `Clear the land for a Garden for ${formatAmount(GARDEN_COST)} Gold?`);
       if (confirmed) {
           if (game.gold >= GARDEN_COST) {
               addGold(-GARDEN_COST);
               game.farm.buildings.garden = true;
               game.isDirty = true;
               await showGameAlert("Success", "You purchased the Garden!");
               
               // Open after purchase
               showMainScreen('hubGarden');
           } else {
               await showGameAlert("Not Enough Gold", `You need ${formatAmount(GARDEN_COST)} Gold.`);
           }
       }
       return;
   }

   showMainScreen('hubGarden');
}

function openWellHub() {
  game.shopOpen = false;
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  stopFishing();
  stopStoneForging();
  stopCookingChicken();
  stopWoodcutting();

  const wrapper = document.getElementById('hubWell');
  
  // Inject the UI with Progress Bar
  wrapper.innerHTML = `
    <h2>The Well</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: Empty Bucket.</div>
    
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="wellProgress"></div>
        <div class="progress-text" id="wellProgressText"></div>
      </div>
    </div>

    <div class="action-buttons" style="margin-top: 20px;">
      <button id="startWaterBtn" class="primary">Gather Water</button>
      <button id="stopWaterBtn" class="primary" style="background:#555; display:none;">Stop</button>
      <button id="hubWell_ReturnBtn" class="primary" style="background:#666;">Return</button>
    </div>
  `;

  // Re-attach listeners
  document.getElementById('startWaterBtn').onclick = startGatheringWater;
  document.getElementById('stopWaterBtn').onclick = stopGatheringWater;
  document.getElementById('hubWell_ReturnBtn').onclick = openPersonalFarmHub; // Return to Farm view

  showMainScreen('hubWell');
}

async function startGatheringWater() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }

  // Check Inventory for Empty Bucket
  let hasBucket = false;
  for (const slot of game.inventory) {
    if (slot && slot.name === 'Empty Bucket') {
      hasBucket = true;
      break;
    }
  }

  if (!hasBucket) {
    await showGameAlert("Requirement", "You need an Empty Bucket to gather water.");
    return;
  }

  if (game.gatheringWaterActive) return;

  game.gatheringWaterActive = true;
  document.getElementById('startWaterBtn').style.display = 'none';
  document.getElementById('stopWaterBtn').style.display = 'inline-block';
  
  game.progressFrame = setTimeout(() => gatheringWaterLoop(Date.now(), Date.now()), 16);
}

function gatheringWaterLoop(timestamp, startTime) {
  if (!game.gatheringWaterActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= WELL_GATHER_TIME_MS) {
    // 1. Check for bucket again
    let hasBucket = false;
    for (const slot of game.inventory) {
      if (slot && slot.name === 'Empty Bucket') {
        hasBucket = true;
        break;
      }
    }

    if (!hasBucket) {
      showGameAlert("Out of Buckets", "You ran out of empty buckets.");
      stopGatheringWater();
      return;
    }

    // 2. Process Swap & Add XP
    removeItem('Empty Bucket', 1);
    addItem('Bucket of Water', 1);
    
    // Add XP (Silenced by the change in part1.txt)
    addXP('strength', 1); 
    
    // 3. Custom Popups
    // Water first (Delay 0)
    showItemPopup('+1 Bucket of Water', 'wellProgress', 0);
    
    // Strength XP second (Delay 450) - This makes it appear "under" or after the water
    showItemPopup('+1 Strength XP', 'wellProgress', 450);
    
    // Reset UI
    const bar = document.getElementById('wellProgress');
    if (bar) bar.style.width = '0%';
    
    // 4. Restart Loop
    const overdueTime = elapsed - WELL_GATHER_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    return gatheringWaterLoop(Date.now(), newStartTime);

  } else {
    // Update Progress Bar
    const progress = (elapsed / WELL_GATHER_TIME_MS) * 100;
    const bar = document.getElementById('wellProgress');
    if (bar) bar.style.width = progress + '%';
    
    game.progressFrame = setTimeout(() => gatheringWaterLoop(Date.now(), startTime), 16);
  }
}

function stopGatheringWater() {
  game.gatheringWaterActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const bar = document.getElementById('wellProgress');
  if(bar) bar.style.width = '0%';
  
  const startBtn = document.getElementById('startWaterBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  
  const stopBtn = document.getElementById('stopWaterBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  
  game.isDirty = true;
}

function openHuntingBoard() {
  showMainScreen('hubHuntingBoard');
  renderBountyInterface();
}

function renderBountyInterface() {
  const container = document.getElementById('bountyContent');
  if (!container) return;
  container.innerHTML = '';

  if (game.activeBounty) {
    // --- ACTIVE MISSION VIEW ---
    const b = game.activeBounty;
    const isComplete = b.kills >= b.req;
    const statusColor = isComplete ? '#44aa44' : '#efe3cf';
    const statusText = isComplete ? 'MISSION COMPLETE' : 'IN PROGRESS';
    
    const bountyHtml = `
      <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 2px solid ${isComplete ? '#44aa44' : 'var(--accent)'};">
        <h3 style="color: var(--gold); margin-top: 0;">Current Bounty: Kill ${b.target}s</h3>
        <div style="color: ${statusColor}; font-weight: bold; margin-bottom: 10px;">${statusText}</div>
        
        <div style="margin-bottom: 10px;">
           Progress: <span style="color: #fff;">${b.kills} / ${b.req}</span>
        </div>
        <div style="width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden;">
           <div style="width: ${Math.min(100, (b.kills / b.req) * 100)}%; height: 100%; background: var(--gold);"></div>
        </div>
        <div style="margin-top: 15px; font-size: 14px; color: #ccc;">
           Reward: ${b.reward} Gold
        </div>
        
        ${isComplete ? 
          `<button onclick="claimBountyReward()" class="primary" style="margin-top: 15px; background: #44aa44; width: 100%;">Claim Reward</button>` : 
          `<div style="margin-top: 15px; font-style: italic; color: #888;">Return here when the job is done.</div>`
        }
      </div>
    `;
    container.innerHTML = bountyHtml;

  } else {
    // --- SELECT MISSION VIEW ---
    const bhLvl = game.bountyhunting.level;
    const isLvl2Locked = bhLvl < 10;

    container.innerHTML = `
      <div onclick="assignBounty(1)" class="quest-line-card" style="text-align: left; margin-bottom: 12px;">
        <div style="font-size: 18px; font-weight: bold; color: var(--gold);">Level 1 Bounties</div>
        <div style="font-size: 12px; color: #ccc; margin-top: 4px;">Rats, Spiders, Chickens, Goblins, etc.</div>
        <div style="margin-top: 8px; color: #aaffaa;">Reward: 500 Gold</div>
      </div>

      <div onclick="assignBounty(2)" class="quest-line-card ${isLvl2Locked ? 'locked-item' : ''}" style="text-align: left;">
        <div style="font-size: 18px; font-weight: bold; color: ${isLvl2Locked ? '#888' : '#ff4d4d'};">Level 2 Bounties</div>
        <div style="font-size: 12px; color: #ccc; margin-top: 4px;">Elite targets like Crazy Owls and The Witch.</div>
        <div style="margin-top: 8px; color: ${isLvl2Locked ? '#ff8888' : '#aaffaa'};">
            ${isLvl2Locked ? 'Requires Bounty Hunting Lvl 10' : 'Reward: 1,000 - 1,500 Gold'}
        </div>
      </div>
    `;
  }
}

async function assignBounty(tier) {
  if (!game.isSessionActive) {
    await showGameAlert("Session Error", "Session not active.");
    return;
  }

  // --- FIX: Level 10 requirement for Tier 2 ---
  if (tier === 2 && game.bountyhunting.level < 10) {
    await showGameAlert("Level Required", "You need Bounty Hunting Level 10 to take on elite contracts.");
    return;
  }
  
  // Pick random target based on tier
  const targets = (tier === 2) ? BOUNTY_TIER_2_TARGETS : BOUNTY_TIER_1_TARGETS;
  const randomTarget = targets[Math.floor(Math.random() * targets.length)];
  
  // Determine reward based on monster name
  let reward = 500; 
  if (randomTarget === 'Crazy Owl') reward = 1000;
  if (randomTarget === 'The Witch') reward = 1500;

  game.activeBounty = {
    target: randomTarget,
    req: BOUNTY_REQ_COUNT,
    kills: 0,
    tier: tier,
    reward: reward
  };
  
  await showGameAlert("Bounty Accepted", `Your mission: Kill ${BOUNTY_REQ_COUNT} ${randomTarget}s.`);
  
  // --- FIX: Update Sidebar Mission Tab in real-time ---
  if (typeof renderBountyDetails === 'function') {
      renderBountyDetails();
  }

  game.isDirty = true;
  renderBountyInterface();
}

async function claimBountyReward() {
  if (!game.activeBounty || game.activeBounty.kills < game.activeBounty.req) return;
  
  const rewardAmount = game.activeBounty.reward || 500;
  addGold(rewardAmount);
  playGlobalSound('sounds/soundeffects/levelupsound.mp3');
  
  game.activeBounty = null; // Clear mission
  
  // --- NEW: Real-time update for the sidebar tab ---
  if (typeof window.renderBountyDetails === 'function') {
      window.renderBountyDetails();
  }
  // --- END NEW ---
  
  game.isDirty = true;
  
  renderBountyInterface(); // This is the main hub render function
  await showGameAlert("Bounty Claimed", `You received ${BOUNTY_REWARD_GOLD} Gold.`);
}

function updateBountyProgress(enemyName, delay = 0) {
  if (game.activeBounty && game.activeBounty.target === enemyName) {
    if (game.activeBounty.kills < game.activeBounty.req) {
      game.activeBounty.kills++;
      
      // Award XP per kill with delay
      // We ensure delay is treated as a number
      addXP('bountyhunting', BOUNTY_KILL_XP, parseInt(delay));

      // --- NEW: Real-time update for the sidebar tab ---
      if (typeof window.renderBountyDetails === 'function') {
          window.renderBountyDetails();
      }
      
      game.isDirty = true;
    }
  }
}

function openForgeStone(type) {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  stopFishing();
  
  const wrapper = document.getElementById('hubDynamic');
  const shardName = `${type} Crystal Shard`;
  const stoneName = `${type}stone`;

  wrapper.innerHTML = `
    <h2>Forge - ${stoneName}</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 5 ${shardName}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="forgeProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startForgeBtn" class="primary">Start Forging</button>
      <button id="stopForgeBtn" class="primary" style="background:#555; display:none;">Stop Forging</button>
      <button onclick="openElementalForgeHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startForgeBtn').onclick = () => startForgingStone(type);
  document.getElementById('stopForgeBtn').onclick = stopStoneForging;
  showMainScreen('hubDynamic');
}

async function startForgingStone(type) {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active.");
    return;
  }
  
  // +++ NEW LEVEL CHECK +++
  let levelReq = 1;
  if (type === 'Earth') levelReq = STONE_FORGE_EARTH_LVL;
  else if (type === 'Air') levelReq = STONE_FORGE_AIR_LVL;
  else if (type === 'Water') levelReq = STONE_FORGE_WATER_LVL;

  if (game.stoneforging.level < levelReq) {
      await showGameAlert("Level Required", `You need Stone Forging Level ${levelReq} to craft this.`);
      return;
  }
  // +++ END NEW +++
  
  const stoneName = `${type}stone`;
  const shardName = `${type} Crystal Shard`;

  if (!canReceiveItem(stoneName)) {
    await showGameAlert("Inventory Full", "You have no room to craft this.");
    return;
  }
  
  if (game.stoneforgingActive) return;

  let totalShards = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === shardName) totalShards += slot.qty;
  }

  if (totalShards < STONE_SHARD_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${STONE_SHARD_COST} ${shardName}.`);
      return;
  }
  
  game.stoneforgingActive = true;
  document.getElementById('startForgeBtn').style.display = 'none';
  document.getElementById('stopForgeBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => stoneForgingLoop(Date.now(), Date.now(), type), 16);
}

async function stoneForgingLoop(timestamp, startTime, type) {
  if (!game.stoneforgingActive) return; 
  const elapsed = Date.now() - startTime;

  const stoneName = `${type}stone`;
  const shardName = `${type} Crystal Shard`;

  if (elapsed >= STONE_CRAFT_TIME_MS) {
    let totalShards = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === shardName) totalShards += slot.qty;
    }
    if (totalShards < STONE_SHARD_COST) {
        await showGameAlert("Out of Materials", `You've run out of ${shardName}.`);
        stopStoneForging();
        return;
    }
    
    removeItem(shardName, STONE_SHARD_COST);
    addItem(stoneName, 1);
    addXP('stoneforging', STONE_CRAFT_XP);
    showItemPopup(`+${STONE_CRAFT_XP} Stone Forging XP`, 'forgeProgress', 0);
    showItemPopup(`+1 ${stoneName}`, 'forgeProgress', 450);
    
    document.getElementById('forgeProgress').style.width = '0%';
    
    const overdueTime = elapsed - STONE_CRAFT_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalShardsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === shardName) totalShardsAfter += slot.qty;
    }
    if (totalShardsAfter < STONE_SHARD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough shards to make more.");
        stopStoneForging();
        return;
    }
    
    return stoneForgingLoop(Date.now(), newStartTime, type);

  } else {
    const progress = (elapsed / STONE_CRAFT_TIME_MS) * 100;
    document.getElementById('forgeProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => stoneForgingLoop(Date.now(), startTime, type), 16);
  }
}

// =================================================================
// +++ NEW: ALCHEMY BREWING FUNCTIONS +++
// =================================================================
const BREW_TIME_MS = 5000;
const VITALITY_POTION_XP = 60;

function openAlchemyHub() {
  showMainScreen('hubAlchemy');
  renderAlchemyItems();
}

function renderAlchemyItems() {
  const container = document.getElementById('alchemyItemsContainer');
  if (!container) return;
  container.innerHTML = '';

  // Vitality Potion (Level 1)
  const btn = document.createElement('button');
  btn.className = 'primary';
  btn.style.cssText = 'width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;';
  btn.innerHTML = `<img src="images/vitalitypotion.png" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">`;
  
  btn.onclick = openBrewVitalityPotion;
  btn.onmouseenter = (e) => showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Vitality Potion</div>Requires: 10 Dirt Shrooms, 6 Wild Herbs, 1 Empty Vial<br><div style="color:#fff;">Requires Alchemy Lvl: 1</div>`);
  btn.onmouseleave = hideTooltip;
  
  container.appendChild(btn);
}

function openBrewVitalityPotion() {
  game.shopOpen = false; 
  hideTooltip();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Brewing - Vitality Potion</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: 10 Dirt Shrooms, 6 Wild Herbs, 1 Empty Vial.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="brewProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startBrewBtn" class="primary">Start Brewing</button>
      <button id="stopBrewBtn" class="primary" style="background:#555; display:none;">Stop Brewing</button>
      <button onclick="openAlchemyHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startBrewBtn').onclick = startBrewingVitality;
  document.getElementById('stopBrewBtn').onclick = stopBrewing;
  showMainScreen('hubDynamic');
}

async function startBrewingVitality() {
  if (!game.isSessionActive) return;
  if (!canReceiveItem('Vitality Potion')) { await showGameAlert("Inventory Full", "No room."); return; }
  
  let shrooms = 0, herbs = 0, vials = 0;
  game.inventory.forEach(s => {
    if(s && s.name === 'Dirt Shroom') shrooms += s.qty;
    if(s && s.name === 'Wild Herb') herbs += s.qty;
    if(s && s.name === 'Empty Vial') vials += s.qty;
  });

  if (shrooms < 10 || herbs < 6 || vials < 1) {
    await showGameAlert("Not Enough Materials", "You need 10 Dirt Shrooms, 6 Wild Herbs and 1 Empty Vial.");
    return;
  }

  game.alchemyActive = true;
  document.getElementById('startBrewBtn').style.display = 'none';
  document.getElementById('stopBrewBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => brewLoop(Date.now(), Date.now()), 16);
}

function brewLoop(ts, startTime) {
  if (!game.alchemyActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= BREW_TIME_MS) {
    if (removeItem('Dirt Shroom', 10) && removeItem('Wild Herb', 6) && removeItem('Empty Vial', 1)) {
      addItem('Vitality Potion', 1);
      addXP('alchemy', VITALITY_POTION_XP);
      showItemPopup(`+${VITALITY_POTION_XP} Alchemy XP`, 'brewProgress', 0);
      showItemPopup(`+1 Vitality Potion`, 'brewProgress', 450);
      
      // Check for next loop
      let s = 0, h = 0, v = 0;
      game.inventory.forEach(slot => {
        if(slot && slot.name === 'Dirt Shroom') s += slot.qty;
        if(slot && slot.name === 'Wild Herb') h += slot.qty;
        if(slot && slot.name === 'Empty Vial') v += slot.qty;
      });
      if (s >= 10 && h >= 6 && v >= 1 && canReceiveItem('Vitality Potion')) {
        return brewLoop(Date.now(), Date.now());
      }
    }
    stopBrewing();
  } else {
    document.getElementById('brewProgress').style.width = (elapsed / BREW_TIME_MS) * 100 + '%';
    game.progressFrame = setTimeout(() => brewLoop(Date.now(), startTime), 16);
  }
}

function stopBrewing() {
  game.alchemyActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  if(document.getElementById('startBrewBtn')) document.getElementById('startBrewBtn').style.display = 'inline-block';
  if(document.getElementById('stopBrewBtn')) document.getElementById('stopBrewBtn').style.display = 'none';
  if(document.getElementById('brewProgress')) document.getElementById('brewProgress').style.width = '0%';
}


// =================================================================
// --- 5. NEW FISHING FUNCTIONS ---
// =================================================================

/**
 * Main function to open the Fishing Areas Hub
 */
function openFishingHub() {
  showMainScreen('hubFishingAreas');
}

/**
 * Opens the Ocean fishing area
 */
function openOceanFishingArea() {
  showMainScreen('hubOcean');
}

/**
 * Opens the River fishing area
 */
function openRiverFishingArea() {
  showMainScreen('hubRiver');
}

/**
 * Generic function to stop any fishing action
 */
function stopFishing(progressId = 'fishProgress', startBtnId = 'startFishBtn', stopBtnId = 'stopFishBtn') {
  game.fishingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const bar = document.getElementById(progressId);
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById(startBtnId);
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById(stopBtnId);
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

// --- Herring (Ocean) UI & Logic ---
function openFishHerring(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fishing - Herring</h2>
    <div style="margin-top:8px; color:#efe3cf;">A common ocean fish.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fishProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFishBtn" class="primary">Start Fishing</button>
      <button id="stopFishBtn" class="primary" style="background:#555; display:none;">Stop Fishing</button>
      <button onclick="openOceanFishingArea()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFishBtn').onclick = startFishingHerring;
  document.getElementById('stopFishBtn').onclick = stopFishing;
  showMainScreen('hubDynamic');
}

async function startFishingHerring() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Herring')) {
    await showGameAlert("Inventory Full", "You have no room to fish this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fishingActive) return;

  // --- NEW: Check for Fishing Pole ---
  let hasPole = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Pole') {
          hasPole = true;
          break;
      }
  }
  if (!hasPole) {
      await showGameAlert("Tool Required", "You need a Fishing Pole in your inventory to fish.");
      return;
  }
  // --- END NEW ---

  // --- NEW: Check for Fishing Bait ---
  let hasBait = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Bait') {
          hasBait = true;
          break;
      }
  }
  if (!hasBait) {
      await showGameAlert("Material Required", "You need Fishing Bait in your inventory to fish.");
      return;
  }
  // --- END NEW ---
  
  game.fishingActive = true;
  document.getElementById('startFishBtn').style.display = 'none';
  document.getElementById('stopFishBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fishingHerringLoop(Date.now(), Date.now()), 16);
}

async function fishingHerringLoop(timestamp, startTime) {
  if (!game.fishingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= FISHING_TIME_MS) {
    let hasBait = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBait = true;
            break;
        }
    }
    if (!hasBait) {
        await showGameAlert("Out of Materials", "You've run out of Fishing Bait.");
        stopFishing();
        return;
    }

    removeItem('Fishing Bait', 1);
    addItem('Herring', 1);
    addXP('fishing', HERRING_FISH_XP);
    showItemPopup(`+${HERRING_FISH_XP} Fishing XP`, 'fishProgress', 0);
    showItemPopup(`+1 Herring`, 'fishProgress', 450);
    
    document.getElementById('fishProgress').style.width = '0%';
    
    const overdueTime = elapsed - FISHING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let hasBaitAfter = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBaitAfter = true;
            break;
        }
    }
    if (!hasBaitAfter) {
        await showGameAlert("Not Enough Materials", "You don't have any more Fishing Bait.");
        stopFishing();
        return;
    }

    const emptySlotIndex = game.inventory.findIndex(slot => slot === null);
    const stackIndex = game.inventory.findIndex(slot => slot && slot.name === 'Herring');
    if (emptySlotIndex === -1 && stackIndex === -1) {
        await showGameAlert("Inventory Full", "Your inventory is full.");
        stopFishing();
        return;
    }
    
    return fishingHerringLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / FISHING_TIME_MS) * 100;
    document.getElementById('fishProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fishingHerringLoop(Date.now(), startTime), 16);
  }
}

// --- Trout (River) UI & Logic ---
function openFishTrout(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fishing - Trout</h2>
    <div style="margin-top:8px; color:#efe3cf;">A common river fish.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fishProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFishBtn" class="primary">Start Fishing</button>
      <button id="stopFishBtn" class="primary" style="background:#555; display:none;">Stop Fishing</button>
      <button onclick="openRiverFishingArea()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFishBtn').onclick = startFishingTrout;
  document.getElementById('stopFishBtn').onclick = stopFishing;
  showMainScreen('hubDynamic');
}

async function startFishingTrout() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Trout')) {
    await showGameAlert("Inventory Full", "You have no room to fish this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fishingActive) return;

  // --- NEW: Check for Fishing Pole ---
  let hasPole = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Pole') {
          hasPole = true;
          break;
      }
  }
  if (!hasPole) {
      await showGameAlert("Tool Required", "You need a Fishing Pole in your inventory to fish.");
      return;
  }
  // --- END NEW ---

  // --- NEW: Check for Fishing Bait ---
  let hasBait = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Bait') {
          hasBait = true;
          break;
      }
  }
  if (!hasBait) {
      await showGameAlert("Material Required", "You need Fishing Bait in your inventory to fish.");
      return;
  }
  // --- END NEW ---
  
  game.fishingActive = true;
  document.getElementById('startFishBtn').style.display = 'none';
  document.getElementById('stopFishBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fishingTroutLoop(Date.now(), Date.now()), 16);
}

async function fishingTroutLoop(timestamp, startTime) {
  if (!game.fishingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= FISHING_TIME_MS) {
    let hasBait = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBait = true;
            break;
        }
    }
    if (!hasBait) {
        await showGameAlert("Out of Materials", "You've run out of Fishing Bait.");
        stopFishing();
        return;
    }

    removeItem('Fishing Bait', 1);
    addItem('Trout', 1);
    addXP('fishing', TROUT_FISH_XP);
    showItemPopup(`+${TROUT_FISH_XP} Fishing XP`, 'fishProgress', 0);
    showItemPopup(`+1 Trout`, 'fishProgress', 450);
    
    document.getElementById('fishProgress').style.width = '0%';
    
    const overdueTime = elapsed - FISHING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let hasBaitAfter = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBaitAfter = true;
            break;
        }
    }
    if (!hasBaitAfter) {
        await showGameAlert("Not Enough Materials", "You don't have any more Fishing Bait.");
        stopFishing();
        return;
    }

    const emptySlotIndex = game.inventory.findIndex(slot => slot === null);
    const stackIndex = game.inventory.findIndex(slot => slot && slot.name === 'Trout');
    if (emptySlotIndex === -1 && stackIndex === -1) {
        await showGameAlert("Inventory Full", "Your inventory is full.");
        stopFishing();
        return;
    }
    
    return fishingTroutLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / FISHING_TIME_MS) * 100;
    document.getElementById('fishProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fishingTroutLoop(Date.now(), startTime), 16);
  }
}

// --- Salmon (River) UI & Logic ---
function openFishSalmon(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fishing - Salmon</h2>
    <div style="margin-top:8px; color:#efe3cf;">A large, strong river fish.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fishProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFishBtn" class="primary">Start Fishing</button>
      <button id="stopFishBtn" class="primary" style="background:#555; display:none;">Stop Fishing</button>
      <button onclick="openRiverFishingArea()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFishBtn').onclick = startFishingSalmon;
  document.getElementById('stopFishBtn').onclick = stopFishing;
  showMainScreen('hubDynamic');
}

async function startFishingSalmon() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Salmon')) {
    await showGameAlert("Inventory Full", "You have no room to fish this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fishingActive) return;

  // --- NEW: Check for Fishing Pole ---
  let hasPole = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Pole') {
          hasPole = true;
          break;
      }
  }
  if (!hasPole) {
      await showGameAlert("Tool Required", "You need a Fishing Pole in your inventory to fish.");
      return;
  }
  // --- END NEW ---

  // --- NEW: Check for Fishing Bait ---
  let hasBait = false;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Fishing Bait') {
          hasBait = true;
          break;
      }
  }
  if (!hasBait) {
      await showGameAlert("Material Required", "You need Fishing Bait in your inventory to fish.");
      return;
  }
  // --- END NEW ---
  
  game.fishingActive = true;
  document.getElementById('startFishBtn').style.display = 'none';
  document.getElementById('stopFishBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fishingSalmonLoop(Date.now(), Date.now()), 16);
}

async function fishingSalmonLoop(timestamp, startTime) {
  if (!game.fishingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= FISHING_TIME_MS) {
    let hasBait = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBait = true;
            break;
        }
    }
    if (!hasBait) {
        await showGameAlert("Out of Materials", "You've run out of Fishing Bait.");
        stopFishing();
        return;
    }

    removeItem('Fishing Bait', 1);
    addItem('Salmon', 1);
    addXP('fishing', SALMON_FISH_XP);
    showItemPopup(`+${SALMON_FISH_XP} Fishing XP`, 'fishProgress', 0);
    showItemPopup(`+1 Salmon`, 'fishProgress', 450);
    
    document.getElementById('fishProgress').style.width = '0%';
    
    const overdueTime = elapsed - FISHING_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let hasBaitAfter = false;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Fishing Bait') {
            hasBaitAfter = true;
            break;
        }
    }
    if (!hasBaitAfter) {
        await showGameAlert("Not Enough Materials", "You don't have any more Fishing Bait.");
        stopFishing();
        return;
    }

    const emptySlotIndex = game.inventory.findIndex(slot => slot === null);
    const stackIndex = game.inventory.findIndex(slot => slot && slot.name === 'Salmon');
    if (emptySlotIndex === -1 && stackIndex === -1) {
        await showGameAlert("Inventory Full", "Your inventory is full.");
        stopFishing();
        return;
    }
    
    return fishingSalmonLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / FISHING_TIME_MS) * 100;
    document.getElementById('fishProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fishingSalmonLoop(Date.now(), startTime), 16);
  }
}

// =================================================================
// --- END NEW FISHING FUNCTIONS ---
// =================================================================

// =================================================================
// +++ NEW: QUEST SYSTEM FUNCTIONS (ID BASED) +++
// =================================================================

function openQuestHub() {
  showMainScreen('hubQuests');
  renderQuestLinesList();
}

// Helper: Migrates old "step" data to new "ID" data on the fly
function getQuestProgress(lineId) {
    // Initialize if missing
    if (!game.questLines[lineId]) {
        game.questLines[lineId] = { completed: [], activeQuestId: null, kills: 0 };
    }

    const data = game.questLines[lineId];
    const lineConfig = QUEST_LINES[lineId];

    // --- MIGRATION LOGIC (Step -> IDs) ---
    // FIX: Only run migration if 'completed' array does NOT exist yet.
    // This prevents the game from using the old 'step' value to wipe your new progress on reload.
    if (typeof data.step === 'number' && !data.completed) {
        data.completed = [];
        
        // +++ SPECIFIC PATCH FOR 'TUTORIAL' LINE +++
        if (lineId === 'tutorial') {
            if (data.step >= 1) data.completed.push('tut_1'); // Foundation
            if (data.step >= 2) data.completed.push('tut_2'); // Chickens
            if (data.step >= 3) data.completed.push('tut_3'); // Spiders
        } 
        else {
            for (let i = 0; i < data.step; i++) {
                if (lineConfig.quests[i]) {
                    data.completed.push(lineConfig.quests[i].id);
                }
            }
        }
        
        data.activeQuestId = null; 
    }

    // Always delete the old 'step' from local memory so it doesn't cause issues during this session
    if (typeof data.step !== 'undefined') {
        delete data.step;
    }
    // --- END MIGRATION ---

    // Ensure completed is an array (if it was somehow missing)
    if (!data.completed) data.completed = [];

    // Determine the current active quest
    let firstUnfinished = null;
    for (const q of lineConfig.quests) {
        if (!data.completed.includes(q.id)) {
            firstUnfinished = q;
            break; // Stop at the first missing quest
        }
    }

    // Logic to reset kills if the active quest has changed
    if (firstUnfinished) {
        if (data.activeQuestId !== firstUnfinished.id) {
            data.activeQuestId = firstUnfinished.id;
            data.kills = 0; 
        }
    } else {
        data.activeQuestId = 'COMPLETED';
    }

    return { data, activeQuest: firstUnfinished };
}

/**
 * Renders the content for the entire Quests sidebar tab.
 */
function renderQuestTabContent() {
    renderActiveQuestDetails();
    renderBountyDetails();
}

/**
 * Renders the active quest details (only the first in the Tutorial line for now)
 * into the Quests sidebar tab.
 */
function renderActiveQuestDetails() {
    const container = document.getElementById('questsSubTabContent');
    if (!container) return;

    // --- We only care about the Tutorial line for the sidebar display ---
    const lineId = 'tutorial'; 
    const lineData = QUEST_LINES[lineId];
    if (!lineData) return;

    const { data, activeQuest } = getQuestProgress(lineId);

    if (!activeQuest) {
        container.innerHTML = `<div style="text-align:center; color:#44aa44; font-style:italic; padding: 10px;">All quests completed!</div>`;
        return;
    }
    
    // --- RENDER ACTIVE QUEST DETAILS ---
    let reqHtml = '';
    
    // Check Skill Requirement
    if (activeQuest.reqSkill) {
        const currentLvl = game[activeQuest.reqSkill.skill].level;
        const reqLvl = activeQuest.reqSkill.level;
        const met = currentLvl >= reqLvl;
        const color = met ? '#aaffaa' : '#ff8888';
        reqHtml += `<div style="color:${color}; margin-bottom: 5px;">${met ? '' : ''} Lvl ${reqLvl} ${activeQuest.reqSkill.skill}</div>`;
    }

    // Check Task Requirement
    if (activeQuest.type === 'gather') {
        activeQuest.reqItems.forEach(req => {
            let has = 0;
            for (const slot of game.inventory) if (slot && slot.name === req.name) has += slot.qty;
            const met = has >= req.qty;
            const color = met ? '#aaffaa' : '#ff8888';
            reqHtml += `<div style="color:${color};">${met ? '' : ''} Gather ${req.qty} ${req.name}</div>`;
        });
    } else if (activeQuest.type === 'kill') {
        const currentKills = data.kills || 0;
        const target = activeQuest.targetCount;
        const met = currentKills >= target;
        const color = met ? '#aaffaa' : '#ff8888';
        reqHtml += `<div style="color:${color};">${met ? '' : ''} Kill ${target} ${activeQuest.targetEnemy}s (Progress: ${currentKills}/${target})</div>`;
    }

    // Final Render
    container.innerHTML = `
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px;">
            <div style="font-weight: bold; color: var(--gold); margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                Current Quest: ${activeQuest.name}
            </div>
            <div style="font-style: italic; font-size: 13px; color: #ccc; margin-bottom: 10px;">
                ${activeQuest.desc}
            </div>
            <div style="font-weight: bold; color: #fff; margin-bottom: 5px;">Objectives:</div>
            ${reqHtml}
        </div>
    `;
}

/**
 * Renders the active bounty details into the Missions sidebar tab.
 */
function renderBountyDetails() {
    const container = document.getElementById('missionsSubTabContent');
    if (!container) return;

    const b = game.activeBounty;

    if (!b) {
        container.innerHTML = `<div style="text-align:center; color:#ccc; font-style:italic; padding: 10px;">No active mission. Visit the Hunting Board to accept a bounty.</div>`;
        return;
    }

    const isComplete = b.kills >= b.req;
    const statusColor = isComplete ? '#44aa44' : 'var(--gold)';
    const statusText = isComplete ? 'MISSION COMPLETE' : 'IN PROGRESS';
    
    // RENDER ACTIVE BOUNTY DETAILS
    container.innerHTML = `
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px;">
            <div style="font-weight: bold; color: var(--gold); margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                Active Bounty: Kill ${b.target}s
            </div>
            
            <div style="font-weight: bold; color: ${statusColor}; margin-bottom: 10px;">
                Status: ${statusText}
            </div>
            
            <div style="margin-bottom: 10px;">
               Progress: <span style="color: #fff; font-weight: bold;">${b.kills} / ${b.req}</span>
            </div>
            <div style="width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
               <div style="width: ${Math.min(100, (b.kills / b.req) * 100)}%; height: 100%; background: var(--gold);"></div>
            </div>
            <div style="font-size: 14px; color: #aaffaa;">
               Reward: ${b.reward} Gold
            </div>
        </div>
    `;
}


function renderQuestLinesList() {
  const container = document.getElementById('questLinesContainer');
  container.innerHTML = '';

  for (const [lineId, lineData] of Object.entries(QUEST_LINES)) {
    const { data, activeQuest } = getQuestProgress(lineId);
    
    const isLineComplete = (data.activeQuestId === 'COMPLETED');
    const totalSteps = lineData.quests.length;
    const completedCount = data.completed.length;

    const div = document.createElement('div');
    div.className = `quest-line-card ${isLineComplete ? 'quest-line-completed' : ''}`;
    
    let statusText = "";
    let color = "#efe3cf";
    
    if (isLineComplete) {
        statusText = "All Quests Completed";
        color = "#44aa44";
    } else {
        // Check if current quest is ready
        if (checkQuestRequirements(lineId)) {
            statusText = `Active: ${activeQuest.name} <span style="color:#aaffaa; font-weight:bold;">(Ready!)</span>`;
            div.style.borderColor = "#44aa44"; 
        } else {
            statusText = `Active: ${activeQuest.name}`;
        }
    }

    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size: 18px; font-weight: bold; color: var(--gold);">${lineData.name}</div>
        <div style="font-size: 14px; color: #aaa;">${completedCount} / ${totalSteps}</div>
      </div>
      <div style="margin-top: 5px; font-size: 14px; color: ${color};">${statusText}</div>
      <div style="font-size: 12px; color: #888; margin-top: 4px;">${lineData.desc}</div>
    `;
    
    div.onclick = () => openQuestLine(lineId);
    container.appendChild(div);
  }
}

function openQuestLine(lineId) {
    showMainScreen('hubQuestLine');
    const lineData = QUEST_LINES[lineId];
    const { data, activeQuest } = getQuestProgress(lineId);
    
    setText('questLineTitle', lineData.name);
    
    // --- 1. RENDER COMPLETED HISTORY ---
    const historySection = document.getElementById('completedQuestsSection');
    const historyList = document.getElementById('completedQuestsList');
    
    // Find specifically WHICH quests are done from the config list order
    // This allows inserted quests to show up correctly as "not done" even if later ones are done (rare edge case)
    // But mostly this list just shows what we have marked as complete.
    const completedQuestsInOrder = lineData.quests.filter(q => data.completed.includes(q.id));

    if (completedQuestsInOrder.length > 0) {
        historySection.style.display = 'block';
        let historyHtml = '';
        completedQuestsInOrder.forEach(q => {
            historyHtml += `
                <div class="completed-quest-row">
                    <span>${q.name}</span>
                    <span style="color:#44aa44; font-weight:bold;"></span>
                </div>
            `;
        });
        historyList.innerHTML = historyHtml;
        historyList.scrollTop = historyList.scrollHeight;
    } else {
        historySection.style.display = 'none';
    }

    const container = document.getElementById('activeQuestContainer');

    // --- 2. CHECK COMPLETION ---
    if (!activeQuest) {
        container.innerHTML = `<div style="text-align:center; color:#44aa44; font-weight:bold; font-size:18px; padding: 20px;">This quest line is complete!</div>`;
        return;
    }

    // --- 3. RENDER ACTIVE QUEST ---
    container.innerHTML = `
        <h3 id="activeQuestName" style="color: var(--gold); margin-top: 0;"></h3>
        <div id="activeQuestDesc" style="font-style: italic; color: #ccc; margin-bottom: 15px;"></div>
        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;">
            <div style="font-weight: bold; margin-bottom: 5px;">Requirements:</div>
            <div id="activeQuestReqs"></div>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px; color: #aaffaa;">Rewards:</div>
            <div id="activeQuestRewards"></div>
        </div>
        <div class="action-buttons" style="margin-top: 20px; justify-content: flex-end;">
            <button id="questCompleteBtn" class="primary" style="background: #44aa44; display: none;">Complete Quest</button>
        </div>
    `;

    const qData = activeQuest;
    setText('activeQuestName', `Current: ${qData.name}`);
    setText('activeQuestDesc', qData.desc);

    // --- REQUIREMENTS ---
    let reqHtml = '';
    if (qData.reqSkill) {
        const currentLvl = game[qData.reqSkill.skill].level;
        const reqLvl = qData.reqSkill.level;
        const met = currentLvl >= reqLvl;
        const color = met ? 'quest-req-met' : 'quest-req-not-met';
        const icon = met ? '' : '';
        reqHtml += `<div class="${color}">${icon} Level ${reqLvl} ${qData.reqSkill.skill}</div>`;
    }

    if (qData.type === 'gather') {
        qData.reqItems.forEach(req => {
            let has = 0;
            for (const slot of game.inventory) if (slot && slot.name === req.name) has += slot.qty;
            const met = has >= req.qty;
            const color = met ? 'quest-req-met' : 'quest-req-not-met';
            const icon = met ? '' : '';
            reqHtml += `<div class="${color}">${icon} ${req.qty} ${req.name}</div>`;
        });
    } else if (qData.type === 'kill') {
        const currentKills = data.kills || 0;
        const target = qData.targetCount;
        const met = currentKills >= target;
        const color = met ? 'quest-req-met' : 'quest-req-not-met';
        const icon = met ? '' : '';
        reqHtml += `<div class="${color}">${icon} Kill ${target} ${qData.targetEnemy}s (Progress: ${currentKills}/${target})</div>`;
    }
    document.getElementById('activeQuestReqs').innerHTML = reqHtml;

    // --- REWARDS ---
    let rewHtml = '';
    if (qData.rewards.gold) rewHtml += `<div style="color:var(--gold);"> ${qData.rewards.gold} Gold</div>`;
    if (qData.rewards.items) {
        qData.rewards.items.forEach(r => {
            rewHtml += `<div style="color:#fff;"> ${r.qty} ${r.name}</div>`;
        });
    }
    document.getElementById('activeQuestRewards').innerHTML = rewHtml;

    // --- BUTTONS ---
    const completeBtn = document.getElementById('questCompleteBtn');
    if (checkQuestRequirements(lineId)) {
        completeBtn.style.display = 'inline-block';
        completeBtn.onclick = () => completeQuest(lineId);
    } else {
        completeBtn.style.display = 'none';
    }
}

function checkQuestRequirements(lineId) {
    const { data, activeQuest } = getQuestProgress(lineId);
    if (!activeQuest) return false; // Line complete
    
    const qData = activeQuest;

    // Check Skill
    if (qData.reqSkill) {
        if (game[qData.reqSkill.skill].level < qData.reqSkill.level) return false;
    }

    if (qData.type === 'gather') {
        for (const req of qData.reqItems) {
            let count = 0;
            for (const slot of game.inventory) {
                if (slot && slot.name === req.name) count += slot.qty;
            }
            if (count < req.qty) return false;
        }
        return true;
    } else if (qData.type === 'kill') {
        return (data.kills || 0) >= qData.targetCount;
    }
    return false;
}

async function completeQuest(lineId) {
    if (!checkQuestRequirements(lineId)) return;
    
    const { data, activeQuest } = getQuestProgress(lineId);
    const qData = activeQuest;
    
    // 1. Deduct Gather Items
    if (qData.type === 'gather') {
        // Only remove items if 'consume' is not explicitly set to false
        if (qData.consume !== false) {
            for (const req of qData.reqItems) {
                removeItem(req.name, req.qty);
            }
        }
    }
    
    // 2. Give Rewards
    if (qData.rewards.gold) addGold(qData.rewards.gold);
    if (qData.rewards.items) {
        qData.rewards.items.forEach(r => addItem(r.name, r.qty));
    }
    
    // 3. Mark Complete (Push ID to array)
    data.completed.push(qData.id);
    data.kills = 0; // Reset kills for next quest
    data.activeQuestId = null; // Force recalculation
    
    playGlobalSound('sounds/soundeffects/levelupsound.mp3'); 
    await showGameAlert("Quest Complete!", `You completed: ${qData.name}`);
    
    // --- NEW: Real-time update for the sidebar tab + main hub ---
    if (typeof window.renderActiveQuestDetails === 'function') {
        window.renderActiveQuestDetails();
    }
    // Also update the main hub list
    if (typeof window.renderQuestLinesList === 'function') {
        window.renderQuestLinesList();
    }
    // --- END NEW ---
    
    game.isDirty = true;
    
    // Refresh the main quest line hub screen (if the player is on it)
    openQuestLine(lineId);
}

function updateQuestKillCount(enemyName) {
    let updated = false;
    
    for (const [lineId, lineData] of Object.entries(QUEST_LINES)) {
        const { data, activeQuest } = getQuestProgress(lineId);
        
        if (!activeQuest) continue;
        
        // Is this a kill quest for this enemy?
        if (activeQuest.type === 'kill' && activeQuest.targetEnemy === enemyName) {
            if (data.kills < activeQuest.targetCount) {
                data.kills++;
                updated = true;
            }
        }
    }
    
    if (updated) {
        if (typeof window.renderActiveQuestDetails === 'function') {
            window.renderActiveQuestDetails();
        }
        game.isDirty = true;
    }
}


// --- Unstrung Softwood Bow UI & Logic ---
function openFletchUnstrungSoftwoodBow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Unstrung Softwood Bow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${UNSTRUNG_SOFTWOOD_WOOD_COST} Softwood. Yields ${UNSTRUNG_SOFTWOOD_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingUnstrungSoftwoodBow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingUnstrungSoftwoodBow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Unstrung Softwood Bow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Softwood') totalWood += slot.qty;
  }

  if (totalWood < UNSTRUNG_SOFTWOOD_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${UNSTRUNG_SOFTWOOD_WOOD_COST} Softwood.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingUnstrungSoftwoodBowLoop(Date.now(), Date.now()), 16);
}

async function fletchingUnstrungSoftwoodBowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= UNSTRUNG_SOFTWOOD_TIME_MS) {
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Softwood') totalWood += slot.qty;
    }
    if (totalWood < UNSTRUNG_SOFTWOOD_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of Softwood.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Softwood', UNSTRUNG_SOFTWOOD_WOOD_COST);
    addItem('Unstrung Softwood Bow', UNSTRUNG_SOFTWOOD_YIELD);
    addXP('fletching', UNSTRUNG_SOFTWOOD_XP);
    showItemPopup(`+${UNSTRUNG_SOFTWOOD_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${UNSTRUNG_SOFTWOOD_YIELD} Unstrung Softwood Bow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - UNSTRUNG_SOFTWOOD_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Softwood') totalWoodAfter += slot.qty;
    }
    if (totalWoodAfter < UNSTRUNG_SOFTWOOD_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Softwood to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingUnstrungSoftwoodBowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / UNSTRUNG_SOFTWOOD_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingUnstrungSoftwoodBowLoop(Date.now(), startTime), 16);
  }
}

// --- Softwood Bow UI & Logic ---
function openFletchSoftwoodBow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Softwood Bow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${SOFTWOOD_BOW_UNSTRUNG_COST} Unstrung Softwood Bow, ${SOFTWOOD_BOW_STRING_COST} Bow String. Yields ${SOFTWOOD_BOW_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingSoftwoodBow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingSoftwoodBow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Softwood Bow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalUnstrung = 0;
  let totalStrings = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Unstrung Softwood Bow') totalUnstrung += slot.qty;
      if (slot && slot.name === 'Bow String') totalStrings += slot.qty;
  }

  if (totalUnstrung < SOFTWOOD_BOW_UNSTRUNG_COST || totalStrings < SOFTWOOD_BOW_STRING_COST) {
      await showGameAlert("Not Enough Materials", `You need ${SOFTWOOD_BOW_UNSTRUNG_COST} Unstrung Softwood Bow and ${SOFTWOOD_BOW_STRING_COST} Bow String.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingSoftwoodBowLoop(Date.now(), Date.now()), 16);
}

async function fletchingSoftwoodBowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= SOFTWOOD_BOW_TIME_MS) {
    let totalUnstrung = 0;
    let totalStrings = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unstrung Softwood Bow') totalUnstrung += slot.qty;
        if (slot && slot.name === 'Bow String') totalStrings += slot.qty;
    }
    if (totalUnstrung < SOFTWOOD_BOW_UNSTRUNG_COST || totalStrings < SOFTWOOD_BOW_STRING_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Unstrung Softwood Bow', SOFTWOOD_BOW_UNSTRUNG_COST);
    removeItem('Bow String', SOFTWOOD_BOW_STRING_COST);
    addItem('Softwood Bow', SOFTWOOD_BOW_YIELD);
    addXP('fletching', SOFTWOOD_BOW_XP);
    showItemPopup(`+${SOFTWOOD_BOW_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${SOFTWOOD_BOW_YIELD} Softwood Bow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - SOFTWOOD_BOW_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalUnstrungAfter = 0;
    let totalStringsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unstrung Softwood Bow') totalUnstrungAfter += slot.qty;
        if (slot && slot.name === 'Bow String') totalStringsAfter += slot.qty;
    }
    if (totalUnstrungAfter < SOFTWOOD_BOW_UNSTRUNG_COST || totalStringsAfter < SOFTWOOD_BOW_STRING_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingSoftwoodBowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / SOFTWOOD_BOW_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingSoftwoodBowLoop(Date.now(), startTime), 16);
  }
}

// --- Unstrung Oak Bow UI & Logic ---
function openFletchUnstrungOakBow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Unstrung Oak Bow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${UNSTRUNG_OAK_WOOD_COST} Oak. Yields ${UNSTRUNG_OAK_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingUnstrungOakBow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingUnstrungOakBow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Unstrung Oak Bow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalWood = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Oak') totalWood += slot.qty;
  }

  if (totalWood < UNSTRUNG_OAK_WOOD_COST) {
      await showGameAlert("Not Enough Materials", `You need at least ${UNSTRUNG_OAK_WOOD_COST} Oak.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingUnstrungOakBowLoop(Date.now(), Date.now()), 16);
}

async function fletchingUnstrungOakBowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= UNSTRUNG_OAK_TIME_MS) {
    let totalWood = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalWood += slot.qty;
    }
    if (totalWood < UNSTRUNG_OAK_WOOD_COST) {
        await showGameAlert("Out of Materials", "You've run out of Oak.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Oak', UNSTRUNG_OAK_WOOD_COST);
    addItem('Unstrung Oak Bow', UNSTRUNG_OAK_YIELD);
    addXP('fletching', UNSTRUNG_OAK_XP);
    showItemPopup(`+${UNSTRUNG_OAK_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${UNSTRUNG_OAK_YIELD} Unstrung Oak Bow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - UNSTRUNG_OAK_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalWoodAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Oak') totalWoodAfter += slot.qty;
    }
    if (totalWoodAfter < UNSTRUNG_OAK_WOOD_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough Oak to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingUnstrungOakBowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / UNSTRUNG_OAK_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingUnstrungOakBowLoop(Date.now(), startTime), 16);
  }
}

// --- Oak Bow UI & Logic ---
function openFletchOakBow(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Fletching - Oak Bow</h2>
    <div style="margin-top:8px; color:#efe3cf;">Requires: ${OAK_BOW_UNSTRUNG_COST} Unstrung Oak Bow, ${OAK_BOW_STRING_COST} Bow String. Yields ${OAK_BOW_YIELD}.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="fletchProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startFletchBtn" class="primary">Start Fletching</button>
      <button id="stopFletchBtn" class="primary" style="background:#555; display:none;">Stop Fletching</button>
      <button onclick="openFletchingHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startFletchBtn').onclick = startFletchingOakBow;
  document.getElementById('stopFletchBtn').onclick = () => stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn'); 
  showMainScreen('hubDynamic');
}

async function startFletchingOakBow() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem('Oak Bow')) {
    await showGameAlert("Inventory Full", "You have no room to fletch this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.fletchingActive) return;

  let totalUnstrung = 0;
  let totalStrings = 0;
  for (const slot of game.inventory) {
      if (slot && slot.name === 'Unstrung Oak Bow') totalUnstrung += slot.qty;
      if (slot && slot.name === 'Bow String') totalStrings += slot.qty;
  }

  if (totalUnstrung < OAK_BOW_UNSTRUNG_COST || totalStrings < OAK_BOW_STRING_COST) {
      await showGameAlert("Not Enough Materials", `You need ${OAK_BOW_UNSTRUNG_COST} Unstrung Oak Bow and ${OAK_BOW_STRING_COST} Bow String.`);
      return;
  }
  
  game.fletchingActive = true;
  document.getElementById('startFletchBtn').style.display = 'none';
  document.getElementById('stopFletchBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => fletchingOakBowLoop(Date.now(), Date.now()), 16);
}

async function fletchingOakBowLoop(timestamp, startTime) {
  if (!game.fletchingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= OAK_BOW_TIME_MS) {
    let totalUnstrung = 0;
    let totalStrings = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unstrung Oak Bow') totalUnstrung += slot.qty;
        if (slot && slot.name === 'Bow String') totalStrings += slot.qty;
    }
    if (totalUnstrung < OAK_BOW_UNSTRUNG_COST || totalStrings < OAK_BOW_STRING_COST) {
        await showGameAlert("Out of Materials", "You've run out of materials.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    removeItem('Unstrung Oak Bow', OAK_BOW_UNSTRUNG_COST);
    removeItem('Bow String', OAK_BOW_STRING_COST);
    addItem('Oak Bow', OAK_BOW_YIELD);
    addXP('fletching', OAK_BOW_XP);
    showItemPopup(`+${OAK_BOW_XP} Fletching XP`, 'fletchProgress', 0);
    showItemPopup(`+${OAK_BOW_YIELD} Oak Bow`, 'fletchProgress', 450);
    
    document.getElementById('fletchProgress').style.width = '0%';
    
    const overdueTime = elapsed - OAK_BOW_TIME_MS;
    const newStartTime = Date.now() - overdueTime;
    
    let totalUnstrungAfter = 0;
    let totalStringsAfter = 0;
    for (const slot of game.inventory) {
        if (slot && slot.name === 'Unstrung Oak Bow') totalUnstrungAfter += slot.qty;
        if (slot && slot.name === 'Bow String') totalStringsAfter += slot.qty;
    }
    if (totalUnstrungAfter < OAK_BOW_UNSTRUNG_COST || totalStringsAfter < OAK_BOW_STRING_COST) {
        await showGameAlert("Not Enough Materials", "You don't have enough materials to make more.");
        stopFletching('fletchProgress', 'startFletchBtn', 'stopFletchBtn');
        return;
    }
    
    return fletchingOakBowLoop(Date.now(), newStartTime);

  } else {
    const progress = (elapsed / OAK_BOW_TIME_MS) * 100;
    document.getElementById('fletchProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => fletchingOakBowLoop(Date.now(), startTime), 16);
  }
}


function renderSmithingItems(metalType) {
  const container = document.getElementById('smithingItemsContainer');
  if (!container) return;
  
  const smithLvl = game.blacksmith.level;
  
  const setupSmithButton = (btnId, locked, onclick, levelReq, tooltipText, itemName) => {
    const btn = document.getElementById(btnId);
    if (btn) {
      const nameHtml = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">${itemName}</div>`;
      if (locked) {
        btn.onclick = null;
        const lockedTT = nameHtml + `<div style="color:#ff8888;">Requires Blacksmith Lvl: ${levelReq}</div>`;
        btn.onmouseenter = (event) => showTooltip(event, lockedTT);
      } else {
        btn.onclick = onclick;
        const unlockedTT = nameHtml + tooltipText;
        btn.onmouseenter = (event) => showTooltip(event, unlockedTT);
      }
      btn.onmouseleave = hideTooltip;
    }
  };
  
  if (metalType === 'copper') {
    const copperBarLocked = smithLvl < COPPER_BAR_LVL;
    const copperPickaxeLocked = smithLvl < COPPER_PICKAXE_LVL;
    const copperAxeLocked = smithLvl < COPPER_AXE_LVL;
    const copperSwordLocked = smithLvl < COPPER_SWORD_LVL;
    const copperBootsLocked = smithLvl < COPPER_BOOTS_LVL;
    const copperHelmetLocked = smithLvl < COPPER_HELMET_LVL;
    const copperPlatelegsLocked = smithLvl < COPPER_PLATELEGS_LVL;
    const copperChestLocked = smithLvl < COPPER_CHEST_LVL;
    const copperTipsLocked = smithLvl < BLACKSMITH_COPPER_TIPS_LVL;
    
    container.innerHTML = `
      <button id="copperBarBtn" class="primary ${copperBarLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperbar.png" alt="Copper Bar" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperPickaxeBtn" class="primary ${copperPickaxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperpickaxe.png" alt="Copper Pickaxe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperAxeBtn" class="primary ${copperAxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperaxe.png" alt="Copper Axe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperShortswordBtn" class="primary ${copperSwordLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/coppershortsword.png" alt="Copper Shortsword" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperBootsBtn" class="primary ${copperBootsLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperboots.png" alt="Copper Boots" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperHelmetBtn" class="primary ${copperHelmetLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperhelmet.png" alt="Copper Helmet" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperPlatelegsBtn" class="primary ${copperPlatelegsLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperplatelegs.png" alt="Copper Platelegs" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperChestplateBtn" class="primary ${copperChestLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperchestplate.png" alt="Copper Chestplate" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="copperArrowTipBtn" class="primary ${copperTipsLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/copperarrowtip.png" alt="Copper Arrow Tip" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
    `;
    
    setupSmithButton('copperBarBtn', copperBarLocked, openCopperBarSmith, COPPER_BAR_LVL, 'Requires: 2 Copper Ore', 'Copper Bar');
    setupSmithButton('copperPickaxeBtn', copperPickaxeLocked, openCopperPickaxeSmith, COPPER_PICKAXE_LVL, `Requires: ${COPPER_PICKAXE_BAR_COST} Copper Bars, ${COPPER_PICKAXE_WOOD_COST} Softwood`, 'Copper Pickaxe');
    setupSmithButton('copperAxeBtn', copperAxeLocked, openCopperAxeSmith, COPPER_AXE_LVL, `Requires: ${COPPER_AXE_BAR_COST} Copper Bars, ${COPPER_AXE_WOOD_COST} Softwood`, 'Copper Axe');
    setupSmithButton('copperShortswordBtn', copperSwordLocked, openCopperShortswordSmith, COPPER_SWORD_LVL, `Requires: ${SHORTSWORD_BAR_COST} Copper Bars`, 'Copper Shortsword');
    setupSmithButton('copperBootsBtn', copperBootsLocked, openCopperBootsSmith, COPPER_BOOTS_LVL, `Requires: ${BOOTS_BAR_COST} Copper Bars`, 'Copper Boots');
    setupSmithButton('copperHelmetBtn', copperHelmetLocked, openCopperHelmetSmith, COPPER_HELMET_LVL, `Requires: ${HELMET_BAR_COST} Copper Bars`, 'Copper Helmet');
    setupSmithButton('copperPlatelegsBtn', copperPlatelegsLocked, openCopperPlatelegsSmith, COPPER_PLATELEGS_LVL, `Requires: ${COPPER_PLATELEGS_BAR_COST} Copper Bars`, 'Copper Platelegs');
    setupSmithButton('copperChestplateBtn', copperChestLocked, openCopperChestplateSmith, COPPER_CHEST_LVL, `Requires: ${CHESTPLATE_BAR_COST} Copper Bars`, 'Copper Chestplate');
    setupSmithButton('copperArrowTipBtn', copperTipsLocked, openSmithCopperArrowTip, BLACKSMITH_COPPER_TIPS_LVL, `Requires: ${COPPER_ARROW_TIP_BAR_COST} Copper Bars`, `Copper Arrow Tip x${COPPER_ARROW_TIP_YIELD}`);
    
  } else if (metalType === 'iron') {
    const ironBarLocked = smithLvl < IRON_BAR_LVL;
    const ironPickaxeLocked = smithLvl < IRON_PICKAXE_LVL;
    const ironAxeLocked = smithLvl < IRON_AXE_LVL;
    const ironSwordLocked = smithLvl < IRON_SWORD_LVL;
    const ironBootsLocked = smithLvl < IRON_BOOTS_LVL;
    const ironHelmetLocked = smithLvl < IRON_HELMET_LVL;
    const ironPlatelegsLocked = smithLvl < IRON_PLATELEGS_LVL;
    const ironChestLocked = smithLvl < IRON_CHEST_LVL;
    
    container.innerHTML = `
      <button id="ironBarBtn" class="primary ${ironBarLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironbar.png" alt="Iron Bar" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironPickaxeBtn" class="primary ${ironPickaxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironpickaxe.png" alt="Iron Pickaxe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironAxeBtn" class="primary ${ironAxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironaxe.png" alt="Iron Axe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironShortswordBtn" class="primary ${ironSwordLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironshortsword.png" alt="Iron Shortsword" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironBootsBtn" class="primary ${ironBootsLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironboots.png" alt="Iron Boots" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironHelmetBtn" class="primary ${ironHelmetLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironhelmet.png" alt="Iron Helmet" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironPlatelegsBtn" class="primary ${ironPlatelegsLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironplatelegs.png" alt="Iron Platelegs" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="ironChestplateBtn" class="primary ${ironChestLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/ironchestplate.png" alt="Iron Chestplate" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
    `;
    
    setupSmithButton('ironBarBtn', ironBarLocked, openIronBarSmith, IRON_BAR_LVL, `Requires: ${IRON_BAR_ORE_COST} Iron Ore, ${IRON_BAR_COAL_COST} Coal Ore`, 'Iron Bar');
    setupSmithButton('ironPickaxeBtn', ironPickaxeLocked, openIronPickaxeSmith, IRON_PICKAXE_LVL, `Requires: ${IRON_PICKAXE_BAR_COST} Iron Bars, ${IRON_PICKAXE_WOOD_COST} Oak`, 'Iron Pickaxe');
    setupSmithButton('ironAxeBtn', ironAxeLocked, openIronAxeSmith, IRON_AXE_LVL, `Requires: ${IRON_AXE_BAR_COST} Iron Bars, ${IRON_AXE_WOOD_COST} Oak`, 'Iron Axe');
    setupSmithButton('ironShortswordBtn', ironSwordLocked, openIronShortswordSmith, IRON_SWORD_LVL, `Requires: ${IRON_SHORTSWORD_BAR_COST} Iron Bars`, 'Iron Shortsword');
    setupSmithButton('ironBootsBtn', ironBootsLocked, openIronBootsSmith, IRON_BOOTS_LVL, `Requires: ${IRON_BOOTS_BAR_COST} Iron Bars`, 'Iron Boots');
    setupSmithButton('ironHelmetBtn', ironHelmetLocked, openIronHelmetSmith, IRON_HELMET_LVL, `Requires: ${IRON_HELMET_BAR_COST} Iron Bars`, 'Iron Helmet');
    setupSmithButton('ironPlatelegsBtn', ironPlatelegsLocked, openIronPlatelegsSmith, IRON_PLATELEGS_LVL, `Requires: ${IRON_PLATELEGS_BAR_COST} Iron Bars`, 'Iron Platelegs');
    setupSmithButton('ironChestplateBtn', ironChestLocked, openIronChestplateSmith, IRON_CHEST_LVL, `Requires: ${IRON_CHESTPLATE_BAR_COST} Iron Bars`, 'Iron Chestplate');
    
  } else if (metalType === 'silver') {
    const silverBarLocked = smithLvl < SILVER_BAR_LVL;
    const silverPickaxeLocked = smithLvl < 22;
    const silverAxeLocked = smithLvl < 22;

    container.innerHTML = `
      <button id="silverBarBtn" class="primary ${silverBarLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/silverbar.png" alt="Silver Bar" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="silverPickaxeBtn" class="primary ${silverPickaxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/silverpickaxe.png" alt="Silver Pickaxe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
      <button id="silverAxeBtn" class="primary ${silverAxeLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/silveraxe.png" alt="Silver Axe" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>
    `;
    
    setupSmithButton('silverBarBtn', silverBarLocked, openSilverBarSmith, SILVER_BAR_LVL, `Requires: ${SILVER_BAR_ORE_COST} Silver Ore, ${SILVER_BAR_COAL_COST} Coal Ore`, 'Silver Bar');
    setupSmithButton('silverPickaxeBtn', silverPickaxeLocked, openSilverPickaxeSmith, 22, `Requires: ${SILVER_PICKAXE_BAR_COST} Silver Bars, ${SILVER_PICKAXE_WOOD_COST} Birch`, 'Silver Pickaxe');
    setupSmithButton('silverAxeBtn', silverAxeLocked, openSilverAxeSmith, 22, `Requires: ${SILVER_AXE_BAR_COST} Silver Bars, ${SILVER_AXE_WOOD_COST} Birch`, 'Silver Axe');
  } else if (metalType === 'gold') {
    const goldBarLocked = smithLvl < GOLD_BAR_LVL;
    container.innerHTML = `
      <button id="goldBarBtn" class="primary ${goldBarLocked ? 'locked-item' : ''}" style="width: var(--slot-size); height: var(--slot-size); display: flex; align-items: center; justify-content: center; padding: 0;">
        <img src="images/goldbar.png" alt="Gold Bar" style="width: 60px; height: 60px; border-radius: 4px; object-fit: contain;">
      </button>`;
    setupSmithButton('goldBarBtn', goldBarLocked, openGoldBarSmith, GOLD_BAR_LVL, `Requires: ${GOLD_BAR_ORE_COST} Gold Ore, ${GOLD_BAR_COAL_COST} Coal Ore`, 'Gold Bar');
  }
}

// --- NEW: Coal Mine UI ---

function openCopperMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Mine - Copper Vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A common copper vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = startMining;
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}




function openCoalMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Mine - Coal Vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A dark, crumbly coal vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startCoalMining();
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Sand Mine UI ---
function openSandMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Sand</h2>
    <div style="margin-top:8px; color:#efe3cf;">A pile of coarse sand.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = startSandMining;
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

async function startSandMining() {
  // Tool Check (Any pickaxe)
  const bestPickaxe = getBestTool('pickaxe');
  if (bestPickaxe < 1) {
    await showGameAlert("Tool Required", "You need at least a Bronze Pickaxe.");
    return;
  }
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (!canReceiveItem(SAND_MINE_ITEM)) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }

  if (game.miningActive) return; 
  game.miningActive = true;
  const startBtn = document.getElementById('startMineBtn');
  const stopBtn = document.getElementById('stopMineBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => sandMiningLoop(Date.now(), Date.now()), 16);
}

function sandMiningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= SAND_MINE_TIME_MS) {
    addItem(SAND_MINE_ITEM, 1);
    addXP('mining', SAND_MINE_XP);
    showItemPopup(`+${SAND_MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 ${SAND_MINE_ITEM}`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) {
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }
    
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - SAND_MINE_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;
    
    return miningCooldownLoop(Date.now(), newCooldownStartTime, MINE_COOLDOWN_SAND_MS, 'mineProgressText', sandMiningLoop);
    
  } else {
    const progress = (elapsed / SAND_MINE_TIME_MS) * 100;
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => sandMiningLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Coal Mine Logic ---
async function startCoalMining() {
  // +++ NEW: Tool Check +++
  const bestPickaxe = getBestTool('pickaxe');
  if (bestPickaxe < 2) { // Requires Copper (Tier 2)
    await showGameAlert("Tool Required", "You need at least a Copper Pickaxe in your inventory to mine this.");
    return;
  }
  // +++ END NEW +++
  
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(COAL_MINE_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to mine this.");
    return;
  }
  // +++ END NEW +++

  if (game.miningActive) return; 
  game.miningActive = true;
  const startBtn = document.getElementById('startMineBtn');
  const stopBtn = document.getElementById('stopMineBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => coalMiningLoop(Date.now(), Date.now()), 16);
}

function coalMiningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= COAL_MINE_TIME_MS) {
    addItem(COAL_MINE_ITEM, 1);
    addXP('mining', COAL_MINE_XP);
    showItemPopup(`+${COAL_MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 ${COAL_MINE_ITEM}`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) {
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }
    
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - COAL_MINE_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;
    
    // --- THIS IS THE FIX: Immediately call the cooldown loop ---
    return miningCooldownLoop(Date.now(), newCooldownStartTime, MINE_COOLDOWN_COAL_MS, 'mineProgressText', coalMiningLoop);
    
  } else {
    const progress = (elapsed / COAL_MINE_TIME_MS) * 100;
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => coalMiningLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Mine UI ---
function openIronMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Mine - Iron Vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A sturdy iron vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startIronMining();
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

function openSilverMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Silver Vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A shimmering silver vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startSilverMining();
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

async function startSilverMining() {
  if (getBestTool('pickaxe') < 3) { 
    await showGameAlert("Tool Required", "You need at least an Iron Pickaxe in your inventory to mine silver.");
    return;
  }
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Session not active."); return; }
  if (!canReceiveItem(SILVER_MINE_ITEM)) { await showGameAlert("Inventory Full", "You have no room."); return; }

  if (game.miningActive) return; 
  game.miningActive = true;
  document.getElementById('startMineBtn').style.display = 'none';
  document.getElementById('stopMineBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => silverMiningLoop(Date.now(), Date.now()), 16);
}

function silverMiningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;
  if (elapsed >= SILVER_MINE_TIME_MS) {
    addItem(SILVER_MINE_ITEM, 1);
    addXP('mining', SILVER_MINE_XP);
    showItemPopup(`+${SILVER_MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 Silver Ore`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) {
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }

    document.getElementById('mineProgress').style.width = '0%';
    const overdueTime = elapsed - SILVER_MINE_TIME_MS;
    return miningCooldownLoop(Date.now(), Date.now() - overdueTime, MINE_COOLDOWN_SILVER_MS, 'mineProgressText', silverMiningLoop);
  } else {
    const progress = (elapsed / SILVER_MINE_TIME_MS) * 100;
    document.getElementById('mineProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => silverMiningLoop(Date.now(), startTime), 16);
  }
}

function openGoldMine(){
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Gold Vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A rich gold vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startGoldMining();
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

async function startGoldMining() {
  if (getBestTool('pickaxe') < 3) { 
    await showGameAlert("Tool Required", "You need at least an Iron Pickaxe in your inventory to mine gold.");
    return;
  }
  if (!game.isSessionActive) { await showGameAlert("Session Not Active", "Session not active."); return; }
  if (!canReceiveItem(GOLD_MINE_ITEM)) { await showGameAlert("Inventory Full", "You have no room."); return; }

  if (game.miningActive) return; 
  game.miningActive = true;
  document.getElementById('startMineBtn').style.display = 'none';
  document.getElementById('stopMineBtn').style.display = 'inline-block';
  game.progressFrame = setTimeout(() => goldMiningLoop(Date.now(), Date.now()), 16);
}

function goldMiningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;
  if (elapsed >= GOLD_MINE_TIME_MS) {
    addItem(GOLD_MINE_ITEM, 1);
    addXP('mining', GOLD_MINE_XP);
    showItemPopup(`+${GOLD_MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 Gold Ore`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) {
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }

    document.getElementById('mineProgress').style.width = '0%';
    const overdueTime = elapsed - GOLD_MINE_TIME_MS;
    return miningCooldownLoop(Date.now(), Date.now() - overdueTime, MINE_COOLDOWN_GOLD_MS, 'mineProgressText', goldMiningLoop);
  } else {
    const progress = (elapsed / GOLD_MINE_TIME_MS) * 100;
    document.getElementById('mineProgress').style.width = progress + '%';
    game.progressFrame = setTimeout(() => goldMiningLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Iron Mine Logic ---
async function startIronMining() {
  // +++ NEW: Tool Check +++
  const bestPickaxe = getBestTool('pickaxe');
  if (bestPickaxe < 2) { // Requires Copper (Tier 2)
    await showGameAlert("Tool Required", "You need at least a Copper Pickaxe in your inventory to mine this.");
    return;
  }
  // +++ END NEW +++

  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(IRON_MINE_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to mine this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.miningActive) return; 
  game.miningActive = true;
  const startBtn = document.getElementById('startMineBtn');
  const stopBtn = document.getElementById('stopMineBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => ironMiningLoop(Date.now(), Date.now()), 16);
}

function ironMiningLoop(timestamp, startTime) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= IRON_MINE_TIME_MS) {
    addItem(IRON_MINE_ITEM, 1);
    addXP('mining', IRON_MINE_XP);
    showItemPopup(`+${IRON_MINE_XP} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 ${IRON_MINE_ITEM}`, 'mineProgress', 450);

    // +++ NEW GEM DROP LOGIC +++
    if (Math.random() < 0.01) {
        const gems = ['Uncut Topaz', 'Uncut Diamond', 'Uncut Emerald', 'Uncut Jade', 'Uncut Ruby', 'Uncut Sapphire'];
        const gem = gems[Math.floor(Math.random() * gems.length)];
        addItem(gem, 1);
        showItemPopup(`+1 ${gem}`, 'mineProgress', 900);
    }
    
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - IRON_MINE_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;

    // --- THIS IS THE FIX: Immediately call the cooldown loop ---
    return miningCooldownLoop(Date.now(), newCooldownStartTime, MINE_COOLDOWN_IRON_MS, 'mineProgressText', ironMiningLoop);
    
  } else {
    const progress = (elapsed / IRON_MINE_TIME_MS) * 100;
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => ironMiningLoop(Date.now(), startTime), 16);
  }
}

function openMineHub() {
  showMainScreen('hubMine');
}

function openCrystalMineHub() {
  showMainScreen('hubCrystalMine');
}

function openEarthCrystalMine() {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Earth Crystal</h2>
    <div style="margin-top:8px; color:#efe3cf;">A glowing earth crystal vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openCrystalMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startCrystalMining('Earth');
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

function openAirCrystalMine() {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Air Crystal</h2>
    <div style="margin-top:8px; color:#efe3cf;">A shimmering air crystal vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openCrystalMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startCrystalMining('Air');
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

function openWaterCrystalMine() {
  game.shopOpen = false; 
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Mine - Water Crystal</h2>
    <div style="margin-top:8px; color:#efe3cf;">A deep blue water crystal vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
        <div class="progress-text" id="mineProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="openCrystalMineHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startMineBtn').onclick = () => startCrystalMining('Water');
  document.getElementById('stopMineBtn').onclick = stopMining;
  showMainScreen('hubDynamic');
}

async function startCrystalMining(type) {
  // Tool Check: Tier 3 (Iron) required
  const bestPickaxe = getBestTool('pickaxe');
  if (bestPickaxe < 3) { 
    await showGameAlert("Tool Required", "You need at least an Iron Pickaxe in your inventory to mine crystal veins.");
    return;
  }

  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }

  let item, timeMs, levelReq;
  if (type === 'Earth') { item = EARTH_CRYSTAL_ITEM; timeMs = EARTH_CRYSTAL_TIME_MS; levelReq = EARTH_CRYSTAL_LVL; }
  else if (type === 'Air') { item = AIR_CRYSTAL_ITEM; timeMs = AIR_CRYSTAL_TIME_MS; levelReq = AIR_CRYSTAL_LVL; }
  else if (type === 'Water') { item = WATER_CRYSTAL_ITEM; timeMs = WATER_CRYSTAL_TIME_MS; levelReq = WATER_CRYSTAL_LVL; }

  // --- FIX: Check Level Requirement ---
  if (game.mining.level < levelReq) {
      await showGameAlert("Level Required", `You need Mining Level ${levelReq} to mine ${type} Crystals.`);
      return;
  }
  // --- END FIX ---

  if (!canReceiveItem(item)) {
    await showGameAlert("Inventory Full", "You have no room to mine this.");
    return;
  }

  if (game.miningActive) return; 
  game.miningActive = true;
  const startBtn = document.getElementById('startMineBtn');
  const stopBtn = document.getElementById('stopMineBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  
  // We pass the Type to the loop
  game.progressFrame = setTimeout(() => crystalMiningLoop(Date.now(), Date.now(), type), 16);
}

function crystalMiningLoop(timestamp, startTime, type) {
  if (!game.miningActive) return; 
  const elapsed = Date.now() - startTime;

  let item, timeMs, xp;
  if (type === 'Earth') { item = EARTH_CRYSTAL_ITEM; timeMs = EARTH_CRYSTAL_TIME_MS; xp = EARTH_CRYSTAL_XP; }
  else if (type === 'Air') { item = AIR_CRYSTAL_ITEM; timeMs = AIR_CRYSTAL_TIME_MS; xp = AIR_CRYSTAL_XP; }
  else if (type === 'Water') { item = WATER_CRYSTAL_ITEM; timeMs = WATER_CRYSTAL_TIME_MS; xp = WATER_CRYSTAL_XP; }

  if (elapsed >= timeMs) {
    addItem(item, 1);
    addXP('mining', xp);
    showItemPopup(`+${xp} Mining XP`, 'mineProgress', 0);
    showItemPopup(`+1 ${item}`, 'mineProgress', 450);
    
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - timeMs;
    const newCooldownStartTime = Date.now() - overdueTime;

    // Re-use existing mining cooldown loop
    // We need to wrap the next call to pass the 'type' argument
    return miningCooldownLoop(Date.now(), newCooldownStartTime, 1500, 'mineProgressText', (ts, st) => crystalMiningLoop(ts, st, type));
    
  } else {
    const progress = (elapsed / timeMs) * 100;
    const bar = document.getElementById('mineProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => crystalMiningLoop(Date.now(), startTime, type), 16);
  }
}

// --- NEW: Woodcutting Hub UI ---
function openForestHub() {
  showMainScreen('hubForest');
}

// --- NEW: Softwood Tree UI ---
function openSoftwoodTree(){
  game.shopOpen = false; 
  hideTooltip();
  stopBlacksmithing();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Chop - Softwood Tree</h2>
    <div style="margin-top:8px; color:#efe3cf;">A common, pliable tree.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="woodcutProgress"></div>
        <div class="progress-text" id="woodcutProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startChopBtn" class="primary">Start Chopping</button>
      <button id="stopChopBtn" class="primary" style="background:#555; display:none;">Stop Chopping</button>
      <button onclick="openForestHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startChopBtn').onclick = startChoppingSoftwood;
  document.getElementById('stopChopBtn').onclick = stopWoodcutting;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// --- NEW: Oak Tree UI ---
function openOakTree(){
  game.shopOpen = false; 
  hideTooltip();
  stopBlacksmithing();
  stopMining();
  const wrapper = document.getElementById('hubDynamic'); // <-- 1. CHANGED
  wrapper.innerHTML = `
    <h2>Chop - Oak Tree</h2>
    <div style="margin-top:8px; color:#efe3cf;">A strong, sturdy oak.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="woodcutProgress"></div>
        <div class="progress-text" id="woodcutProgressText"></div> </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startChopBtn" class="primary">Start Chopping</button>
      <button id="stopChopBtn" class="primary" style="background:#555; display:none;">Stop Chopping</button>
      <button onclick="openForestHub()" class="primary" style="background:#666;">Return</button> </div>
  `;
  document.getElementById('startChopBtn').onclick = startChoppingOak;
  document.getElementById('stopChopBtn').onclick = stopWoodcutting;
  showMainScreen('hubDynamic'); // <-- 2. ADDED
}

// =================================================================
// +++ NEW: ADVANCED WOODCUTTING (Birch, Maple, Mahogany) +++
// =================================================================

// --- Constants ---
const BIRCH_LEVEL = 20;
const BIRCH_XP = 40;
const BIRCH_TIME_MS = 5000; // 5 seconds

const MAPLE_LEVEL = 30;
const MAPLE_XP = 70;
const MAPLE_TIME_MS = 8000; // 8 seconds

const MAHOGANY_LEVEL = 40;
const MAHOGANY_XP = 110;
const MAHOGANY_TIME_MS = 12000; // 12 seconds

// --- Birch Functions ---
function openBirchTree() {
  
  game.shopOpen = false;
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  stopFishing();
  stopStoneForging();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Woodcutting - Birch</h2>
    <div style="margin-top:8px; color:#efe3cf;">A sturdy birch tree with white bark.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="woodcutProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startWoodcutBtn" class="primary">Chop Tree</button>
      <button id="stopWoodcutBtn" class="primary" style="background:#555; display:none;">Stop Chopping</button>
      <button onclick="openForestHub()" class="primary" style="background:#666;">Return</button> 
    </div>
  `;
  document.getElementById('startWoodcutBtn').onclick = startChoppingBirch;
  document.getElementById('stopWoodcutBtn').onclick = stopWoodcutting;
  showMainScreen('hubDynamic');
}

async function startChoppingBirch() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (!canReceiveItem('Birch')) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }
  // Check Tool: Tier 2 is Copper
  if (getBestTool('axe') < 2) {
      await showGameAlert("Tool Required", "You need at least a Copper Axe to chop this tree.");
      return;
  }

  if (game.woodcuttingActive) return;
  game.woodcuttingActive = true;
  
  document.getElementById('startWoodcutBtn').style.display = 'none';
  document.getElementById('stopWoodcutBtn').style.display = 'inline-block';
  
  game.progressFrame = setTimeout(() => woodcutBirchLoop(Date.now(), Date.now()), 16);
}

function woodcutBirchLoop(timestamp, startTime) {
  if (!game.woodcuttingActive) return;
  const elapsed = Date.now() - startTime;
  
  if (elapsed >= BIRCH_TIME_MS) {
      addItem('Birch', 1);
      addXP('woodcutting', BIRCH_XP);
      showItemPopup(`+${BIRCH_XP} Woodcutting XP`, 'woodcutProgress', 0);
      showItemPopup('+1 Birch', 'woodcutProgress', 450);
      
      document.getElementById('woodcutProgress').style.width = '0%';
      
      if (!canReceiveItem('Birch')) {
          showGameAlert("Inventory Full", "Inventory is full.");
          stopWoodcutting();
          return;
      }
      
      const overdueTime = elapsed - BIRCH_TIME_MS;
      const newStartTime = Date.now() - overdueTime;
      return woodcutBirchLoop(Date.now(), newStartTime);
  } else {
      const progress = (elapsed / BIRCH_TIME_MS) * 100;
      const bar = document.getElementById('woodcutProgress');
      if (bar) bar.style.width = progress + '%';
      game.progressFrame = setTimeout(() => woodcutBirchLoop(Date.now(), startTime), 16);
  }
}

// --- Maple Functions ---
function openMapleTree() {
  
  game.shopOpen = false;
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  stopFishing();
  stopStoneForging();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Woodcutting - Maple</h2>
    <div style="margin-top:8px; color:#efe3cf;">A beautiful maple tree.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="woodcutProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startWoodcutBtn" class="primary">Chop Tree</button>
      <button id="stopWoodcutBtn" class="primary" style="background:#555; display:none;">Stop Chopping</button>
      <button onclick="openForestHub()" class="primary" style="background:#666;">Return</button> 
    </div>
  `;
  document.getElementById('startWoodcutBtn').onclick = startChoppingMaple;
  document.getElementById('stopWoodcutBtn').onclick = stopWoodcutting;
  showMainScreen('hubDynamic');
}

async function startChoppingMaple() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (!canReceiveItem('Maple')) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }
  // Check Tool: Tier 2 is Copper (User requirement)
  if (getBestTool('axe') < 2) {
      await showGameAlert("Tool Required", "You need at least a Copper Axe to chop this tree.");
      return;
  }

  if (game.woodcuttingActive) return;
  game.woodcuttingActive = true;
  
  document.getElementById('startWoodcutBtn').style.display = 'none';
  document.getElementById('stopWoodcutBtn').style.display = 'inline-block';
  
  game.progressFrame = setTimeout(() => woodcutMapleLoop(Date.now(), Date.now()), 16);
}

function woodcutMapleLoop(timestamp, startTime) {
  if (!game.woodcuttingActive) return;
  const elapsed = Date.now() - startTime;
  
  if (elapsed >= MAPLE_TIME_MS) {
      addItem('Maple', 1);
      addXP('woodcutting', MAPLE_XP);
      showItemPopup(`+${MAPLE_XP} Woodcutting XP`, 'woodcutProgress', 0);
      showItemPopup('+1 Maple', 'woodcutProgress', 450);
      
      document.getElementById('woodcutProgress').style.width = '0%';
      
      if (!canReceiveItem('Maple')) {
          showGameAlert("Inventory Full", "Inventory is full.");
          stopWoodcutting();
          return;
      }
      
      const overdueTime = elapsed - MAPLE_TIME_MS;
      const newStartTime = Date.now() - overdueTime;
      return woodcutMapleLoop(Date.now(), newStartTime);
  } else {
      const progress = (elapsed / MAPLE_TIME_MS) * 100;
      const bar = document.getElementById('woodcutProgress');
      if (bar) bar.style.width = progress + '%';
      game.progressFrame = setTimeout(() => woodcutMapleLoop(Date.now(), startTime), 16);
  }
}

// --- Mahogany Functions ---
function openMahoganyTree() {
  
  game.shopOpen = false;
  hideTooltip();
  stopMining();
  stopBlacksmithing();
  stopFletching();
  stopCraftingBowString();
  stopFishing();
  stopStoneForging();
  
  const wrapper = document.getElementById('hubDynamic');
  wrapper.innerHTML = `
    <h2>Woodcutting - Mahogany</h2>
    <div style="margin-top:8px; color:#efe3cf;">A hard, tropical wood.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="woodcutProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startWoodcutBtn" class="primary">Chop Tree</button>
      <button id="stopWoodcutBtn" class="primary" style="background:#555; display:none;">Stop Chopping</button>
      <button onclick="openForestHub()" class="primary" style="background:#666;">Return</button> 
    </div>
  `;
  document.getElementById('startWoodcutBtn').onclick = startChoppingMahogany;
  document.getElementById('stopWoodcutBtn').onclick = stopWoodcutting;
  showMainScreen('hubDynamic');
}

async function startChoppingMahogany() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (!canReceiveItem('Mahogany')) {
    await showGameAlert("Inventory Full", "Inventory full.");
    return;
  }
  // Check Tool: Tier 2 is Copper
  if (getBestTool('axe') < 2) {
      await showGameAlert("Tool Required", "You need at least a Copper Axe to chop this tree.");
      return;
  }

  if (game.woodcuttingActive) return;
  game.woodcuttingActive = true;
  
  document.getElementById('startWoodcutBtn').style.display = 'none';
  document.getElementById('stopWoodcutBtn').style.display = 'inline-block';
  
  game.progressFrame = setTimeout(() => woodcutMahoganyLoop(Date.now(), Date.now()), 16);
}

function woodcutMahoganyLoop(timestamp, startTime) {
  if (!game.woodcuttingActive) return;
  const elapsed = Date.now() - startTime;
  
  if (elapsed >= MAHOGANY_TIME_MS) {
      addItem('Mahogany', 1);
      addXP('woodcutting', MAHOGANY_XP);
      showItemPopup(`+${MAHOGANY_XP} Woodcutting XP`, 'woodcutProgress', 0);
      showItemPopup('+1 Mahogany', 'woodcutProgress', 450);
      
      document.getElementById('woodcutProgress').style.width = '0%';
      
      if (!canReceiveItem('Mahogany')) {
          showGameAlert("Inventory Full", "Inventory is full.");
          stopWoodcutting();
          return;
      }
      
      const overdueTime = elapsed - MAHOGANY_TIME_MS;
      const newStartTime = Date.now() - overdueTime;
      return woodcutMahoganyLoop(Date.now(), newStartTime);
  } else {
      const progress = (elapsed / MAHOGANY_TIME_MS) * 100;
      const bar = document.getElementById('woodcutProgress');
      if (bar) bar.style.width = progress + '%';
      game.progressFrame = setTimeout(() => woodcutMahoganyLoop(Date.now(), startTime), 16);
  }
}

// Attach Listeners when DOM is ready (or manually attach if injecting)
document.addEventListener('DOMContentLoaded', () => {
    const birchBtn = document.getElementById('birchTreeBtn');
    if(birchBtn) birchBtn.onclick = openBirchTree;
    
    const mapleBtn = document.getElementById('mapleTreeBtn');
    if(mapleBtn) mapleBtn.onclick = openMapleTree;
    
    const mahoganyBtn = document.getElementById('mahoganyTreeBtn');
    if(mahoganyBtn) mahoganyBtn.onclick = openMahoganyTree;
});

// --- NEW: Stop Woodcutting Logic ---
function stopWoodcutting(){
  game.woodcuttingActive = false;
  if(game.progressFrame) clearTimeout(game.progressFrame);
  
  const textEl = document.getElementById('woodcutProgressText');
  if (textEl) textEl.innerText = '';

  const bar = document.getElementById('woodcutProgress');
  if(bar) bar.style.width = '0%';
  const startBtn = document.getElementById('startChopBtn');
  if(startBtn) startBtn.style.display = 'inline-block';
  const stopBtn = document.getElementById('stopChopBtn');
  if(stopBtn) stopBtn.style.display = 'none';
  game.isDirty = true;
}

// --- NEW: Woodcutting Cooldown Loop ---
function woodcuttingCooldownLoop(timestamp, startTime, duration, progressTextId, nextLoopFunction) {
  if (!game.woodcuttingActive) {
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = '';
    return;
  }

  const elapsed = Date.now() - startTime; // Use Date.now() for real time
  const remainingMs = duration - elapsed;

  if (remainingMs <= 0) {
    // --- COOLDOWN IS COMPLETE ---
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = '';
    
    const overdueTime = -remainingMs;
    const newActionStartTime = Date.now() - overdueTime;
            
    // --- THIS IS THE FIX: Immediately call the next loop ---
    return nextLoopFunction(Date.now(), newActionStartTime);
    
  } else {
    // --- COOLDOWN IN PROGRESS ---
    const remainingSecs = (remainingMs / 1000).toFixed(1);
    const textEl = document.getElementById(progressTextId);
    if (textEl) textEl.innerText = `${remainingSecs}s`;
    
    game.progressFrame = setTimeout(() => 
      woodcuttingCooldownLoop(Date.now(), startTime, duration, progressTextId, nextLoopFunction)
    , 16);
  }
}

// --- NEW: Softwood Logic ---
async function startChoppingSoftwood() {
  // +++ NEW: Tool Check +++
  const bestAxe = getBestTool('axe');
  if (bestAxe < 1) { // Requires Bronze (Tier 1)
    await showGameAlert("Tool Required", "You need at least a Bronze Axe in your inventory to chop this.");
    return;
  }
  // +++ END NEW +++

  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(SOFTWOOD_CHOP_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to chop this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.woodcuttingActive) return; 
  game.woodcuttingActive = true;
  const startBtn = document.getElementById('startChopBtn');
  const stopBtn = document.getElementById('stopChopBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => softwoodChoppingLoop(Date.now(), Date.now()), 16);
}

function softwoodChoppingLoop(timestamp, startTime) {
  if (!game.woodcuttingActive) return; 
  const elapsed = Date.now() - startTime;

  if (elapsed >= SOFTWOOD_CHOP_TIME_MS) {
    addItem(SOFTWOOD_CHOP_ITEM, 1);
    addXP('woodcutting', SOFTWOOD_CHOP_XP);
    showItemPopup(`+${SOFTWOOD_CHOP_XP} Woodcutting XP`, 'woodcutProgress', 0);
    showItemPopup(`+1 ${SOFTWOOD_CHOP_ITEM}`, 'woodcutProgress', 450);
    
    const bar = document.getElementById('woodcutProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - SOFTWOOD_CHOP_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;
    
    // --- THIS IS THE FIX: Immediately call the cooldown loop ---
    return woodcuttingCooldownLoop(Date.now(), newCooldownStartTime, CHOP_COOLDOWN_SOFTWOOD_MS, 'woodcutProgressText', softwoodChoppingLoop);

  } else {
    const progress = (elapsed / SOFTWOOD_CHOP_TIME_MS) * 100;
    const bar = document.getElementById('woodcutProgress');
    if (bar) bar.style.width = progress + '%';
    game.progressFrame = setTimeout(() => softwoodChoppingLoop(Date.now(), startTime), 16);
  }
}

// --- NEW: Oak Logic ---
async function startChoppingOak() {
  // +++ NEW: Tool Check +++
  const bestAxe = getBestTool('axe');
  if (bestAxe < 2) { // Requires Copper (Tier 2)
    await showGameAlert("Tool Required", "You need at least a Copper Axe in your inventory to chop this.");
    return;
  }
  // +++ END NEW +++

  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // +++ NEW INVENTORY CHECK +++
  if (!canReceiveItem(OAK_CHOP_ITEM)) {
    await showGameAlert("Inventory Full", "You have no room to chop this.");
    return;
  }
  // +++ END NEW +++
  
  if (game.woodcuttingActive) return; 
  game.woodcuttingActive = true;
  const startBtn = document.getElementById('startChopBtn');
  const stopBtn = document.getElementById('stopChopBtn');
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'inline-block';
  game.progressFrame = setTimeout(() => oakChoppingLoop(Date.now(), Date.now()), 16);
}

function oakChoppingLoop(timestamp, startTime) {
  if (!game.woodcuttingActive) return;
  const elapsed = Date.now() - startTime;

  if (elapsed >= OAK_CHOP_TIME_MS) {
    // 1. Give Log & XP
    addItem(OAK_CHOP_ITEM, 1);
    addXP('woodcutting', OAK_CHOP_XP);
    showItemPopup(`+${OAK_CHOP_XP} Woodcutting XP`, 'woodcutProgress', 0);
    showItemPopup(`+1 ${OAK_CHOP_ITEM}`, 'woodcutProgress', 450);

    // +++ NEW: 5% Chance for Dirt Shroom +++
    if (Math.random() < 0.05) {
        addItem('Dirt Shroom', 1);
        showItemPopup('+1 Dirt Shroom', 'woodcutProgress', 900); // 900ms delay to appear 3rd
    }
    // +++ END NEW +++

    const bar = document.getElementById('woodcutProgress');
    if (bar) bar.style.width = '0%';
    
    const overdueTime = elapsed - OAK_CHOP_TIME_MS;
    const newCooldownStartTime = Date.now() - overdueTime;
    
    return woodcuttingCooldownLoop(Date.now(), newCooldownStartTime, CHOP_COOLDOWN_OAK_MS, 'woodcutProgressText', oakChoppingLoop);

  } else {
    const progress = (elapsed / OAK_CHOP_TIME_MS) * 100;
    const bar = document.getElementById('woodcutProgress');
    if (bar) bar.style.width = progress + '%';
    
    game.progressFrame = setTimeout(() => oakChoppingLoop(Date.now(), startTime), 16);
  }
}

function openCombatHub() {
  showMainScreen('hubCombat');
  // Preload the assets for the *next* screen
  // (We can't use preloadImages anymore, but this asset is already in the master list)
}

function openFarmCombatArea() {
  game.lastCombatAreaHub = 'hubFarm'; // +++ SET LAST HUB +++
  showMainScreen('hubFarm');
}

// +++ NEW CAVE HUB FUNCTION +++
function openCaveCombatArea() {
  game.lastCombatAreaHub = 'hubCave'; // +++ SET LAST HUB +++
  showMainScreen('hubCave');
}

function openMadmaxCastle() {
  game.lastCombatAreaHub = 'hubMadmaxCastle'; 
  showMainScreen('hubMadmaxCastle');
}

function openCombatInterface(enemyName) {
  if (game.miningActive) { stopMining(); game.wasMiningBeforeCombat = true; }
  if (game.blacksmithingActive) { stopBlacksmithing(); game.wasSmithingBeforeCombat = true; }
  if (game.woodcuttingActive) { stopWoodcutting(); game.wasWoodcuttingBeforeCombat = true; }
  if (game.fletchingActive) { stopFletching(); game.wasFletchingBeforeCombat = true; }
  if (game.craftingActive) { stopCraftingBowString(); game.wasCraftingBeforeCombat = true; }
  if (game.fishingActive) { stopFishing(); game.wasFishingBeforeCombat = true; }
  if (game.stoneforgingActive) { stopStoneForging(); game.wasStoneForgingBeforeCombat = true; }

  // --- FIXED: Added 'name' property to all mobs and added Spider back ---
  const mobs = {
    'Chicken': { name: 'Chicken', level: 1, maxHp: 10, style: 'melee', maxHit: 1, attackLvl: 1, defenceLvl: 1, img: 'images/chickenmonster.jpeg' },
    'Rat': { name: 'Rat', level: 1, maxHp: 10, style: 'melee', maxHit: 1, attackLvl: 1, defenceLvl: 1, img: 'images/ratmonster.jpeg' },
    'Spider': { name: 'Spider', level: 2, maxHp: 12, style: 'melee', maxHit: 2, attackLvl: 2, defenceLvl: 2, img: 'images/spidermonster.jpeg' }, // <-- Added Spider
    'Cow': { name: 'Cow', level: 2, maxHp: 15, style: 'melee', maxHit: 2, attackLvl: 3, defenceLvl: 3, img: 'images/cowmonster.png' },
    'Goblin': { name: 'Goblin', level: 8, maxHp: 25, style: 'melee', maxHit: 3, attackLvl: 8, defenceLvl: 5, img: 'images/goblinmonster.jpeg' },
    'Crazy Platypus': { name: 'Crazy Platypus', level: 5, maxHp: 20, style: 'ranged', maxHit: 3, attackLvl: 6, defenceLvl: 4, img: 'images/platypusmonster.jpeg' },
    'Crazy Owl': { name: 'Crazy Owl', level: 10, maxHp: 45, style: 'ranged', maxHit: 5, attackLvl: 12, defenceLvl: 8, img: 'images/crazyowlmonster.jpeg' },
    'The Witch': { name: 'The Witch', level: 15, maxHp: 60, style: 'magic', maxHit: 8, attackLvl: 15, defenceLvl: 5, img: 'images/witchmonster.jpeg' },
    'Madmax': { name: 'Madmax', level: 69, maxHp: 500, style: 'melee', maxHit: 15, attackLvl: 60, defenceLvl: 50, img: 'images/madmaxmonster.jpeg', lastSpecialTime: Date.now() },
    'Centipede': { name: 'Centipede', level: 5, maxHp: 20, style: 'melee', maxHit: 4, attackLvl: 5, defenceLvl: 5, img: 'images/centipedemonster.jpeg' }
  };

  const def = mobs[enemyName];
  if (!def) { console.error('Unknown enemy:', enemyName); return; }

  game.currentEnemy = { ...def, currentHp: def.maxHp };

  const imgEl = document.getElementById('combat-enemy-img');
  if (imgEl) {
      imgEl.src = game.currentEnemy.img;
      imgEl.style.height = ''; 
  }

  // +++ AUTO EAT UI INJECTION +++
  const combatPanel = document.getElementById('combat-action-panel');
  // We inject a new structure to hold styles AND the auto-eat slot side-by-side
  const styleContainerHtml = `
    <p style="margin: 0 0 5px 0; font-weight: bold;">Combat Style & Auto-Eat:</p>
    <div id="combat-styles-container">
        <div id="combat-styles">
            <button id="style-attack" class="primary" onclick="setAttackStyle('attack')">Accurate</button>
            <button id="style-strength" class="primary" onclick="setAttackStyle('strength')">Aggressive</button>
            <button id="style-defence" class="primary" onclick="setAttackStyle('defence')">Defensive</button>
        </div>
        <div id="auto-eat-slot-wrapper">
            <div id="autoEatSlot" class="auto-eat-slot" onclick="unequipAutoEat()">
                <!-- Icon injected via JS -->
            </div>
            <div style="font-size:10px; color:#aaa; margin-top:2px;">Auto Heal</div>
            <input type="range" id="autoHealSlider" min="1" max="99" value="${game.autoEatThreshold || 20}" style="width: 50px; margin-top: 4px; height: 10px;">
            <div id="autoHealPercentDisplay" style="font-size: 10px; color: var(--gold);">${game.autoEatThreshold || 20}%</div>
        </div>
    </div>
    <div id="combat-main-actions">
        <button id="combat-fight-btn" class="primary" style="background:#900;" onclick="beginCombat()">Fight</button>
        <button id="combat-run-btn" class="primary" style="background:#080; display:none;" onclick="runFromCombat()">Run</button>
        <button id="combat-return-btn" class="primary" style="background:#555;" onclick="returnToCombatArea()">Return</button>
    </div>
  `;
  
  // Replace the innerHTML of the panel to include our new layout
  combatPanel.innerHTML = styleContainerHtml;

  // Add Slider Listener
  const healSlider = document.getElementById('autoHealSlider');
  const healDisplay = document.getElementById('autoHealPercentDisplay');
  if (healSlider && healDisplay) {
      healSlider.oninput = function() {
          game.autoEatThreshold = parseInt(this.value);
          healDisplay.innerText = this.value + '%';
          game.isDirty = true;
      };
  }
  
  // Render the slot content
  renderAutoEatSlot();
  // +++ END AUTO EAT UI +++
  
  document.getElementById('combat-fight-btn').style.display = 'block';
  document.getElementById('combat-fight-btn').disabled = false;
  document.getElementById('combat-run-btn').style.display = 'none';
  document.getElementById('combat-return-btn').style.display = 'block';

  updateEnemyCombatUI(); 
  renderEquipment();
  setAttackStyle(game.playerAttackStyle, true); 
  showMainScreen('hubActiveCombat'); 
}

function setAttackStyle(style, isInitialization = false) {
  game.playerAttackStyle = style;
  
  // Update button visual state
  const styles = ['attack', 'strength', 'defence'];
  styles.forEach(s => {
    const btn = document.getElementById(`style-${s}`);
    if (btn) {
      if (s === style) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    }
  });
  
  // --- THIS IS THE FIX ---
  // Re-render equipment to update stats (like style bonuses)
  // This will also update the combat UI equipment panel if it's open
  renderEquipment(); 
  // --- END FIX ---

  if (!isInitialization) {
    // Line deleted
  }
}




// NEW: Function to start the combat loops
function beginCombat() {
  if (game.inCombat) return; 
  if (!game.isSessionActive) {
    showGameAlert("Session Not Active", "This game session is not active. Please take control to perform actions.");
    return;
  }
  
  // --- NEW ARROW CHECK ---
  const weapon = game.equipment.weapon;
  const isRanged = (weapon && weapon.name.endsWith('Bow'));
  
  if (isRanged) {
      const arrows = game.equipment.arrows;
      if (!arrows || arrows.qty < 1) {
          showWarningPopup("You don't have any arrows equipped.");
          return; // Stop the fight from starting
      }
  }

  game.inCombat = true;

  // +++ FIX: Reset Madmax's timer when the fight ACTUALLY starts +++
  // This prevents the timer from counting down while you are sitting in the menu.
  if (game.currentEnemy && game.currentEnemy.name === 'Madmax') {
      game.currentEnemy.lastSpecialTime = Date.now();
  }
  // +++ END FIX +++

  document.getElementById('combat-fight-btn').style.display = 'none'; 
  document.getElementById('combat-run-btn').style.display = 'block'; 
  document.getElementById('combat-run-btn').disabled = false;
  
  // --- NEW: Calculate stats and set dynamic attack speed ---
  const stats = getPlayerCombatStats();
  
  // Player attacks at their calculated attack speed (Using new Loop)
  game.playerCombatInterval = setTimeout(playerCombatLoop, stats.attackSpeed);
  
  // Enemy (Chicken) attacks every 3.0 seconds
  game.enemyCombatInterval = setInterval(enemyAttackTurn, 3000);
}

// NEW: Function to restart ONLY the player's attack interval
function restartPlayerAttackInterval() {
  if (!game.inCombat || !game.currentEnemy) return; 
  
  // 1. Clear pending timeout
  if (game.playerCombatInterval) clearTimeout(game.playerCombatInterval);
  
  // 2. Get new stats
  const stats = getPlayerCombatStats();
  
  // 3. Start the new loop immediately
  game.playerCombatInterval = setTimeout(playerCombatLoop, stats.attackSpeed);
  
  // 4. Re-enable the run button
  const runBtn = document.getElementById('combat-run-btn');
  if (runBtn) runBtn.disabled = false;
}

// NEW: Function to restart combat intervals without resetting the fight
function restartCombatIntervals() {
  if (!game.inCombat || !game.currentEnemy) return; // Should already be in combat
  
  // 1. Clear existing intervals
  if (game.playerCombatInterval) clearInterval(game.playerCombatInterval);
  if (game.enemyCombatInterval) clearInterval(game.enemyCombatInterval);
  
  // 2. Get new stats
  const stats = getPlayerCombatStats();
  
  // 3. Restart intervals
  game.playerCombatInterval = setInterval(playerAttackTurn, stats.attackSpeed);
  game.enemyCombatInterval = setInterval(enemyAttackTurn, 3000);
  
  // 4. Re-enable the run button
  const runBtn = document.getElementById('combat-run-btn');
  if (runBtn) runBtn.disabled = false;
}

// NEW: Function to stop combat
function runFromCombat(playerDied = false) {
  if (!game.inCombat) return; // Can't run if not in a fight
  
  game.inCombat = false;
  
  // Stop the attack loops
  if (game.playerCombatInterval) clearInterval(game.playerCombatInterval);
  if (game.enemyCombatInterval) clearInterval(game.enemyCombatInterval);
  game.playerCombatInterval = null;
  game.enemyCombatInterval = null;

  const fightBtn = document.getElementById('combat-fight-btn');
  const runBtn = document.getElementById('combat-run-btn');
  const returnBtn = document.getElementById('combat-return-btn');
  
  if (playerDied) {
    // Player is dead, disable all actions
    if (fightBtn) fightBtn.disabled = true;
    if (runBtn) runBtn.disabled = true;
    if (returnBtn) returnBtn.style.display = 'none';
  } else {
    // Player clicked "Run"
    if (fightBtn) fightBtn.style.display = 'block'; // SHOW Fight
    if (fightBtn) fightBtn.disabled = false;
    if (runBtn) runBtn.style.display = 'none'; // HIDE Run
    if (runBtn) runBtn.disabled = true;
    if (returnBtn) returnBtn.style.display = 'block'; // Show return

    // Reset enemy HP
    if (game.currentEnemy) {
        game.currentEnemy.currentHp = game.currentEnemy.maxHp;
        updateEnemyCombatUI();
    }
  }
}

function returnToCombatArea() { // +++ RENAMED FUNCTION +++
  // +++ NEW FIX: Stop combat loops +++
  if (game.inCombat) {
    game.inCombat = false;
    if (game.playerCombatInterval) clearInterval(game.playerCombatInterval);
    if (game.enemyCombatInterval) clearInterval(game.enemyCombatInterval);
    game.playerCombatInterval = null;
    game.enemyCombatInterval = null;
  }
  // +++ END FIX +++

  // 1. Go back to the correct combat hub screen
  showMainScreen(game.lastCombatAreaHub); 
  
  // 2. Check if we need to resume skilling
  if (game.wasMiningBeforeCombat) {
    openCopperMine(); // Re-opens the mine UI
    startMining();      // Restarts mining
  } else if (game.wasSmithingBeforeCombat) {
    // This is more complex, might need to know *which* item
    openBlacksmithHub(); // Just return to hub for now
  } else if (game.wasWoodcuttingBeforeCombat) { // +++ NEW +++
    openForestHub(); // Return to Forest hub
  } else if (game.wasFletchingBeforeCombat) { // +++ NEW +++
    openFletchingHub(); // Return to Fletching hub
  } else if (game.wasCraftingBeforeCombat) { // +++ NEW +++
    openCraftingHub(); // Return to Crafting hub
  } else if (game.wasFishingBeforeCombat) { 
    openFishingHub(); // Return to Fishing hub
  } else if (game.wasStoneForgingBeforeCombat) { // +++ NEW +++
    openElementalForgeHub(); // Return to Elemental Forge
  }
  game.wasMiningBeforeCombat = false;
  game.wasSmithingBeforeCombat = false;
  game.wasWoodcuttingBeforeCombat = false; 
  game.wasFletchingBeforeCombat = false; 
  game.wasCraftingBeforeCombat = false; 
  game.wasFishingBeforeCombat = false; 
  game.wasStoneForgingBeforeCombat = false; // +++ NEW +++
}

// NEW: Helper function to update the enemy's HP bar
function updateEnemyCombatUI() {
  if (!game.currentEnemy) return;
  
  const enemy = game.currentEnemy;
  const percent = Math.max(0, (enemy.currentHp / enemy.maxHp) * 100);
  
  const fill = document.getElementById('combat-enemy-hp-fill');
  const text = document.getElementById('combat-enemy-hp-text');
  
  if (fill) fill.style.width = percent + '%';
  if (text) text.textContent = `${enemy.currentHp} / ${enemy.maxHp} HP`;
}

function showDeathOverlay() {
  const overlay = document.getElementById('deathOverlay');
  if (overlay) overlay.style.display = 'flex';
}

/**
 * Hides the death overlay.
 */
function hideDeathOverlay() {
  const overlay = document.getElementById('deathOverlay');
  if (overlay) overlay.style.display = 'none';
}

/**
 * Handles all logic when a player's HP reaches 0.
 */
function handlePlayerDeath() {
  // 1. Wipe inventory
  game.inventory = new Array(game.inventoryCapacity).fill(null);
  renderInventoryGrid();
  
  // 2. Wipe gold
  game.gold = 0;
  updateGoldUI();
  
  // 3. Save the empty state
  if (typeof window.savePlayerData === 'function') {
    window.savePlayerData();
  }
  
  // 4. Show the death modal
  showDeathOverlay();
}

/**
 * Handles the "Revive" button click.
 */
function revivePlayer() {
  // 1. Hide the modal
  hideDeathOverlay();
  
  // 2. Restore HP
  game.hp = game.maxHP;
  updateHPUI();
  
  // 3. Go back to the main hub
  backToActions();
  
  // 4. Save the new HP state
  if (typeof window.savePlayerData === 'function') {
    window.savePlayerData();
  }
}
// --- END: Death & Revive Functions ---


function showDamageSplat(target, amount, type) {
  let anchorElement = null;
  if (target === 'player') {
    anchorElement = document.getElementById('hpFill').parentElement; 
  } else if (target === 'enemy') {
    anchorElement = document.getElementById('combat-enemy-hp-bar');
  }

  if (!anchorElement) return;

  const splat = document.createElement('div');
  splat.className = 'combat-splat';
  
  if (type === 'special') {
    splat.classList.add('splat-special');
    splat.innerHTML = ` ${amount}!`; 
  } else if (type === 'damage' && amount > 0) {
    splat.classList.add('splat-damage');
    splat.textContent = amount;
  } else if (type === 'block' || (type === 'damage' && amount === 0)) { 
    // Only show "Miss" if explicitly blocked or damage is 0
    splat.classList.add('splat-block');
    splat.textContent = 'Miss'; 
  } else {
    // If it's any other type (like a custom heal type), don't show "Miss"
    return;
  }
  
  splat.style.right = (Math.floor(Math.random() * 20) - 40) + 'px';
  
  anchorElement.appendChild(splat);
  setTimeout(() => splat.remove(), 850);
}

/**
 * NEW: Recursive combat loop.
 * Allows gear switching without resetting the current cooldown.
 */
function playerCombatLoop() {
  if (!game.inCombat) return;
  
  // 1. Execute the attack
  playerAttackTurn();
  
  // 2. If still fighting, schedule the NEXT attack based on CURRENT stats
  if (game.inCombat) {
      const stats = getPlayerCombatStats();
      game.playerCombatInterval = setTimeout(playerCombatLoop, stats.attackSpeed);
  }
}

function playerAttackTurn(spellOverride = null) {
  if (!game.inCombat || !game.currentEnemy) return;

  const playerStats = getPlayerCombatStats();
  const enemy = game.currentEnemy;
  game.lastAttackTime = Date.now();

  const weaponType = playerStats.equippedWeaponType;
  let activeSpell = null;

  if (spellOverride) activeSpell = spellOverride;
  else if (game.autocastSpell && weaponType === 'magic') activeSpell = SPELL_LIST.find(s => s.name === game.autocastSpell);

  if (weaponType === 'ranged') {
    if (!game.equipment.arrows || game.equipment.arrows.qty < 1) {
      showWarningPopup("Out of arrows!");
      runFromCombat(false); return;
    }
  } else if (weaponType === 'magic' && !activeSpell && !spellOverride) {
    return;
  }

  if (activeSpell) {
    let requiredStone = activeSpell.name.split(' ')[0] + 'stone';
    let stoneCount = 0;
    for (const slot of game.inventory) if (slot && slot.name === requiredStone) stoneCount += slot.qty;
    if (stoneCount < 3) { showWarningPopup(`Need 3 ${requiredStone}!`); return; }
    removeItem(requiredStone, 3);
    playGlobalSound('sounds/soundeffects/earthblastsoundeffect.mp3');
  } else if (weaponType === 'ranged') {
    playGlobalSound('sounds/soundeffects/arrowsoundeffect.mp3');
  } else {
    playGlobalSound('sounds/soundeffects/swordsoundeffect.mp3');
  }

  // --- AGGRESSIVE DAMAGE FORMULAS ---
  let maxHit = 0;
  if (weaponType === 'melee') {
    maxHit = 2 + (game.strength.level / 4) + (playerStats.meleeStr / 1.5);
  } 
  else if (weaponType === 'ranged') {
    maxHit = 2 + (game.ranged.level / 4) + (playerStats.rangedStr / 1.5);
  } 
  else if (weaponType === 'magic' && activeSpell) {
    maxHit = activeSpell.damage + (game.magic.level / 4) + (playerStats.magicDmg * 2);
  }
  maxHit = Math.floor(maxHit);

  // --- ACCURACY CALCULATIONS ---
  let attackRoll = 0;
  if (weaponType === 'melee') attackRoll = game.attack.level * (playerStats.meleeAtk + 64);
  else if (weaponType === 'ranged') attackRoll = game.ranged.level * (playerStats.rangedAtk + 64);
  else if (weaponType === 'magic') attackRoll = game.magic.level * (playerStats.magicAtk + 64);

  let defenceRoll = enemy.defenceLvl * 64;
  let triangleMod = 1.0;
  if (weaponType === 'melee' && enemy.style === 'ranged') triangleMod = 0.8;
  if (weaponType === 'ranged' && enemy.style === 'magic') triangleMod = 0.5;
  if (weaponType === 'magic' && enemy.style === 'melee') triangleMod = 0.2;
  if (weaponType === 'melee' && enemy.style === 'magic') triangleMod = 1.2;
  if (weaponType === 'ranged' && enemy.style === 'melee') triangleMod = 1.2;
  if (weaponType === 'magic' && enemy.style === 'ranged') triangleMod = 1.5;
  defenceRoll = Math.floor(defenceRoll * triangleMod);

  let hitChance = 0;
  if (attackRoll > defenceRoll) hitChance = 1 - (defenceRoll + 2) / (2 * (attackRoll + 1));
  else hitChance = attackRoll / (2 * (defenceRoll + 1));

  const roll = Math.random();
  let damage = 0;

  if (roll < hitChance) {
    damage = Math.floor(Math.random() * (maxHit + 1));
    const enemyImg = document.getElementById('combat-enemy-img');
    if (enemyImg) {
      enemyImg.classList.remove('enemy-hit-anim');
      void enemyImg.offsetWidth;
      enemyImg.classList.add('enemy-hit-anim');
    }
  }

  // --- OVERKILL CAP FIX ---
  // If the damage is higher than the enemy's remaining health, cap it.
  let effectiveDamage = Math.min(damage, enemy.currentHp);

  if (effectiveDamage > 0) {
    showDamageSplat('enemy', effectiveDamage, 'damage');
  } else {
    // If we actually rolled a hit but it resulted in 0 damage, or we missed.
    showDamageSplat('enemy', 0, 'block');
  }

  game.currentEnemy.currentHp -= effectiveDamage;
  updateEnemyCombatUI();

  if (weaponType === 'ranged') {
    game.equipment.arrows.qty--;
    if (game.equipment.arrows.qty <= 0) game.equipment.arrows = null;
    renderEquipment();
  }

  // --- XP GRANTS (Based on Effective Damage) ---
  if (effectiveDamage > 0) {
    const xp = effectiveDamage * 4;

    const hpXp = Math.ceil(xp / 3);
    addXP('vitality', hpXp);
    showItemPopup(`+${hpXp} Vitality XP`, null, 0); 

    let statName = '';
    if (weaponType === 'magic') statName = 'magic';
    else if (weaponType === 'ranged') statName = 'ranged';
    else statName = game.playerAttackStyle;

    addXP(statName, xp); 

    const displayStat = statName.charAt(0).toUpperCase() + statName.slice(1);
    setTimeout(() => {
      showItemPopup(`+${xp} ${displayStat} XP`, null);
    }, 450);

    if (game.equipment.pet) {
      const petIndex = game.pets.findIndex(p => p.id === game.equipment.pet.id);
      if (petIndex > -1) {
        const pet = game.pets[petIndex];
        if (pet.hp > 0 && pet.level < 50) {
          const petXPGained = Math.ceil(xp * 0.10);
          pet.xp += petXPGained;
          const xpNeeded = pet.level * 100;
          if (pet.xp >= xpNeeded) {
            pet.xp -= xpNeeded;
            pet.level++;
            showItemPopup(`Pet Lvl Up: ${pet.level}!`, null, 600);
            playGlobalSound('sounds/soundeffects/levelupsound.mp3');
            game.isDirty = true;
          }
        }
      }
    }
  }

  if (game.currentEnemy.currentHp <= 0) {
    handleEnemyDeath();
  }
}

function enemyAttackTurn() {
  if (!game.inCombat || !game.currentEnemy) return;

  const playerStats = getPlayerCombatStats();
  const enemy = game.currentEnemy;

  // Madmax Special Attack Logic
  if (enemy.name === 'Madmax') {
      const now = Date.now();
      if (now - enemy.lastSpecialTime >= 20000) {
          let specDmg = Math.floor(Math.random() * 40) + 10;
          game.hp -= specDmg;
          
          updateHPUI(); // Show damage immediately
          showDamageSplat('player', specDmg, 'special');
          enemy.lastSpecialTime = now;
          
          // --- DELAYED AUTO EAT (0.2s) ---
          setTimeout(() => {
              const threshold = (game.autoEatThreshold || 20) / 100;
              // Changed while to if to allow cooldown check in triggerAutoEat
              if (game.hp > 0 && (game.hp / game.maxHP) <= threshold && game.autoEatSlot) {
                  triggerAutoEat();
              }

              if (game.hp <= 0) { 
                  game.hp = 0; 
                  updateHPUI(); 
                  runFromCombat(true); 
                  handlePlayerDeath(); 
              } else {
                  updateHPUI(); // Update UI if healed
              }
          }, 200);
          
          return;
      }
  }

  let enemyAtkRoll = enemy.attackLvl * 64;
  let playerDefRoll = 0;
  
  if (enemy.style === 'melee') {
      playerDefRoll = Math.max(0, game.defence.level * (playerStats.meleeDef + 64));
  } else if (enemy.style === 'ranged') {
      playerDefRoll = Math.max(0, game.defence.level * (playerStats.rangedDef + 64));
  } else if (enemy.style === 'magic') {
      const magicDefLevel = Math.floor((game.magic.level * 0.7) + (game.defence.level * 0.3));
      playerDefRoll = Math.max(0, magicDefLevel * (playerStats.magicDef + 64));
  }

  let hitChance = 0;
  if (enemyAtkRoll > playerDefRoll) hitChance = 1 - (playerDefRoll + 2) / (2 * (enemyAtkRoll + 1));
  else hitChance = enemyAtkRoll / (2 * (playerDefRoll + 1));

  const roll = Math.random();
  let damage = 0;

  if (roll < hitChance) {
      damage = Math.floor(Math.random() * (enemy.maxHit + 1));
      showDamageSplat('player', damage, 'damage');
  } else {
      showDamageSplat('player', 0, 'block');
  }

  game.hp -= damage;
  updateHPUI(); // Show damage immediately

  // --- DELAYED AUTO EAT (0.2s) ---
  setTimeout(() => {
      const threshold = (game.autoEatThreshold || 20) / 100;
      // Changed while to if to allow cooldown check in triggerAutoEat
      if (game.hp > 0 && (game.hp / game.maxHP) <= threshold && game.autoEatSlot) {
          triggerAutoEat();
      }

      if (game.hp <= 0) {
          game.hp = 0; 
          updateHPUI();
          runFromCombat(true); 
          handlePlayerDeath();
      } else {
          updateHPUI(); // Update UI if healed
      }
  }, 200);
}

function handleEnemyDeath() {
    updateQuestKillCount(game.currentEnemy.name);
    
    // Start delays at 900ms so they appear AFTER the 2 XP popups
    let dropDelay = 900;
    
    if (game.activeBounty && game.activeBounty.target === game.currentEnemy.name && game.activeBounty.kills < game.activeBounty.req) {
        updateBountyProgress(game.currentEnemy.name, dropDelay);
        dropDelay += 450; 
    }

    const name = game.currentEnemy.name;
    
    // Drops
    if (name === 'Chicken') { 
      addItem('Raw Chicken', 1);
      const featherQty = Math.floor(Math.random() * 5) + 2; 
      addItem('Feather', featherQty);
      showItemPopup('+1 Raw Chicken', null, dropDelay);
      showItemPopup(`+${featherQty} Feather`, null, dropDelay + 450); 
    } else if (name === 'Rat') {
      addItem('Rat Tail', 1);
      showItemPopup(`+1 Rat Tail`, null, dropDelay);
    } else if (name === 'Spider') { 
      const silkQty = Math.floor(Math.random() * 3) + 1; 
      addItem('Silk', silkQty);
      showItemPopup(`+${silkQty} Silk`, null, dropDelay);
      if (Math.floor(Math.random() * PET_EGG_DROP_RATE) === 0) {
          addItem('Pet Spider Egg', 1);
          showItemPopup('<span style="color:#ff4d4d; font-size:16px;">EGG DROP!</span>', null, dropDelay + 200);
          if (typeof addLocalChatMessage === 'function') addLocalChatMessage("You found a rare Pet Spider Egg!", "trade"); 
      }
    } else if (name === 'Centipede') {
      if (removeItem('Empty Vial', 1)) {
          addItem('Venom', 1);
          showItemPopup(`+1 Venom`, null, dropDelay);
      } 
    } else if (name === 'Cow') {
      addItem('Cow Hide', 1);
      addItem('Beef', 1); 
      showItemPopup(`+1 Cow Hide`, null, dropDelay);
      showItemPopup(`+1 Beef`, null, dropDelay + 450);
    } else if (name === 'Goblin') {
      addItem('Copper Ore', 5);
      showItemPopup(`+5 Copper Ore`, null, dropDelay);
    } else if (name === 'Crazy Platypus') {
      addItem('Fishing Bait', 2);
      showItemPopup(`+2 Fishing Bait`, null, dropDelay);
    } else if (name === 'Crazy Owl') {
      addItem('Feather', 10);
      showItemPopup(`+10 Feather`, null, dropDelay);
    } else if (name === 'The Witch') {
      addItem('Empty Vial', 2);
      showItemPopup(`+2 Empty Vial`, null, dropDelay);
      
      if (Math.random() < 0.5) {
          addItem('Wild Herb', 1);
          showItemPopup(`+1 Wild Herb`, null, dropDelay + 450);
          dropDelay += 450;
      }
      if (Math.floor(Math.random() * 30) === 0) {
          addItem('Magic Staff', 1);
          showItemPopup(`+1 Magic Staff`, null, dropDelay + 450);
      }
    } else if (name === 'Madmax') {
      // 1/8 Chance for Lottery Tickets (12.5% drop rate)
      if (Math.floor(Math.random() * 8) === 0) {
          addItem('Lottery Ticket', 2);
          showItemPopup('+2 Lottery Ticket', null, dropDelay);
          dropDelay += 450; // Add delay so rare drop doesn't overlap if it hits
      }
      
      // 1/100 Rare Drop
      if (Math.floor(Math.random() * 100) === 0) {
          addItem('Silver Fangs of the Fallen Monarch', 1);
          showItemPopup('<span style="color:var(--gold); font-size:16px;">RARE DROP!</span>', null, dropDelay + 450);
          if (typeof addLocalChatMessage === 'function') {
              addLocalChatMessage("You have obtained the Silver Fangs of the Fallen Monarch!", "trade");
          }
      }
    }
    
  

    // Reset Enemy
    game.currentEnemy.currentHp = game.currentEnemy.maxHp;
    updateEnemyCombatUI();
}


// =================================================================
// +++ NEW: LOTTERY SYSTEM LOGIC +++
// =================================================================
const LOTTERY_COST = 10000;
const SLOT_WIDTH = 80; 
const WINNER_INDEX = 40; 
const TOTAL_SLOTS = 50; 

// --- NEW: Rotating Jackpot Pool ---
const JACKPOT_POOL = [
    { name: 'Elegant Black Cape', desc: '** The cape provides +2 Armor.' },
    { name: 'Gold Crown', desc: '** The crown provides +5 Defense and +2 Attack stats.' }
];

function getCurrentJackpot() {
    const dayIndex = Math.floor(Date.now() / (1000 * 60 * 60 * 24)) % JACKPOT_POOL.length;
    return JACKPOT_POOL[dayIndex];
}

// =================================================================
// +++ NEW: WEIGHTED LOTTERY SYSTEM +++
// =================================================================

const LOTTERY_LOOT = [
    { name: 'Sand', qty: 1000, weight: 100 },
    { name: 'Coal Ore', qty: 1000, weight: 100 },
    { name: 'Copper Ore', qty: 1000, weight: 100 },
    { name: 'Softwood', qty: 1000, weight: 100 },
    { name: 'Feather', qty: 1000, weight: 100 },
    { name: 'Raw Chicken', qty: 1000, weight: 100 },
    { name: 'Fishing Bait', qty: 1000, weight: 60 },
    { name: 'Iron Ore', qty: 1000, weight: 60 },
    { name: 'Gold', qty: 5000, weight: 40 },
    { name: 'Iron Bar', qty: 750, weight: 30 },
    { name: 'Gold Ore', qty: 1000, weight: 30 },
    { name: 'Oak', qty: 1000, weight: 30 },
    { name: 'Cooked Salmon', qty: 750, weight: 30 },
    { name: 'Gold', qty: 25000, weight: 10 },
    { name: 'Waterstone', qty: 2000, weight: 20 },     
    { name: 'Airstone', qty: 2000, weight: 20 } 
];

function getRandomLotteryFiller() {
    let totalWeight = 0;
    for (const item of LOTTERY_LOOT) totalWeight += (item.weight || 10);
    let random = Math.floor(Math.random() * totalWeight);
    for (const item of LOTTERY_LOOT) {
        const weight = item.weight || 10;
        if (random < weight) return item;
        random -= weight;
    }
    return LOTTERY_LOOT[0];
}

function openLotteryHub() {
    showMainScreen('hubLottery');
    const reel = document.getElementById('lotteryReel');
    const resultMsg = document.getElementById('lotteryResultMsg');
    const buyBtn = document.getElementById('buyTicketBtn');
    const returnBtn = document.getElementById('hubLottery_ReturnBtn');
    
    // Set text based on rotation
    const jackpot = getCurrentJackpot();
    document.getElementById('lotteryJackpotName').innerText = jackpot.name;
    document.getElementById('lotteryJackpotDesc').innerText = jackpot.desc;

    // Trigger immediate timer update
    updateLotteryTimer();

    let ticketCount = 0;
    for(const slot of game.inventory) {
        if(slot && slot.name === 'Lottery Ticket') ticketCount += slot.qty;
    }
    
    if (ticketCount > 0) {
        buyBtn.textContent = `Use Ticket (${ticketCount})`;
        buyBtn.style.background = '#b300ff';
        buyBtn.style.color = '#fff';
    } else {
        buyBtn.textContent = "Buy Ticket (10k Gold)";
        buyBtn.style.background = 'var(--gold)';
        buyBtn.style.color = '#000';
    }

    reel.style.transition = 'none';
    reel.style.transform = 'translateX(0px)';
    reel.innerHTML = '';
    resultMsg.innerHTML = '';
    buyBtn.disabled = false;
    returnBtn.disabled = false;

    // Teasers
    for(let i=0; i<10; i++) {
        let item = (Math.random() < 0.10) ? { name: jackpot.name, qty: 1 } : getRandomLotteryFiller();
        const slot = document.createElement('div');
        slot.className = 'lottery-slot';
        let imgName = item.name.toLowerCase().replace(/\s+/g, '');
        if (item.name === 'Copper Ore') imgName = 'copper_ore';
        if (item.name === 'Gold') imgName = 'goldpouch';
        if (item.name === 'Elegant Black Cape') imgName = 'elegantblackcape';
        if (item.name === 'Gold Crown') imgName = 'goldcrown';
        
        slot.innerHTML = `<img src="images/${imgName}.png"><span class="qty-badge">${formatAmount(item.qty)}</span>`;
        if (item.name === jackpot.name) {
            slot.style.background = "radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(0,0,0,0) 70%)";
        }
        reel.appendChild(slot);
    }
}

// NEW: Live Timer Calculation
function updateLotteryTimer() {
    const timerEl = document.getElementById('lotteryTimer');
    const hub = document.getElementById('hubLottery');
    if (!timerEl || !hub || !hub.classList.contains('active')) return;

    const now = new Date();
    // Calculate time until next UTC Midnight (When the rotation index changes)
    const nextMidnight = new Date();
    nextMidnight.setUTCHours(24, 0, 0, 0); 
    
    const diff = nextMidnight - now;

    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);

    timerEl.innerText = `${h}h ${m}m ${s}s`;

    // If timer reaches zero while player is watching, update the item info
    if (h === 0 && m === 0 && s === 0) {
        const jackpot = getCurrentJackpot();
        document.getElementById('lotteryJackpotName').innerText = jackpot.name;
        document.getElementById('lotteryJackpotDesc').innerText = jackpot.desc;
    }
}

async function buyLotteryTicket() {
    if (!game.isSessionActive) {
        await showGameAlert("Session Error", "Session not active.");
        return;
    }

    const jackpot = getCurrentJackpot();

    // 1. Check for Tickets or Gold
    let ticketCount = 0;
    for(const slot of game.inventory) {
        if(slot && slot.name === 'Lottery Ticket') ticketCount += slot.qty;
    }

    let usingTicket = ticketCount > 0;
    if (!usingTicket && game.gold < LOTTERY_COST) {
        await showGameAlert("Too Poor", "You need 10,000 Gold to buy a ticket.");
        return;
    }

    const emptySlotIndex = game.inventory.findIndex(slot => slot === null);
    if (emptySlotIndex === -1) {
         await showGameAlert("Inventory Full", "Please make space in your inventory before playing.");
         return;
    }

    // 2. Determine Outcome IMMEDIATELY
    let wonItemName = "";
    let wonItemQty = 1;
    const jackpotRoll = Math.floor(Math.random() * 1000) + 1;
    
    if (jackpotRoll === 1) {
        wonItemName = jackpot.name;
        wonItemQty = 1;
    } else {
        const item = getRandomLotteryFiller();
        wonItemName = item.name;
        wonItemQty = item.qty;
    }

    // 3. Payment
    if (usingTicket) removeItem('Lottery Ticket', 1);
    else addGold(-LOTTERY_COST);

    game.isDirty = true; 

    // 4. Visual Reel Setup
    const reel = document.getElementById('lotteryReel');
    reel.innerHTML = '';
    
    for(let i=0; i<TOTAL_SLOTS; i++) {
        let itemDisplay;
        if (i === WINNER_INDEX) {
            itemDisplay = { name: wonItemName, qty: wonItemQty };
        } else {
            itemDisplay = (Math.random() < 0.05) ? { name: jackpot.name, qty: 1 } : getRandomLotteryFiller();
        }
        
        const slot = document.createElement('div');
        slot.className = 'lottery-slot';
        let imgName = itemDisplay.name.toLowerCase().replace(/\s+/g, '');
        if (itemDisplay.name === 'Copper Ore') imgName = 'copper_ore';
        if (itemDisplay.name === 'Gold Crown') imgName = 'goldcrown';
        if (itemDisplay.name === 'Elegant Black Cape') imgName = 'elegantblackcape';
        if (itemDisplay.name === 'Gold') imgName = 'goldpouch'; 
        
        const scaleStyle = (itemDisplay.name === 'Diamond' || itemDisplay.name === 'Uncut Diamond') ? 'style="transform: scale(0.93);"' : '';
        slot.innerHTML = `<img src="images/${imgName}.png" ${scaleStyle}><span class="qty-badge">${formatAmount(itemDisplay.qty)}</span>`;
        
        if (itemDisplay.name === jackpot.name) {
            slot.style.background = "radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(0,0,0,0) 70%)";
        }
        reel.appendChild(slot);
    }

    const buyBtn = document.getElementById('buyTicketBtn');
    const returnBtn = document.getElementById('hubLottery_ReturnBtn');
    buyBtn.disabled = true;
    returnBtn.disabled = true;
    document.getElementById('lotteryResultMsg').innerHTML = '';

    const containerCenter = document.querySelector('.lottery-window').offsetWidth / 2;
    const winnerCenter = (WINNER_INDEX * SLOT_WIDTH) + (SLOT_WIDTH / 2);
    const scrollPos = -(winnerCenter - containerCenter);

    reel.style.transition = 'none';
    reel.style.transform = 'translateX(0px)';
    reel.offsetHeight; 
    reel.style.transition = 'transform 4s cubic-bezier(0.1, 0.1, 0.1, 1)'; 
    reel.style.transform = `translateX(${scrollPos}px)`;

    setTimeout(() => {
        if (wonItemName === 'Gold') addGold(wonItemQty); 
        else addItem(wonItemName, wonItemQty, 0); 

        const resultMsg = document.getElementById('lotteryResultMsg');
        if (wonItemName === jackpot.name) {
            resultMsg.innerHTML = `<span style="color: #ff4d4d; font-size: 22px;">JACKPOT! YOU WON THE ${wonItemName.toUpperCase()}!</span>`;
            playGlobalSound('sounds/soundeffects/levelupsound.mp3');
        } else {
            resultMsg.innerHTML = `Won: ${wonItemQty.toLocaleString()} ${wonItemName}`;
            playGlobalSound('sounds/soundeffects/inventorysound.mp3');
        }
        
        buyBtn.disabled = false;
        returnBtn.disabled = false;
        
        let remainingTickets = 0;
        for(const slot of game.inventory) {
            if(slot && slot.name === 'Lottery Ticket') remainingTickets += slot.qty;
        }
        
        if (remainingTickets > 0) {
            buyBtn.textContent = `Use Ticket (${remainingTickets})`;
            buyBtn.style.background = '#b300ff';
            buyBtn.style.color = '#fff';
        } else {
            buyBtn.textContent = "Buy Ticket (10k Gold)";
            buyBtn.style.background = 'var(--gold)';
            buyBtn.style.color = '#000';
        }
        
        game.isDirty = true; 
    }, 4100);
}

function backToActions(){
  showMainScreen('hubActions');
}

function _createModal(title, contentHtml, buttons) {
  // +++ FIX: Force tooltip to hide immediately when a popup opens +++
  if (typeof hideTooltip === 'function') {
    hideTooltip();
  }

  // Return a new promise that we can control
  return new Promise((resolve) => {
    // 1. Create elements
    const overlay = document.createElement('div');
    overlay.id = 'gameModalOverlay';

    const modal = document.createElement('div');
    modal.className = 'game-modal';

    const titleEl = document.createElement('div');
    titleEl.className = 'game-modal-title';
    titleEl.textContent = title;

    const contentEl = document.createElement('div');
    contentEl.className = 'game-modal-content';
    contentEl.innerHTML = contentHtml; // Use innerHTML to allow custom content

    const buttonEl = document.createElement('div');
    buttonEl.className = 'game-modal-buttons';

    // 2. Create buttons
    buttons.forEach(btnConfig => {
      const button = document.createElement('button');
      button.textContent = btnConfig.text;
      button.className = btnConfig.class || 'primary';
      if (btnConfig.style) {
        button.style.background = btnConfig.style;
      }

      // --- MODIFIED ONCLICK LOGIC ---
      button.onclick = () => {
        const inputEl = modal.querySelector('.game-modal-input');
        let resolveValue = btnConfig.value; // Default to the button's value (e.g., null for 'Cancel')

        // If an input exists AND the clicked button was NOT a cancel button (value is not null)
        if (inputEl && btnConfig.value !== null) { 
          resolveValue = inputEl.value; // Resolve with the input's value instead
        }
        
        overlay.remove();
        resolve(resolveValue); // Resolve with either the input value or the button value
      };
      // --- END MODIFICATION ---
      
      buttonEl.appendChild(button);
    });

    // 3. Assemble and append
    modal.appendChild(titleEl);
    modal.appendChild(contentEl);
    modal.appendChild(buttonEl);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Focus the first primary button or input
    const firstButton = modal.querySelector('button.primary');
    const firstInput = modal.querySelector('input');
    if (firstInput) {
      firstInput.focus();
      firstInput.select(); // Also select the text
    } else if (firstButton) {
      firstButton.focus();
    }
  });
}

/**
 * Shows a custom, in-game alert box.
 * Replaces the default browser alert().
 * @param {string} title - The title for the alert.
 * @param {string} message - The message to display.
 */
async function showGameAlert(title, message) {
  const buttons = [
    { text: 'OK', value: 'ok', class: 'primary' }
  ];
  // We await the modal helper. The promise will resolve when 'OK' is clicked.
  await _createModal(title, `<p>${message}</p>`, buttons);
}

async function showGamePrompt(title, message, defaultValue = '') {
  // HTML for the modal's content, including the input field
  const contentHtml = `
    <p>${message}</p>
    <input type="number" class="game-modal-input" value="${defaultValue}" onfocus="this.select();">
  `;
  
  // Buttons: Cancel (value: null) and OK (value: 'ok')
  const buttons = [
    { text: 'Cancel', value: null, class: 'primary', style: '#666' },
    { text: 'OK', value: 'ok', class: 'primary' } // 'ok' is a placeholder, _createModal will grab the input value
  ];

  // Our upgraded _createModal will return the input's value if 'OK' is clicked,
  // or null if 'Cancel' is clicked.
  const result = await _createModal(title, contentHtml, buttons);
  return result;
}

/**
 * Shows a custom, in-game confirmation box (Yes/No).
 * Replaces the default browser confirm().
 * @param {string} title - The title for the confirm box.
 * @param {string} message - The question to ask.
 * @returns {Promise<boolean>} - Resolves true if "Yes" was clicked, false if "No"/"Cancel".
 */
async function showGameConfirm(title, message) {
  const contentHtml = `<p>${message}</p>`;
  
  const buttons = [
    { text: 'No', value: false, class: 'primary', style: '#666' },
    { text: 'Yes', value: true, class: 'primary' } // 'Yes' resolves to true
  ];

  // This will return `true` or `false`
  const result = await _createModal(title, contentHtml, buttons);
  return result;
}


let draggedBankItem = null; // Stores data for bank drag-and-drop

// +++ FIX: Define scroll intervals globally so handleBankDrop can see them +++
let inventoryScrollInterval = null;
let bankScrollInterval = null;

/**
 * Renders the bank tabs UI (Main, 2, 3... +)
 */
function renderBankTabs() {
  const container = document.getElementById('bankTabsContainer');
  if (!container) return;
  container.innerHTML = '';

  game.bankTabs.forEach((tab, index) => {
    const btn = document.createElement('button');
    btn.className = 'bank-tab-btn';
    
    if (index === 0) {
        // +++ MAIN TAB (Static Chest Image) +++
        btn.innerHTML = '<img src="images/chest.png" alt="Main">';
        btn.style.padding = "0 6px";
        btn.style.display = "flex";
        btn.style.alignItems = "center";
        btn.style.justifyContent = "center";
    } else {
        // +++ EXTRA TABS (Dynamic Item Preview) +++
        const firstItem = tab && tab[0];
        let imgName = 'chest'; // Default icon if empty

        if (firstItem) {
            imgName = firstItem.name.toLowerCase().replace(/\s+/g,'_');
            
            const overrides = {
                'copper_bar': 'copperbar', 'copper_chestplate': 'copperchestplate', 'copper_shortsword': 'coppershortsword',
                'copper_helmet': 'copperhelmet', 'copper_boots': 'copperboots', 'raw_chicken': 'rawchicken',
                'cooked_chicken': 'cookedchicken', 'burnt_chicken': 'burntchicken', 'cooked_herring': 'cookedherring',
                'burnt_herring': 'burntherring', 'cooked_trout': 'cookedtrout', 'burnt_trout': 'burnttrout',
                'cooked_salmon': 'cookedsalmon', 'burnt_salmon': 'burntsalmon', 'beef': 'beef',
                'cooked_beef': 'cookedbeef', 'burnt_beef': 'burntbeef', 'gold_crown': 'goldcrown', 'elegant_black_cape': 'elegantblackcape',
                'coal_ore': 'coalore', 'iron_ore': 'ironore', 'iron_bar': 'ironbar',
                'iron_helmet': 'ironhelmet', 'iron_chestplate': 'ironchestplate', 'iron_boots': 'ironboots',
                'iron_shortsword': 'ironshortsword', 'copper_platelegs': 'copperplatelegs', 'iron_platelegs': 'ironplatelegs',
                'silver_ore': 'silverore', 'gold_ore': 'goldore',
                'softwood': 'softwood', 'oak': 'oak', 'bronze_pickaxe': 'bronzepickaxe', 'bronze_axe': 'bronzeaxe',
                'copper_pickaxe': 'copperpickaxe', 'copper_axe': 'copperaxe', 'iron_pickaxe': 'ironpickaxe',
                'iron_axe': 'ironaxe', 'silver_pickaxe': 'silverpickaxe', 'silver_axe': 'silveraxe', 'feather': 'feather', 'arrow_shaft': 'arrowshaft',
                'copper_arrow_tip': 'copperarrowtip', 'unbound_arrow': 'unboundarrow', 'copper_arrow': 'copperarrow',
                'silk': 'silk', 'cloth': 'cloth', 'wizard_hat': 'wizardhat', 'wizard_robe': 'wizardrobe',
                'wizard_trousers': 'wizardtrousers', 'wizard_boots': 'wizardboots', 'magic_staff': 'magicstaff',
                'pet_spider_egg': 'petegg1', // +++ NEW PET EGG +++
                'rat_tail': 'rattail', 'sand': 'sand', 'empty_vial': 'emptyvial',
                'venom': 'venom', 'lottery_ticket': 'lotteryticket', 'earth_crystal_shard': 'earthcrystalshard',
                'air_crystal_shard': 'aircrystalshard', 'water_crystal_shard': 'watercrystalshard', 'bow_string': 'bowstring',
                'unstrung_softwood_bow': 'unstrungsoftwoodbow', 'unstrung_oak_bow': 'unstrungoakbow', 'softwood_bow': 'softwoodbow',
                'oak_bow': 'oakbow', 'cow_hide': 'cowhide', 'leather': 'leather', 'leather_hood': 'leatherhood',
                'leather_body': 'leatherarmor', 'leather_chaps': 'leatherpants', 'leather_boots': 'leatherboots',
                'herring': 'herring', 'trout': 'trout', 'salmon': 'salmon', 'fishing_pole': 'fishingpole',
                'fishing_bait': 'fishingbait', 'empty_bucket': 'emptybucket', 'bucket_of_milk': 'bucketofmilk', 
                'bucket_of_water': 'bucketofwater', 'grass_seed': 'grassseed', 'corn_seed': 'cornseed',
                'vitality_potion': 'vitalitypotion', 'gold_ring': 'goldring'
            };
            
            if (overrides[imgName]) {
                imgName = overrides[imgName];
            }
        }

        // Render the image (Item or Chest)
        btn.innerHTML = `<img src="images/${imgName}.png" alt="Tab">`;
        
        // Styles
        btn.style.padding = "0 6px"; 
        btn.style.display = "flex";
        btn.style.alignItems = "center";
        btn.style.justifyContent = "center";
    }
    
    if (index === game.activeBankTabIndex) {
      btn.classList.add('active');
    }
    
    btn.onclick = () => switchBankTab(index);
    container.appendChild(btn);
  });

  // +++ Limit Check (Main + 4 Extras = 5 Total) +++
  if (game.bankTabs.length < 5) {
      const currentCount = game.bankTabs.length;
      let cost = 0;
      if (currentCount === 1) cost = 100000;
      else if (currentCount === 2) cost = 1000000;
      else if (currentCount === 3) cost = 10000000;
      else if (currentCount === 4) cost = 100000000;

      const addBtn = document.createElement('button');
      addBtn.className = 'add-tab-btn';
      addBtn.textContent = '+';
      addBtn.onclick = buyBankTab;
      addBtn.onmouseenter = (e) => showTooltip(e, `<div style="color:var(--gold);">Buy Bank Tab</div>Cost: ${formatAmount(cost)} Gold`);
      addBtn.onmouseleave = hideTooltip;
      container.appendChild(addBtn);
  }
}

function switchBankTab(index) {
  game.activeBankTabIndex = index;
  renderBankTabs();
  renderBankGrid();
}

async function buyBankTab() {
  if (!game.isSessionActive) {
      await showGameAlert("Session Not Active", "Session not active.");
      return;
  }
  
  const currentCount = game.bankTabs.length;

  // +++ NEW: Limit Check +++
  if (currentCount >= 5) {
      await showGameAlert("Max Reached", "You have reached the maximum number of bank tabs.");
      return;
  }

  // +++ NEW: Scaling Costs +++
  let cost = 0;
  if (currentCount === 1) cost = 100000;        // 1st Extra
  else if (currentCount === 2) cost = 1000000;   // 2nd Extra
  else if (currentCount === 3) cost = 10000000;  // 3rd Extra
  else if (currentCount === 4) cost = 100000000; // 4th Extra
  
  if (game.gold < cost) {
      await showGameAlert("Not Enough Gold", `You need ${formatAmount(cost)} Gold to buy the next bank tab.`);
      return;
  }

  const confirmed = await showGameConfirm("Buy Bank Tab", `Purchase a new bank tab for ${formatAmount(cost)} Gold?`);
  if (confirmed) {
      if (game.gold >= cost) {
          addGold(-cost);
          // Add new empty tab
          game.bankTabs.push(new Array(game.bankCapacity).fill(null));
          // Switch to it
          game.activeBankTabIndex = game.bankTabs.length - 1;
          
          renderBankTabs();
          renderBankGrid();
          game.isDirty = true;
      }
  }
}



/**
 * Renders the Bank grid UI
 */
function renderBankGrid() {
  const grid = document.getElementById('bankGrid');
  if (!grid) return;
  
  // +++ NEW: Render Tabs first +++
  renderBankTabs(); 
  
  grid.innerHTML = '';
  
  // +++ USE ACTIVE TAB +++
  const currentTab = game.bankTabs[game.activeBankTabIndex];
  if (!currentTab) return;

  for(let i = 0; i < game.bankCapacity; i++) {
    const slotData = currentTab[i]; // <-- Use currentTab
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    slot.dataset.slotIndex = i;
    
    slot.addEventListener('dragover', handleBankDragOver);
    slot.addEventListener('dragleave', (e) => e.target.closest('.inv-slot').classList.remove('drag-over'));
    slot.addEventListener('drop', handleBankDrop);
    
    if(slotData) {
      const item = slotData;
      
      slot.draggable = true; 
      slot.addEventListener('dragstart', (e) => handleBankWithdrawDragStart(e, item, i));
      slot.addEventListener('dragend', () => {
        draggedBankItem = null;
        game.isDragging = false; 
        const draggingEl = document.querySelector('.inv-slot.dragging');
        if (draggingEl) draggingEl.classList.remove('dragging');
      });
      
      slot.onclick = () => withdrawItem(i); 

      const img = document.createElement('img');
              let imgName = item.name.toLowerCase().replace(/\s+/g,'_');
              if (item.name === 'Copper Bar') imgName = 'copperbar';
              else if (item.name === 'Copper Chestplate') imgName = 'copperchestplate';
              else if (item.name === 'Silver Ore') imgName = 'silverore';
              else if (item.name === 'Gold Ore') imgName = 'goldore';
              else if (item.name === 'Copper Shortsword') imgName = 'coppershortsword';
              else if (item.name === 'Copper Helmet') imgName = 'copperhelmet';
              else if (item.name === 'Copper Boots') imgName = 'copperboots';
              else if (item.name === 'Raw Chicken') imgName = 'rawchicken';
              else if (item.name === 'Cooked Chicken') imgName = 'cookedchicken';
              else if (item.name === 'Burnt Chicken') imgName = 'burntchicken';
              
              
              else if (item.name === 'Cooked Herring') imgName = 'cookedherring';
              else if (item.name === 'Burnt Herring') imgName = 'burntherring';
              else if (item.name === 'Cooked Trout') imgName = 'cookedtrout';
              else if (item.name === 'Burnt Trout') imgName = 'burnttrout';
              else if (item.name === 'Cooked Salmon') imgName = 'cookedsalmon';
              else if (item.name === 'Burnt Salmon') imgName = 'burntsalmon';
              
              
              else if (item.name === 'Beef') imgName = 'beef';
              else if (item.name === 'Cooked Beef') imgName = 'cookedbeef';
              else if (item.name === 'Burnt Beef') imgName = 'burntbeef';

              
              else if (item.name === 'Gold Crown') imgName = 'goldcrown'; 
              else if (item.name === 'Elegant Black Cape') imgName = 'elegantblackcape';
       
              else if (item.name === 'Coal Ore') imgName = 'coalore';
              else if (item.name === 'Iron Ore') imgName = 'ironore';
              else if (item.name === 'Iron Bar') imgName = 'ironbar';
              else if (item.name === 'Silver Bar') imgName = 'silverbar';
              else if (item.name === 'Gold Bar') imgName = 'goldbar';
              else if (item.name === 'Iron Helmet') imgName = 'ironhelmet';
              else if (item.name === 'Iron Chestplate') imgName = 'ironchestplate';
              else if (item.name === 'Iron Boots') imgName = 'ironboots';
              else if (item.name === 'Iron Shortsword') imgName = 'ironshortsword';
              else if (item.name === 'Copper Platelegs') imgName = 'copperplatelegs'; // +++ NEW +++
              else if (item.name === 'Iron Platelegs') imgName = 'ironplatelegs'; // +++ NEW +++
              else if (item.name === 'Softwood') imgName = 'softwood';
              else if (item.name === 'Oak') imgName = 'oak';
              else if (item.name === 'Bronze Pickaxe') imgName = 'bronzepickaxe'; // +++ NEW +++
              else if (item.name === 'Bronze Axe') imgName = 'bronzeaxe'; // +++ NEW +++
              else if (item.name === 'Copper Pickaxe') imgName = 'copperpickaxe'; // +++ NEW +++
              else if (item.name === 'Copper Axe') imgName = 'copperaxe'; // +++ NEW +++
              else if (item.name === 'Iron Pickaxe') imgName = 'ironpickaxe'; // +++ NEW +++
              else if (item.name === 'Iron Axe') imgName = 'ironaxe'; // +++ NEW +++
              else if (item.name === 'Silver Pickaxe') imgName = 'silverpickaxe'; // +++ NEW +++
              else if (item.name === 'Silver Axe') imgName = 'silveraxe'; // +++ NEW +++
              else if (item.name === 'Feather') imgName = 'feather'; // +++ NEW +++
              else if (item.name === 'Arrow Shaft') imgName = 'arrowshaft'; // +++ NEW +++
              else if (item.name === 'Copper Arrow Tip') imgName = 'copperarrowtip'; // +++ NEW +++
              else if (item.name === 'Unbound Arrow') imgName = 'unboundarrow'; // +++ NEW +++
              else if (item.name === 'Copper Arrow') imgName = 'copperarrow'; // +++ NEW +++
              else if (item.name === 'Silk') imgName = 'silk'; // +++ NEW +++

              
              else if (item.name === 'Cloth') imgName = 'cloth';
              else if (item.name === 'Wizard Hat') imgName = 'wizardhat';
              else if (item.name === 'Wizard Robe') imgName = 'wizardrobe';
              else if (item.name === 'Wizard Trousers') imgName = 'wizardtrousers';
              else if (item.name === 'Wizard Boots') imgName = 'wizardboots';
              else if (item.name === 'Magic Staff') imgName = 'magicstaff'; // +++ FIX: ADD MAGIC STAFF +++
              else if (item.name === 'Pet Spider Egg') imgName = 'petegg1'; // +++ FIX: ADD PET EGG +++
              else if (item.name === 'Rat Tail') imgName = 'rattail'; // +++ NEW ITEM +++
              else if (item.name === 'Sand') imgName = 'sand'; // +++ NEW +++
              else if (item.name === 'Empty Vial') imgName = 'emptyvial'; // +++ NEW +++
              else if (item.name === 'Venom') imgName = 'venom'; // +++ NEW +++
              else if (item.name === 'Lottery Ticket') imgName = 'lotteryticket'; // +++ NEW +++
              
              
              else if (item.name === 'Earth Crystal Shard') imgName = 'earthcrystalshard';
              else if (item.name === 'Air Crystal Shard') imgName = 'aircrystalshard';
              else if (item.name === 'Water Crystal Shard') imgName = 'watercrystalshard';

              
              else if (item.name === 'Bow String') {
                  imgName = 'bowstring';
              } else if (item.name === 'Unstrung Softwood Bow') {
                  imgName = 'unstrungsoftwoodbow';
              } else if (item.name === 'Unstrung Oak Bow') {
                  imgName = 'unstrungoakbow';
              } else if (item.name === 'Softwood Bow') {
                  imgName = 'softwoodbow';
              } else if (item.name === 'Oak Bow') {
                  imgName = 'oakbow';
              }

// +++ NEW LEATHER +++
              else if (item.name === 'Cow Hide') {
                  imgName = 'cowhide';
              } else if (item.name === 'Leather') {
                  imgName = 'leather';
              } else if (item.name === 'Leather Hood') {
                  imgName = 'leatherhood';
              } else if (item.name === 'Leather Body') {
                  imgName = 'leatherarmor';
              } else if (item.name === 'Leather Chaps') {
                  imgName = 'leatherpants';
              } else if (item.name === 'Leather Boots') {
                  imgName = 'leatherboots';
              }

              // +++ NEW FISHING ITEMS +++
              else if (item.name === 'Herring') {
                  imgName = 'herring';
              } else if (item.name === 'Trout') {
                  imgName = 'trout';
              } else if (item.name === 'Salmon') {
                  imgName = 'salmon';
              } else if (item.name === 'Fishing Pole') {
                  imgName = 'fishingpole';
              } else if (item.name === 'Fishing Bait') {
                  imgName = 'fishingbait';
              }
              // +++ NEW BUCKETS +++
              else if (item.name === 'Empty Bucket' || imgName === 'empty_bucket') {
                  imgName = 'emptybucket';
              } else if (item.name === 'Bucket of Milk' || imgName === 'bucket_of_milk') {
                  imgName = 'bucketofmilk';
              } else if (item.name === 'Bucket of Water' || imgName === 'bucket_of_water') {
                  imgName = 'bucketofwater';
              }
              // +++ NEW FARM ITEMS +++
              else if (item.name === 'Grass Seed') {
                  imgName = 'grassseed';
              } else if (item.name === 'Grass') {
                  imgName = 'grass';
              } else if (item.name === 'Corn Seed') {
                  imgName = 'cornseed';
              } else if (item.name === 'Corn') {
                  imgName = 'corn';
              } else if (item.name === 'Dirt Shroom') {
                  imgName = 'dirtshroom'; }
              else if (item.name === 'Wild Herb') {
                  imgName = 'wildherb'; }
              else if (item.name === 'Vitality Potion') {
                  imgName = 'vitalitypotion'; }
              
              // +++ NEW GEMS +++
              else if (item.name === 'Uncut Topaz') imgName = 'uncuttopaz';
              else if (item.name === 'Uncut Diamond') imgName = 'uncutdiamond';
              else if (item.name === 'Uncut Emerald') imgName = 'uncutemerald';
              else if (item.name === 'Uncut Jade') imgName = 'uncutjade';
              else if (item.name === 'Uncut Ruby') imgName = 'uncutruby';
              else if (item.name === 'Uncut Sapphire') imgName = 'uncutsapphire';

              // +++ NEW CUT GEMS +++
              else if (item.name === 'Topaz') imgName = 'topaz';
              else if (item.name === 'Diamond') imgName = 'diamond';
              else if (item.name === 'Emerald') imgName = 'emerald';
              else if (item.name === 'Jade') imgName = 'jade';
              else if (item.name === 'Ruby') imgName = 'ruby';
              else if (item.name === 'Sapphire') imgName = 'sapphire';
              else if (item.name === 'Gold Ring') imgName = 'goldring';
              else if (item.name === 'Diamond Ring') imgName = 'diamondring';
              else if (item.name === 'Emerald Ring') imgName = 'emeraldring';
              else if (item.name === 'Ruby Ring') imgName = 'rubyring';
              else if (item.name === 'Sapphire Ring') imgName = 'sapphirering';
              else if (item.name === 'Topaz Ring') imgName = 'topazring';
              else if (item.name === 'Silver Fangs of the Fallen Monarch') imgName = 'silverfangsofthefallenmonarch';

              // --- END OF FIX ---
              img.src = `images/${imgName}.png`;
      img.alt = item.name;
      
      // Apply Enchantment Glows
      const eLvl = item.enchantLevel || 0;
      if (item.name === 'Gold Crown' || item.name === 'Elegant Black Cape') {
          slot.classList.add('legendary-glow');
      } else if (eLvl > 0) {
          slot.classList.add(`enchant-glow-${eLvl}`);
      }

      if (eLvl > 0) {
          const badge = document.createElement('div');
          badge.className = 'enchant-level-badge';
          badge.innerText = `+${eLvl}`;
          slot.appendChild(badge);
      }

      // Shrink diamond images slightly...
      // Shrink diamond images slightly to match higher res gems
      if (item.name === 'Diamond' || item.name === 'Uncut Diamond') {
          img.style.transform = 'scale(0.93)';
      }
      img.onerror = function(){ this.style.opacity='0.08'; };
      slot.appendChild(img);
      
      const amt = document.createElement('div');
      amt.className = 'inv-amount';
      amt.innerText = formatAmount(item.qty); 
      slot.appendChild(amt);
      
      // --- UPDATED: Generate Correct Stat Tooltip ---
      const itemName = item.name;
      const stats = ITEM_STATS[itemName];
      let itemStats = '';

      if (stats) {
        const enchantLvl = item.enchantLevel || 0;
        const stdB = enchantLvl;
        const penB = Math.floor(enchantLvl / 2);

        if (stats.meleeStr) itemStats += `<div style="color:#ff4d4d;">+${stats.meleeStr + stdB} Melee Strength</div>`;
        if (stats.rangedStr) itemStats += `<div style="color:#44aa44;">+${stats.rangedStr + stdB} Ranged Strength</div>`;
        if (stats.magicDmg) itemStats += `<div style="color:#4da6ff;">+${stats.magicDmg + stdB} Magic Damage</div>`;
        
        // Match Defense scaling logic
        let mBonus = stdB, rBonus = stdB, magBonus = stdB;
        if (stats.armorType === 'melee') magBonus = penB;
        else if (stats.armorType === 'ranged' || stats.armorType === 'magic') mBonus = penB;

        if (stats.meleeDef !== undefined) itemStats += `<div style="color:#e38a42;">+${stats.meleeDef + mBonus} Melee Def</div>`;
        if (stats.rangedDef !== undefined) itemStats += `<div style="color:#aaffaa;">+${stats.rangedDef + rBonus} Ranged Def</div>`;
        if (stats.magicDef !== undefined) itemStats += `<div style="color:#6dafff;">+${stats.magicDef + magBonus} Magic Def</div>`;

        if (stats.maxHPBonus) itemStats += `<div style="color:#ffaaaa;">+${stats.maxHPBonus + stdB} Max HP</div>`;
        
        // --- ADDED SPEED DISPLAY ---
        if (stats.speed) itemStats += `<div style="color:var(--gold);">Speed: ${(stats.speed / 1000).toFixed(1)}s</div>`;
      }

      const tooltipContent = `
        <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${itemName} ${item.enchantLevel > 0 ? '+' + item.enchantLevel : ''}</div>
        <div style="font-size:12px;">Amount: ${item.qty.toLocaleString()}</div>
        ${itemStats}
        <div style="color:#ffaaaa; margin-top: 5px; font-size:11px;">Click or Drag to withdraw...</div>
      `;
      slot.onmouseenter = (evt) => showTooltip(evt, tooltipContent);
      slot.onmouseleave = hideTooltip;
    }
    grid.appendChild(slot);
  }
}



/**
 * Updates the gold values on the bank screen
 */
function updateBankGoldUI() {
  setText('bankPlayerGold', formatAmount(game.gold));
  setText('bankStoredGold', formatAmount(game.bankGold));

  // +++ NEW: Tooltip for exact bank amount +++
  const bankDisplay = document.getElementById('bankStoredGold');
  if (bankDisplay) {
    bankDisplay.style.cursor = 'help';
    bankDisplay.onmouseenter = (e) => showTooltip(e, `<div style="color:var(--gold); font-weight:bold; font-size:14px;">${game.bankGold.toLocaleString()} Gold</div>`);
    bankDisplay.onmouseleave = hideTooltip;
  }
}

/**
 * Main function to open the Bank UI
 */
function openBank() {
  showMainScreen('hubBank');
}
// --- Bank Drag-and-Drop Handlers ---

function handleBankDragStart(e, item, fromIndex) {
  hideTooltip(); // <--- ADDED THIS LINE
  // Store item data for the drop
  draggedBankItem = { item, fromIndex };
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    e.target.closest('.inv-slot').classList.add('dragging');
  }, 0);
}

function handleBankDragOver(e) {
  e.preventDefault();
  // +++ FIX: Force cursor explicitly for bank slots +++
  if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
  
  const targetSlot = e.target.closest('.inv-slot');
  if (targetSlot) {
    targetSlot.classList.add('drag-over');
  }
}

async function handleBankDrop(e) {
  e.preventDefault();
  game.isDragging = false; // FIX: Immediately unlock tooltips on drop

  // +++ FIX: Stop auto-scrolling immediately when item is dropped in bank +++
  if (inventoryScrollInterval) {
      clearInterval(inventoryScrollInterval);
      inventoryScrollInterval = null;
  }
  if (bankScrollInterval) {
      clearInterval(bankScrollInterval);
      bankScrollInterval = null;
  }
  // +++ END FIX +++

  const targetSlot = e.target.closest('.inv-slot');
  
  if (targetSlot) {
    targetSlot.classList.remove('drag-over');
  }
  
  // Clean up *any* dragging slot, from either grid
  const draggingInvEl = document.querySelector('#inventoryGrid .inv-slot.dragging');
  if (draggingInvEl) draggingInvEl.classList.remove('dragging');
  const draggingBankEl = document.querySelector('#bankGrid .inv-slot.dragging');
  if (draggingBankEl) draggingBankEl.classList.remove('dragging');

  if (!targetSlot || !draggedBankItem) {
     draggedBankItem = null;
     return;
  }

  const toIndex = parseInt(targetSlot.dataset.slotIndex);
  const fromIndex = draggedBankItem.fromIndex;

  // --- NEW LOGIC: Check drag source ---
  if (draggedBankItem.source === 'bank') {
    // === BANK -> BANK internal move ===
    
    if (fromIndex !== toIndex) {
      // +++ USE ACTIVE TAB +++
      const currentTab = game.bankTabs[game.activeBankTabIndex];
      // --- Get the item data *before* the prompt ---
      const dragItemBeforePrompt = currentTab[fromIndex];
      const dropItem = currentTab[toIndex];

      // --- MODIFIED: Handle Shift-Click to move specific amount ---
      if (e.shiftKey && dragItemBeforePrompt) { 
        
        if (dropItem && (dropItem.name !== dragItemBeforePrompt.name || (dropItem.enchantLevel || 0) !== (dragItemBeforePrompt.enchantLevel || 0))) {
          await showGameAlert("Invalid Slot", "You can only move onto an empty slot or a stack of the same item.");
        } else {
          const input = await showGamePrompt(
            `Move ${dragItemBeforePrompt.name}`, 
            `How many to move? (You have: ${dragItemBeforePrompt.qty})`,
            "" 
          );

          if (input === null) {
            const originalSlotEl = document.querySelector(`#bankGrid .inv-slot[data-slot-index="${fromIndex}"]`);
            if (originalSlotEl) {
              originalSlotEl.classList.remove('dragging');
            }
          } else {
            const itemAfterPrompt = currentTab[fromIndex];
            
            if (!itemAfterPrompt || itemAfterPrompt.name !== dragItemBeforePrompt.name) {
              draggedBankItem = null;
              game.isDragging = false;
              return;
            }
            
            const splitAmount = parseInt(input);

            if (isNaN(splitAmount) || splitAmount <= 0) { /* Invalid */ }
            
            else if (splitAmount > itemAfterPrompt.qty) { 
              await showGameAlert("Invalid Amount", "You don't have that many.");
            } 
            
            else if (splitAmount === itemAfterPrompt.qty) { 
              if (itemAfterPrompt && dropItem && itemAfterPrompt.name === dropItem.name && (itemAfterPrompt.enchantLevel || 0) === (dropItem.enchantLevel || 0)) {
                dropItem.qty += itemAfterPrompt.qty;
                currentTab[fromIndex] = null;
              } else {
                currentTab[fromIndex] = dropItem;
                currentTab[toIndex] = itemAfterPrompt;
              }
              renderBankGrid();
              if (typeof window.savePlayerData === 'function') savePlayerData();
            }
            
            else {
              if (dropItem) { 
                dropItem.qty += splitAmount;
              } else { 
                currentTab[toIndex] = { ...itemAfterPrompt, qty: splitAmount };
              }
              itemAfterPrompt.qty -= splitAmount; 

              renderBankGrid();
              if (typeof window.savePlayerData === 'function') savePlayerData();
            }
          }
        }
      } else {
        const dragItem = currentTab[fromIndex];
        if (dragItem && dropItem && dragItem.name === dropItem.name && (dragItem.enchantLevel || 0) === (dropItem.enchantLevel || 0)) {
          dropItem.qty += dragItem.qty;
          currentTab[fromIndex] = null;
        } else {
          currentTab[fromIndex] = dropItem;
          currentTab[toIndex] = dragItem;
        }
        renderBankGrid();
        if (typeof window.savePlayerData === 'function') savePlayerData();
      }
    }

  } else {
    // === INVENTORY -> BANK deposit ===
    // Check for Ctrl (Windows) or Cmd (Mac) to skip prompt
    const skipPrompt = e.ctrlKey || e.metaKey; 
    const depositSuccess = await depositItem(draggedBankItem.item, fromIndex, toIndex, skipPrompt);
    
    if (!depositSuccess) {
      const originalSlotEl = document.querySelector(`#inventoryGrid .inv-slot[data-slot-index="${fromIndex}"]`);
      if (originalSlotEl) {
        originalSlotEl.classList.remove('dragging');
      }
    }
  }
  
  draggedBankItem = null;
  game.isDragging = false; // Final safety unlock
}

// --- Bank Core Logic ---

function handleBankWithdrawDragStart(e, item, fromBankIndex) {
  hideTooltip(); // <--- ADDED THIS LINE
  // Store item data and the *source* as 'bank'
  draggedBankItem = { item, fromIndex: fromBankIndex, source: 'bank' };
  e.dataTransfer.effectAllowed = 'move';
  game.isDragging = true;
  setTimeout(() => {
    e.target.closest('.inv-slot').classList.add('dragging');
  }, 0);
}


async function depositItem(item, fromInventoryIndex, toBankIndex, skipPrompt = false) {
  if (!item) return;
  const currentTab = game.bankTabs[game.activeBankTabIndex];
  const bankSlot = currentTab[toBankIndex];
  
  // 1. Swap Logic
  if (bankSlot && (bankSlot.name !== item.name || (bankSlot.enchantLevel || 0) !== (item.enchantLevel || 0))) {
      if (game.inventory[fromInventoryIndex].name !== item.name) return;
      const temp = bankSlot;
      currentTab[toBankIndex] = game.inventory[fromInventoryIndex];
      game.inventory[fromInventoryIndex] = temp;
      renderBankGrid();
      renderInventoryGrid();
      hideTooltip();
      game.isDirty = true;
      return true;
  }

  // 2. Quantity Logic
  let qtyToDeposit = item.qty;
  // Only ask if quantity > 1 AND the player didn't hold Ctrl
  if (item.qty > 1 && !skipPrompt) {
    const input = await showGamePrompt(`Deposit ${item.name}`, `How many to deposit? (You have: ${item.qty})`, item.qty);
    if (input === null) return false;
    qtyToDeposit = parseInt(input);
  }

  if (isNaN(qtyToDeposit) || qtyToDeposit <= 0 || qtyToDeposit > item.qty) return;

  // 3. Deposit logic preserving enchantment
  const enchant = item.enchantLevel || 0;
  game.inventory[fromInventoryIndex].qty -= qtyToDeposit;
  if (game.inventory[fromInventoryIndex].qty <= 0) game.inventory[fromInventoryIndex] = null;

  if (bankSlot) {
    bankSlot.qty += qtyToDeposit;
  } else {
    currentTab[toBankIndex] = { name: item.name, qty: qtyToDeposit, enchantLevel: enchant };
  }

  renderBankGrid();
  renderInventoryGrid();
  hideTooltip();
  game.isDirty = true;
  return true;
}

async function withdrawItem(fromBankIndex) {
  const currentTab = game.bankTabs[game.activeBankTabIndex];
  const item = currentTab[fromBankIndex];
  if (!item) return;

  let qtyToWithdraw = item.qty;
  if (item.qty > 1) {
    const input = await showGamePrompt(`Withdraw ${item.name}`, `How many to withdraw? (Bank has: ${item.qty})`, item.qty);
    if (input === null) return;
    qtyToWithdraw = parseInt(input);
  }
  
  if (isNaN(qtyToWithdraw) || qtyToWithdraw <= 0 || qtyToWithdraw > item.qty) return;
  
  // Call addItem with the enchantment level
  addItem(item.name, qtyToWithdraw, item.enchantLevel || 0); 
  
  currentTab[fromBankIndex].qty -= qtyToWithdraw;
  if (currentTab[fromBankIndex].qty <= 0) currentTab[fromBankIndex] = null;
  
  renderBankGrid();
  renderInventoryGrid(); 
  hideTooltip();
  game.isDirty = true;
}

async function depositGold() { // <-- ADD 'async'
  const inputEl = document.getElementById('bankGoldInput');
  if (!inputEl) return;
  
  let amount = parseInt(inputEl.value);
  if (isNaN(amount) || amount <= 0) {
    await showGameAlert("Invalid Amount", "Please enter a valid amount."); // <-- USE 'await showGameAlert'
    return;
  }
  if (amount > game.gold) {
    await showGameAlert("Not Enough Gold", "You don't have that much gold to deposit."); // <-- USE 'await showGameAlert'
    return;
  }

  game.gold -= amount;
  game.bankGold += amount;

  inputEl.value = '';
  updateBankGoldUI();
  updateGoldUI(); // Update main UI
  game.isDirty = true;
}

async function withdrawGold() { 
  const inputEl = document.getElementById('bankGoldInput');
  if (!inputEl) return;
  
  let amount = parseInt(inputEl.value);
  if (isNaN(amount) || amount <= 0) {
    await showGameAlert("Invalid Amount", "Please enter a valid amount.");
    return;
  }
  if (amount > game.bankGold) {
    await showGameAlert("Not Enough Gold", "You don't have that much gold in your bank.");
    return;
  }

  game.bankGold -= amount;
  game.gold += amount;

  inputEl.value = '';
  updateBankGoldUI();
  updateGoldUI(); 
  game.isDirty = true;
}

// +++ NEW: Deposit/Withdraw ALL Gold Functions +++
async function depositAllGold() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (game.gold <= 0) {
    await showGameAlert("No Gold", "You don't have any gold to deposit.");
    return;
  }

  const amount = game.gold;
  game.gold = 0;
  game.bankGold += amount;

  updateBankGoldUI();
  updateGoldUI();
  game.isDirty = true;
}

async function withdrawAllGold() {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "Session not active.");
    return;
  }
  if (game.bankGold <= 0) {
    await showGameAlert("Bank Empty", "You don't have any gold in the bank.");
    return;
  }

  const amount = game.bankGold;
  game.bankGold = 0;
  game.gold += amount;

  updateBankGoldUI();
  updateGoldUI();
  game.isDirty = true;
}
// +++ END NEW +++

async function dragWithdrawItem(fromBankIndex, toInventoryIndex, skipPrompt = false) {
  const currentTab = game.bankTabs[game.activeBankTabIndex];
  const bankItem = currentTab[fromBankIndex];
  const inventorySlotItem = game.inventory[toInventoryIndex];

  if (!bankItem) return;

  const enchant = bankItem.enchantLevel || 0;

  // Swap Logic (Checks both Name and Enchantment)
  if (inventorySlotItem && (inventorySlotItem.name !== bankItem.name || (inventorySlotItem.enchantLevel || 0) !== enchant)) {
      currentTab[fromBankIndex] = inventorySlotItem;
      game.inventory[toInventoryIndex] = bankItem;
      renderBankGrid();
      renderInventoryGrid();
      hideTooltip();
      game.isDirty = true;
      return;
  }

  let qtyToWithdraw = bankItem.qty;
  // Only ask if quantity > 1 AND the player didn't hold Ctrl
  if (bankItem.qty > 1 && !skipPrompt) {
    const input = await showGamePrompt(`Withdraw ${bankItem.name}`, `How many to withdraw? (Bank has: ${bankItem.qty})`, bankItem.qty);
    if (input === null) return; 
    qtyToWithdraw = parseInt(input);
  }
  
  if (isNaN(qtyToWithdraw) || qtyToWithdraw <= 0 || qtyToWithdraw > bankItem.qty) return;

  // Added check for enchantment level matching
  if (inventorySlotItem && inventorySlotItem.name === bankItem.name && (inventorySlotItem.enchantLevel || 0) === enchant) {
    inventorySlotItem.qty += qtyToWithdraw;
    bankItem.qty -= qtyToWithdraw;
    if (bankItem.qty <= 0) currentTab[fromBankIndex] = null;
  } else {
    if (qtyToWithdraw === bankItem.qty) {
        game.inventory[toInventoryIndex] = bankItem;
        currentTab[fromBankIndex] = null;
    } else {
        game.inventory[toInventoryIndex] = { name: bankItem.name, qty: qtyToWithdraw, enchantLevel: enchant };
        bankItem.qty -= qtyToWithdraw;
    }
  }
  
  renderBankGrid();
  renderInventoryGrid();
  hideTooltip();
  game.isDirty = true;
}


// =================================================================
// --- END NEW BANK FUNCTIONS ---
// =================================================================

async function buyShopItem(itemName, price) {
  if (!game.isSessionActive) {
    await showGameAlert("Session Not Active", "This tab is not active. Please take control to perform actions.");
    return;
  }
  // Check if they can afford at least one
  if (game.gold < price) {
    await showGameAlert("Not Enough Gold", `You need ${price} Gold to buy that.`);
    return;
  }

  // --- NEW: Ask for quantity ---
  const input = await showGamePrompt(
    `Buy ${itemName}`, 
    `How many ${itemName} do you want to buy? (Price: ${price}ea)`, 
    1 // Default value
  );

  if (input === null) return; // User cancelled
  const qtyToBuy = parseInt(input);

  if (isNaN(qtyToBuy) || qtyToBuy <= 0) {
    return; // Invalid number
  }
  // --- END NEW ---

  const totalCost = price * qtyToBuy;
  
  // Check if they have enough gold for the total purchase
  if (game.gold < totalCost) {
    await showGameAlert("Not Enough Gold", `You need ${totalCost} Gold to buy ${qtyToBuy} ${itemName}.`);
    return;
  }

  // Check for inventory space (find existing stack OR an empty slot)
  // Your addItem function is smart, so we just need to make sure
  // it *can* add (i.e., not full with no matching stacks).
  const stackIndex = game.inventory.findIndex(slot => slot && slot.name === itemName);
  const emptySlotIndex = game.inventory.findIndex(slot => slot === null);
  
  if (stackIndex === -1 && emptySlotIndex === -1) {
     await showGameAlert("Inventory Full", "You have no space in your inventory to buy this.");
     return;
  }
  
  addGold(-totalCost);
  addItem(itemName, qtyToBuy); // Use the new quantity
  await showGameAlert("Purchase Complete", `You bought ${qtyToBuy} ${itemName} for ${totalCost} Gold.`);
  
  // No need to render, addItem and addGold already do.
  if (typeof window.savePlayerData === 'function') {
    window.savePlayerData();
  }
}

function openShop() {
  showMainScreen('hubShop');
}

function resetGameState() {
  stopMining(); 
  stopBlacksmithing();
  stopFletching(); 
  stopCraftingBowString(); 
  stopFishing(); 
  stopStoneForging();
  
  if (game.inCombat) {
    runFromCombat(false);
  }

  // CLEANUP ENCHANTING
  game.enchantSlot = null;
  game.enchantingActive = false;

  // CLEANUP AUTO EAT
  game.autoEatSlot = null; // <--- ADD THIS LINE

  game.name = '';
  game.hp = 10;
  game.maxHP = 10;
  game.inventory = new Array(game.inventoryCapacity).fill(null);
  game.gold = 100; 
  game.bank = new Array(game.bankCapacity).fill(null);

  game.bankTabs = [new Array(game.bankCapacity).fill(null)];
  game.activeBankTabIndex = 0;

  game.bankGold = 0;
  game.equipment = { 
    necklace: null, helmet: null, cape: null, 
    weapon: null, chest: null, shield: null, 
    ring1: null, legs: null, ring2: null, 
    arrows: null, boots: null, pet: null 
  };

  game.mining = { level: 1, xp: 0, totalXP: 0 };
  game.blacksmith = { level: 1, xp: 0, totalXP: 0 };
  game.cooking = { level: 1, xp: 0, totalXP: 0 };
  game.woodcutting = { level: 1, xp: 0, totalXP: 0 };
  game.fletching = { level: 1, xp: 0, totalXP: 0 }; 
  game.fishing = { level: 1, xp: 0, totalXP: 0 }; 
  
  game.crafting = { level: 1, xp: 0, totalXP: 0 };
  game.ranged = { level: 1, xp: 0, totalXP: 0 };
  game.magic = { level: 1, xp: 0, totalXP: 0 };
  game.stoneforging = { level: 1, xp: 0, totalXP: 0 }; 
  
  game.attack = { level: 1, xp: 0, totalXP: 0 };
  game.strength = { level: 1, xp: 0, totalXP: 0 };
  game.defence = { level: 1, xp: 0, totalXP: 0 };
  game.vitality = { level: 1, xp: 0, totalXP: 0 };

  game.bountyhunting = { level: 1, xp: 0, totalXP: 0 };
  game.farming = { level: 1, xp: 0, totalXP: 0 }; 
  game.activeBounty = null;

  game.farm = {
    chickens: [],
    cows: [],
    garden: new Array(16).fill(null),
    cellar: new Array(16).fill(null),
    buildings: { coop: false, barn: false, well: false, garden: false, cellar: false }
  };

  game.questLines = {}; 
  game.autoEatUnlocked = false;
  game.lastAutoHealTime = 0;

  game.miningActive = false;
  game.blacksmithingActive = false;
  game.cookingActive = false;
  game.woodcuttingActive = false;
  game.fletchingActive = false; 
  game.craftingActive = false; 
  game.fishingActive = false; 
  game.stoneforgingActive = false;
  game.alchemyActive = false; 
  game.gatheringWaterActive = false;
  game.tailoring = { level: 1, xp: 0, totalXP: 0 };
  game.tailoringActive = false;
  game.thieving = { level: 1, xp: 0, totalXP: 0 };
  game.petmastery = { level: 1, xp: 0, totalXP: 0 };
  game.alchemy = { level: 1, xp: 0, totalXP: 0 };
  game.thieving = { level: 1, xp: 0, totalXP: 0 };
  game.thievingTargets = [];
  game.shopOpen = false;
  game.isAdmin = false;
  
  game.isSessionActive = false;
  game.isDragging = false;
  if (typeof window.stopSessionHeartbeat === 'function') {
      window.stopSessionHeartbeat();
  }
  
  if (game.progressFrame) {
    clearTimeout(game.progressFrame);
    game.progressFrame = null;
  }
  setText('charName', 'Player');
  updateHPUI();
  renderInventoryGrid();
  updateSkillUI();
  updateGoldUI(); 
  renderEquipment(); 
  if (typeof backToActions === 'function') {
    backToActions();
  }
  if (typeof showTab === 'function') {
    showTab('inventory'); 
  }
}

/**
 * Saves the current game.settings to localStorage
 */
function saveSettings() {
  localStorage.setItem('rusticGameSettings', JSON.stringify(game.settings));
}

/**
 * Loads settings from localStorage into game.settings
 */
function loadSettings() {
  const savedJSON = localStorage.getItem('rusticGameSettings');
  if (savedJSON) {
    const saved = JSON.parse(savedJSON);

    // --- NEW: Migration logic ---
    // Check for old properties
    if (typeof saved.volume === 'number') {
      game.settings.sfxVolume = saved.volume;
    }
    if (typeof saved.isMuted === 'boolean') {
      game.settings.isSfxMuted = saved.isMuted;
    }

    // Load new properties if they exist
    if (typeof saved.sfxVolume === 'number') {
      game.settings.sfxVolume = saved.sfxVolume;
    }
    if (typeof saved.isSfxMuted === 'boolean') {
      game.settings.isSfxMuted = saved.isSfxMuted;
    }
    if (typeof saved.musicVolume === 'number') {
      game.settings.musicVolume = saved.musicVolume;
    }
    if (typeof saved.isMusicMuted === 'boolean') {
      game.settings.isMusicMuted = saved.isMusicMuted;
    }
    // --- END Migration ---
  }

  applySettingsUI();

  // --- NEW: Apply music settings to player ---
  // This ensures music volume is correct on load
  if (typeof updateMusicPlayerState === 'function') {
    updateMusicPlayerState();
  }
}

/**
 * Updates the UI elements in the settings modal
 */
function applySettingsUI() {
  const sfxSlider = document.getElementById('sfxVolumeSlider');
  const sfxMute = document.getElementById('sfxMuteBtn');
  const musicSlider = document.getElementById('musicVolumeSlider');
  const musicMute = document.getElementById('musicMuteBtn');

  // --- SFX Controls ---
  if (sfxSlider) {
    sfxSlider.value = game.settings.sfxVolume;
    sfxSlider.disabled = game.settings.isSfxMuted;
  }
  if (sfxMute) {
    sfxMute.textContent = game.settings.isSfxMuted ? 'Unmute' : 'Mute';
    if (game.settings.isSfxMuted) {
      sfxMute.style.background = 'var(--gold)';
      sfxMute.style.color = '#000';
    } else {
      sfxMute.style.background = 'var(--accent)';
      sfxMute.style.color = '#fff';
    }
  }

  // --- Music Controls ---
  if (musicSlider) {
    musicSlider.value = game.settings.musicVolume;
    musicSlider.disabled = game.settings.isMusicMuted;
  }
  if (musicMute) {
    musicMute.textContent = game.settings.isMusicMuted ? 'Unmute' : 'Mute';
    if (game.settings.isMusicMuted) {
      musicMute.style.background = 'var(--gold)';
      musicMute.style.color = '#000';
    } else {
      musicMute.style.background = 'var(--accent)';
      musicMute.style.color = '#fff';
    }
  }
}

/**
 * Opens the settings modal
 */
function openSettings() {
  const modal = document.getElementById('settingsModalOverlay');
  if (modal) {
    applySettingsUI(); // Ensure UI is in sync when opening
    modal.style.display = 'flex';
  }
}

/**
 * Closes the settings modal
 */
function closeSettings() {
  const modal = document.getElementById('settingsModalOverlay');
  if (modal) modal.style.display = 'none';
}

/**
 * The new global sound player that respects settings
 * @param {string} src - The path to the sound file
 */
// +++ NEW: Hub Screen Toggler Function +++
// +++ ADDED hubWell +++
const hubScreenIds = ['hubActions', 'hubMine', 'hubCrystalMine', 'hubBlacksmith', 'hubFletching', 'hubCrafting', 'hubElementalForge', 'hubForest', 'hubKitchen', 'hubCombat', 'hubFarm', 'hubCave', 'hubMadmaxCastle', 'hubShop', 'hubBank', 'hubDynamic', 'hubFishingAreas', 'hubOcean', 'hubRiver', 'hubLottery', 'hubQuests', 'hubQuestLine', 'hubHuntingBoard', 'hubPersonalFarm', 'hubGarden', 'hubBarn', 'hubChickenCoop', 'hubWindmill', 'hubWell', 'hubActiveCombat', 'hubPetYard', 'hubCellar', 'hubNormalForest', 'hubDarkForest', 'hubAlchemy', 'hubThieving', 'hubTailoring', 'hubEnchanting'];
function showMainScreen(screenIdToShow) {
  // NEW: Safely return item from enchanting table if player navigates away
  if (typeof returnEnchantItem === 'function' && game.enchantSlot) {
    returnEnchantItem();
  }

  // Stop all skilling actions
  stopMining();
  stopBlacksmithing();
  stopCookingChicken();
  stopWoodcutting();
  stopFletching(); 
  stopCraftingBowString();
  stopFishing(); 
  stopStoneForging();
  stopGatheringWater();
  stopTailoring();
  game.shopOpen = false;
  hideTooltip();

  // Get the wrapper and clear dynamic content
  const wrapper = document.getElementById('mainContentWrapper');
  const dynamicHub = document.getElementById('hubDynamic');
  
  // --- We removed the 'if' block that was clearing the HTML ---

  // Toggle the screens
  hubScreenIds.forEach(id => {
    const screen = document.getElementById(id);
    if (screen) {
      if (id === screenIdToShow) {
        screen.classList.add('active');
      } else {
        screen.classList.remove('active');
      }
    }
  });

  // Special case: if we're showing the blacksmith hub, render its items
  if (screenIdToShow === 'hubBlacksmith') {
    const lastTab = game.lastSmithingTab || 'copper';
    renderSmithingItems(lastTab);

    // Update all tab buttons to ensure the correct one is highlighted
    const smithTabs = ['smithCopperTab', 'smithIronTab', 'smithSilverTab', 'smithGoldTab'];
    smithTabs.forEach(tabId => {
      const btn = document.getElementById(tabId);
      if (btn) {
        // Extract the metal name from the button ID (e.g., smithSilverTab -> silver)
        const metalName = tabId.replace('smith', '').replace('Tab', '').toLowerCase();
        if (metalName === lastTab) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      }
    });
  }
  
  // +++ NEW: Special case for crafting hub +++
  if (screenIdToShow === 'hubCrafting') {
    renderCraftingItems();
  }

  if (screenIdToShow === 'hubTailoring') {
    renderTailoringItems();
  }

  // +++ NEW: Special case for Garden hub +++
  if (screenIdToShow === 'hubGarden') {
    renderGarden();
  }

  // +++ NEW: Special case for Cellar hub +++
  if (screenIdToShow === 'hubCellar') {
    renderCellar();
  }
  
  // Special case: if we're showing the mine hub, apply level locks
  if (screenIdToShow === 'hubMine') {
    const miningLvl = game.mining.level;
    document.getElementById('ironVeinBtn').classList.toggle('locked-item', miningLvl < IRON_MINE_LVL);
    document.getElementById('coalVeinBtn').classList.toggle('locked-item', miningLvl < COAL_MINE_LVL);
    document.getElementById('silverVeinBtn').classList.toggle('locked-item', miningLvl < SILVER_MINE_LVL);
    document.getElementById('goldVeinBtn').classList.toggle('locked-item', miningLvl < GOLD_MINE_LVL);
  }

  // Special case: if we're showing the crystal mine hub, apply level locks
  if (screenIdToShow === 'hubCrystalMine') {
    const miningLvl = game.mining.level;
    // FIX: Apply visual lock to Earth Crystal too
    document.getElementById('earthCrystalBtn').classList.toggle('locked-item', miningLvl < EARTH_CRYSTAL_LVL);
    document.getElementById('airCrystalBtn').classList.toggle('locked-item', miningLvl < AIR_CRYSTAL_LVL);
    document.getElementById('waterCrystalBtn').classList.toggle('locked-item', miningLvl < WATER_CRYSTAL_LVL);
  }
  
  // Special case: if we're showing the forest hub, apply level locks
  if (screenIdToShow === 'hubForest') {
    const woodcuttingLvl = game.woodcutting.level;
    document.getElementById('oakTreeBtn').classList.toggle('locked-item', woodcuttingLvl < OAK_TREE_LVL);
    // Added locks for new trees
    document.getElementById('birchTreeBtn').classList.toggle('locked-item', woodcuttingLvl < BIRCH_LEVEL);
    document.getElementById('mapleTreeBtn').classList.toggle('locked-item', woodcuttingLvl < MAPLE_LEVEL);
    document.getElementById('mahoganyTreeBtn').classList.toggle('locked-item', woodcuttingLvl < MAHOGANY_LEVEL);
  }

// Special case: if we're showing the kitchen hub, apply level locks
  if (screenIdToShow === 'hubKitchen') {
    const cookLvl = game.cooking.level;
    document.getElementById('cookTroutBtn').classList.toggle('locked-item', cookLvl < COOK_TROUT_LVL);
    document.getElementById('cookSalmonBtn').classList.toggle('locked-item', cookLvl < COOK_SALMON_LVL);
  }

  // +++ NEW: Special case for hubRiver level locks +++
  if (screenIdToShow === 'hubRiver') {
    const fishingLvl = game.fishing.level;
    document.getElementById('fishTroutBtn').classList.toggle('locked-item', fishingLvl < TROUT_FISH_LVL);
    document.getElementById('fishSalmonBtn').classList.toggle('locked-item', fishingLvl < SALMON_FISH_LVL);
  }
  
  // Special case: if we're showing the shop
  if (screenIdToShow === 'hubShop') {
    game.shopOpen = true;
  }
  
  // Special case: if we're showing the bank
  if (screenIdToShow === 'hubBank') {
    renderBankGrid();
    updateBankGoldUI();
  }
}

// Exposed to window so HTML elements can use it inline
window.playGlobalSound = function(src) {
  if (game.settings.isSfxMuted) return; // Use new sfxMuted setting
  try {
    const sound = new Audio(src);
    sound.volume = game.settings.sfxVolume; // Use new sfxVolume setting
    sound.play();
  } catch (e) {
    console.warn("Could not play sound", src, e);
  }
};

/**
 * Renders the Shop grid UI
 */
function renderShopGrid() {
  const grid = document.getElementById('shopGrid');
  if (!grid) return;
  
  grid.innerHTML = '';
  for(let i = 0; i < SHOP_INVENTORY.length; i++) {
    const item = SHOP_INVENTORY[i];
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    
    if(item) {
      // slot.draggable = true; // <-- DISABLED
      // slot.addEventListener('dragstart', (e) => handleShopDragStart(e, item)); // <-- DISABLED
      // slot.addEventListener('dragend', () => { // <-- DISABLED
      //   draggedShopItem = null;
      //   game.isDragging = false; 
      //   const draggingEl = document.querySelector('.inv-slot.dragging');
      //   if (draggingEl) draggingEl.classList.remove('dragging');
      // }); // <-- DISABLED
      
      slot.onclick = () => buyShopItem(item.name, item.price); 

      const img = document.createElement('img');
      let imgName = item.name.toLowerCase().replace(/\s+/g,'_');
      if (item.name === 'Bronze Pickaxe') imgName = 'bronzepickaxe';
      else if (item.name === 'Bronze Axe') imgName = 'bronzeaxe';
      else if (item.name === 'Fishing Pole') imgName = 'fishingpole';
      else if (item.name === 'Fishing Bait') imgName = 'fishingbait';
      else if (item.name === 'Empty Bucket') imgName = 'emptybucket';
      // +++ NEW SEED FIX +++
      else if (item.name === 'Grass Seed') imgName = 'grassseed';
      else if (item.name === 'Corn Seed') imgName = 'cornseed';
      // +++ END NEW +++
      
      img.src = `images/${imgName}.png`;
      img.alt = item.name;
      
      // Apply Enchantment Glows
      const eLvl = item.enchantLevel || 0;
      if (item.name === 'Gold Crown' || item.name === 'Elegant Black Cape') {
          slot.classList.add('legendary-glow');
      } else if (eLvl > 0) {
          slot.classList.add(`enchant-glow-${eLvl}`);
      }

      if (eLvl > 0) {
          const badge = document.createElement('div');
          badge.className = 'enchant-level-badge';
          badge.innerText = `+${eLvl}`;
          slot.appendChild(badge);
      }

      // Shrink diamond images slightly...
      // Shrink diamond images slightly to match higher res gems
      if (item.name === 'Diamond' || item.name === 'Uncut Diamond') {
          img.style.transform = 'scale(0.93)';
      }
      img.onerror = function(){ this.style.opacity='0.08'; };
      slot.appendChild(img);
      
      // Don't show an amount, just the item

      const tooltipContent = `
        <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${item.name}</div>
        <div style="color:#fff;">Price: ${item.price} Gold</div>
        <div style="color:#aaffaa; margin-top: 5px;">Click to buy...</div>
      `; // <-- UPDATED TOOLTIP
      slot.onmouseenter = (evt) => showTooltip(evt, tooltipContent);
      slot.onmouseleave = hideTooltip;
    }
    grid.appendChild(slot);
  }
}

// --- END: Settings Functions ---


// --- MODIFIED: Added isDragging logic ---
document.addEventListener('DOMContentLoaded', ()=>{
  
  // --- NEW: Stats Panel Listeners ---
  const toggleStatsBtn = document.getElementById('toggleStatsBtn');
  const closeStatsBtn = document.getElementById('closeStatsBtn');
  const statsPanel = document.getElementById('statsPanel');
  const statsPanelHeader = document.getElementById('statsPanelHeader');
  
  // --- NEW: Spells Panel Listeners ---
  const toggleSpellsBtn = document.getElementById('toggleSpellsBtn');
  const closeSpellsBtn = document.getElementById('closeSpellsBtn');
  const spellsPanel = document.getElementById('spellsPanel');
  // --- END NEW ---

  if (toggleStatsBtn) {
    toggleStatsBtn.onclick = () => {
      if (statsPanel) {
        if (typeof renderEquipment === 'function') {
            renderEquipment();
        }
        // Simply toggle visibility. Do NOT close the Spells panel.
        statsPanel.style.visibility = (statsPanel.style.visibility === 'visible') ? 'hidden' : 'visible';
      }
    };
  }
  if (closeStatsBtn) {
    closeStatsBtn.onclick = () => {
      if (statsPanel) statsPanel.style.visibility = 'hidden'; 
    };
  }

  // --- NEW: Toggle Spells Button Logic ---
  if (toggleSpellsBtn) {
    toggleSpellsBtn.onclick = () => {
       if (spellsPanel) {
          // Check if currently hidden or visible
          if (spellsPanel.style.visibility !== 'visible') {
              // Opening
              if (typeof renderSpellsPanel === 'function') renderSpellsPanel();
              spellsPanel.style.visibility = 'visible';
          } else {
              // Closing
              spellsPanel.style.visibility = 'hidden';
              // FIX: Clear icons immediately to prevent visual lag
              const container = document.getElementById('spellsIconsContainer');
              if (container) container.innerHTML = ''; 
          }
       }
    }; 
  }
  
  if (closeSpellsBtn) {
    closeSpellsBtn.onclick = () => {
      if (spellsPanel) {
          spellsPanel.style.visibility = 'hidden'; 
          // FIX: Clear icons immediately to prevent visual lag
          const container = document.getElementById('spellsIconsContainer');
          if (container) container.innerHTML = ''; 
      }
    };
  }
  // --- END NEW ---

  // --- NEW: Draggable Panel Logic ---
  let isDraggingPanel = false; // <--- Defined variable
  let panelOffsetX = 0;        // <--- Defined variable
  let panelOffsetY = 0;        // <--- Defined variable

  if (statsPanelHeader) {
    statsPanelHeader.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return; // Only drag with left click
      isDraggingPanel = true;

      // --- THIS IS THE FIX ---
      
      // 1. Get the panel's VISUAL position on screen
      const rect = statsPanel.getBoundingClientRect();
      
      // 2. Calculate the mouse's offset from the panel's top-left corner
      panelOffsetX = e.clientX - rect.left;
      panelOffsetY = e.clientY - rect.top;
      
      // 3. ATOMICALLY (all at once):
      //    a) Clear the transform that was centering it
      //    b) Set the top/left to the exact pixel values it was just at
      statsPanel.style.transform = ''; 
      statsPanel.style.top = rect.top + 'px';
      statsPanel.style.left = rect.left + 'px';
      
      e.preventDefault();
    });
  }

  document.addEventListener('mousemove', (e) => {
    if (!isDraggingPanel) return;
    e.preventDefault(); 

    // The 'isFirstMove' logic is gone.
    // We just update the position based on the new mouse coordinates
    // and the offset we saved on mousedown.
    statsPanel.style.left = (e.clientX - panelOffsetX) + 'px';
    statsPanel.style.top = (e.clientY - panelOffsetY) + 'px';
  });

  document.addEventListener('mouseup', (e) => {
    if (isDraggingPanel) {
        isDraggingPanel = false;
        e.preventDefault();
    }
  });
  // --- END: Stats Panel Listeners & Draggable Logic ---
  
  // +++ ADD THIS ENTIRE BLOCK OF LISTENERS +++
  
  // --- Hub Actions (Main Hub) ---
  document.getElementById('minesActionIcon').onclick = openMineHub;
  document.getElementById('crystalMineActionIcon').onclick = openCrystalMineHub; // +++ NEW +++
  document.getElementById('fishingActionIcon').onclick = openFishingHub; // +++ NEW +++
  document.getElementById('forestActionIcon').onclick = openForestHub;
  document.getElementById('blacksmithActionIcon').onclick = openBlacksmithHub;
  document.getElementById('kitchenActionIcon').onclick = openKitchenHub;
  document.getElementById('combatActionIcon').onclick = openCombatHub;
  document.getElementById('shopActionIcon').onclick = openShop;
  document.getElementById('bankActionIcon').onclick = openBank;
  document.getElementById('fletchingActionIcon').onclick = openFletchingHub; // +++ NEW +++
  document.getElementById('craftingActionIcon').onclick = openCraftingHub; 
  document.getElementById('elementalForgeActionIcon').onclick = openElementalForgeHub; // +++ NEW +++
  document.getElementById('huntingBoardActionIcon').onclick = openHuntingBoard;
  document.getElementById('hubHuntingBoard_ReturnBtn').onclick = backToActions;
  document.getElementById('alchemyActionIcon').onclick = openAlchemyHub; // +++ NEW +++
  document.getElementById('hubAlchemy_ReturnBtn').onclick = backToActions;
  document.getElementById('tailoringActionIcon').onclick = openTailoringHub;
  document.getElementById('hubTailoring_ReturnBtn').onclick = backToActions;
  document.getElementById('thievingActionIcon').onclick = openThievingHub;
  document.getElementById('enchantingActionIcon').onclick = openEnchantingHub;
  document.getElementById('hubThieving_ReturnBtn').onclick = backToActions; // +++ NEW +++
  
  // +++ NEW: Quest Button Listener +++
  const questBtn = document.getElementById('questsActionIcon');
  if (questBtn) {
      questBtn.onclick = openQuestHub;
      questBtn.onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Quests</div>Check available jobs');
      questBtn.onmouseleave = hideTooltip;
  }
  document.getElementById('hubQuests_ReturnBtn').onclick = backToActions;
  document.getElementById('questLine_ReturnBtn').onclick = openQuestHub;
  
  // --- Hub Crafting Listeners ---
  document.getElementById('hubCrafting_ReturnBtn').onclick = backToActions; 
  document.getElementById('hubElementalForge_ReturnBtn').onclick = backToActions; // +++ NEW +++
  
  // --- Hub Mine Listeners ---

// --- Hub Crystal Mine Listeners ---
  document.getElementById('hubCrystalMine_ReturnBtn').onclick = backToActions;
  
  // FIX: Add level check for Earth Crystal click
  document.getElementById('earthCrystalBtn').onclick = () => {
    if (game.mining.level >= EARTH_CRYSTAL_LVL) openEarthCrystalMine();
  };

  document.getElementById('airCrystalBtn').onclick = () => {
    if (game.mining.level >= AIR_CRYSTAL_LVL) openAirCrystalMine();
  };
  document.getElementById('waterCrystalBtn').onclick = () => {
    if (game.mining.level >= WATER_CRYSTAL_LVL) openWaterCrystalMine();
  };

  document.getElementById('copperVeinBtn').onclick = openCopperMine;
  document.getElementById('ironVeinBtn').onclick = () => { if (game.mining.level >= IRON_MINE_LVL) openIronMine(); };
  document.getElementById('coalVeinBtn').onclick = () => { if (game.mining.level >= COAL_MINE_LVL) openCoalMine(); };
  document.getElementById('silverVeinBtn').onclick = () => { if (game.mining.level >= SILVER_MINE_LVL) openSilverMine(); };
  document.getElementById('goldVeinBtn').onclick = () => { if (game.mining.level >= GOLD_MINE_LVL) openGoldMine(); };
  document.getElementById('hubMine_ReturnBtn').onclick = backToActions;
  
  // --- Hub Blacksmith Listeners ---
  const smithTabs = ['smithCopperTab', 'smithIronTab', 'smithSilverTab', 'smithGoldTab'];
  
  document.getElementById('smithCopperTab').onclick = () => {
    smithTabs.forEach(tab => document.getElementById(tab).classList.remove('active'));
    document.getElementById('smithCopperTab').classList.add('active');
    game.lastSmithingTab = 'copper';
    renderSmithingItems('copper');
  };
  document.getElementById('smithIronTab').onclick = () => {
    smithTabs.forEach(tab => document.getElementById(tab).classList.remove('active'));
    document.getElementById('smithIronTab').classList.add('active');
    game.lastSmithingTab = 'iron';
    renderSmithingItems('iron');
  };
  document.getElementById('smithSilverTab').onclick = () => {
    smithTabs.forEach(tab => document.getElementById(tab).classList.remove('active'));
    document.getElementById('smithSilverTab').classList.add('active');
    game.lastSmithingTab = 'silver';
    renderSmithingItems('silver');
  };
  document.getElementById('smithGoldTab').onclick = () => {
    smithTabs.forEach(tab => document.getElementById(tab).classList.remove('active'));
    document.getElementById('smithGoldTab').classList.add('active');
    game.lastSmithingTab = 'gold';
    renderSmithingItems('gold');
  };
  document.getElementById('hubBlacksmith_ReturnBtn').onclick = backToActions;

  // --- Hub Fletching Listeners ---
  document.getElementById('hubFletching_ReturnBtn').onclick = backToActions;

  // --- Hub Forest Listeners ---
  document.getElementById('softwoodTreeBtn').onclick = openSoftwoodTree;
  document.getElementById('oakTreeBtn').onclick = () => {
    if (game.woodcutting.level >= OAK_TREE_LVL) openOakTree();
  };
  document.getElementById('birchTreeBtn').onclick = () => {
    if (game.woodcutting.level >= BIRCH_LEVEL) openBirchTree();
  };
  document.getElementById('mapleTreeBtn').onclick = () => {
    if (game.woodcutting.level >= MAPLE_LEVEL) openMapleTree();
  };
  document.getElementById('mahoganyTreeBtn').onclick = () => {
    if (game.woodcutting.level >= MAHOGANY_LEVEL) openMahoganyTree();
  };
  document.getElementById('hubForest_ReturnBtn').onclick = backToActions;

  // --- Tooltips for Hub Forest ---
  document.getElementById('softwoodTreeBtn').onmouseenter = (e) => {
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Softwood Tree</div><div style="color:#fff;">Requires Woodcutting Lvl: ${SOFTWOOD_TREE_LVL}</div>`);
  };
  document.getElementById('softwoodTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('oakTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < OAK_TREE_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Oak Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${OAK_TREE_LVL}</div>`);
  };
  document.getElementById('oakTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('birchTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < BIRCH_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Birch Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${BIRCH_LEVEL}</div>`);
  };
  document.getElementById('birchTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('mapleTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < MAPLE_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Maple Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${MAPLE_LEVEL}</div>`);
  };
  document.getElementById('mapleTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('mahoganyTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < MAHOGANY_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Mahogany Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${MAHOGANY_LEVEL}</div>`);
  };
  document.getElementById('mahoganyTreeBtn').onmouseleave = hideTooltip;

  // --- Hub Kitchen Listeners ---
  document.getElementById('cookChickenBtn').onclick = openCookChicken;
  document.getElementById('cookBeefBtn').onclick = openCookBeef;
  document.getElementById('cookHerringBtn').onclick = openCookHerring;
  document.getElementById('cookTroutBtn').onclick = () => {
    if (game.cooking.level >= COOK_TROUT_LVL) openCookTrout();
  };
  document.getElementById('cookSalmonBtn').onclick = () => {
    if (game.cooking.level >= COOK_SALMON_LVL) openCookSalmon();
  };
  document.getElementById('hubKitchen_ReturnBtn').onclick = backToActions;

  // --- Hub Combat Listeners ---
  document.getElementById('farmAreaBtn').onclick = openFarmCombatArea;
  document.getElementById('caveAreaBtn').onclick = openCaveCombatArea; // +++ NEW +++
  document.getElementById('hubCombat_ReturnBtn').onclick = backToActions;
  
  // --- Hub Fishing Listeners ---
  document.getElementById('oceanAreaBtn').onclick = openOceanFishingArea;
  document.getElementById('riverAreaBtn').onclick = openRiverFishingArea;
  document.getElementById('hubFishingAreas_ReturnBtn').onclick = backToActions;
  
  // --- Hub Ocean/River Return Listeners ---
  document.getElementById('hubOcean_ReturnBtn').onclick = openFishingHub;
  document.getElementById('hubRiver_ReturnBtn').onclick = openFishingHub;
  
  // --- Hub Farm/Cave Return Listeners ---
  document.getElementById('hubFarm_ReturnBtn').onclick = openCombatHub; // +++ NEW +++
  document.getElementById('hubCave_ReturnBtn').onclick = openCombatHub; // +++ NEW +++
  
  // --- Hub Madmax Listeners ---
  document.getElementById('madmaxCastleBtn').onclick = openMadmaxCastle;
  document.getElementById('hubMadmaxCastle_ReturnBtn').onclick = openCombatHub;

  // --- Hub Forest Listeners ---
  document.getElementById('normalForestAreaBtn').onclick = () => {
    game.lastCombatAreaHub = 'hubNormalForest'; 
    showMainScreen('hubNormalForest');
  };
  document.getElementById('hubNormalForest_ReturnBtn').onclick = openCombatHub;

  // --- Hub Dark Forest Listeners ---
  document.getElementById('darkForestAreaBtn').onclick = () => {
    game.lastCombatAreaHub = 'hubDarkForest'; 
    showMainScreen('hubDarkForest');
  };
  document.getElementById('hubDarkForest_ReturnBtn').onclick = openCombatHub;

  // --- Hub Fishing Level Locks (in Listeners) ---
  document.getElementById('fishTroutBtn').onclick = () => {
    if (game.fishing.level >= TROUT_FISH_LVL) openFishTrout();
  };
  document.getElementById('fishSalmonBtn').onclick = () => {
    if (game.fishing.level >= SALMON_FISH_LVL) openFishSalmon();
  };
  // CSS class is now applied by showMainScreen('hubRiver')

  // --- Hub Shop Listeners ---
  document.getElementById('hubShop_ReturnBtn').onclick = backToActions;
  
  // --- Hub Bank Listeners ---
  document.getElementById('bankDepositGoldBtn').onclick = depositGold;
  document.getElementById('bankWithdrawGoldBtn').onclick = withdrawGold;
  
  // +++ NEW GOLD LISTENERS +++
  document.getElementById('bankDepositAllGoldBtn').onclick = depositAllGold;
  document.getElementById('bankWithdrawAllGoldBtn').onclick = withdrawAllGold;
  // +++ END NEW +++

  document.getElementById('hubBank_ReturnBtn').onclick = backToActions;

  // --- Tooltips for Hub Icons ---
  document.getElementById('minesActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Mine</div>');
  document.getElementById('minesActionIcon').onmouseleave = hideTooltip;
  document.getElementById('forestActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Forest</div>');
  document.getElementById('crystalMineActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Crystal Mine</div>');
  document.getElementById('crystalMineActionIcon').onmouseleave = hideTooltip;
  document.getElementById('forestActionIcon').onmouseleave = hideTooltip;
  document.getElementById('blacksmithActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Blacksmith</div>');
  document.getElementById('blacksmithActionIcon').onmouseleave = hideTooltip;
  document.getElementById('kitchenActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Kitchen</div>');
  document.getElementById('kitchenActionIcon').onmouseleave = hideTooltip;
  document.getElementById('combatActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Combat Areas</div>');
  document.getElementById('combatActionIcon').onmouseleave = hideTooltip;
  document.getElementById('shopActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Shop</div>');
  document.getElementById('shopActionIcon').onmouseleave = hideTooltip;
  document.getElementById('bankActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Bank</div>');
  document.getElementById('bankActionIcon').onmouseleave = hideTooltip;
  document.getElementById('fletchingActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Fletching Bench</div>'); // +++ NEW +++
  document.getElementById('fletchingActionIcon').onmouseleave = hideTooltip; // +++ NEW +++
  document.getElementById('craftingActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Crafting Bench</div>');
  document.getElementById('craftingActionIcon').onmouseleave = hideTooltip;
  document.getElementById('elementalForgeActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Elemental Forge</div>'); 
  document.getElementById('elementalForgeActionIcon').onmouseleave = hideTooltip;
  document.getElementById('fishingActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Fishing Areas</div>');
  document.getElementById('fishingActionIcon').onmouseleave = hideTooltip;
  // +++ NEW BOUNTY TOOLTIP +++
  document.getElementById('huntingBoardActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Hunting Board</div>Take on bounties');
  document.getElementById('huntingBoardActionIcon').onmouseleave = hideTooltip;
  
  // +++ NEW ALCHEMY TOOLTIP +++
  document.getElementById('alchemyActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Alchemy Table</div>Brew powerful potions');
  document.getElementById('alchemyActionIcon').onmouseleave = hideTooltip;
  document.getElementById('tailoringActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Tailoring Table</div>Craft leather and cloth gear');
  document.getElementById('tailoringActionIcon').onmouseleave = hideTooltip;

  // +++ NEW PERSONAL FARM LISTENERS +++
  document.getElementById('personalFarmActionIcon').onclick = openPersonalFarmHub;
  document.getElementById('hubPersonalFarm_ReturnBtn').onclick = backToActions;
  document.getElementById('personalFarmActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Farm</div>Manage crops & livestock');
  document.getElementById('personalFarmActionIcon').onmouseleave = hideTooltip;

  // +++ NEW PET YARD LISTENERS +++
  document.getElementById('petYardActionIcon').onclick = openPetYardHub;
  document.getElementById('hubPetYard_ReturnBtn').onclick = backToActions;
  document.getElementById('petYardActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Pet Yard</div>Manage your pets');
  document.getElementById('petYardActionIcon').onmouseleave = hideTooltip;
  
  // Listeners for inside the Farm buildings (Return to the Farm view)
  document.getElementById('hubBarn_ReturnBtn').onclick = openPersonalFarmHub;
  document.getElementById('hubChickenCoop_ReturnBtn').onclick = openPersonalFarmHub;
  document.getElementById('hubWindmill_ReturnBtn').onclick = openPersonalFarmHub;
  document.getElementById('hubWell_ReturnBtn').onclick = openPersonalFarmHub;

  // +++ NEW: Garden Navigation +++
  document.getElementById('goToGardenBtn').onclick = handleGardenClick;
  const backToFarmBtn = document.getElementById('backToFarmFromGardenBtn');
  if (backToFarmBtn) {
      backToFarmBtn.onclick = openPersonalFarmHub;
      backToFarmBtn.style.transform = "rotate(180deg)"; // Flip the arrow to point left
  }
  document.getElementById('hubGarden_ReturnBtn').onclick = backToActions;

  // --- Hub Lottery Listeners ---
  document.getElementById('lotteryActionIcon').onclick = openLotteryHub;
  document.getElementById('buyTicketBtn').onclick = buyLotteryTicket;
  document.getElementById('hubLottery_ReturnBtn').onclick = backToActions;
  document.getElementById('lotteryActionIcon').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold);">Lottery</div>Win Rare Prizes!');
  document.getElementById('lotteryActionIcon').onmouseleave = hideTooltip;
  if (!hubScreenIds.includes('hubLottery')) hubScreenIds.push('hubLottery');
  
// --- Tooltips for Hub Crystal Mine ---
  document.getElementById('earthCrystalBtn').onmouseenter = (e) => {
      const isLowLvl = game.mining.level < EARTH_CRYSTAL_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Earth Crystal</div><div style="color:${textColor};">Requires Mining Lvl: ${EARTH_CRYSTAL_LVL}</div>Tool: Iron Pickaxe`);
  };
  document.getElementById('earthCrystalBtn').onmouseleave = hideTooltip;
  
  document.getElementById('airCrystalBtn').onmouseenter = (e) => {
      const isLowLvl = game.mining.level < AIR_CRYSTAL_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Air Crystal</div><div style="color:${textColor};">Requires Mining Lvl: ${AIR_CRYSTAL_LVL}</div>Tool: Iron Pickaxe`);
  };
  document.getElementById('airCrystalBtn').onmouseleave = hideTooltip;
  
  document.getElementById('waterCrystalBtn').onmouseenter = (e) => {
      const isLowLvl = game.mining.level < WATER_CRYSTAL_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Water Crystal</div><div style="color:${textColor};">Requires Mining Lvl: ${WATER_CRYSTAL_LVL}</div>Tool: Iron Pickaxe`);
  };
  document.getElementById('waterCrystalBtn').onmouseleave = hideTooltip;

  // --- Tooltips for Hub Mine ---
  
  // Sand
  document.getElementById('sandVeinBtn').onclick = openSandMine;
  document.getElementById('sandVeinBtn').onmouseenter = (e) => {
      showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Sand</div><div style="color:#fff;">Requires Mining Lvl: 1</div>Tool: Bronze Pickaxe');
  };
  document.getElementById('sandVeinBtn').onmouseleave = hideTooltip;

  // Copper
  document.getElementById('copperVeinBtn').onmouseenter = (e) => {
      showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Copper Vein</div><div style="color:#fff;">Requires Mining Lvl: 1</div>Tool: Bronze Pickaxe');
  };
  document.getElementById('copperVeinBtn').onmouseleave = hideTooltip;

  // Iron
  document.getElementById('ironVeinBtn').onmouseenter = (e) => {
    const isLowLvl = game.mining.level < IRON_MINE_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Iron Vein</div><div style="color:${textColor};">Requires Mining Lvl: ${IRON_MINE_LVL}</div>Tool: Copper Pickaxe`;
    showTooltip(e, tt);
  };
  document.getElementById('ironVeinBtn').onmouseleave = hideTooltip;
  
  // Coal
  document.getElementById('coalVeinBtn').onmouseenter = (e) => {
    const isLowLvl = game.mining.level < COAL_MINE_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Coal Vein</div><div style="color:${textColor};">Requires Mining Lvl: ${COAL_MINE_LVL}</div>Tool: Copper Pickaxe`;
    showTooltip(e, tt);
  };
  document.getElementById('coalVeinBtn').onmouseleave = hideTooltip;

  // Silver
  document.getElementById('silverVeinBtn').onmouseenter = (e) => {
    const isLowLvl = game.mining.level < SILVER_MINE_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Silver Vein</div><div style="color:${textColor};">Requires Mining Lvl: ${SILVER_MINE_LVL}</div>Tool: Iron Pickaxe`;
    showTooltip(e, tt);
  };
  document.getElementById('silverVeinBtn').onmouseleave = hideTooltip;

  // Gold
  document.getElementById('goldVeinBtn').onmouseenter = (e) => {
    const isLowLvl = game.mining.level < GOLD_MINE_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Gold Vein</div><div style="color:${textColor};">Requires Mining Lvl: ${GOLD_MINE_LVL}</div>Tool: Iron Pickaxe`;
    showTooltip(e, tt);
  };
  document.getElementById('goldVeinBtn').onmouseleave = hideTooltip;
  
  // --- Tooltips for Hub Forest ---
  document.getElementById('softwoodTreeBtn').onmouseenter = (e) => {
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Softwood Tree</div><div style="color:#fff;">Requires Woodcutting Lvl: ${SOFTWOOD_TREE_LVL}</div>`);
  };
  document.getElementById('softwoodTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('oakTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < OAK_TREE_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Oak Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${OAK_TREE_LVL}</div>`);
  };
  document.getElementById('oakTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('birchTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < BIRCH_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Birch Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${BIRCH_LEVEL}</div>`);
  };
  document.getElementById('birchTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('mapleTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < MAPLE_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Maple Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${MAPLE_LEVEL}</div>`);
  };
  document.getElementById('mapleTreeBtn').onmouseleave = hideTooltip;

  document.getElementById('mahoganyTreeBtn').onmouseenter = (e) => {
      const isLowLvl = game.woodcutting.level < MAHOGANY_LEVEL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Mahogany Tree</div><div style="color:${textColor};">Requires Woodcutting Lvl: ${MAHOGANY_LEVEL}</div>`);
  };
  document.getElementById('mahoganyTreeBtn').onmouseleave = hideTooltip;

  // --- Tooltips for Hub Kitchen ---
  
  // Chicken (Level 1)
  document.getElementById('cookChickenBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Cooked Chicken</div>Requires: 1 Raw Chicken<br><div style="color:#fff;">Requires Cooking Lvl: 1</div>');
  document.getElementById('cookChickenBtn').onmouseleave = hideTooltip;

  // Beef (Level 1 - Updated to include requirement text)
  document.getElementById('cookBeefBtn').onmouseenter = (e) => {
      const isLowLvl = game.cooking.level < COOK_BEEF_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Cooked Beef</div>Requires: 1 Beef<br><div style="color:${textColor};">Requires Cooking Lvl: ${COOK_BEEF_LVL}</div>`);
  };
  document.getElementById('cookBeefBtn').onmouseleave = hideTooltip;
  
  // Herring (Updated text)
  document.getElementById('cookHerringBtn').onmouseenter = (e) => {
      const isLowLvl = game.cooking.level < COOK_HERRING_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Cooked Herring</div>Requires: 1 Herring<br><div style="color:${textColor};">Requires Cooking Lvl: ${COOK_HERRING_LVL}</div>`);
  };
  document.getElementById('cookHerringBtn').onmouseleave = hideTooltip;
  
  // Trout Tooltip
  document.getElementById('cookTroutBtn').onmouseenter = (e) => {
    const isLowLvl = game.cooking.level < COOK_TROUT_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Cooked Trout</div>Requires: 1 Trout<br><div style="color:${textColor};">Requires Cooking Lvl: ${COOK_TROUT_LVL}</div>`;
    showTooltip(e, tt);
  };
  document.getElementById('cookTroutBtn').onmouseleave = hideTooltip;
  
  // Salmon Tooltip
  document.getElementById('cookSalmonBtn').onmouseenter = (e) => {
    const isLowLvl = game.cooking.level < COOK_SALMON_LVL;
    const textColor = isLowLvl ? '#ff8888' : '#fff';
    const tt = `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Cooked Salmon</div>Requires: 1 Salmon<br><div style="color:${textColor};">Requires Cooking Lvl: ${COOK_SALMON_LVL}</div>`;
    showTooltip(e, tt);
  };
  document.getElementById('cookSalmonBtn').onmouseleave = hideTooltip;


  // --- Tooltips for Hub Combat ---
  document.getElementById('farmAreaBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">The Farm</div>');
  document.getElementById('farmAreaBtn').onmouseleave = hideTooltip;
  document.getElementById('caveAreaBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">The Cave</div>'); 
  document.getElementById('caveAreaBtn').onmouseleave = hideTooltip; 

  document.getElementById('normalForestAreaBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">The Forest</div>');
  document.getElementById('normalForestAreaBtn').onmouseleave = hideTooltip;

  document.getElementById('madmaxCastleBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:red; margin-bottom: 4px;">Madmax Castle</div>'); 
  document.getElementById('madmaxCastleBtn').onmouseleave = hideTooltip; 
  
  // --- Tooltips for Hub Fishing ---
  document.getElementById('oceanAreaBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">The Ocean</div>');
  document.getElementById('oceanAreaBtn').onmouseleave = hideTooltip;
  document.getElementById('riverAreaBtn').onmouseenter = (e) => showTooltip(e, '<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">The River</div>');
  document.getElementById('riverAreaBtn').onmouseleave = hideTooltip;
  
  // --- Tooltips for Fishing Spots ---
  document.getElementById('fishHerringBtn').onmouseenter = (e) => {
      const isLowLvl = game.fishing.level < HERRING_FISH_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Fish Herring</div><div style="color:${textColor};">Requires Fishing Lvl: ${HERRING_FISH_LVL}</div>`);
  };
  document.getElementById('fishHerringBtn').onmouseleave = hideTooltip;

  document.getElementById('fishTroutBtn').onmouseenter = (e) => {
      const isLowLvl = game.fishing.level < TROUT_FISH_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Fish Trout</div><div style="color:${textColor};">Requires Fishing Lvl: ${TROUT_FISH_LVL}</div>`);
  };
  document.getElementById('fishTroutBtn').onmouseleave = hideTooltip;

  document.getElementById('fishSalmonBtn').onmouseenter = (e) => {
      const isLowLvl = game.fishing.level < SALMON_FISH_LVL;
      const textColor = isLowLvl ? '#ff8888' : '#fff';
      showTooltip(e, `<div style="font-weight:bold; color:var(--gold); margin-bottom: 4px;">Fish Salmon</div><div style="color:${textColor};">Requires Fishing Lvl: ${SALMON_FISH_LVL}</div>`);
  };
  document.getElementById('fishSalmonBtn').onmouseleave = hideTooltip;

  // +++ END NEW LISTENER BLOCK +++
  
  
  // preloadAllGameAssets(); // <-- This line should already be here
  showTab('inventory'); 
  window.resetGameState = resetGameState;
  showTab('inventory'); 
  window.resetGameState = resetGameState;
  document.addEventListener('mousemove', moveTooltip);
  
  // --- NEW: Prevent Right-Click Menu ---
  // This listens for the 'contextmenu' event (right-click) on the entire page
  // and stops the browser from showing its default menu.
  document.addEventListener('contextmenu', (e) => {
    e.preventDefault(); 
  });
  // --- END NEW ---
  
  const inventoryGrid = document.getElementById('inventoryGrid');
  const inventoryGridWrap = document.getElementById('inventoryGridWrap');
  const bankGridWrap = document.getElementById('bankGridWrap'); // <-- ADD THIS
  let draggedItemIndex = null;
  let currentDragOverSlot = null;
  let draggedShopItem = null; // <-- ADD THIS
  
// --- NEW SMOOTH SCROLL LOGIC (INVENTORY) ---
// inventoryScrollInterval is now global
const SCROLL_SPEED_INV = 5; // Pixels per 16ms (Constant speed)
const SCROLL_ZONE_INV = 50; // 50px from top/bottom

if (inventoryGridWrap) {
  inventoryGridWrap.addEventListener('dragover', (e) => {
    if (!game.isDragging) return;
    e.preventDefault(); 
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';

    const rect = inventoryGridWrap.getBoundingClientRect();
    const clientY = e.clientY;

    const inTopZone = clientY < rect.top + SCROLL_ZONE_INV;
    const inBottomZone = clientY > rect.bottom - SCROLL_ZONE_INV;

    if (inTopZone || inBottomZone) {
      // Start the timer if not already running
      if (!inventoryScrollInterval) {
        inventoryScrollInterval = setInterval(() => {
          if (inTopZone) {
            inventoryGridWrap.scrollTop -= SCROLL_SPEED_INV;
          } else {
            inventoryGridWrap.scrollTop += SCROLL_SPEED_INV;
          }
        }, 16); // Runs ~60 times a second
      }
    } else {
      // Mouse is in the middle (safe zone), stop scrolling
      clearInterval(inventoryScrollInterval);
      inventoryScrollInterval = null;
    }
  });

  // Stop scrolling if mouse leaves the scroll container completely
  inventoryGridWrap.addEventListener('dragleave', (e) => {
    const rect = inventoryGridWrap.getBoundingClientRect();
    // Only clear if we actually left the bounds, not just entered a child slot
    if (e.clientY < rect.top || e.clientY > rect.bottom || e.clientX < rect.left || e.clientX > rect.right) {
        clearInterval(inventoryScrollInterval);
        inventoryScrollInterval = null;
    }
  });
}

// --- NEW SMOOTH SCROLL LOGIC (BANK) ---
// bankScrollInterval is now global
const SCROLL_SPEED_BANK = 5; 
const SCROLL_ZONE_BANK = 50;

if (bankGridWrap) {
  bankGridWrap.addEventListener('dragover', (e) => {
    if (!game.isDragging) return;
    e.preventDefault(); 
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';

    const rect = bankGridWrap.getBoundingClientRect();
    const clientY = e.clientY;

    const inTopZone = clientY < rect.top + SCROLL_ZONE_BANK;
    const inBottomZone = clientY > rect.bottom - SCROLL_ZONE_BANK;

    if (inTopZone || inBottomZone) {
      if (!bankScrollInterval) {
        bankScrollInterval = setInterval(() => {
          if (inTopZone) {
            bankGridWrap.scrollTop -= SCROLL_SPEED_BANK;
          } else {
            bankGridWrap.scrollTop += SCROLL_SPEED_BANK;
          }
        }, 16);
      }
    } else {
      clearInterval(bankScrollInterval);
      bankScrollInterval = null;
    }
  });

  bankGridWrap.addEventListener('dragleave', (e) => {
    const rect = bankGridWrap.getBoundingClientRect();
    if (e.clientY < rect.top || e.clientY > rect.bottom || e.clientX < rect.left || e.clientX > rect.right) {
        clearInterval(bankScrollInterval);
        bankScrollInterval = null;
    }
  });
}

  inventoryGrid.addEventListener('dragstart', (e) => {
    hideTooltip(); // <--- ADDED THIS LINE
    if (e.target && e.target.classList.contains('inv-slot') && e.target.draggable) {
      draggedItemIndex = parseInt(e.target.dataset.slotIndex);
      e.dataTransfer.effectAllowed = 'move';
      
      // +++ NEW: Link to bank drag system +++
      const item = game.inventory[draggedItemIndex];
      if (item) {
        // Use the script-global draggedBankItem
        draggedBankItem = { item: { ...item }, fromIndex: draggedItemIndex };
      }
      // +++ END NEW +++

      // +++ NEW: Set dragging flag +++
      game.isDragging = true;
      
      setTimeout(() => {
        e.target.classList.add('dragging');
      }, 0);
    }
  });


  // +++ FIX: AGGRESSIVE Global listeners to prevent forbidden cursor +++
  // We use capture: true to intercept the event immediately.
  // We handle dragenter AND dragover to stop flickering at boundaries.
  const forceAllowDrag = (e) => {
    e.preventDefault(); // Mandatory to allow dropping
    if (e.dataTransfer) {
        e.dataTransfer.dropEffect = 'move'; // Force visual cursor
    }
  };

  document.addEventListener('dragover', forceAllowDrag, true);
  document.addEventListener('dragenter', forceAllowDrag, true);

  inventoryGrid.addEventListener('dragover', (e) => {
    e.preventDefault();
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'move'; // Force it specifically here too
    
    const targetSlot = e.target.closest('.inv-slot');
    if (targetSlot) {
      if (currentDragOverSlot && currentDragOverSlot !== targetSlot) {
        currentDragOverSlot.classList.remove('drag-over');
      }
      targetSlot.classList.add('drag-over');
      currentDragOverSlot = targetSlot;
    }
  });
  
  inventoryGrid.addEventListener('dragleave', (e) => {
    const targetSlot = e.target.closest('.inv-slot');
    if (targetSlot) {
      targetSlot.classList.remove('drag-over');
      if (currentDragOverSlot === targetSlot) {
        currentDragOverSlot = null;
      }
    }
  });

inventoryGrid.addEventListener('dragend', (e) => {
    // 1. Clean up the '.dragging' class
    const draggingEl = document.querySelector('#inventoryGrid .inv-slot.dragging');
    if (draggingEl) {
      draggingEl.classList.remove('dragging');
    }
    
    // 2. Clean up any lingering 'drag-over' styles
    if (currentDragOverSlot) {
      currentDragOverSlot.classList.remove('drag-over');
      currentDragOverSlot = null;
    }
    
    // 3. Reset all global drag state variables
    draggedItemIndex = null;
    draggedBankItem = null;
    draggedShopItem = null;
    game.isDragging = false;

    // 4. --- NEW: Stop any active scrolling ---
    if (inventoryScrollInterval) {
        clearInterval(inventoryScrollInterval);
        inventoryScrollInterval = null;
    }
    if (bankScrollInterval) {
        clearInterval(bankScrollInterval);
        bankScrollInterval = null;
    }
  });

  inventoryGrid.addEventListener('drop', async (e) => {
    e.preventDefault();
    game.isDragging = false; // FIX: Immediately unlock tooltips on drop

    // +++ FIX: Stop auto-scrolling immediately when item is dropped +++
    if (inventoryScrollInterval) {
        clearInterval(inventoryScrollInterval);
        inventoryScrollInterval = null;
    }
    if (bankScrollInterval) {
        clearInterval(bankScrollInterval);
        bankScrollInterval = null;
    }
    // +++ END FIX +++

    const dropSlot = e.target.closest('.inv-slot');
    
    // Cleanup first
    if (currentDragOverSlot) {
      currentDragOverSlot.classList.remove('drag-over');
      currentDragOverSlot = null;
    }
    const draggingEl = document.querySelector('.inv-slot.dragging');
    if (draggingEl) {
      draggingEl.classList.remove('dragging');
    }

    if (!dropSlot) {
      draggedItemIndex = null;
      draggedBankItem = null;
      draggedShopItem = null;
      game.isDragging = false;
      return;
    }
    
    const dropIndex = parseInt(dropSlot.dataset.slotIndex);

    if (draggedShopItem) {
      await buyShopItem(draggedShopItem.name, draggedShopItem.price);
    } else if (draggedBankItem && draggedBankItem.source === 'bank') {
      // Check for Ctrl (Windows) or Cmd (Mac) to skip prompt
      const skipPrompt = e.ctrlKey || e.metaKey;
      await dragWithdrawItem(draggedBankItem.fromIndex, dropIndex, skipPrompt);
    } else if (draggedItemIndex !== null) {
      const fromIndex = draggedItemIndex;
      const toIndex = dropIndex;
      
      if (fromIndex !== toIndex) { 
        const dragItemBeforePrompt = game.inventory[fromIndex];
        const dropItem = game.inventory[toIndex];

        if (e.shiftKey && dragItemBeforePrompt) { 
          if (dropItem && (dropItem.name !== dragItemBeforePrompt.name || (dropItem.enchantLevel || 0) !== (dragItemBeforePrompt.enchantLevel || 0))) {
            await showGameAlert("Invalid Slot", "You can only move onto an empty slot or a stack of the same item.");
          } else {
            const input = await showGamePrompt(
              `Move ${dragItemBeforePrompt.name}`, 
              `How many to move? (You have: ${dragItemBeforePrompt.qty})`,
              ""
            );
            
            if (input === null) { 
              const originalSlotEl = document.querySelector(`#inventoryGrid .inv-slot[data-slot-index="${fromIndex}"]`);
              if (originalSlotEl) originalSlotEl.classList.remove('dragging');
            } else {
              const itemAfterPrompt = game.inventory[fromIndex];
              if (!itemAfterPrompt || itemAfterPrompt.name !== dragItemBeforePrompt.name) {
                draggedItemIndex = null;
                draggedBankItem = null;
                game.isDragging = false;
                return;
              }
            
              const splitAmount = parseInt(input);
              if (isNaN(splitAmount) || splitAmount <= 0) { /* Invalid */ }
              else if (splitAmount > itemAfterPrompt.qty) { 
                await showGameAlert("Invalid Amount", "You don't have that many.");
              } 
              else if (splitAmount === itemAfterPrompt.qty) { 
                if (itemAfterPrompt && dropItem && itemAfterPrompt.name === dropItem.name && (itemAfterPrompt.enchantLevel || 0) === (dropItem.enchantLevel || 0)) {
                    dropItem.qty += itemAfterPrompt.qty;
                    game.inventory[fromIndex] = null;
                } else {
                    game.inventory[fromIndex] = dropItem;
                    game.inventory[toIndex] = itemAfterPrompt;
                }
                renderInventoryGrid();
                if (typeof window.savePlayerData === 'function') savePlayerData();
              }
              else {
                if (dropItem) { 
                  dropItem.qty += splitAmount;
                } else { 
                  game.inventory[toIndex] = { ...itemAfterPrompt, qty: splitAmount };
                }
                itemAfterPrompt.qty -= splitAmount;
                renderInventoryGrid();
                if (typeof window.savePlayerData === 'function') savePlayerData();
              }
            }
          }
        } else {
          const dragItem = game.inventory[fromIndex]; 
          if (dragItem && dropItem && dragItem.name === dropItem.name && (dragItem.enchantLevel || 0) === (dropItem.enchantLevel || 0)) {
              dropItem.qty += dragItem.qty;
              game.inventory[fromIndex] = null;
          } else {
              game.inventory[fromIndex] = dropItem;
              game.inventory[toIndex] = dragItem;
          }
          renderInventoryGrid();
          if (typeof window.savePlayerData === 'function') savePlayerData();
        }
      }
    }
    
    draggedItemIndex = null;
    draggedBankItem = null;
    draggedShopItem = null;
    game.isDragging = false; // Final safety unlock
  });
  
  // --- NEW: Settings Modal Listeners ---
  const settingsBtn = document.getElementById('settingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');

  // --- SFX ---
  const sfxVolumeSlider = document.getElementById('sfxVolumeSlider');
  const sfxMuteBtn = document.getElementById('sfxMuteBtn');

  // --- Music ---
  const musicVolumeSlider = document.getElementById('musicVolumeSlider');
  const musicMuteBtn = document.getElementById('musicMuteBtn');

  if (settingsBtn) settingsBtn.onclick = openSettings;
  if (closeSettingsBtn) closeSettingsBtn.onclick = closeSettings;

  // --- SFX Slider Listener ---
  if (sfxVolumeSlider) {
    sfxVolumeSlider.addEventListener('input', (e) => {
      const newVolume = parseFloat(e.target.value);
      game.settings.sfxVolume = newVolume;
      // If they change volume, assume they want to unmute
      if (game.settings.isSfxMuted) {
        game.settings.isSfxMuted = false;
        applySettingsUI();
      }
      saveSettings(); // Save on change
    });
  }

  // --- SFX Mute Listener ---
  if (sfxMuteBtn) {
    sfxMuteBtn.onclick = () => {
      game.settings.isSfxMuted = !game.settings.isSfxMuted;
      applySettingsUI(); // Update button text/slider state
      saveSettings(); // Save the new mute state
    };
  }

  // --- Music Slider Listener ---
  if (musicVolumeSlider) {
    musicVolumeSlider.addEventListener('input', (e) => {
      const newVolume = parseFloat(e.target.value);
      game.settings.musicVolume = newVolume;
      // If they change volume, assume they want to unmute
      if (game.settings.isMusicMuted) {
        game.settings.isMusicMuted = false;
        applySettingsUI();
      }
      updateMusicPlayerState(); // Update live music volume
      saveSettings(); // Save on change
    });
  }

  // --- Music Mute Listener ---
  if (musicMuteBtn) {
    musicMuteBtn.onclick = () => {
      game.settings.isMusicMuted = !game.settings.isMusicMuted;
      applySettingsUI(); // Update button text/slider state
      updateMusicPlayerState(); // Update live music volume/mute

      // --- This is a bonus fix for autoplay ---
      // If music isn't playing yet, this click will start it.
      if (!game.settings.isMusicMuted && musicPlayer.paused) {
          musicPlayer.play().then(() => {
            audioAutoplayBlocked = false; 
          }).catch(e => console.warn("Could not start music."));
      }
      // --- End bonus fix ---

      saveSettings(); // Save the new mute state
    };
  }

 // --- NEW: Global Button Click Sound ---
  document.body.addEventListener('click', (e) => {
    // This selector now captures:
    // 1. 'button' -> Standard buttons (Fight, Run, Return, etc.)
    // 2. '[id$="ActionIcon"]' -> Top Menu Icons
    // 3. '.quest-line-card' -> The Quest rectangles
    // 4. 'div[id$="Btn"]' -> Fish area buttons (they are divs, not real buttons)
    // 5. 'div[onclick^="openCombatInterface"]' -> Monster images (Chicken/Cow/Spider)
    const target = e.target.closest('button, [id$="ActionIcon"], .quest-line-card, div[id$="Btn"], div[onclick^="openCombatInterface"]');
    
    if (target) {
       // If it is a real HTML button, don't play sound if it's disabled
       if (target.tagName === 'BUTTON' && target.disabled) return;
       
       playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');
    }
  });
  
});

window.showSaveIndicator = function() {
    const timerEl = document.getElementById('saveTimerText');
    if (timerEl) {
        timerEl.style.visibility = 'visible';
        // Hide the message after 2 seconds
        setTimeout(() => {
            timerEl.style.visibility = 'hidden';
        }, 2000);
    }
}

// =================================================================
// --- NEW: PLAYER INSPECT FUNCTIONS (Accessible globally) ---
// =================================================================

/**
 * Helper to render the *inspected* player's equipment using dummy slots.
 * @param {object} equipment - The equipment object from the inspected player's save data.
 * @param {HTMLElement} frame - The DOM element to render into.
 */
/**
 * Helper to render the *inspected* player's equipment using dummy slots.
 * @param {object} equipment - The equipment object from the inspected player's save data.
 * @param {HTMLElement} frame - The DOM element to render into.
 */
/**
 * Helper to render the *inspected* player's equipment using dummy slots.
 */
function renderInspectEquipment(equipment, frame) {
    frame.innerHTML = '';
    const slots = [
        'necklace', 'helmet', 'cape', 
        'weapon', 'chest', 'shield', 
        'ring1', 'legs', 'ring2', 
        'arrows', 'boots', 'pet'
    ];

    const getStats = (name) => (window.ITEM_STATS && window.ITEM_STATS[name]) ? window.ITEM_STATS[name] : null;

    const itemImageMap = {
        'Copper Helmet': 'copperhelmet', 'Copper Chestplate': 'copperchestplate', 'Copper Shortsword': 'coppershortsword', 'Copper Boots': 'copperboots', 
        'Iron Helmet': 'ironhelmet', 'Iron Chestplate': 'ironchestplate', 'Iron Shortsword': 'ironshortsword', 'Iron Boots': 'ironboots', 
        'Copper Platelegs': 'copperplatelegs', 'Iron Platelegs': 'ironplatelegs', 
        'Silver Pickaxe': 'silverpickaxe', 'Silver Axe': 'silveraxe',
        'Softwood Bow': 'softwoodbow', 'Oak Bow': 'oakbow', 
        'Copper Arrow': 'copperarrow', 'Leather Hood': 'leatherhood', 'Leather Body': 'leatherarmor', 'Leather Chaps': 'leatherpants', 
        'Leather Boots': 'leatherboots', 'Wizard Hat': 'wizardhat', 'Wizard Robe': 'wizardrobe', 'Wizard Trousers': 'wizardtrousers', 
        'Wizard Boots': 'wizardboots', 'Magic Staff': 'magicstaff', 'Gold Crown': 'goldcrown', 'Elegant Black Cape': 'elegantblackcape', '1tapper': '1tapper', 'Pet Spider': 'petspider', 'Pet Spider Egg': 'petegg1',
        'Empty Bucket': 'emptybucket', 'Bucket of Milk': 'bucketofmilk', 'Bucket of Water': 'bucketofwater', 'Vitality Potion': 'vitalitypotion', 'Gold Ring': 'goldring',
        'Diamond Ring': 'diamondring', 'Emerald Ring': 'emeraldring', 'Ruby Ring': 'rubyring', 'Sapphire Ring': 'sapphirering', 'Topaz Ring': 'topazring',
        'Silver Fangs of the Fallen Monarch': 'silverfangsofthefallenmonarch'
    };

    slots.forEach(slotType => {
        const item = equipment[slotType];
        const slotEl = document.createElement('div');
        slotEl.className = 'equipment-slot';
        
        let imgName = '';
        let isTwoHandedBlock = false;
        
        if (item) {
            imgName = itemImageMap[item.name] || item.name.toLowerCase().replace(/\s+/g,'_');
        } else {
            if (slotType === 'helmet') imgName = 'helmet'; else if (slotType === 'chest') imgName = 'chestplate';
            else if (slotType === 'weapon') imgName = 'weapon'; else if (slotType === 'boots') imgName = 'boots';
            else if (slotType === 'necklace') imgName = 'necklace'; else if (slotType === 'cape') imgName = 'cape';
            else if (slotType === 'shield') imgName = 'shield'; else if (slotType === 'legs') imgName = 'legs';
            else if (slotType === 'ring1' || slotType === 'ring2') imgName = 'ring'; else if (slotType === 'arrows') imgName = 'arrows';
            else if (slotType === 'pet') imgName = 'pet';
        }

        if (slotType === 'shield' && !item && equipment.weapon) {
            const weaponStats = getStats(equipment.weapon.name);
            if (weaponStats && weaponStats.twoHanded) {
                isTwoHandedBlock = true;
                imgName = itemImageMap[equipment.weapon.name] || 'weapon';
            }
        }
        
        let extraStyle = '';
        if (item && (item.name === 'Diamond' || item.name === 'Uncut Diamond')) extraStyle = 'transform: scale(0.93);';
        slotEl.innerHTML = `<img src="images/${imgName}.png" alt="${slotType}" loading="eager" style="${isTwoHandedBlock ? 'opacity: 0.5; filter: grayscale(50%);' : ''} ${extraStyle}">`;
        
        if (item) {
            const enchantLvl = item.enchantLevel || 0;
            if (item.name === 'Gold Crown' || item.name === 'Elegant Black Cape') {
                slotEl.classList.add('legendary-glow');
            } else if (enchantLvl > 0) {
                slotEl.classList.add(`enchant-glow-${enchantLvl}`);
            }

            if (enchantLvl > 0) {
                const badge = document.createElement('div');
                badge.className = 'enchant-level-badge';
                badge.innerText = `+${enchantLvl}`;
                slotEl.appendChild(badge);
            }

            const itemStats = getStats(item.name);
            let statsHtml = '';
            
            // --- SYNCED CALCULATION LOGIC ---
            let tier = 1;
            const MATERIAL_TIERS = { 'Bronze': 1, 'Softwood': 1, 'Copper': 2, 'Leather': 2, 'Iron': 3, 'Cloth': 3, 'Wizard': 3, 'Oak': 3, 'Silver': 4, 'Birch': 4, 'Gold': 5, 'Maple': 5, 'Mahogany': 5, 'Ring': 5 };
            for (let [mat, val] of Object.entries(MATERIAL_TIERS)) { if (item.name.includes(mat)) { tier = val; break; } }
            
            let bonus = 0;
            if (item.name.includes("Ring") || item.name.includes("Wizard")) {
                bonus = enchantLvl; // +1 per level for Wizard and Rings
            } else {
                bonus = Math.floor(enchantLvl * (tier * 0.5)); // Tier scaling for others
            }
            const bonusText = bonus > 0 ? `<span style="font-size:10px;"> (+${bonus})</span>` : '';

            if (itemStats) {
                const stdB = item.enchantLevel || 0;
                const penB = Math.floor(stdB / 2);

                if (itemStats.meleeStr) statsHtml += `<div style="color:#ff4d4d;">+${itemStats.meleeStr + stdB} Melee Strength</div>`;
                if (itemStats.rangedStr) statsHtml += `<div style="color:#44aa44;">+${itemStats.rangedStr + stdB} Ranged Strength</div>`;
                if (itemStats.magicDmg) statsHtml += `<div style="color:#4da6ff;">+${itemStats.magicDmg + stdB} Magic Damage</div>`;
                
                let mBonus = stdB, rBonus = stdB, magBonus = stdB;
                if (itemStats.armorType === 'melee') magBonus = penB;
                else if (itemStats.armorType === 'ranged' || itemStats.armorType === 'magic') mBonus = penB;

                if (itemStats.meleeDef !== undefined) statsHtml += `<div style="color:#e38a42;">+${itemStats.meleeDef + mBonus} Melee Def</div>`;
                if (itemStats.rangedDef !== undefined) statsHtml += `<div style="color:#aaffaa;">+${itemStats.rangedDef + rBonus} Ranged Def</div>`;
                if (itemStats.magicDef !== undefined) statsHtml += `<div style="color:#6dafff;">+${itemStats.magicDef + magBonus} Magic Def</div>`;
                
                if (itemStats.maxHPBonus) statsHtml += `<div style="color:#ffaaaa;">+${itemStats.maxHPBonus + stdB} Max HP</div>`;
            }

            const tooltipContent = `<div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${item.name} ${enchantLvl > 0 ? `+${enchantLvl}` : ''}</div>${statsHtml}`;
            slotEl.onmouseenter = (evt) => window.showTooltip(evt, tooltipContent);
            slotEl.onmouseleave = window.hideTooltip;
        } else {
            slotEl.onmouseenter = (evt) => window.showTooltip(evt, isTwoHandedBlock ? "Occupied by 2H Weapon" : `Empty Slot`);
            slotEl.onmouseleave = window.hideTooltip;
        }
        frame.appendChild(slotEl);
    });
}
// This function needs to be defined in the module script to access Firebase, 
// but exposed to the window object so the HTML onclick can trigger it.

// =================================================================
// +++ NEW: THIEVING SYSTEM +++
// =================================================================

const THIEVING_REFRESH_TIME = 180000; // 3 minutes

const THIEVING_TARGET_DEFS = [
    { id: 'beggar', name: "Beggar's Pouch", level: 1, failRate: 15, xp: 10, dmg: 1, reward: { gold: [5, 15] } },
    { id: 'drunk', name: "Drunk Peasant", level: 1, failRate: 20, xp: 12, dmg: 1, reward: { gold: [10, 20] } },
    { id: 'fisherman', name: "Fisherman", level: 1, failRate: 25, xp: 15, dmg: 1, reward: { items: [{ name: 'Herring', qty: 2, chance: 70 }, { name: 'Trout', qty: 1, chance: 40 }] } },
    { id: 'pantry', name: "Farmhouse Pantry", level: 5, failRate: 35, xp: 30, dmg: 2, reward: { items: [{ name: 'Cooked Chicken', qty: 2, chance: 60 }, { name: 'Bronze Axe', qty: 1, chance: 10 }, { name: 'Corn', qty: 5, chance: 50 }] } },
    { id: 'pocket', name: "Peasant's Pocket", level: 5, failRate: 30, xp: 25, dmg: 2, reward: { gold: [40, 80] } },
    { id: 'cart', name: "Delivery Cart", level: 5, failRate: 40, xp: 45, dmg: 3, reward: { items: [{ name: 'Iron Ore', qty: 5, chance: 50 }, { name: 'Leather', qty: 3, chance: 50 }, { name: 'Cloth', qty: 2, chance: 40 }, { name: 'Softwood', qty: 10, chance: 60 }] } },
    { id: 'jewelry', name: "Market Jewelry Stall", level: 10, failRate: 55, xp: 80, dmg: 4, reward: { items: [{ name: 'Silver Bar', qty: 2, chance: 50 }, { name: 'Gold Bar', qty: 1, chance: 20 }] } },
    { id: 'house', name: "Unlocked Town House", level: 10, failRate: 50, xp: 100, dmg: 4, reward: { gold: [100, 200], items: [{ name: 'Leather Body', qty: 1, chance: 15 }, { name: 'Earthstone', qty: 1, chance: 20 }, { name: 'Waterstone', qty: 1, chance: 20 }, { name: 'Vitality Potion', qty: 1, chance: 30 }] } },
    { id: 'guard', name: "Guard", level: 10, failRate: 65, xp: 150, dmg: 6, reward: { gold: [250, 500] } }
];

function openThievingHub() {
    showMainScreen('hubThieving');
    refreshThievingTargets();
}

function refreshThievingTargets() {
    const now = Date.now();
    // 1. Remove expired targets
    game.thievingTargets = game.thievingTargets.filter(t => t.expiresAt > now);

    // 2. Fill up to 4 targets (MODIFIED FROM 5)
    while (game.thievingTargets.length < 4) {
        const available = THIEVING_TARGET_DEFS.filter(d => d.level <= game.thieving.level);
        const randomDef = available[Math.floor(Math.random() * available.length)];
        
        game.thievingTargets.push({
            ...randomDef,
            instanceId: Math.random().toString(36).substr(2, 9),
            expiresAt: now + THIEVING_REFRESH_TIME
        });
    }
    renderThievingList();
}

function renderThievingList() {
    const container = document.getElementById('thievingTargetsList');
    if (!container) return;
    container.innerHTML = '';
    const now = Date.now();

    game.thievingTargets.forEach(target => {
        const remaining = Math.max(0, Math.ceil((target.expiresAt - now) / 1000));
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

        const card = document.createElement('div');
        card.className = 'thieving-target-card';
        card.innerHTML = `
            <div class="thieving-info">
                <div style="font-weight:bold; color:var(--gold);">${target.name} (Lvl ${target.level})</div>
                <div class="thieving-chance">Fail Chance: ${target.failRate}%</div>
                <div class="thieving-timer">Expires in: ${timeStr}</div>
            </div>
            <button class="primary" onclick="attemptSteal('${target.instanceId}')">Steal</button>
        `;
        container.appendChild(card);
    });
}

async function attemptSteal(instanceId) {
    if (!game.isSessionActive) return;
    const targetIndex = game.thievingTargets.findIndex(t => t.instanceId === instanceId);
    if (targetIndex === -1) return;

    const target = game.thievingTargets[targetIndex];
    const roll = Math.random() * 100;

    if (roll < target.failRate) {
        // FAIL
        game.hp = Math.max(0, game.hp - target.dmg);
        
        // --- INSTANT AUTO EAT CHECK FOR THIEVING ---
        const threshold = (game.autoEatThreshold || 20) / 100;
        if (game.hp > 0 && (game.hp / game.maxHP) <= threshold && game.autoEatSlot) {
            triggerAutoEat();
        }

        updateHPUI();
        showDamageSplat('player', target.dmg, 'damage');
        showWarningPopup(`Caught! You took ${target.dmg} damage.`);
        playGlobalSound('sounds/soundeffects/swordsoundeffect.mp3');
        if (game.hp <= 0) handlePlayerDeath();
    } else {
        // SUCCESS
        addXP('thieving', target.xp);
        let popupDelay = 0; 
        showItemPopup(`+${target.xp} Thieving XP`, null, popupDelay);
        popupDelay += 450; 

        if (target.reward.gold) {
            const amount = Math.floor(Math.random() * (target.reward.gold[1] - target.reward.gold[0] + 1)) + target.reward.gold[0];
            addGold(amount);
            showItemPopup(`+${amount} Gold`, null, popupDelay);
            popupDelay += 450; 
        }

        let itemsFound = false;
        if (target.reward.items) {
            target.reward.items.forEach((itemDef) => {
                if (Math.random() * 100 < itemDef.chance) {
                    addItem(itemDef.name, itemDef.qty);
                    showItemPopup(`+${itemDef.qty} ${itemDef.name}`, null, popupDelay);
                    popupDelay += 450; 
                    itemsFound = true;
                }
            });
            if (!itemsFound && !target.reward.gold) showWarningPopup("Nothing of value found...");
        }
        
        playGlobalSound('sounds/soundeffects/inventorysound.mp3');
        game.thievingTargets.splice(targetIndex, 1);
        refreshThievingTargets();
    }
    game.isDirty = true;
}

// --- ENCHANTING LOGIC ---

function openEnchantingHub() {
    game.enchantSlot = null;
    showMainScreen('hubEnchanting');
    renderEnchantSlot();
}

function renderEnchantSlot() {
    const container = document.getElementById('enchantSlot');
    const costText = document.getElementById('enchantCostText');
    const enchantBtn = document.getElementById('enchantBtn');
    if(!container) return;
    
    container.innerHTML = '';
    // IMPORTANT: Reset the class list so the green glow doesn't get stuck
    container.className = "inv-slot"; 
    container.style.border = "2px dashed var(--gold)";

    if (!game.enchantSlot) {
        costText.innerText = "Select an item from your inventory";
        enchantBtn.style.display = "none";
        return;
    }

    const item = game.enchantSlot;
    const img = document.createElement('img');
    
    // Improved Image logic to match all equipment
    let imgName = item.name.toLowerCase().replace(/\s+/g, '');
    // Specific Fixes for filenames
    if (item.name === "Leather Body") imgName = "leatherarmor";
    if (item.name === "Leather Chaps") imgName = "leatherpants";
    if (item.name.includes("Ring") && item.name !== "Gold Ring") imgName = item.name.toLowerCase().replace(" ", "");
    if (item.name === "Silver Fangs of the Fallen Monarch") imgName = "silverfangsofthefallenmonarch";

    img.src = `images/${imgName}.png`;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "contain";
    container.appendChild(img);

    const eLvl = item.enchantLevel || 0;
    if (eLvl > 0) {
        container.classList.add(`enchant-glow-${eLvl}`);
        const badge = document.createElement('div');
        badge.className = 'enchant-level-badge';
        badge.innerText = `+${eLvl}`;
        container.appendChild(badge);
    }

    if (eLvl >= 4) {
        costText.innerText = "Maximum Enchantment Reached";
        enchantBtn.style.display = "none";
    } else {
        const cost = calculateEnchantCost(item);
        costText.innerText = `Upgrade to +${eLvl + 1}: ${cost.toLocaleString()} Gold`;
        enchantBtn.style.display = "block";
    }
}

// --- NEW HELPER FOR SHOP VALUE ---
function getCumulativeEnchantInvestment(itemName, level) {
    if (level <= 0) return 0;
    
    // Find the tier (matches your calculateEnchantCost logic)
    let tier = 1;
    const MATERIAL_TIERS = { 
        'Bronze': 1, 'Softwood': 1, 'Copper': 2, 'Leather': 2, 
        'Iron': 3, 'Cloth': 3, 'Wizard': 3, 'Oak': 3, 
        'Silver': 4, 'Birch': 4, 'Gold': 5, 'Maple': 5, 
        'Mahogany': 5, 'Ring': 5 
    };
    for (let mat in MATERIAL_TIERS) {
        if (itemName.includes(mat)) { 
            tier = MATERIAL_TIERS[mat]; 
            break; 
        }
    }

    let totalCost = 0;
    // Calculate the sum of all previous upgrade costs
    // Level 1 cost: 1^2, Level 2: 2^2, Level 3: 3^2, Level 4: 4^2
    for (let i = 1; i <= level; i++) {
        totalCost += (tier * 500) * Math.pow(i, 2);
    }
    return totalCost;
}


function calculateEnchantCost(item) {
    let tier = 1;
    // We check the MATERIAL_TIERS keys to see if the item name contains them
    for (let mat in MATERIAL_TIERS) {
        if (item.name.includes(mat)) { 
            tier = MATERIAL_TIERS[mat]; 
            break; 
        }
    }
    const currentLvl = item.enchantLevel || 0;
    return (tier * 500) * Math.pow((currentLvl + 1), 2);
}

function handleEnchantItemClick(item, index) {
    const screen = document.getElementById('hubEnchanting');
    if (!screen.classList.contains('active')) return false;

    // NEW: Hide tooltip immediately on click to prevent "ghosting"
    hideTooltip();

    // Prevent legendary/jewelry items from being enchanted
    if (item.name === "Gold Ring" || item.name === "Gold Crown" || item.name === "Elegant Black Cape") {
        showWarningPopup(`The ${item.name} cannot be enchanted!`);
        return true;
    }

    const stats = ITEM_STATS[item.name];
    if (!stats || (!stats.weaponType && !stats.armorType)) {
        showWarningPopup("Only weapons and armor can be enchanted!");
        return true; 
    }

    if (game.enchantSlot) returnEnchantItem();

    game.enchantSlot = { ...item, qty: 1 };
    removeItem(item.name, 1, item.enchantLevel || 0);
    renderEnchantSlot();
    
    // Save immediately so the item doesn't disappear on refresh
    game.isDirty = true;
    return true;
}

function returnEnchantItem() {
    if (!game.enchantSlot) return;

    // NEW: Hide tooltip immediately on click
    hideTooltip();

    addItem(game.enchantSlot.name, 1, game.enchantSlot.enchantLevel || 0);
    game.enchantSlot = null;
    renderEnchantSlot();
    
    // Save immediately so the item is back in inventory safely
    game.isDirty = true;
}

// --- NEW: Particle Animation Helper ---
function runEnchantParticles(durationMs) {
    const slot = document.getElementById('enchantSlot');
    if (!slot) return;
    
    const rect = slot.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    const particles = [];
    const particleCount = 30;
    
    // Create particles
    for(let i=0; i<particleCount; i++) {
        const p = document.createElement('div');
        p.className = 'magic-particle';
        document.body.appendChild(p);
        particles.push({
            el: p,
            angle: (Math.PI * 2 * i) / particleCount,
            radius: 60,
            speed: 0.1 + Math.random() * 0.05,
            exploding: false
        });
    }

    const startTime = Date.now();
    let animFrame;

    function animate() {
        const now = Date.now();
        const elapsed = now - startTime;

        // Phase 1: Spinning (Before duration ends)
        if (elapsed < durationMs) {
            particles.forEach(p => {
                p.angle += p.speed;
                // Spiral in slightly
                p.radius = 60 + Math.sin(now * 0.005) * 10; 
                
                const x = centerX + Math.cos(p.angle) * p.radius;
                const y = centerY + Math.sin(p.angle) * p.radius;
                
                p.el.style.left = (x - 3) + 'px';
                p.el.style.top = (y - 3) + 'px';
            });
            animFrame = requestAnimationFrame(animate);
        } 
        // Phase 2: Explosion (After duration)
        else {
            let stillAnimating = false;
            particles.forEach(p => {
                if (!p.exploding) {
                    p.exploding = true;
                    p.vx = Math.cos(p.angle) * 15; // Fast outward velocity
                    p.vy = Math.sin(p.angle) * 15;
                    p.opacity = 1;
                }
                
                // Move outward
                const currentLeft = parseFloat(p.el.style.left);
                const currentTop = parseFloat(p.el.style.top);
                p.el.style.left = (currentLeft + p.vx) + 'px';
                p.el.style.top = (currentTop + p.vy) + 'px';
                
                // Fade out
                p.opacity -= 0.03;
                p.el.style.opacity = p.opacity;
                
                if (p.opacity > 0) stillAnimating = true;
                else p.el.style.display = 'none';
            });

            if (stillAnimating) {
                animFrame = requestAnimationFrame(animate);
            } else {
                // Cleanup
                particles.forEach(p => p.el.remove());
            }
        }
    }
    
    animate();
}

async function attemptEnchant() {
    if (!game.enchantSlot || !game.isSessionActive) return;
    
    // Check cost first
    const cost = calculateEnchantCost(game.enchantSlot);
    if (game.gold < cost) {
        showGameAlert("Not Enough Gold", "You need more gold to perform this enchantment.");
        return;
    }

    hideTooltip();

    // 1. Setup Visuals
    const overlay = document.getElementById('enchantOverlay');
    const container = document.querySelector('.container'); // Main game container
    const btn = document.getElementById('enchantBtn');
    
    // Disable button to prevent double clicks
    if(btn) btn.disabled = true;

    // Start Riser Audio
    playGlobalSound('sounds/soundeffects/riser.mp3');

    // Apply Effects
    if (overlay) overlay.classList.add('active'); // Darken screen
    if (container) container.classList.add('enchant-shake'); // Shake screen
    
    // Start Particle System
    runEnchantParticles(3000); // Spin for 3 seconds

    // 2. Wait 3 seconds for the "Build Up"
    setTimeout(async () => {
        // Remove Shake and Darkness
        if (container) container.classList.remove('enchant-shake');
        if (overlay) overlay.classList.remove('active');
        if (btn) btn.disabled = false;

        // Play Success Sound
        playGlobalSound('sounds/soundeffects/successenchant.mp3');

        // Apply Logic
        addGold(-cost);
        game.enchantSlot.enchantLevel = (game.enchantSlot.enchantLevel || 0) + 1;
        
        renderEnchantSlot();
        game.isDirty = true;

        // Show Success Popup (Slight delay to let explosion start)
        setTimeout(() => {
            showGameAlert("Success!", `Your ${game.enchantSlot.name} is now +${game.enchantSlot.enchantLevel}!`);
        }, 200);

    }, 3000);
}

</script>

<div id="itemContextMenu"></div>

<div id="asset-cache" style="position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0.001; pointer-events: none; z-index: -1000; overflow: hidden;"></div>

<script type="module">
  // Firebase imports (CDN modules)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import {

  getFirestore, doc, setDoc, getDoc, collection, query, getDocs, where,
    addDoc, serverTimestamp, onSnapshot, orderBy, limit, limitToLast, runTransaction, writeBatch, updateDoc,
    increment // <-- ADD THIS
    
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const ADMIN_UID = "qHclRuNSFTTrE19xYd7ilqIPFVe2";

  // +++ NEW: Stub function for resetGameState +++
  // The real function is defined in the non-module script
  function stopCraftingBowString() {
    if (typeof window.stopCraftingBowString === 'function') {
      window.stopCraftingBowString();
    } else {
      game.craftingActive = false;
    }
  }
  
  const firebaseConfig = {
    apiKey: "AIzaSyD6sIi0SbPUUjJFJsJB22xBOF7ZD0H7utw",
    authDomain: "skill-3d8e1.firebaseapp.com",
    projectId: "skill-3d8e1",
    storageBucket: "skill-3d8e1.firebasestorage.app",
    messagingSenderId: "973290752767",
    appId: "1:973290752767:web:e80faba45f8707603d9aca"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authScreen = document.getElementById('authScreen');
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');
  const refreshLeaderboardBtn = document.getElementById('refreshLeaderboardBtn'); 

  // +++ --- NEW SESSION LOCK CONSTANTS & FUNCTIONS --- +++
  const LOCK_STALE_TIME_MS = 120000; // 2 minutes (Gives us room to slow down writes)
  const LOCK_HEARTBEAT_MS = 999999999;
  /**
   * (Helper) Gets the player doc ref.
   */
  function getPlayerRef() {
    const user = auth.currentUser;
    if (!user) return null;
    return doc(db, "players", user.uid);
  }

  /**
   * Shows the session lock overlay.
   */
  function showSessionLockOverlay() {
    const overlay = document.getElementById('sessionLockOverlay');
    if (overlay) overlay.style.display = 'flex';
  }
  
  /**
   * Hides the session lock overlay.
   */
  function hideSessionLockOverlay() {
    const overlay = document.getElementById('sessionLockOverlay');
    if (overlay) overlay.style.display = 'none';
  }

  /**
   * Starts the heartbeat to keep our session lock fresh.
   */
  // --- REPLACED WITH SIMPLIFIED FUNCTION (starting around line 802) ---
  /**
   * Starts the heartbeat to keep our session lock fresh.
   * NOTE: The active lock refresh logic is now solely handled by the 30s autosave
   * (or a separate manual save), so we only start a passive timer.
   */
  window.startSessionHeartbeat = function() {
    if (game.lockHeartbeat) return; // Already running
    
    // Use the extremely large interval, effectively making this timer passive.
    // The 30s autosave is now the only functional timer.
    game.lockHeartbeat = setInterval(() => {
        // This timer still runs, but the interval is so long it will rarely fire,
        // ensuring the 30s autosave is the primary write source.
    }, LOCK_HEARTBEAT_MS); 
  }

  /**
   * Stops the heartbeat.
   */
  window.stopSessionHeartbeat = function() {
    if (game.lockHeartbeat) {
      clearInterval(game.lockHeartbeat);
      game.lockHeartbeat = null;
    }
  }

  /**
   * Releases the session lock from Firebase.
   * @param {boolean} isAsync - If false, we can't wait for the update (e.g., closing tab).
   */
  window.releaseSessionLock = async function(isAsync = true) {
    stopSessionHeartbeat();
    const playerRef = getPlayerRef();
    if (!playerRef) return;
    
    // We only release the lock if we are the one holding it.
    try {
      const promise = runTransaction(db, async (transaction) => {
        const snap = await transaction.get(playerRef);
        if (!snap.exists()) return;
        const lock = snap.data().activeSession;
        if (lock && lock.id === game.sessionLockId) {
          transaction.update(playerRef, { activeSession: null });
        }
      });
      
      if (isAsync) {
        await promise;
      }
    } catch (e) {
      console.error("Failed to release lock:", e);
    }
  }
  
  /**
   * Tries to acquire the session lock using a transaction.
   * This is called when a lock is free or stale, or when user clicks "Take Control".
   */
  window.acquireSessionLock = async function(force = false) {
    const playerRef = getPlayerRef();
    if (!playerRef) return;
    
    try {
      await runTransaction(db, async (transaction) => {
        const snap = await transaction.get(playerRef);
        if (!snap.exists()) throw new Error("Player doc does not exist.");
        
        const data = snap.data();
        const lock = data.activeSession;
        const now = Date.now();
        
        // Only block the takeover if we AREN'T forcing it and the lock is fresh
        if (!force && lock && lock.id !== game.sessionLockId && (now - lock.timestamp) < LOCK_STALE_TIME_MS) {
          throw new Error("Lock is still fresh and held by another session.");
        }
        
        // Take the lock
        const newLock = { id: game.sessionLockId, timestamp: now };
        transaction.update(playerRef, { activeSession: newLock });
      });
      
      game.isSessionActive = true;
      hideSessionLockOverlay();
      
    } catch (e) {
      console.error("Failed to acquire lock:", e.message);
    }
  }
  // +++ --- END NEW SESSION LOCK FUNCTIONS --- +++


  window.savePlayerData = async function() {
    try {
      const user = auth.currentUser;
      if (!user || !game.isSessionActive || !game.isDirty) return;
      
      const inventoryToSave = [];
      game.inventory.forEach((item, index) => {
          if (item) {
              inventoryToSave.push({
                  slot: index,
                  name: item.name,
                  qty: item.qty,
                  enchantLevel: item.enchantLevel || 0 
              });
          }
      });
      
      const bankTabsToSave = {}; 
      game.bankTabs.forEach((tabArray, i) => {
          const tabData = [];
          tabArray.forEach((item, index) => {
              if (item) {
                  tabData.push({
                      slot: index,
                      name: item.name,
                      qty: item.qty,
                      enchantLevel: item.enchantLevel || 0 
                  });
              }
          });
          bankTabsToSave[i.toString()] = tabData;
      });
      
      const payload = {
        name: game.name || "",
        name_lowercase: (game.name || "").toLowerCase(),
        hp: game.hp,
        maxHP: game.maxHP,
        inventory: inventoryToSave,
        enchantSlot: game.enchantSlot || null, 
        gold: game.gold,
        bankTabs: bankTabsToSave,
        bankGold: game.bankGold,
        equipment: game.equipment,
        mining: game.mining,
        blacksmith: game.blacksmith,
        attack: game.attack,
        strength: game.strength,
        defence: game.defence,
        vitality: game.vitality,
        cooking: game.cooking,
        woodcutting: game.woodcutting,
        fletching: game.fletching,
        crafting: game.crafting,
        ranged: game.ranged,
        magic: game.magic,
        fishing: game.fishing,
        stoneforging: game.stoneforging,
        bountyhunting: game.bountyhunting,
        farming: game.farming,
        alchemy: game.alchemy,
        tailoring: game.tailoring,
        thieving: game.thieving,
        petmastery: game.petmastery,
        pets: game.pets,
        incubator: game.incubator,
        activeBounty: game.activeBounty || null,
        autoEatSlot: game.autoEatSlot || null,
        farm: game.farm,
        questLines: game.questLines,
        playerAttackStyle: game.playerAttackStyle, 
        autocastSpell: game.autocastSpell || null,
        autoEatUnlocked: game.autoEatUnlocked, 
        autoEatThreshold: game.autoEatThreshold || 20,
        lastAutoHealTime: game.lastAutoHealTime || 0,
        updatedAt: new Date().toISOString()
      };
      await setDoc(doc(db, "players", user.uid), payload, { merge: true });
      game.isDirty = false;
      if (typeof window.showSaveIndicator === 'function') window.showSaveIndicator();
    } catch (e) {
      console.error("Save failed:", e);
    }
};

  // =================================================================
  // --- NEW: PLAYER INSPECT LOGIC (Module Script) ---
  // =================================================================
  
  /**
   * Fetches player data and opens the inspect modal.
   * NOTE: This function must be exposed to the window object to be called from the leaderboard HTML.
   * @param {string} playerName - The name of the player to inspect.
   */
window.inspectPlayer = async function(playerName) {
    if (!auth.currentUser) return;
    if (typeof window.playGlobalSound === 'function') window.playGlobalSound('sounds/soundeffects/buttonsoundeffect.mp3');
    
    const frame = document.getElementById('inspectEquipmentFrame');
    const statsPanel = document.getElementById('inspectStatsPanel');
    const modalName = document.getElementById('inspectPlayerName');
    const inspectOverlay = document.getElementById('playerInspectOverlay');
    
    if (frame) frame.innerHTML = ''; 
    if (statsPanel) statsPanel.innerHTML = '<div style="color:#ccc; text-align:center; padding:20px;">Loading Stats...</div>'; 
    if (modalName) modalName.textContent = 'Loading...';
    if (inspectOverlay) inspectOverlay.style.display = 'flex';

    try {
      const nameLower = playerName.toLowerCase();
      const q = query(collection(db, "players"), where("name_lowercase", "==", nameLower), limit(1));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        await window.showGameAlert("Player Not Found", "Could not find player data.");
        if (inspectOverlay) inspectOverlay.style.display = 'none';
        return;
      }

      const playerData = querySnapshot.docs[0].data();
      const playerEquipment = playerData.equipment || {};

      modalName.textContent = playerData.name || 'Player';
      renderInspectEquipment(playerEquipment, frame);

      // --- Sync Calculation logic with local Player Stats ---
      let meleeStr = 0, rangedStr = 0, magicDmg = 0;
      let meleeDef = 0, rangedDef = 0, magicDef = 0;

      Object.values(playerEquipment).forEach(item => {
          if (item && item.name) {
              const def = window.ITEM_STATS[item.name];
              if (def) {
                  const eLvl = item.enchantLevel || 0;
                  const stdB = eLvl;
                  const penB = Math.floor(eLvl / 2);

                  // Offense
                  meleeStr += (def.meleeStr || 0) + (def.meleeStr ? stdB : 0);
                  rangedStr += (def.rangedStr || 0) + (def.rangedStr ? stdB : 0);
                  magicDmg += (def.magicDmg || 0) + (def.magicDmg ? stdB : 0);
                  
                  // Defense Scaling based on gear type
                  if (def.armorType === 'melee') {
                      meleeDef += (def.meleeDef || 0) + stdB;
                      rangedDef += (def.rangedDef || 0) + stdB;
                      magicDef += (def.magicDef || 0) + penB;
                  } else if (def.armorType === 'ranged' || def.armorType === 'magic') {
                      meleeDef += (def.meleeDef || 0) + penB;
                      rangedDef += (def.rangedDef || 0) + stdB;
                      magicDef += (def.magicDef || 0) + stdB;
                  } else {
                      meleeDef += (def.meleeDef || 0) + stdB;
                      rangedDef += (def.rangedDef || 0) + stdB;
                      magicDef += (def.magicDef || 0) + stdB;
                  }
              }
          }
      });

      // Update HTML to 2-column layout (Matches Player Stats Tab exactly)
      statsPanel.innerHTML = `
          <div style="display: flex; gap: 12px;">
            <!-- Left Column: Offense -->
            <div class="stats-column" style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
              <div class="stat-row"><span class="stat-label">Melee Strength</span><span class="stat-value" style="color:#ff4d4d;">+${meleeStr}</span></div>
              <div class="stat-row"><span class="stat-label">Ranged Strength</span><span class="stat-value" style="color:#44aa44;">+${rangedStr}</span></div>
              <div class="stat-row"><span class="stat-label">Magic Damage</span><span class="stat-value" style="color:#4da6ff;">+${magicDmg}</span></div>
            </div>
            
            <!-- Right Column: Defense -->
            <div class="stats-column" style="flex: 1; display: flex; flex-direction: column; gap: 4px; border-left: 1px solid rgba(109, 69, 45, 0.5); padding-left: 10px;">
              <div class="stat-row"><span class="stat-label">Melee Defense</span><span class="stat-value" style="color:#e38a42;">+${meleeDef}</span></div>
              <div class="stat-row"><span class="stat-label">Ranged Defense</span><span class="stat-value" style="color:#aaffaa;">+${rangedDef}</span></div>
              <div class="stat-row"><span class="stat-label">Magic Defense</span><span class="stat-value" style="color:#6dafff;">+${magicDef}</span></div>
            </div>
          </div>
      `;

      document.getElementById('closeInspectBtn').onclick = () => {
          inspectOverlay.style.display = 'none';
          window.hideTooltip(); 
      };

    } catch (e) {
      console.error("Inspect error:", e);
      if (inspectOverlay) inspectOverlay.style.display = 'none';
    }
};
  
  // --- HEAVILY MODIFIED: loadPlayerDataAndStart (now handles session lock) ---
  async function loadPlayerDataAndStart(user) {
    try {
      if (playerDocListener) {
        playerDocListener();
        playerDocListener = null;
      }
      
      if (updatesListenerUnsubscribe) {
        updatesListenerUnsubscribe();
        updatesListenerUnsubscribe = null;
      }
      isUpdatesHistoryLoaded = false;

      const ref = doc(db, "players", user.uid);
      let isFirstLoad = true; 
      
      playerDocListener = onSnapshot(ref, (snap) => {
        
        if (!snap.exists()) {
          console.log("Player document doesn't exist, showing start screen.");
          authScreen.style.display = 'none';
          startScreen.style.display = 'block'; 
          gameScreen.style.display = 'none';
          return; 
        }

        const data = snap.data();

        // +++ FIX: CHECK NAME BEFORE LOCKING +++
        // If the player has no name, they are still in the registration/creation phase.
        // We must NOT attempt to acquire a session lock yet, or it will error.
        if (!data.name) {
          authScreen.style.display = 'none';
          startScreen.style.display = 'block'; 
          gameScreen.style.display = 'none';
          return; // Stop here!
        }
        // +++ END FIX +++

        const lock = data.activeSession;
        const now = Date.now();

        // --- 1. SESSION LOCK LOGIC ---
        if (!lock || (now - lock.timestamp > LOCK_STALE_TIME_MS)) {
          // Lock is free or stale. Try to acquire it.
          // We only do this if we're not *already* the active session.
          if (!game.isSessionActive) {
            acquireSessionLock();
          }
        } else if (lock.id !== game.sessionLockId) {
          // Another tab has a fresh lock. We are INACTIVE.
          game.isSessionActive = false;
          stopSessionHeartbeat();
          showSessionLockOverlay();
          // Stop any local actions immediately
          stopMining();
          stopBlacksmithing();
          // Trade close logic removed
        } else {
          // We have the lock. We are ACTIVE.
          game.isSessionActive = true;
          hideSessionLockOverlay();
        }

        // --- 2. DATA SYNC LOGIC ---
        
        // Ignore our own "echo" saves
        if (snap.metadata.hasPendingWrites) {
          return;
        }
        
        // If we are the active tab, AND we are busy (mining, dragging, etc.),
        // do not sync data. This prevents rollbacks.
        if (game.isSessionActive && (game.miningActive || game.blacksmithingActive || game.cookingActive || game.woodcuttingActive || game.fletchingActive || game.isDragging)) {
          return;
        }
        
        // If we are INACTIVE, OR we are ACTIVE and IDLE, sync the data.
        game.playerAttackStyle = data.playerAttackStyle || 'strength';
        
        // +++ NEW: Load Autocast Spell +++
        game.autocastSpell = data.autocastSpell || null;
        // Update the visual border on the spell icons immediately
        if (typeof renderSpellsPanel === 'function') renderSpellsPanel();
        // +++ END NEW +++
        
        // +++ NEW: Load Equipment +++
        game.equipment = data.equipment || { helmet: null, chest: null, weapon: null, boots: null };
        renderEquipment(); // <-- Render the equipment on load
        // +++ END NEW +++

        if (!data.name) {
          // This handles the case right after registration
          authScreen.style.display = 'none';
          startScreen.style.display = 'block'; 
          gameScreen.style.display = 'none';
          return;
        }

        game.name = data.name || game.name || "Adventurer";
        game.hp = (typeof data.hp === 'number') ? data.hp : game.hp;
        game.maxHP = (typeof data.maxHP === 'number') ? data.maxHP : game.maxHP;
        
        let loadedInventoryData = data.inventory || [];
        game.inventory = new Array(game.inventoryCapacity).fill(null);
        if (Array.isArray(loadedInventoryData)) {
            if (loadedInventoryData.length > 0 && typeof loadedInventoryData[0].slot === 'number') {
                loadedInventoryData.forEach(item => {
                    if (item && typeof item.slot === 'number' && item.slot < game.inventoryCapacity) {
                        game.inventory[item.slot] = { 
                            name: item.name, 
                            qty: item.qty, 
                            enchantLevel: item.enchantLevel || 0 
                        };
                    }
                });
            } else if (loadedInventoryData.length > 0) {
                console.log("Migrating (buggy) array inventory...");
                for (let i = 0; i < loadedInventoryData.length && i < game.inventoryCapacity; i++) {
                    if(loadedInventoryData[i]) {
                      game.inventory[i] = { name: loadedInventoryData[i].name, qty: loadedInventoryData[i].qty };
                    }
                }
            }
        } else {
            console.log("Migrating legacy (object) inventory...");
            const entries = Object.entries(loadedInventoryData);
            for (let i = 0; i < entries.length && i < game.inventoryCapacity; i++) {
                game.inventory[i] = { name: entries[i][0], qty: entries[i][1] };
            }
        }
        
        game.gold = (typeof data.gold === 'number') ? data.gold : 0; 
        game.bankGold = (typeof data.bankGold === 'number') ? data.bankGold : 0;
        game.questLines = data.questLines || {}; 

        // NEW: Automatically return item to inventory if it was left on the table in the DB
        if (data.enchantSlot) {
            const itemToRecover = data.enchantSlot;
            addItem(itemToRecover.name, 1, itemToRecover.enchantLevel || 0);
            game.enchantSlot = null;
            game.isDirty = true; // Mark for next auto-save instead of immediate write
        } else {
            game.enchantSlot = null;
        } 
        
        // --- NEW: Bank Tabs Loading & Migration ---
        game.activeBankTabIndex = 0;
        game.bankTabs = [];

        // 1. Check for new Object Map format (The correct way for Firestore)
        if (data.bankTabs && typeof data.bankTabs === 'object' && !Array.isArray(data.bankTabs)) {
            // Sort keys to ensure tabs load in order (0, 1, 2...)
            const sortedKeys = Object.keys(data.bankTabs).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedKeys.forEach(key => {
                const tabData = data.bankTabs[key]; // This is the array of items
                const newTab = new Array(game.bankCapacity).fill(null);
                if (Array.isArray(tabData)) {
                    tabData.forEach(item => {
                        if (item && typeof item.slot === 'number' && item.slot < game.bankCapacity) {
                            // Updated to include enchantLevel
                            newTab[item.slot] = { 
                                name: item.name, 
                                qty: item.qty, 
                                enchantLevel: item.enchantLevel || 0 
                            };
                        }
                    });
                }
                game.bankTabs.push(newTab);
            });
        } 
        // 2. Fallback: Migration from old flat 'bank' array
        else {
            const firstTab = new Array(game.bankCapacity).fill(null);
            let loadedBankData = data.bank || [];
            if (Array.isArray(loadedBankData)) {
                loadedBankData.forEach(item => {
                    if (item && typeof item.slot === 'number' && item.slot < game.bankCapacity) {
                        firstTab[item.slot] = { name: item.name, qty: item.qty };
                    }
                });
            }
            game.bankTabs.push(firstTab);
        }
        
        // Ensure at least one tab exists
        if (game.bankTabs.length === 0) {
            game.bankTabs.push(new Array(game.bankCapacity).fill(null));
        }
        // --- END NEW ---
        
        if (data.mining) {
          game.mining.level = data.mining.level || 1;
          game.mining.xp = data.mining.xp || 0;
          game.mining.totalXP = data.mining.totalXP || getTotalXPForLevel(data.mining.level - 1) + data.mining.xp || 0; 
        } else {
          game.mining = { level: 1, xp: 0, totalXP: 0 }; 
        }
        
        if (data.blacksmith) {
          game.blacksmith.level = data.blacksmith.level || 1;
          game.blacksmith.xp = data.blacksmith.xp || 0;
          game.blacksmith.totalXP = data.blacksmith.totalXP || getTotalXPForLevel(data.blacksmith.level - 1) + data.blacksmith.xp || 0; 
        } else {
          game.blacksmith = { level: 1, xp: 0, totalXP: 0 }; 
        }
        
        // +++ NEW ATTACK LOADING LOGIC +++
        if (data.attack) {
          game.attack.level = data.attack.level || 1;
          game.attack.xp = data.attack.xp || 0;
          game.attack.totalXP = data.attack.totalXP || getTotalXPForLevel(data.attack.level - 1) + data.attack.xp || 0; 
        } else {
          game.attack = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW ATTACK LOADING LOGIC +++
        
        // +++ NEW STRENGTH LOADING LOGIC +++
        if (data.strength) {
          game.strength.level = data.strength.level || 1;
          game.strength.xp = data.strength.xp || 0;
          game.strength.totalXP = data.strength.totalXP || getTotalXPForLevel(data.strength.level - 1) + data.strength.xp || 0; 
        } else {
          game.strength = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW STRENGTH LOADING LOGIC +++
        
        // +++ NEW DEFENCE LOADING LOGIC +++
        if (data.defence) {
          game.defence.level = data.defence.level || 1;
          game.defence.xp = data.defence.xp || 0;
          game.defence.totalXP = data.defence.totalXP || getTotalXPForLevel(data.defence.level - 1) + data.defence.xp || 0; 
        } else {
          game.defence = { level: 1, xp: 0, totalXP: 0 }; 
        }
        //
        //

        // +++ NEW VITALITY LOADING LOGIC +++
        if (data.vitality) {
          game.vitality.level = data.vitality.level || 1;
          game.vitality.xp = data.vitality.xp || 0;
          game.vitality.totalXP = data.vitality.totalXP || getTotalXPForLevel(data.vitality.level - 1) + data.vitality.xp || 0; 
        } else {
          game.vitality = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW VITALITY LOADING LOGIC +++
        
        // +++ NEW COOKING LOADING LOGIC +++
        if (data.cooking) {
          game.cooking.level = data.cooking.level || 1;
          game.cooking.xp = data.cooking.xp || 0;
          game.cooking.totalXP = data.cooking.totalXP || getTotalXPForLevel(data.cooking.level - 1) + data.cooking.xp || 0; 
        } else {
          game.cooking = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW VITALITY LOADING LOGIC +++
        
        // +++ NEW WOODCUTTING LOADING LOGIC +++
        if (data.woodcutting) {
          game.woodcutting.level = data.woodcutting.level || 1;
          game.woodcutting.xp = data.woodcutting.xp || 0;
          game.woodcutting.totalXP = data.woodcutting.totalXP || getTotalXPForLevel(data.woodcutting.level - 1) + data.woodcutting.xp || 0; 
        } else {
          game.woodcutting = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW WOODCUTTING LOADING LOGIC +++
        
        // +++ NEW FLETCHING LOADING LOGIC +++
        if (data.fletching) {
          game.fletching.level = data.fletching.level || 1;
          game.fletching.xp = data.fletching.xp || 0;
          game.fletching.totalXP = data.fletching.totalXP || getTotalXPForLevel(data.fletching.level - 1) + data.fletching.xp || 0; 
        } else {
          game.fletching = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW FLETCHING LOADING LOGIC +++
        
        // +++ NEW CRAFTING LOADING LOGIC +++
        if (data.crafting) {
          game.crafting.level = data.crafting.level || 1;
          game.crafting.xp = data.crafting.xp || 0;
          game.crafting.totalXP = data.crafting.totalXP || getTotalXPForLevel(data.crafting.level - 1) + data.crafting.xp || 0; 
        } else {
          game.crafting = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW CRAFTING LOADING LOGIC +++
        
        // +++ NEW RANGED LOADING LOGIC +++
        if (data.ranged) {
          game.ranged.level = data.ranged.level || 1;
          game.ranged.xp = data.ranged.xp || 0;
          game.ranged.totalXP = data.ranged.totalXP || getTotalXPForLevel(data.ranged.level - 1) + data.ranged.xp || 0; 
        } else {
          game.ranged = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW RANGED LOADING LOGIC +++
        
        // +++ NEW MAGIC LOADING LOGIC +++
        if (data.magic) {
          game.magic.level = data.magic.level || 1;
          game.magic.xp = data.magic.xp || 0;
          game.magic.totalXP = data.magic.totalXP || getTotalXPForLevel(data.magic.level - 1) + data.magic.xp || 0; 
        } else {
          game.magic = { level: 1, xp: 0, totalXP: 0 }; 
        }
        // +++ END NEW MAGIC LOADING LOGIC +++
        
        // +++ NEW FISHING LOADING LOGIC +++
        if (data.fishing) {
          game.fishing.level = data.fishing.level || 1;
          game.fishing.xp = data.fishing.xp || 0;
          game.fishing.totalXP = data.fishing.totalXP || getTotalXPForLevel(data.fishing.level - 1) + data.fishing.xp || 0; 
        } else {
          game.fishing = { level: 1, xp: 0, totalXP: 0 }; 
        }
        
        // +++ NEW STONE FORGING LOADING LOGIC +++
        if (data.stoneforging) {
          game.stoneforging.level = data.stoneforging.level || 1;
          game.stoneforging.xp = data.stoneforging.xp || 0;
          game.stoneforging.totalXP = data.stoneforging.totalXP || getTotalXPForLevel(data.stoneforging.level - 1) + data.stoneforging.xp || 0; 
        } else {
          game.stoneforging = { level: 1, xp: 0, totalXP: 0 }; 
        }
        
        // +++ NEW BOUNTY LOADING LOGIC +++
        if (data.bountyhunting) {
          game.bountyhunting.level = data.bountyhunting.level || 1;
          game.bountyhunting.xp = data.bountyhunting.xp || 0;
          game.bountyhunting.totalXP = data.bountyhunting.totalXP || getTotalXPForLevel(data.bountyhunting.level - 1) + data.bountyhunting.xp || 0; 
        } else {
          game.bountyhunting = { level: 1, xp: 0, totalXP: 0 }; 
        }

        // +++ NEW: LOAD ALCHEMY DATA +++
        if (data.alchemy) {
          game.alchemy.level = data.alchemy.level || 1;
          game.alchemy.xp = data.alchemy.xp || 0;
          game.alchemy.totalXP = data.alchemy.totalXP || getTotalXPForLevel(data.alchemy.level - 1) + data.alchemy.xp || 0; 
        } else {
          game.alchemy = { level: 1, xp: 0, totalXP: 0 }; 
        }
        
        if (data.thieving) {
          game.thieving.level = data.thieving.level || 1;
          game.thieving.xp = data.thieving.xp || 0;
          game.thieving.totalXP = data.thieving.totalXP || getTotalXPForLevel(data.thieving.level - 1) + data.thieving.xp || 0; 
        } else {
          game.thieving = { level: 1, xp: 0, totalXP: 0 }; 
        }

        if (data.tailoring) {
          game.tailoring.level = data.tailoring.level || 1;
          game.tailoring.xp = data.tailoring.xp || 0;
          game.tailoring.totalXP = data.tailoring.totalXP || getTotalXPForLevel(data.tailoring.level - 1) + data.tailoring.xp || 0;
        } else {
          game.tailoring = { level: 1, xp: 0, totalXP: 0 };
        }

         // +++ NEW PET LOAD +++
        if (data.petmastery) {
          game.petmastery.level = data.petmastery.level || 1;
          game.petmastery.xp = data.petmastery.xp || 0;
          game.petmastery.totalXP = data.petmastery.totalXP || getTotalXPForLevel(data.petmastery.level - 1) + data.petmastery.xp || 0;
        } else {
          game.petmastery = { level: 1, xp: 0, totalXP: 0 }; 
        }
        game.pets = data.pets || [];
        game.incubator = data.incubator || { active: false, startTime: 0, eggType: null };

        // +++ NEW FARMING LOAD +++
        if (data.farming) {
          game.farming.level = data.farming.level || 1;
          game.farming.xp = data.farming.xp || 0;
          game.farming.totalXP = data.farming.totalXP || getTotalXPForLevel(data.farming.level - 1) + data.farming.xp || 0; 
        } else {
          game.farming = { level: 1, xp: 0, totalXP: 0 }; 
        }
        game.activeBounty = data.activeBounty || null;
        game.autoEatSlot = data.autoEatSlot || null;
        game.autoEatUnlocked = data.autoEatUnlocked || false; 
        game.autoEatThreshold = data.autoEatThreshold || 20; // Load the slider value
        
        // +++ NEW FARM LOADING & OFFLINE CALC (MULTI-CHICKEN & COWS) +++
        game.farm = data.farm || { chickens: [], cows: [], garden: new Array(16).fill(null), cellar: new Array(16).fill(null) };
        if (!game.farm.cellar) game.farm.cellar = new Array(16).fill(null);
        if (!game.farm.cows) game.farm.cows = []; 
        // +++ NEW: Init buildings if missing +++
        if (!game.farm.buildings) {
            game.farm.buildings = { coop: false, barn: false, well: false, garden: false, cellar: false };
        }
        // Ensure the cellar property exists specifically for old saves
        if (game.farm.buildings.cellar === undefined) {
            game.farm.buildings.cellar = false;
        }
        
        // Define constants locally
        const _HP_DECAY_MS = 43200000; // 12 Hours
        const _EGG_TIMER_MS = 43200000; 
        const _COW_HP_DECAY = 43200000;
        const _COW_MILK_TIMER = 43200000; // 12 Hours

        // MIGRATION: Convert old single object to array if it exists
        if (game.farm.chicken && !game.farm.chickens) {
            if (game.farm.chicken.active) {
                game.farm.chickens = [game.farm.chicken];
            } else {
                game.farm.chickens = [];
            }
            delete game.farm.chicken;
        }
        // Safety check
        if (!game.farm.chickens) game.farm.chickens = [];

        // OFFLINE CALCULATION LOOP
        // (Variable 'now' is already defined at the top of this function)
        
        // Loop backwards to safely handle deaths
        for (let i = game.farm.chickens.length - 1; i >= 0; i--) {
            const c = game.farm.chickens[i];
            const lastCalc = c.lastCalcTime || now;
            const diff = now - lastCalc;

            if (diff > 1000) {
                // 1. Calculate HP Loss using local constant
                const hpLost = Math.floor(diff / _HP_DECAY_MS);
                
                const startHp = c.hp;
                const endHp = startHp - hpLost;
                
                if (endHp <= 0) {
                    // Chicken died while offline
                    game.farm.chickens.splice(i, 1);
                    console.log(`Chicken #${i} died while offline.`);
                } else {
                    // Chicken survived. Update HP.
                    c.hp = endHp;
                    c.lastCalcTime = now;
                    
                    // 2. Calculate Eggs using local constant
                    // Simplified: Only if it ended healthy do we award eggs for the full duration
                    if (endHp >= 5) {
                        const eggsGained = Math.floor(diff / _EGG_TIMER_MS);
                        c.storedEggs = (c.storedEggs || 0) + eggsGained;
                    }
                }
            }
        }

// COW OFFLINE LOOP
        for (let i = game.farm.cows.length - 1; i >= 0; i--) {
            const c = game.farm.cows[i];
            const lastCalc = c.lastCalcTime || now;
            const diff = now - lastCalc;

            if (diff > 1000) {
                // 1. Calculate HP Loss
                const hpLost = Math.floor(diff / _COW_HP_DECAY);
                
                const startHp = c.hp;
                const endHp = startHp - hpLost;
                
                if (endHp <= 0) {
                    game.farm.cows.splice(i, 1);
                    console.log(`Cow #${i} died while offline.`);
                } else {
                    c.hp = endHp;
                    c.lastCalcTime = now;
                    
                    // 2. Calculate Milk (Only until full)
                    // If it was already full, nothing happens.
                    // If not full, check if time passed exceeds required time.
                    if (!c.hasMilk && endHp >= 5) {
                        // Add time passed to current accumulator
                        let potentialProgress = (c.milkTimer || 0) + diff;
                        if (potentialProgress >= _COW_MILK_TIMER) {
                            c.hasMilk = true;
                            c.milkTimer = 0;
                        } else {
                            c.milkTimer = potentialProgress;
                        }
                    }
                }
            }
        }

        // +++ NEW PET OFFLINE LOOP +++
        if (game.pets && game.pets.length > 0) {
            for (let p of game.pets) {
                const lastCalc = p.lastCalcTime || now;
                const diff = now - lastCalc;
                if (diff > 1000) {
                    const hpLost = Math.floor(diff / PET_HP_DECAY_MS);
                    if (hpLost > 0) {
                        p.hp = Math.max(0, p.hp - hpLost);
                        p.lastCalcTime = now; // Update time so we don't decay again instantly
                    }
                }
            }
        }

        // +++ END NEW LOGIC +++

        setText('charName', game.name);
        updateHPUI(); // This now calculates maxHP using game.vitality.level
        renderInventoryGrid();
        updateSkillUI();
        updateGoldUI(); 
        
        // +++ NEW: Pre-render the bank UI on load +++
        renderBankGrid();
        updateBankGoldUI();
        // +++ END NEW +++

        // +++ NEW: Pre-render the Shop UI on load +++
        renderShopGrid();
        // +++ END NEW +++
        
        if (isFirstLoad) {
          window.renderLeaderboards(); 
          isFirstLoad = false;         
          backToActions(); 
        }
        
        startScreen.style.display = 'none';
        authScreen.style.display = 'none';
        gameScreen.style.display = 'block';
        loadSettings();
        startMusicPlaylist();

      }, async (error) => { // <-- Add 'async' here
        console.error("Player listener error:", error);
        await showGameAlert("Load Error", "Error loading player data. Please refresh the page.");
      });
      
      const initialSnap = await getDoc(ref);
      if (!initialSnap.exists() || !initialSnap.data().name) {
        authScreen.style.display = 'none';
        startScreen.style.display = 'block';
        gameScreen.style.display = 'none';
        return false; 
      }

      return true; 
      
    } catch (e) {
      console.error("Load failed:", e);
      return false;
    }
  }

  // --- MODIFIED: Added activeSession to new doc ---
  registerBtn.onclick = async function() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) { await showGameAlert("Error", "Please enter an email and password."); return; }
    try {
      const uc = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "players", uc.user.uid), {
        name: "",
        name_lowercase: "",
        hp: 10,
        maxHP: 10,
        inventory: [],
        gold: 100, 
        // +++ NEW +++
        bank: [],
        bankGold: 0,
        // +++ END NEW +++
        equipment: { helmet: null, chest: null, weapon: null, boots: null },
        mining: { level: 1, xp: 0, totalXP: 0 },
        blacksmith: { level: 1, xp: 0, totalXP: 0 }, 
        attack: { level: 1, xp: 0, totalXP: 0 }, 
        strength: { level: 1, xp: 0, totalXP: 0 }, 
        defence: { level: 1, xp: 0, totalXP: 0 }, 
        vitality: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW VITALITY FOR NEW ACCOUNTS +++
        cooking: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW COOKING FOR NEW ACCOUNTS +++
        woodcutting: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW WOODCUTTING FOR NEW ACCOUNTS +++
        fletching: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW FLETCHING FOR NEW ACCOUNTS +++
        
        // +++ NEW SKILLS FOR NEW ACCOUNTS +++
        crafting: { level: 1, xp: 0, totalXP: 0 },
        ranged: { level: 1, xp: 0, totalXP: 0 },
        fishing: { level: 1, xp: 0, totalXP: 0 },
        stoneforging: { level: 1, xp: 0, totalXP: 0 },
        magic: { level: 1, xp: 0, totalXP: 0 }, 
        alchemy: { level: 1, xp: 0, totalXP: 0 }, // +++ NEW +++ 
        
        playerAttackStyle: 'strength',
        activeSession: null, // +++ ADD THIS
        createdAt: new Date().toISOString()
      });
      await showGameAlert("Account Created", "Your account has been created. You must now create your character.");
    } catch (err) {
      await showGameAlert("Registration Failed", err.message || "An unknown error occurred during registration.");
      console.error(err);
    }
  };

  loginBtn.onclick = async function() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) { await showGameAlert("Error", "Please enter an email and password."); return; }
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      await showGameAlert("Login Failed", err.message || "An unknown error occurred during login.");
      console.error(err);
    }
  };

  // --- MODIFIED: Handles session cleanup ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // Trade cleanup removed
      if (playerDocListener) playerDocListener();

      const started = await loadPlayerDataAndStart(user);
      
      if (user.uid === ADMIN_UID) {
        game.isAdmin = true;
        console.log("Admin status granted.");
      } else {
        game.isAdmin = false;
        game.playerAttackStyle = 'strength';
      }
      
      if (started) {
        initChatListener();
        initUpdatesListener();
        initBroadcastListener(); // +++ ADD THIS LINE +++
        // The loadPlayerDataAndStart listener will automatically handle
        // acquiring the lock on first load.
      } else {
        startScreen.style.display = 'block';
        gameScreen.style.display = 'none';
        authScreen.style.display = 'none';
      }
    } else {
      // User is logged out
      authScreen.style.display = 'flex';
      startScreen.style.display = 'none';
      gameScreen.style.display = 'none';
      
      // Stop listeners and release lock
      // Trade cleanup removed
      if (playerDocListener) playerDocListener();
      if (updatesListenerUnsubscribe) updatesListenerUnsubscribe();
      if (broadcastListenerUnsubscribe) broadcastListenerUnsubscribe(); // +++ ADD THIS LINE +++
      isUpdatesHistoryLoaded = false;
      stopSessionHeartbeat();
      // We don't release the lock, just let it go stale.
      
      if (window.resetGameState) {
        window.resetGameState();
      }
      isTradeRequestsLoaded = false; 
    }
  });

  (function(){
    const originalCreate = window.createCharacter;
    if (typeof originalCreate === "function") {
      window.createCharacter = async function() {
        const name = document.getElementById('playerName').value.trim();
        if(!name) { await showGameAlert("Error", "Please enter a name for your character."); return; }
        try {
          const nameLower = name.toLowerCase();
          const q = query(collection(db, "players"), where("name_lowercase", "==", nameLower));
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
             await showGameAlert("Name Taken", "That name is already taken. Please choose another."); return;
          }
        } catch (e) {
          console.error("Name check failed:", e);
           await showGameAlert("Error", "An error occurred while checking the name. Please try again."); return;
        }
        
        originalCreate(); // Sets game.name locally
        
        const user = auth.currentUser;
        if (user) {
          // Acquire the session lock so we are authorized to save
          if (typeof window.acquireSessionLock === 'function') {
            await window.acquireSessionLock();
          }

          game.isSessionActive = true;
          game.isDirty = true; // Ensure savePlayerData doesn't exit early

          await window.savePlayerData(); // This saves the name to Firestore
          window.renderLeaderboards();
          
          // Initialize listeners that were skipped during the initial "no-name" load
          initChatListener(); 
          initUpdatesListener(); 
          initBroadcastListener(); 
        }
      };
    }
  })();
  
  // --- CHAT FUNCTIONS (Unchanged) ---
  let isChatHistoryLoaded = false;
  let localMessageQueue = [];
  let chatListenerUnsubscribe = null;
  let isTradeRequestsLoaded = false; 
  let playerDocListener = null; 
  let updatesListenerUnsubscribe = null;
  let isUpdatesHistoryLoaded = false; 
// +++ NEW BROADCAST LISTENER +++
  let broadcastListenerUnsubscribe = null;
  let lastBroadcastTimestamp = null;

// =================================================================
  // --- RESTORED HELPER FUNCTIONS (Required for Admin /giveitem to others) ---
  // =================================================================
  function convertSavedInvToLocal(savedInvData) {
      const localInv = new Array(game.inventoryCapacity || 40).fill(null);
      if (!Array.isArray(savedInvData)) {
          const entries = Object.entries(savedInvData);
          for (let i = 0; i < entries.length && i < localInv.length; i++) {
              localInv[i] = { name: entries[i][0], qty: entries[i][1] };
          }
      } else {
          savedInvData.forEach(item => {
              if (item && typeof item.slot === 'number' && item.slot < localInv.length) {
                  localInv[item.slot] = { name: item.name, qty: item.qty };
              }
          });
      }
      return localInv;
  }

  function convertLocalInvToSaved(localInv) {
      const inventoryToSave = [];
      localInv.forEach((item, index) => {
          if (item) {
              inventoryToSave.push({ slot: index, name: item.name, qty: item.qty });
          }
      });
      return inventoryToSave;
  }

  function modifyInventory(localInvArray, itemName, qtyChange) {
      const newInv = JSON.parse(JSON.stringify(localInvArray)); 
      if (qtyChange > 0) { // Adding
          let amountToAdd = qtyChange;
          for (const slot of newInv) {
              if (slot && slot.name === itemName) {
                  slot.qty += amountToAdd;
                  amountToAdd = 0;
                  break; 
              }
          }
          if (amountToAdd > 0) {
              let emptySlotIndex = newInv.findIndex(slot => slot === null);
              if (emptySlotIndex > -1) newInv[emptySlotIndex] = { name: itemName, qty: amountToAdd };
          }
      } else if (qtyChange < 0) { // Removing
          let amountToRemove = Math.abs(qtyChange);
          for (let i = newInv.length - 1; i >= 0; i--) {
              const slot = newInv[i];
              if (slot && slot.name === itemName) {
                  if (slot.qty > amountToRemove) {
                      slot.qty -= amountToRemove;
                      amountToRemove = 0;
                  } else {
                      amountToRemove -= slot.qty;
                      newInv[i] = null;
                  }
              }
              if (amountToRemove === 0) break;
          }
      }
      return newInv;
  }

 // =================================================================
  // --- RESTORED ADMIN COMMANDS (With Case Correction) ---
  // =================================================================
  async function handleChatCommand(messageText) {
    const user = auth.currentUser;
    if (!user) return false;

    // 1. Check if Admin
    if (game.isAdmin && messageText.startsWith('/')) {
        const parts = messageText.substring(1).split(' ');
        const command = parts[0].toLowerCase();
        const args = parts.slice(1);

        // --- COMMAND: /givegold player amount ---
        if (command === 'givegold') {
            const targetName = args[0] ? args[0].toLowerCase() : '';
            const amount = parseInt(args[1]);
            if (!targetName || isNaN(amount) || amount <= 0) {
                addLocalChatMessage("Usage: /givegold [playername] [amount]", 'error');
                return true;
            }

            // Case A: Give to Self
            if (targetName === game.name.toLowerCase()) {
                if (typeof window.addGold === 'function') {
                    window.addGold(amount);
                    await window.savePlayerData();
                    addLocalChatMessage(`Admin: Spawning ${amount} Gold`, 'system');
                }
                return true;
            }

            // Case B: Give to Others
            try {
                const q = query(collection(db, "players"), where("name_lowercase", "==", targetName));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    addLocalChatMessage(`Player not found: ${args[0]}`, 'error');
                    return true;
                }
                const playerDoc = querySnapshot.docs[0];
                await updateDoc(doc(db, "players", playerDoc.id), {
                    gold: increment(amount)
                });
                addLocalChatMessage(`Admin: Gave ${amount} Gold to ${playerDoc.data().name}.`, 'system');
            } catch (e) {
                addLocalChatMessage(`Error giving gold: ${e.message}`, 'error');
            }
            return true;
        }

        // --- COMMAND: /giveitem player item amount ---
        if (command === 'giveitem') {
            const targetName = args[0] ? args[0].toLowerCase() : '';
            const qty = parseInt(args[args.length - 1]);
            
            // Extract the raw name parts
            const rawNameParts = args.slice(1, -1);
            
            if (!targetName || rawNameParts.length === 0 || isNaN(qty) || qty <= 0) {
                addLocalChatMessage("Usage: /giveitem [playername] [Item Name] [amount]", 'error');
                return true;
            }

            // +++ FIX: VALIDATE ITEM EXISTENCE +++
            const rawInput = rawNameParts.join(' ').toLowerCase();
            let itemName = null;

            // Check against VALID_ITEMS list
            if (typeof VALID_ITEMS !== 'undefined') {
                const officialMatch = VALID_ITEMS.find(i => i.toLowerCase() === rawInput);
                if (officialMatch) {
                    itemName = officialMatch; // Found it! Use exact name from list.
                }
            }

            // If item was not found in the list, stop and show error
            if (!itemName) {
                addLocalChatMessage(`Error: '${rawNameParts.join(' ')}' is not a valid item.`, 'error');
                return true;
            }
            // +++ END FIX +++
            
            // Case A: Give to Self
            if (targetName === game.name.toLowerCase()) {
                if (typeof window.addItem === 'function') {
                    window.addItem(itemName, qty); 
                    await window.savePlayerData();
                    addLocalChatMessage(`Admin: Spawning ${qty} x ${itemName}`, 'system');
                }
                return true;
            }

            // Case B: Give to Others
            try {
                const q = query(collection(db, "players"), where("name_lowercase", "==", targetName));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    addLocalChatMessage(`Player not found: ${args[0]}`, 'error');
                    return true;
                }
                const playerDoc = querySnapshot.docs[0];
                const playerData = playerDoc.data();
                
                let currentLocalInv = convertSavedInvToLocal(playerData.inventory || []);
                const newLocalInv = modifyInventory(currentLocalInv, itemName, qty);
                const newSavedInv = convertLocalInvToSaved(newLocalInv);
                
                await updateDoc(doc(db, "players", playerDoc.id), { inventory: newSavedInv });
                addLocalChatMessage(`Admin: Gave ${qty}x ${itemName} to ${playerData.name}.`, 'system');
            } catch (e) {
                console.error(e);
                addLocalChatMessage(`Error giving item: ${e.message}`, 'error');
            }
            return true;
        }

        // --- COMMAND: /update message ---
        if (command === 'update') {
            const messageText = args.join(' ');
            if (messageText.length === 0) return true;
            try {
              await addDoc(collection(db, "updates"), {
                text: messageText,
                timestamp: serverTimestamp()
              });
              addLocalChatMessage("Update posted.", 'system');
            } catch (e) {
              console.error("Error posting update: ", e);
            }
            return true;
        }

        // --- COMMAND: /messageall message ---
        if (command === 'messageall') {
            const messageText = args.join(' ');
            if (messageText.length === 0) return true;
            try {
              await setDoc(doc(db, "system", "broadcast"), {
                message: messageText,
                timestamp: serverTimestamp()
              });
              addLocalChatMessage("Broadcast message sent.", 'system');
            } catch (e) {
              console.error("Error sending broadcast: ", e);
            }
            return true;
        }

        // --- COMMAND: /forget questname ---
        if (command === 'forget') {
            const inputName = args.join(' ');
            if (!inputName) return true;
            
            let targetId = inputName;
            let foundName = inputName;
            if (window.QUEST_LINES) {
                for (const lineId in window.QUEST_LINES) {
                    const line = window.QUEST_LINES[lineId];
                    const match = line.quests.find(q => q.name.toLowerCase() === inputName.toLowerCase());
                    if (match) {
                        targetId = match.id;
                        foundName = match.name;
                        break;
                    }
                }
            }

            let found = false;
            for (const lineId in game.questLines) {
                const lineData = game.questLines[lineId];
                if (lineData.completed) {
                    const index = lineData.completed.indexOf(targetId);
                    if (index > -1) {
                        lineData.completed.splice(index, 1);
                        lineData.activeQuestId = null; 
                        lineData.kills = 0;
                        found = true;
                        addLocalChatMessage(`Admin: Forgot '${foundName}'. Re-open quest tab.`, 'system');
                        break; 
                    }
                }
            }
            if (found) await window.savePlayerData();
            else addLocalChatMessage(`Quest '${foundName}' not found in history.`, 'error');
            return true;
        }
        
        // --- COMMAND: /setlevel player skill level ---
        if (command === 'setlevel') {
            const targetName = args[0] ? args[0].toLowerCase() : '';
            const skill = args[1] ? args[1].toLowerCase() : '';
            const level = parseInt(args[2]);
            if (!targetName || !skill || isNaN(level)) return true;

            const newTotalXP = (window.getTotalXPForLevel) ? window.getTotalXPForLevel(level) : 0; 
            const newSkillData = { level: level, xp: 0, totalXP: newTotalXP };

            // Self
            if (targetName === game.name.toLowerCase()) {
                game[skill] = newSkillData; 
                if(window.updateSkillUI) window.updateSkillUI();
                if(window.updateHPUI) window.updateHPUI();
                await window.savePlayerData(); 
                addLocalChatMessage(`Admin: Set own ${skill} to ${level}.`, 'system');
                return true;
            }
            // Others
             try {
                const q = query(collection(db, "players"), where("name_lowercase", "==", targetName));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    await updateDoc(doc(db, "players", snap.docs[0].id), { [skill]: newSkillData });
                    addLocalChatMessage(`Admin: Set ${snap.docs[0].data().name}'s ${skill} to ${level}.`, 'system');
                }
            } catch (e) { console.error(e); }
            return true;
        }
        
        // --- COMMAND: /godmode ---
        if (command === 'godmode') {
           game.hp = 9999;
           game.maxHP = 9999;
           if(window.updateHPUI) window.updateHPUI();
           addLocalChatMessage("Godmode Enabled.", 'system');
           return true;
        }
    }
    // Not an admin command or not admin
    return false; 
  }




  async function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const messageText = chatInput.value.trim();
    const user = auth.currentUser;
    if (messageText.length === 0) return; 
    
    // +++ NEW: Prevent sending chat from inactive tab +++
    if (!game.isSessionActive) {
      await showGameAlert("Session Not Active", "This tab is not active. Take control to send messages.");
      return;
    }
    
    chatInput.value = '';
    if (messageText.startsWith('/')) {
      const isCommand = await handleChatCommand(messageText);
      if (isCommand) return; 
    }
    if (messageText.length > 256) {
      await showGameAlert("Error", "Your message is too long (max 256 chars).");
      return;
    }
    if (!user || !game.name) {
      await showGameAlert("Error", "You must be logged in and have a character to chat.");
      return;
    }
    try {
      await addDoc(collection(db, "messages"), {
        senderUid: user.uid,
        senderName: game.name,
        text: messageText,
        timestamp: serverTimestamp()
      });
    } catch (e) {
      console.error("Error sending message: ", e);
      await showGameAlert("Error", "Failed to send message. Please try again.");
    }
  }
  // Renamed to match Admin Commands
  function addLocalChatMessage(text, type = 'system') {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;
    const msgElement = document.createElement('div');
    msgElement.style.marginBottom = '6px';
    msgElement.style.lineHeight = '1.3';
    msgElement.style.wordBreak = 'break-word';
    if (type === 'system') {
      msgElement.style.color = '#aaffaa'; 
      msgElement.style.fontStyle = 'italic';
      msgElement.textContent = text;
    } else if (type === 'trade') {
      msgElement.style.color = 'var(--gold)'; 
      msgElement.style.fontWeight = 'bold';
      msgElement.textContent = text;
    } else if (type === 'error') {
      msgElement.style.color = '#ff8888'; 
      msgElement.style.fontStyle = 'italic';
      msgElement.textContent = text;
    }
    chatMessagesContainer.prepend(msgElement); 
  }
  function formatUpdateTimestamp(timestamp) {
    if (!timestamp) return "Just now";
    const date = timestamp.toDate();
    // Formats to: 11/11/25
    return date.toLocaleString('en-US', {
      month: 'numeric',
      day: 'numeric',
      year: '2-digit'
    });
  }

  function addUpdateMessageToDOM(doc) {
    const contentContainer = document.getElementById('updatesContent');
    if (!contentContainer) return;

    const data = doc.data();
    const docId = doc.id;

    // --- FIX: Check if this update is already in the DOM ---
    if (document.getElementById(`update-${docId}`)) {
      return; // Already exists, do nothing
    }
    // --- END FIX ---

    const msgElement = document.createElement('div');
    msgElement.className = 'update-message';
    msgElement.id = `update-${docId}`; // --- NEW: Add unique ID ---
    
    const formattedDate = formatUpdateTimestamp(data.timestamp);
    
    // Create text nodes to prevent HTML injection from the update message
    const textNode = document.createTextNode(" " + data.text);
    const strongNode = document.createElement('strong');
    strongNode.textContent = `${formattedDate}:`;
    
    msgElement.appendChild(strongNode);
    msgElement.appendChild(textNode);
    
    // Add to the top of the list
    contentContainer.prepend(msgElement);
  }

  function initUpdatesListener() {
    if (updatesListenerUnsubscribe) {
      updatesListenerUnsubscribe();
      updatesListenerUnsubscribe = null;
    }
    const contentContainer = document.getElementById('updatesContent');
    if (!contentContainer) return;

    const q = query(
      collection(db, "updates"), 
      orderBy("timestamp", "asc"), // Get oldest first
      limitToLast(20) // But only the last 20
    );

    updatesListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
      if (!isUpdatesHistoryLoaded) {
        // First load: clear "loading" and add all docs
        isUpdatesHistoryLoaded = true;
        contentContainer.innerHTML = '';
        // Prepend all docs so they end up in newest-first order
        querySnapshot.docs.forEach(doc => {
          addUpdateMessageToDOM(doc); // --- FIX: Pass whole doc ---
        });
      } else {
        // Subsequent loads: only add new ones
        querySnapshot.docChanges().forEach((change) => {
          // --- FIX: Show all new messages, including your own ---
          if (change.type === "added") {
            addUpdateMessageToDOM(change.doc); // --- FIX: Pass whole doc ---
          }
        });
      }

      // Prune old messages if we have more than 20
      while (contentContainer.childElementCount > 20) {
        contentContainer.lastChild.remove(); // Remove from the bottom
      }
      
    }, (error) => {
      console.error("Updates listener error: ", error);
      contentContainer.innerHTML = '<div style="color: red; text-align: center;">Error loading updates.</div>';
    });
  }

// +++ NEW: BROADCAST LISTENER (REVISED) +++
  function initBroadcastListener() {
    if (broadcastListenerUnsubscribe) {
      broadcastListenerUnsubscribe();
      broadcastListenerUnsubscribe = null;
    }

    const broadcastRef = doc(db, "system", "broadcast");

    broadcastListenerUnsubscribe = onSnapshot(broadcastRef, (doc) => {
      if (!doc.exists()) return; // No broadcast message set

      const data = doc.data();
      const message = data.message;
      const timestamp = data.timestamp;

      // Ignore if the message has no timestamp
      if (!timestamp) return;

      // --- THIS IS THE NEW LOGIC ---
      if (lastBroadcastTimestamp === null) {
        // This is the FIRST time the listener is running on page load.
        // We will "prime" the system by storing the current timestamp,
        // but we will NOT show the overlay.
        lastBroadcastTimestamp = timestamp;
        return; // Exit without showing the pop-up
      }

      // If we are here, the listener has run at least once.
      // Now, we only proceed if the timestamp in Firestore is *different*
      // from the one we already saw.
      if (timestamp.toMillis() === lastBroadcastTimestamp.toMillis()) {
        // This is the same message we've already seen. Do nothing.
        return;
      }
      // --- END NEW LOGIC ---

      // If we get this far, it means:
      // 1. It's not the first page load check.
      // 2. The timestamp is NEW.
      // This is a genuine, real-time update.
      
      lastBroadcastTimestamp = timestamp; // Store the new timestamp

      const overlay = document.getElementById('broadcastOverlay');
      const messageEl = document.getElementById('broadcastMessage');

      if (overlay && messageEl) {
        messageEl.textContent = message;
        overlay.style.display = 'flex'; // Show the overlay
      }

    }, (error) => {
      console.error("Broadcast listener error: ", error);
    });
  }

  function initChatListener() {
    if (chatListenerUnsubscribe) {
      chatListenerUnsubscribe();
      chatListenerUnsubscribe = null;
    }
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;
    const q = query(
      collection(db, "messages"), 
      orderBy("timestamp", "asc"),
      limitToLast(25)
    );
    chatListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
      let hasAdds = false; 
      querySnapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          if (isChatHistoryLoaded) {
            hasAdds = true; 
            const msg = change.doc.data();

            // +++ NEW: Quieter Chat Sound +++
            if (auth.currentUser && msg.senderUid !== auth.currentUser.uid) {
                // Check if global SFX is not muted
                if (game.settings && !game.settings.isSfxMuted) {
                    try {
                        const audio = new Audio('sounds/soundeffects/chatsound.mp3');
                        // VOLUME REDUCTION: 0.25 = 25% of the Master SFX Volume
                        const masterVol = game.settings.sfxVolume || 0.5;
                        audio.volume = Math.min(1, Math.max(0, masterVol * 0.25)); 
                        audio.play().catch(e => {});
                    } catch (e) {}
                }
            }
            // +++ END NEW +++

            const msgElement = document.createElement('div');
            msgElement.style.marginBottom = '6px';
            msgElement.style.lineHeight = '1.3';
            msgElement.style.wordBreak = 'break-word';
            const sender = document.createElement('strong');
            
            // Admin Color Check
            if (msg.senderUid === ADMIN_UID) {
              sender.style.color = '#ff4d4d'; // Admin Red
            } else {
              sender.style.color = 'var(--gold)'; // Default Gold
            }
            
            sender.textContent = msg.senderName ? `${msg.senderName}: ` : 'System: ';
            const text = document.createTextNode(msg.text);
            msgElement.appendChild(sender);
            msgElement.appendChild(text);
            chatMessagesContainer.prepend(msgElement);
          }
        }
      });
      if (!isChatHistoryLoaded) {
        isChatHistoryLoaded = true;
        let hadHistoryMessages = false;
        querySnapshot.docs.forEach(doc => {
            hadHistoryMessages = true;
            const msg = doc.data();
            const msgElement = document.createElement('div');
            msgElement.style.marginBottom = '6px';
            msgElement.style.lineHeight = '1.3';
            msgElement.style.wordBreak = 'break-word';
            const sender = document.createElement('strong');
            
            if (msg.senderUid === ADMIN_UID) {
              sender.style.color = '#ff4d4d'; // Admin Red
            } else {
              sender.style.color = 'var(--gold)'; // Default Gold
            }
            
            sender.textContent = msg.senderName ? `${msg.senderName}: ` : 'System: ';
            const text = document.createTextNode(msg.text);
            msgElement.appendChild(sender);
            msgElement.appendChild(text);
            chatMessagesContainer.prepend(msgElement);
        });
        let hadQueuedMessages = localMessageQueue.length > 0;
        localMessageQueue.forEach(msg => {
          addLocalChatMessage(msg.text, msg.type); 
        });
        localMessageQueue = []; 
        if (hadHistoryMessages || hadQueuedMessages) {
          chatMessagesContainer.scrollTop = 0;
        }
        while (chatMessagesContainer.childElementCount > 30) {
          chatMessagesContainer.lastChild.remove();
        }
      } 
      else if (hasAdds) {
        while (chatMessagesContainer.childElementCount > 30) {
          chatMessagesContainer.lastChild.remove();
        }
        chatMessagesContainer.scrollTop = 0;
      }
    }, (error) => {
      console.error("Chat listener error: ", error);
      chatMessagesContainer.innerHTML = '<div style="color: red;">Error loading chat.</div>';
    });
  }
  

  // --- LEADERBOARD FUNCTION (Unchanged) ---
  window.renderLeaderboards = async function() {
    const contentContainer = document.getElementById('leaderboardContent'); 
    if (!contentContainer) return;
    
    // --- FIX: Remove the line that clears innerHTML to prevent flash ---
    // contentContainer.innerHTML = `...`; // <-- THIS LINE IS DELETED
    
    try {
      const playersCol = collection(db, "players");
      const q = query(playersCol);
      const querySnapshot = await getDocs(q);
      let players = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (!data.name || data.name === "") return;
        
        // --- THIS IS THE FIX ---
        // We now get the totalXP from *all* skills and add them together.
        const miningXp = data.mining?.totalXP || 0; 
        const blacksmithXp = data.blacksmith?.totalXP || 0;
        const attackXp = data.attack?.totalXP || 0;
        const strengthXp = data.strength?.totalXP || 0;
        const defenceXp = data.defence?.totalXP || 0;
        const vitalityXp = data.vitality?.totalXP || 0;
        const cookingXp = data.cooking?.totalXP || 0;
        const woodcuttingXp = data.woodcutting?.totalXP || 0; // +++ NEW +++
        const fletchingXp = data.fletching?.totalXP || 0; // +++ NEW +++
        const craftingXp = data.crafting?.totalXP || 0; // +++ NEW +++
        const rangedXp = data.ranged?.totalXP || 0; 
        const fishingXp = data.fishing?.totalXP || 0; 
        const magicXp = data.magic?.totalXP || 0; 
        const stoneforgingXp = data.stoneforging?.totalXP || 0; // +++ NEW +++

        const totalXp = (data.mining?.totalXP || 0) + 
                        (data.blacksmith?.totalXP || 0) + 
                        (data.attack?.totalXP || 0) + 
                        (data.strength?.totalXP || 0) + 
                        (data.defence?.totalXP || 0) + 
                        (data.vitality?.totalXP || 0) + 
                        (data.cooking?.totalXP || 0) + 
                        (data.woodcutting?.totalXP || 0) + 
                        (data.fletching?.totalXP || 0) + 
                        (data.crafting?.totalXP || 0) + 
                        (data.ranged?.totalXP || 0) + 
                        (data.magic?.totalXP || 0) + 
                        (data.fishing?.totalXP || 0) + 
                        (data.stoneforging?.totalXP || 0) +
                        (data.bountyhunting?.totalXP || 0) +
                        (data.farming?.totalXP || 0) +
                        (data.petmastery?.totalXP || 0) +
                        (data.alchemy?.totalXP || 0) +
                        (data.tailoring?.totalXP || 0) +
                        (data.thieving?.totalXP || 0);
        // --- END OF FIX ---

        players.push({
          name: data.name,
          totalXp: totalXp,
        });
      });
      players.sort((a, b) => b.totalXp - a.totalXp);
      let leaderboardHtml = '';
      players.slice(0, 10).forEach((player, index) => {
        const rank = index + 1;
        const xpFormatted = player.totalXp.toLocaleString();
        const isCurrentPlayer = (auth.currentUser && game.name === player.name); 
        // --- MODIFIED DIV: ADD CLICK HANDLER & CURSOR ---
        leaderboardHtml += `
          <div 
            class="leaderboard-entry" 
            style="display: flex; justify-content: space-between; padding: 2px 10px; border-bottom: 1px dashed rgba(255,255,255,0.1); background: ${isCurrentPlayer ? 'rgba(181, 166, 66, 0.1)' : 'transparent'}; cursor: pointer;"
            data-name="${player.name}"
            onclick="window.inspectPlayer('${player.name}')"
          >
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="width: 20px; text-align: right; font-weight: bold; color: ${rank <= 3 ? 'var(--gold)' : '#fff'};">${rank}.</span>
              <span>${xpFormatted}</span>
            </div>
            <span style="font-weight: bold;">${player.name}</span>
          </div>
        `;
      });
      if(players.length === 0){
        leaderboardHtml += `<div style="text-align:center; padding: 20px; opacity: 0.7;">No players found. Start playing to get on the board!</div>`;
      }
      contentContainer.innerHTML = leaderboardHtml;
    } catch (e) {
      console.error("Failed to load leaderboards:", e);
      contentContainer.innerHTML = `<div style="text-align:center; margin-top: 0px; color: red;">Failed to load data.</div>`;
    }
  }
  
  // --- MODIFIED: Added Session Lock Button ---
  document.addEventListener('DOMContentLoaded', () => {
    if (refreshLeaderboardBtn) {
        refreshLeaderboardBtn.onclick = async () => {
          // --- NEW: Disable button and show loading text ---
          refreshLeaderboardBtn.disabled = true;
          refreshLeaderboardBtn.textContent = '...'; // Use '...' as it's small

          if (typeof window.savePlayerData === 'function') {
            await window.savePlayerData();
          }
          
          // --- NEW: Await the render so we can re-enable the button ---
          await window.renderLeaderboards(); 
          
          // --- NEW: Re-enable button ---
          refreshLeaderboardBtn.disabled = false;
          refreshLeaderboardBtn.textContent = 'Refresh';
        };
    }
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatInput = document.getElementById('chatInput');
    if (chatSendBtn) {
      chatSendBtn.onclick = sendChatMessage;
    }
    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault(); 
          sendChatMessage();
        }
      });
    }
    
    // +++ NEW: Session Lock Button +++
    const takeControlBtn = document.getElementById('takeControlButton');
    if (takeControlBtn) {
      takeControlBtn.onclick = () => {
        if (typeof window.acquireSessionLock === 'function') {
          // Pass true to force the takeover
          window.acquireSessionLock(true);
        }
      };
    }
  });

  // --- Game Loop (Runs every 1s) ---
  setInterval(() => {
      if (game.isSessionActive) {
          if (typeof processFarmLogic === 'function') processFarmLogic();
          
          // NEW: Updates the Lottery timer clock every second
          if (typeof updateLotteryTimer === 'function') updateLotteryTimer();
      }
       // +++ REFRESH THIEVING TARGETS IF TAB IS ACTIVE +++
      const thievingHub = document.getElementById('hubThieving');
      if (thievingHub && thievingHub.classList.contains('active')) {
          refreshThievingTargets();
      }
  }, 1000);

  // --- Autosave: Keep Session Lock Heartbeat ---
  // Now runs every 60 seconds instead of 5.
  setInterval(async () => {
    const user = auth.currentUser;
    if (user && game.isSessionActive && !document.hidden) {
      const playerRef = getPlayerRef();
      if (playerRef) {
          try {
              // We update the timestamp so other tabs know this one is still alive
              await updateDoc(playerRef, { "activeSession.timestamp": Date.now() }); 
          } catch (e) {}
      }
    }
  }, 60000);

  // --- Autosave: Heavy Data Save Every 60 Seconds ---
  setInterval(async () => {
    const user = auth.currentUser;
    if (user && game.isSessionActive && !document.hidden && game.isDirty) {
      console.log("Batched save triggered...");
      await window.savePlayerData();
    }
  }, 60000);

  // --- Emergency Save on Refresh/Close/Minimize ---
  const handleFinalSave = () => {
    if (game.isSessionActive && game.isDirty) {
       window.savePlayerData();
    }
  };

  window.addEventListener('beforeunload', (e) => {
      try {
        if (typeof window.returnEnchantItem === 'function' && game.enchantSlot) {
          window.returnEnchantItem();
        }
        handleFinalSave();
        if (typeof window.releaseSessionLock === 'function' && game.isSessionActive) {
          window.releaseSessionLock(false); 
        }
      } catch (err) {}
  });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      handleFinalSave();
    }
  });

  // --- MODIFIED: Releases session lock on logout ---
  window.firebaseLogout = async function() {
  try {
    // NEW: Return item from table to inventory before logging out
    if (typeof window.returnEnchantItem === 'function' && game.enchantSlot) {
      window.returnEnchantItem();
    }
    // 1. Stop all local game actions
    if (game.inCombat) runFromCombat(false);
    if (game.miningActive) stopMining();
    if (game.blacksmithingActive) stopBlacksmithing();
    if (game.cookingActive) stopCookingChicken();
    if (game.woodcuttingActive) stopWoodcutting();
    if (game.fletchingActive) stopFletching();
    if (game.craftingActive) stopCraftingBowString();
    if (game.fishingActive) stopFishing();
    if (game.stoneforgingActive) stopStoneForging();
    if (game.gatheringWaterActive) stopGatheringWater();
    
    game.autocastSpell = null;
    if (typeof renderSpellsPanel === 'function') renderSpellsPanel();

    // 2. Release Session Lock
    if (game.isSessionActive) {
      if (typeof window.releaseSessionLock === 'function') {
        await window.releaseSessionLock(true);
      }
    }
    stopSessionHeartbeat();
    
    // 3. Save Data
    await window.savePlayerData();
    
    // 4. +++ FIX: Unsubscribe from all listeners BEFORE signing out +++
    // This prevents "Missing Permissions" errors because the listeners won't try to read after auth is gone.
    if (typeof chatListenerUnsubscribe === 'function') { chatListenerUnsubscribe(); chatListenerUnsubscribe = null; }
    if (typeof updatesListenerUnsubscribe === 'function') { updatesListenerUnsubscribe(); updatesListenerUnsubscribe = null; }
    if (typeof broadcastListenerUnsubscribe === 'function') { broadcastListenerUnsubscribe(); broadcastListenerUnsubscribe = null; }
    if (typeof playerDocListener === 'function') { playerDocListener(); playerDocListener = null; }
    // +++ END FIX +++

    const settingsModal = document.getElementById('settingsModalOverlay');
    if (settingsModal) settingsModal.style.display = 'none';

    // 5. Sign Out
    await signOut(auth);
    
    await showGameAlert("Logged Out", "You have been successfully logged out.");
  } catch (e) {
    console.error("Logout failed:", e);
    await showGameAlert("Logout Failed", "Logout failed. Please try again or close your browser.");
  }
};

  (function() {
    // --- This is the new master preloader ---

    // Define all critical images your game needs to start
    const MASTER_ASSET_LIST = [
      // --- UI & Backgrounds ---
      'images/brickbackground.png', // Fixed name to match CSS
      'images/tittle.jpeg',         // Loading screen background
      'images/gearicon.png',
      'images/equipmenticon.png',   // Tab Icon
      'images/backpackicon.png',    // Tab Icon
      'images/skillicon.png',       // Tab Icon
      'images/questicon.png',       // Tab Icon
      'images/questbuttonicon.jpg', // Hub Icon

      // --- Equipment Placeholders ---
      'images/necklace.png',
      'images/cape.png',
      'images/shield.png',
      'images/legs.png',
      'images/ring.png',
      'images/arrows.png',
      'images/pet.png',             // Empty Pet Slot

      // --- Equipment Items ---
      'images/helmet.png',
      'images/weapon.png',
      'images/chestplate.png',
      'images/boots.png',
      'images/goldcrown.png',       // Rare Item
      'images/elegantblackcape.png', // New Jackpot
      'images/1tapper.png',         // Admin Item

      // --- Hub Icons ---
      'images/mines.png',
      'images/foresticon.png',
      'images/blacksmithicon.png',
      'images/kitchenbutton.png',
      'images/combatareas.png',
      'images/shopbutton.png',
      'images/bankbutton.png',
      'images/fletchingworkbench.png',
      'images/craftingbenchbutton.png',
      'images/elementalforge.jpeg',
      'images/fishingareasbutton.jpeg',
      'images/huntingboard.jpeg',
      'images/oceanbutton.png',
      'images/riverbutton.jpeg',
      'images/madmaxcastle.jpeg',
      'images/normalforest.jpeg',
      'images/darkforest.jpeg',
      'images/crazyowlmonster.jpeg',
      'images/witchmonster.jpeg',
      'images/goblinmonster.jpeg',
      'images/platypusmonster.jpeg',
      // +++ NEW FARM ASSETS +++
      'images/farmicon.jpeg',
      'images/petyardicon.jpeg',
      'images/petmasteryskillicon.jpeg',
      'images/petegg1.png',
      'images/incubator_empty.png',
      'images/incubator_active.png',
      'images/personalfarm.webp',
      'images/cropfield.jpeg', 
      // +++ Garden Assets +++
      'images/grassseed.png',
      'images/grassfirststage.png',
      'images/grasssecondstage.png',
      'images/grassthirdstage.png',
      'images/grass.png',
      'images/cornseed.png',
      'images/cornfirststage.png',
      'images/cornsecondstage.png',
      'images/cornthirdstage.png',
      'images/corn.png',

      // --- shrooms ---

      'images/dirtshroomfirststage.png',
      'images/dirtshroomsecondstage.png',
      'images/dirtshroomthirdstage.png',

      // --- Skill Icons ---
      'images/miningskillicon.png',
      'images/blacksmithskillicon.png',
      'images/attackskillicon.jpeg',
      'images/strengthskillicon.png',
      'images/defenseskillicon.png',
      'images/vitalityskillicon.png',
      'images/cookingskillicon.png',
      'images/woodcuttingskillicon.jpeg',
      'images/fletchingskillicon.jpeg',
      'images/craftingskillicon.png',
      'images/rangedskillicon.jpeg',
      'images/fishingskillicon.jpeg',
      'images/magicskillicon.jpeg',
      'images/stoneforgingskillicon.jpeg',
      'images/bountyhunterskillicon.jpeg',

      // --- Items: Ores & Bars ---
      'images/copper_ore.png',
      'images/copperbar.png',
      'images/coalore.png',
      'images/ironore.png',
      'images/ironbar.png',
      'images/silverbar.png',
      'images/goldbar.png',
      'images/sand.png',
      'images/goldpouch.png',

      // --- Items: Copper Gear ---
      'images/coppershortsword.png',
      'images/copperhelmet.png',
      'images/copperchestplate.png',
      'images/copperboots.png',
      'images/copperplatelegs.png',
      'images/copperpickaxe.png',
      'images/copperaxe.png',

      // --- Items: Iron Gear ---
      'images/ironshortsword.png',
      'images/ironhelmet.png',
      'images/ironchestplate.png',
      'images/ironboots.png',
      'images/ironplatelegs.png',
      'images/ironpickaxe.png',
      'images/ironaxe.png',
      'images/silverpickaxe.png',
      'images/silveraxe.png',

      // --- Items: Bronze Tools ---
      'images/bronzepickaxe.png',
      'images/bronzeaxe.png',

      // --- Items: Food (Raw/Cooked/Burnt) ---
      'images/rawchicken.png',
      'images/cookedchicken.png',
      'images/burntchicken.png',
      'images/beef.png',
      'images/cookedbeef.png',
      'images/burntbeef.png',
      'images/herring.png',
      'images/cookedherring.png', // Missing
      'images/burntherring.png',  // Missing
      'images/trout.png',
      'images/cookedtrout.png',   // Missing
      'images/burnttrout.png',    // Missing
      'images/salmon.png',
      'images/cookedsalmon.png',  // Missing
      'images/burntsalmon.png',   // Missing

      // --- Items: Magic/Crystals ---
      'images/earthcrystalshard.png',
      'images/aircrystalshard.png',
      'images/watercrystalshard.png',
      'images/earthstone.png',
      'images/airstone.png',
      'images/waterstone.png',
      'images/magicstaff.png',
      'images/wizardhat.png',
      'images/wizardrobe.png',
      'images/wizardtrousers.png',
      'images/wizardboots.png',
      
      // --- Spell Icons (Were Missing) ---
      'images/earthbolt.jpeg',
      'images/airbolt.jpeg',
      'images/waterbolt.jpeg',

      // --- Items: Crafting/Fletching ---
      'images/softwood.png',
      'images/oak.png',
      'images/feather.png',
      'images/arrowshaft.png',
      'images/copperarrowtip.png',
      'images/unboundarrow.png',
      'images/copperarrow.png',
      'images/bowstring.png',
      'images/unstrungsoftwoodbow.png',
      'images/unstrungoakbow.png',
      'images/softwoodbow.png',
      'images/oakbow.png',
      'images/cowhide.png',
      'images/leather.png',
      'images/leatherhood.png',
      'images/leatherarmor.png',
      'images/leatherpants.png',
      'images/leatherboots.png',
      'images/silk.png',
      'images/cloth.png',
      'images/emptyvial.png',
      'images/venom.png',
      'images/lotteryticket.png', // +++ NEW +++
      'images/wildherb.png',
      'images/goldring.png',
      'images/diamondring.png',
      'images/emeraldring.png',
      'images/rubyring.png',
      'images/sapphirering.png',
      'images/topazring.png',
      'images/alchemyicon.jpeg',
      'images/alchemyskillicon.jpeg',
      'images/vitalitypotion.png',
      'images/thievingicon.jpeg',
      'images/thievingskillicon.jpeg',
      'images/tailoringtable.png',
      'images/tailoringskillicon.jpeg',
      
      // --- Items: Fishing ---
      'images/fishingpole.png',
      'images/fishingbait.png',
      
      // --- Farm Items ---
      'images/personalchicken.png',
      'images/egg.png',

      // --- Monsters & Animals ---
      'images/chickenmonster.jpeg',
      'images/chickenanim.gif',
      'images/cowmonster.png',
      'images/cowanim.webp',
      'images/cowanim.webp',
      'images/ratmonster.jpeg', 
      'images/ratanim.webp',
      'images/rattail.png',
      'images/spidermonster.jpeg',
      'images/spideranim.gif',
      'images/centipedemonster.jpeg',
      'images/centipedeanim.webp',
      'images/madmaxmonster.jpeg',
      'images/madmaxanim.webp',

      // --- Veins ---
      'images/coppervein.png',
      'images/coalvein.png',
      'images/ironvein.png',
      'images/sandvein.jpeg',
      'images/silvervein.jpeg',
      'images/goldvein.jpeg',
      'images/silverore.png',
      'images/goldore.png',
      'images/crystalmine.jpeg',
      'images/earthcrystalvein.png',
      'images/aircrystalvein.png',
      'images/watercrystalvein.png',
      // +++ NEW GEMS +++
      'images/uncuttopaz.png',
      'images/uncutdiamond.png',
      'images/uncutemerald.png',
      'images/uncutjade.png',
      'images/uncutruby.png',
      'images/uncutsapphire.png',
      // +++ NEW CUT GEMS +++
      'images/topaz.png',
      'images/diamond.png',
      'images/emerald.png',
      'images/jade.png',
      'images/ruby.png',
      'images/sapphire.png',
      'images/silverfangsofthefallenmonarch.png'
    ];

   /**
     * Preloads assets using standard onload (Robust & Error-Free)
     * @param {string[]} assetList - Array of image paths
     * @returns {Promise}
     */
    function preloadAllAssets(assetList) {
      const authScreen = document.getElementById('authScreen');
      if (authScreen) authScreen.style.display = 'none';

      const loadingScreen = document.getElementById('loadingScreen');
      loadingScreen.style.display = 'flex'; 
      
      const progressBarFill = document.getElementById('loading-bar-fill');
      const progressPercentText = document.getElementById('loading-progress-percent');
      
      const cacheContainer = document.getElementById('asset-cache');

      if (cacheContainer) {
          setInterval(() => {
              cacheContainer.style.opacity = (cacheContainer.style.opacity === '0.001') ? '0.002' : '0.001';
          }, 10000); 
      }

      let loadedCount = 0;
      const totalAssets = assetList.length;

      const promises = assetList.map(src => {
        return new Promise((resolve) => {
          const img = new Image();
          
          // +++ CHANGED: Use .onload instead of .decode() +++
          // This is the standard way to load images. It is much less strict
          // and will accept your files exactly as they are.
          img.onload = () => {
              if (cacheContainer) {
                  cacheContainer.appendChild(img);
              }
              updateProgress();
              resolve();
          };

          img.onerror = () => {
              // If a file is truly missing, we log a simple warning but keep loading
              console.warn(`[Preloader] Could not load: ${src}`);
              updateProgress();
              resolve();
          };

          img.src = src;
        });
      });

      function updateProgress() {
          loadedCount++;
          const percent = Math.round((loadedCount / totalAssets) * 100);
          if (progressBarFill) progressBarFill.style.width = percent + '%';
          if (progressPercentText) progressPercentText.innerText = percent + '%';
      }

      return Promise.all(promises);
    }

    // Run the preloader
    preloadAllAssets(MASTER_ASSET_LIST).then(() => {
      console.log('[Preloader] All assets loaded.');

      // +++ FIX: FORCE-DECODE ALL MONSTER ANIMATIONS +++
      // We define the list of animations explicitly here to ensure they are cached.
      // These filenames match exactly what is used in openCombatInterface.
      const monsterAnims = [
        'images/chickenanim.gif',
        'images/ratanim.webp',
        'images/spideranim.gif',
        'images/centipedeanim.webp',
        'images/cowanim.webp',
        'images/madmaxanim.webp'
      ];

      const cacheContainer = document.getElementById('asset-cache');
      
      monsterAnims.forEach(src => {
          // Create a new image element for the cache
          const img = new Image();
          img.src = src;
          
          // Apply styles to keep it hidden but active in the DOM
          img.style.position = 'absolute';
          img.style.top = '-9999px';
          img.style.left = '-9999px';
          img.style.width = '1px'; 
          img.style.height = '1px';
          
          // 'eager' tells the browser to load this immediately, even if off-screen
          img.setAttribute('loading', 'eager'); 
          
          // Append to the hidden cache container (or body if container is missing)
          if (cacheContainer) {
              cacheContainer.appendChild(img);
          } else {
              document.body.appendChild(img);
          }
      });
      // +++ END FIX +++
      
      const loadingScreen = document.getElementById('loadingScreen');
      
      if (loadingScreen) {
        loadingScreen.style.display = 'none'; // Hide loading
      }

      // --- We removed the code that shows the authScreen ---
      // The onAuthStateChanged listener will now handle showing
      // the correct screen (login OR game) without a flash.

    });

  })();


  
</script>
</body>
</html>