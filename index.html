<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rustic Skilling & Crafting Game</title>
<style>
 /* --- Base / Background --- */
:root {
  --panel-bg: rgba(64, 40, 20, 0.95); /* Deeper, earthier brown */
  --accent: #6d452d; /* Darker, richer wood tone */
  --accent-hover: #8a5a3a; /* Darker hover effect */
  --gold: #b5a642;
  --slot-size: 60px;
  --slot-gap: 10px;
}
body {
  margin: 0;
  font-family: "Garamond", serif;
  /* --- NEW BACKGROUND START --- */
  background: #3f2b21; /* Fallback color for dark brick */
  background-image: url('images/brick_background.png');
  background-size: cover; /* Ensures the image covers the entire screen */
  background-attachment: fixed; /* Keeps the background static */
  background-position: center center; /* Centers the background image */
  /* --- NEW BACKGROUND END --- */
  color: #fff;
  -webkit-font-smoothing: antialiased;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

/* --- Start / Game screens --- */
#startScreen, #gameScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
}
#gameScreen { display: none; }

/* --- Layout container (MODIFIED) --- */
.container {
  width: 100%;
  max-width: 1240px;
  display: flex;
  flex-direction: column; /* <-- CHANGED: Now a column layout */
  gap: 20px;
  padding: 24px;
  box-sizing: border-box;
  margin: 0 auto;
}

/* --- +++ NEW: Panel Row Wrappers +++ --- */
#top-row-panels {
  display: flex;
  gap: 20px;
  align-items: stretch; /* <-- This makes all 3 panels the same height */
  width: 100%;
}

#bottom-row-chat {
  display: flex;
  gap: 20px;
  width: 100%;
}

/* --- +++ NEW: Spacer for Chat Panel +++ --- */
.sidebar-spacer {
  /* This width MUST match the .sidebar width */
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  flex-shrink: 0; /* Prevents it from shrinking */
}


/* --- Sidebar --- */
.sidebar {
  width: calc((var(--slot-size) * 4) + (var(--slot-gap) * 3) + 32px + 8px);
  background: var(--panel-bg);
  padding: 16px;
  border-radius: 10px; /* Slightly less rounded */
  /* Worn/Sturdy Shadow: Inner shadow for depth, outer shadow for lift */
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.4);
  /* Strong, dark border for a rustic frame look */
  border: 4px solid #453625;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.char-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.char-header h2, .main h2, #leaderboardPanel h2 { 
  margin: 0; 
  font-size: 20px; /* <-- GUARANTEED: Sets all main h2s to 20px */
}

.hp-bar { background: #772222; border-radius: 6px; overflow: hidden; margin-bottom: 12px; position: relative; height: 28px; }
.hp-fill { height: 100%; background: #d22; width: 100%; transition: width 0.25s; }
.hp-text { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.7); font-size: 13px; }

.tabs { display: flex; gap: 8px; margin-bottom: 12px; }
.tabs button { flex: 1; padding: 10px; border-radius: 8px; border: 0; background: var(--accent); color: #fff; cursor: pointer; font-weight: 700; }
.tabs button:hover { background: var(--accent-hover); }

/* --- Equipment / Inventory / Skills --- */
.tab-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* keep content at top */
}

/* Equipment slots vertically centered between tabs and bottom */
#equipmentTab {
  display: flex;
  flex-direction: column;
  justify-content: center;
  flex-grow: 1;
  padding-top: 70px; /* lowers them a bit */
}

.equipment-character { display: flex; justify-content: center; }
.character-frame { display: flex; flex-direction: column; align-items: center; }
.equipment-row { display: flex; justify-content: center; margin: 6px 0; gap: 10px; }
.equipment-slot {
  width: var(--slot-size); height: var(--slot-size);
  background: #c69c6d;
  border-radius: 8px;
  border: 2px solid rgba(170,140,100,0.55);
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
  display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.equipment-slot img { width: 100%; height: 100%; object-fit: contain; display: block; }

/* --- Inventory --- */
.inventory-grid-wrap {
  width: 100%;
  height: calc((var(--slot-size) + var(--slot-gap)) * 4);
  overflow-y: auto;
  overflow-x: hidden; /* prevent side scroll */
  padding-right: 0; /* <-- MODIFIED: Removed 6px padding */
  
  /* --- NEW: For Firefox --- */
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}
.inventory-grid {
  display: grid;
  /* --- FIX: Use auto-fit to force 4 columns within the space. --- */
  grid-template-columns: repeat(auto-fit, minmax(var(--slot-size), 1fr));
  gap: var(--slot-gap);
  /* Ensure padding is uniform and matches the gap */
  padding: var(--slot-gap); 
  align-content: start;
}
.inv-slot {
  width: var(--slot-size); height: var(--slot-size);
  background: #c8b89a33;
  border-radius: 8px;
  border: 2px solid rgba(120,90,50,0.25);
  position: relative;
  display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.inv-slot img { width: 100%; height: 100%; object-fit: contain; display: block; pointer-events: none; }
.inv-amount {
  position: absolute;
  right: 4px; bottom: 4px;
  background: rgba(0,0,0,0.6);
  padding: 2px 5px;
  font-size: 12px;
  border-radius: 6px;
  color: #fff;
  font-weight: 700;
  pointer-events: none;
}

/* --- Tooltip --- */
.tooltip {
  position: fixed;
  pointer-events: none;
  background: rgba(20,20,20,0.95);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  z-index: 2000;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
  max-width: 240px;
}

/* --- +++ NEW: Custom Scrollbar for WebKit (Chrome, Safari) +++ --- */
.inventory-grid-wrap::-webkit-scrollbar,
#chatMessages::-webkit-scrollbar {
  width: 8px; /* Sets the width of the scrollbar */
}
.inventory-grid-wrap::-webkit-scrollbar-track,
#chatMessages::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2); /* Dark, subtle track background */
  border-radius: 4px;
}
.inventory-grid-wrap::-webkit-scrollbar-thumb,
#chatMessages::-webkit-scrollbar-thumb {
  background: var(--accent); /* Uses your game's accent color for the handle */
  border-radius: 4px;
}
.inventory-grid-wrap::-webkit-scrollbar-thumb:hover,
#chatMessages::-webkit-scrollbar-thumb:hover {
  background: var(--accent-hover); /* Uses your hover color */
}
/* --- +++ END: Custom Scrollbar +++ --- */


/* --- Main area (MODIFIED) --- */
.main {
  flex: 1; /* <-- RE-ADDED: To fill the middle space */
  background: var(--panel-bg);
  padding: 18px;
  border-radius: 10px; /* Slightly less rounded */
  /* Worn/Sturdy Shadow: Inner shadow for depth, outer shadow for lift */
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.4);
  /* Strong, dark border for a rustic frame look */
  border: 4px solid #453625;
  min-height: 500px; 
  position: relative;
}

/* +++ NEW CHAT PANEL STYLE (MODIFIED) +++ */
.chat-panel {
  background: var(--panel-bg);
  padding: 18px;
  border-radius: 10px;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.4);
  border: 4px solid #453625;
  display: flex; 
  flex-direction: column;
  min-height: 200px; /* Give it a minimum height */
  flex-shrink: 0;
  flex: 1; /* <-- ADDED: To fill the middle space in its row */
}

/* --- THIS IS THE CHAT MESSAGES DIV --- */
#chatMessages {
  flex-grow: 1; 
  background: rgba(0,0,0,0.2); 
  border-radius: 6px; 
  padding: 8px; 
  overflow-y: auto; 
  height: 150px; 
  display: flex; 
  flex-direction: column-reverse;
  
  /* --- NEW: For Firefox --- */
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--panel-bg);
}

#chatInputContainer { 
  display: flex; 
  gap: 8px; 
  margin-top: 10px;
}

#chatInput { 
  flex-grow: 1; 
  padding: 8px; 
  border-radius: 6px; 
  border: 1px solid var(--accent); 
  background: #3f2b21; 
  color: #fff;
}
/* --- END CHAT STYLES --- */


.progress-container {
  background: #3f2b21;
  border-radius: 10px;
  height: 24px;
  overflow: hidden;
  position: relative;
}
.progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.08s; }

.action-buttons { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }

button.primary {
  background: var(--accent); color: #fff; border: 0; padding: 10px 14px; border-radius: 8px; font-weight: 700; cursor: pointer;
}
button.primary:hover { background: var(--accent-hover); }

.xp-popup {
  position: absolute;
  background: #ffd700cc;
  color: #000;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 800;
  pointer-events: none;
  z-index: 1500;
  transform-origin: center;
  animation: rise 900ms ease-out forwards;
  box-shadow: 0 8px 18px rgba(0,0,0,0.35);
}
@keyframes rise {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-46px); opacity: 0; }
}

@media(max-width:900px) {
  /* MODIFIED for new structure */
  .container { flex-direction: column; align-items: center; }
  
  /* Make all panels full width and stack */
  #top-row-panels, #bottom-row-chat {
      flex-direction: column;
      width: 95%;
  }
  .sidebar, .main, .chat-panel { 
      width: 100%; /* Make them fill the 95% wrapper */
      box-sizing: border-box;
  }
  /* Hide the spacers on mobile */
  .sidebar-spacer {
      display: none;
  }
}

</style>
</head>
<body>

<div id="authScreen" style="display:flex; align-items:center; justify-content:center; width:100%;">
  <div style="background:rgba(0,0,0,0.15); padding:26px; border-radius:12px; text-align:center;">
    <h1>Login or Register</h1>
    <input id="authEmail" placeholder="Email" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:8px;"><br>
    <input id="authPassword" type="password" placeholder="Password" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:12px;"><br>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button class="primary" id="registerBtn">Register</button>
      <button class="primary" id="loginBtn" style="background:#666;">Login</button>
    </div>
    <div style="margin-top:12px; font-size:13px; opacity:0.9;">
      After login you will name your character and begin.
    </div>
  </div>
</div>

<div id="startScreen" style="display:none;">
  <div style="background:rgba(0,0,0,0.15); padding:26px; border-radius:12px; text-align:center;">
    <h1>Create your character</h1>
    <input id="playerName" placeholder="Enter name" style="padding:10px; font-size:16px; border-radius:8px; border:none; margin-bottom:12px;">
    <br>
    <button class="primary" onclick="createCharacter()">Create Character</button>
    <p style="margin-top:10px; font-size:13px; opacity:0.9;">Images: place them in <code>images/</code> (optional)</p>
  </div>
</div>


<div id="gameScreen">
  <div class="container">
    
    <div id="top-row-panels">
      
      <div class="sidebar">
        <div class="char-header">
          <h2 id="charName">Player</h2>
        </div>
        <div class="hp-bar">
          <div class="hp-fill" id="hpFill" style="width:100%"></div>
          <div class="hp-text" id="hpText">10 / 10 HP</div>
        </div>
        <div class="tabs">
          <button onclick="showTab('equipment')" id="tabEquipmentBtn">Equipment</button>
          <button onclick="showTab('inventory')" id="tabInventoryBtn">Inventory</button>
          <button onclick="showTab('skills')" id="tabSkillsBtn">Skills</button>
        </div>
        <div class="tab-content">
          <div id="equipmentTab">
            <div class="equipment-character">
              <div class="character-frame">
                <div class="equipment-row">
                  <div class="equipment-slot" id="helmet">
                    <img src="images/helmet.png" alt="Helmet">
                  </div>
                </div>
                <div class="equipment-row" style="align-items:center;">
                  <div class="equipment-slot" id="weapon">
                    <img src="images/weapon.png" alt="Weapon">
                  </div>
                  <div class="equipment-slot" id="chest">
                    <img src="images/chestplate.png" alt="Chest">
                  </div>
                </div>
                <div class="equipment-row">
                  <div class="equipment-slot" id="boots">
                    <img src="images/boots.png" alt="Boots">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="inventoryTab" style="display:none;">
            <div style="margin-bottom:8px; font-size:13px; color:#efe3cf;">Inventory</div>
            <div class="inventory-grid-wrap" id="inventoryGridWrap">
              <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
          </div>
          <div id="skillsTab" style="display:none;">
            <div style="font-size:14px; margin-bottom:8px;">Skills</div>
            <div>Mining: <span id="miningLevel">1</span> — XP: <span id="miningXP">0</span> / <span id="nextXP">100</span> (Total: <span id="miningTotalXP">0</span>)</div>
          </div>
        </div>
      </div>

      <div class="main" id="mainArea">
        <div id="mainContentWrapper">
          <h2>Actions</h2>
          <div id="actionScreen">
            <button class="primary" onclick="openMine()">Beginner Mine</button>
          </div>
        </div>
        <button onclick="firebaseLogout()" class="primary" style="position: absolute; bottom: 18px; right: 18px; background: #900;">Log Out</button>
      </div>

      <div class="sidebar" id="leaderboardPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h2>Leaderboard</h2>
          <button id="refreshLeaderboardBtn" class="primary" style="padding: 6px 10px; font-size: 12px;">Refresh</button>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid var(--accent); margin-bottom: 2px;">
          <span style="font-weight: bold;">TOTAL XP</span>
          <span style="font-weight: bold;">NAME</span>
        </div>
        <div id="leaderboardContent">
          <div style="text-align:center; margin-top: 10px; color: #fff; opacity: 0.7;">Loading leaderboard...</div>
        </div>
      </div>

    </div> <div id="bottom-row-chat">

      <div class="sidebar-spacer"></div>

      <div class="chat-panel" id="chatPanel">
        <div id="chatMessages">
          </div>
        
        <div id="chatInputContainer">
          <input id="chatInput" type="text" placeholder="Type message...">
          <button id="chatSendBtn" class="primary" style="padding: 8px 12px;">Send</button>
        </div>
      </div>

      <div class="sidebar-spacer"></div>

    </div> </div> </div>
<div id="tooltip" class="tooltip" style="display:none;"></div>

<script>
// --- Game State (Unchanged) ---
const game = {
  name: '',
  hp: 10,
  maxHP: 10,
  inventory: {},
  inventoryCapacity: 39,
  // MODIFIED: Added totalXP
  mining: { level: 1, xp: 0, totalXP: 0 },
  miningActive: false,
  progressFrame: null
};

// --- All your original game functions (setText, formatAmount, etc.) are unchanged ---
function setText(id, text){ const el=document.getElementById(id); if(el) el.innerText=text; }

function formatAmount(n) {
  if (n < 1000) {
    return n.toString();
  }
  if (n < 1000000) {
    const val = (n / 1000).toFixed(2);
    return parseFloat(val) + 'k';
  }
  const val = (n / 1000000).toFixed(2);
  return parseFloat(val) + 'M';
}

function createCharacter(){
  const name = document.getElementById('playerName').value.trim();
  if(!name) return; 
  game.name = name;
  document.getElementById('charName').innerText = name;
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'block';
  updateHPUI();
  renderInventoryGrid();
  updateSkillUI();
}

function updateHPUI(){
  const percent = Math.min(100, Math.round((game.hp / game.maxHP) * 100));
  document.getElementById('hpFill').style.width = percent + '%';
  setText('hpText', `${game.hp} / ${game.maxHP} HP`);
}

function showTab(tab){
  document.getElementById('equipmentTab').style.display = 'none';
  document.getElementById('inventoryTab').style.display = 'none';
  document.getElementById('skillsTab').style.display = 'none';
  document.getElementById(tab + 'Tab').style.display = 'block';
}

function renderInventoryGrid(){
  const grid = document.getElementById('inventoryGrid');
  grid.innerHTML = '';
  const capacity = game.inventoryCapacity;
  const entries = Object.entries(game.inventory);
  const slots = new Array(capacity).fill(null);

  for(let i=0;i<entries.length && i<capacity;i++){
    slots[i] = { name: entries[i][0], qty: entries[i][1] };
  }

  for(let i=0;i<capacity;i++){
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    if(slots[i]){
      const item = slots[i];
      const img = document.createElement('img');
      const imgName = item.name.toLowerCase().replace(/\s+/g,'_');
      img.src = `images/${imgName}.png`;
      img.alt = item.name;
      img.onerror = function(){ this.style.opacity='0.08'; this.style.filter='grayscale(90%)'; };
      slot.appendChild(img);
      const amt = document.createElement('div');
      amt.className = 'inv-amount';
      amt.innerText = formatAmount(item.qty); 
      slot.appendChild(amt);
      const exactAmount = item.qty.toLocaleString(); 
      const itemName = item.name;
      const tooltipContent = `
        <div style="font-weight:bold; color:var(--gold); margin-bottom:4px;">${itemName}</div>
        <div style="color:#fff;">Amount: ${exactAmount}</div>
      `;
      slot.onmouseenter = (evt) => {
        showTooltip(evt, tooltipContent);
      };
      slot.onmouseleave = () => {
        hideTooltip();
      };
    }
    grid.appendChild(slot);
  }
}
function addItem(name, qty=1){
  if(!game.inventory[name]) game.inventory[name]=0;
  game.inventory[name]+=qty;
  renderInventoryGrid();
}

const tooltip = document.getElementById('tooltip');

function showTooltip(evt, content) {
  if (!tooltip) return;
  tooltip.innerHTML = content;
  tooltip.style.display = 'block';
  moveTooltip(evt);
}

function hideTooltip() {
  if (!tooltip) return;
  tooltip.style.display = 'none';
}

function moveTooltip(evt) {
  if (!tooltip || tooltip.style.display === 'none') return;
  const tooltipRect = tooltip.getBoundingClientRect();
  let x = evt.clientX + 10;
  let y = evt.clientY + 10;
  if (x + tooltipRect.width > window.innerWidth) {
    x = evt.clientX - tooltipRect.width - 10;
  }
  if (y + tooltipRect.height > window.innerHeight) {
    y = evt.clientY - tooltipRect.height - 10;
  }
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function getNextXP(level){ return Math.floor(100 * Math.pow(1.15, level-1)); }
function updateSkillUI(){
  setText('miningLevel', game.mining.level);
  setText('miningXP', game.mining.xp);
  setText('nextXP', getNextXP(game.mining.level));
  setText('miningTotalXP', game.mining.totalXP); 
}

function addXP(skill, amount){
  game[skill].totalXP += amount; 
  game[skill].xp += amount;
  while(game[skill].xp >= getNextXP(game[skill].level)){
    game[skill].xp -= getNextXP(game[skill].level);
    game[skill].level++;
  }
  updateSkillUI();
  const main = document.getElementById('mainArea');
  const popup = document.createElement('div');
  popup.className = 'xp-popup';
  popup.innerText = `+${amount} ${skill.toUpperCase()} XP`;
  const bar = document.getElementById('mineProgress');
  if (bar) {
    const barRect = bar.getBoundingClientRect();
    const mainRect = main.getBoundingClientRect();
    const relativeX = barRect.left - mainRect.left;
    const relativeY = barRect.top - mainRect.top;
    popup.style.left = (relativeX + barRect.width / 2 - 40) + 'px';
    popup.style.top = (relativeY - 30) + 'px';
  } else {
    popup.style.left = '50%';
    popup.style.top = '120px';
    popup.style.transform = 'translateX(-50%)';
  }
  main.appendChild(popup);
  setTimeout(()=>popup.remove(), 900);
}

const MINE_TIME_MS = 1500;
const MINE_XP = 15;
const MINE_ITEM = 'Copper Ore';

function openMine(){
  const wrapper = document.getElementById('mainContentWrapper');
  wrapper.innerHTML = `
    <h2>Beginner Mine — Copper vein</h2>
    <div style="margin-top:8px; color:#efe3cf;">A low level copper vein.</div>
    <div style="margin-top:16px;">
      <div class="progress-container">
        <div class="progress-fill" id="mineProgress"></div>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:14px;">
      <button id="startMineBtn" class="primary">Start Mining</button>
      <button id="stopMineBtn" class="primary" style="background:#555; display:none;">Stop Mining</button>
      <button onclick="backToActions()" class="primary" style="background:#666;">Return</button>
    </div>
  `;
  document.getElementById('startMineBtn').onclick = startMining;
  document.getElementById('stopMineBtn').onclick = stopMining;
}

function startMining(){
  if(game.miningActive) return;
  game.miningActive = true;
  document.getElementById('startMineBtn').style.display = 'none';
  document.getElementById('stopMineBtn').style.display = 'inline-block';
  miningLoop();
}

function miningLoop(){
  const bar = document.getElementById('mineProgress');
  if(!bar || !game.miningActive) return;

  let start = performance.now();
  function animate(now){
    const elapsed = now - start;
    const progress = Math.min(100, (elapsed / MINE_TIME_MS) * 100);
    bar.style.width = progress + '%';

    if(progress >= 100){
      addItem(MINE_ITEM, 1);
      addXP('mining', MINE_XP);
      bar.style.width = '0%';
      if(game.miningActive){
        start = performance.now();
        requestAnimationFrame(animate);
      }
      return;
    }
    if(game.miningActive) game.progressFrame = requestAnimationFrame(animate);
  }
  game.progressFrame = requestAnimationFrame(animate);
}

function stopMining(){
  game.miningActive = false;
  if(game.progressFrame) cancelAnimationFrame(game.progressFrame);
  const bar = document.getElementById('mineProgress');
  if(bar) bar.style.width = '0%';
  document.getElementById('startMineBtn').style.display = 'inline-block';
  document.getElementById('stopMineBtn').style.display = 'none';
}

function backToActions(){
  stopMining();
  const wrapper = document.getElementById('mainContentWrapper');
  wrapper.innerHTML = `
    <h2>Actions</h2>
    <div id="actionScreen">
      <button class="primary" onclick="openMine()">Beginner Mine</button>
      <div style="margin-top:14px; color:#efe3cf; font-size:13px;">
        Use the left panel to switch between equipment, inventory and skills.
      </div>
    </div>
  `;
}

function resetGameState() {
  if (game.miningActive) {
    stopMining(); 
  }
  game.name = '';
  game.hp = 10;
  game.maxHP = 10;
  game.inventory = {};
  game.mining = { level: 1, xp: 0, totalXP: 0 };
  game.miningActive = false;
  if (game.progressFrame) {
    cancelAnimationFrame(game.progressFrame);
    game.progressFrame = null;
  }
  setText('charName', 'Player');
  updateHPUI();
  renderInventoryGrid();
  updateSkillUI();
  if (typeof backToActions === 'function') {
    backToActions();
  }
  if (typeof showTab === 'function') {
    showTab('equipment');
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  showTab('equipment');
  window.resetGameState = resetGameState;
  document.addEventListener('mousemove', moveTooltip);
});
</script>

<script type="module">
  // Firebase imports (CDN modules)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  // +++ ADDED CHAT IMPORTS +++
  import {
    getFirestore, doc, setDoc, getDoc, collection, query, getDocs, where,
    addDoc, serverTimestamp, onSnapshot, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  
  // --- Your Firebase config (Unchanged) ---
  const firebaseConfig = {
    apiKey: "AIzaSyD6sIi0SbPUUjJFJsJB22xBOF7ZD0H7utw",
    authDomain: "skill-3d8e1.firebaseapp.com",
    projectId: "skill-3d8e1",
    storageBucket: "skill-3d8e1.firebasestorage.app",
    messagingSenderId: "973290752767",
    appId: "1:973290752767:web:e80faba45f8707603d9aca"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM refs (Unchanged)
  const authScreen = document.getElementById('authScreen');
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');
  const refreshLeaderboardBtn = document.getElementById('refreshLeaderboardBtn'); 

  // --- All helper functions (save, load, etc.) are unchanged ---
  window.savePlayerData = async function() {
    try {
      const user = auth.currentUser;
      if (!user) return;
      const nameToSave = game.name || ""; 
      const payload = {
        name: nameToSave,
        name_lowercase: nameToSave.toLowerCase(),
        hp: game.hp,
        maxHP: game.maxHP,
        inventory: game.inventory || {},
        mining: {
          level: game.mining.level,
          xp: game.mining.xp,
          totalXP: game.mining.totalXP 
        },
        updatedAt: new Date().toISOString()
      };
      await setDoc(doc(db, "players", user.uid), payload, { merge: true });
    } catch (e) {
      console.error("Save failed:", e);
    }
  }

  async function loadPlayerDataAndStart(user) {
    try {
      const ref = doc(db, "players", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists() || !snap.data().name) {
        authScreen.style.display = 'none';
        startScreen.style.display = 'block';
        gameScreen.style.display = 'none';
        return false;
      }
      const data = snap.data();
      game.name = data.name || game.name || "Adventurer";
      game.hp = (typeof data.hp === 'number') ? data.hp : game.hp;
      game.maxHP = (typeof data.maxHP === 'number') ? data.maxHP : game.maxHP;
      game.inventory = data.inventory || {};
      if (data.mining) {
        game.mining.level = data.mining.level || game.mining.level;
        game.mining.xp = data.mining.xp || game.mining.xp;
        game.mining.totalXP = data.mining.totalXP || 
                              (data.mining.level > 1 ? estimateTotalXP(data.mining.level - 1) + data.mining.xp : data.mining.xp) || 0; 
      }
      document.getElementById('charName').innerText = game.name;
      startScreen.style.display = 'none';
      authScreen.style.display = 'none';
      gameScreen.style.display = 'block';
      updateHPUI();
      renderInventoryGrid();
      updateSkillUI();
      window.renderLeaderboards(); 
      return true;
    } catch (e) {
      console.error("Load failed:", e);
      return false;
    }
  }

  function estimateTotalXP(level) {
    let total = 0;
    for(let i = 1; i < level; i++) {
        total += getNextXP(i);
    }
    return total;
  }

  // Auth handlers (register, login) are unchanged
  registerBtn.onclick = async function() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return alert("Enter email and password.");
    try {
      const uc = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "players", uc.user.uid), {
        name: "",
        name_lowercase: "",
        hp: 10,
        maxHP: 10,
        inventory: {},
        mining: { level: 1, xp: 0, totalXP: 0 },
        createdAt: new Date().toISOString()
      });
      alert("Account created. Now create your character."); 
    } catch (err) {
      alert(err.message || "Registration failed.");
      console.error(err);
    }
  };

  loginBtn.onclick = async function() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return alert("Enter email and password.");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert(err.message || "Login failed."); 
      console.error(err);
    }
  };

  // +++ MODIFIED Auth state listener +++
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const started = await loadPlayerDataAndStart(user);
      
      // +++ ADDED THIS CHECK +++
      if (started) {
        // If game data was loaded, start the chat
        initChatListener();
      } else {
        // Show create-character screen
        startScreen.style.display = 'block';
        gameScreen.style.display = 'none';
        authScreen.style.display = 'none';
      }
    } else {
      // No user => show auth UI
      authScreen.style.display = 'flex';
      startScreen.style.display = 'none';
      gameScreen.style.display = 'none';
      if (window.resetGameState) {
        window.resetGameState();
      }
    }
  });

  // +++ MODIFIED createCharacter PATCH +++
  (function(){
    const originalCreate = window.createCharacter;
    if (typeof originalCreate === "function") {
      window.createCharacter = async function() {
        const name = document.getElementById('playerName').value.trim();
        if(!name) return alert('Enter a name first.');
        try {
          const nameLower = name.toLowerCase();
          const q = query(collection(db, "players"), where("name_lowercase", "==", nameLower));
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            return alert("That name is already taken. Please choose another.");
          }
        } catch (e) {
          console.error("Name check failed:", e);
          return alert("Error checking name. Please try again.");
        }
        
        originalCreate();
        
        const user = auth.currentUser;
        if (user) {
          await window.savePlayerData();
          window.renderLeaderboards();
          // +++ ADDED THIS LINE +++
          initChatListener(); // Start chat for new player
        }
      };
    }
  })();
  
  // +++ NEW CHAT FUNCTIONS START +++
  
  /**
   * Sends a new chat message to the 'messages' collection in Firestore.
   */
  async function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const messageText = chatInput.value.trim();

    if (messageText.length === 0) return; // Don't send empty messages
    if (messageText.length > 256) {
      alert("Message is too long (max 256 chars).");
      return;
    }

    const user = auth.currentUser;
    if (!user || !game.name) {
      alert("You must be logged in and have a character to chat.");
      return;
    }

    try {
      // Add a new document to the 'messages' collection
      await addDoc(collection(db, "messages"), {
        senderUid: user.uid,
        senderName: game.name,
        text: messageText,
        timestamp: serverTimestamp() // Uses the server's time
      });
      
      // Clear the input field
      chatInput.value = '';

    } catch (e) {
      console.error("Error sending message: ", e);
      alert("Failed to send message. Please try again.");
    }
  }

  /**
   * Initializes the real-time listener for the chat.
   */
  function initChatListener() {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;

    // Create a query to get the last 25 messages, ordered by time
    const q = query(
      collection(db, "messages"), 
      orderBy("timestamp", "desc"), 
      limit(25)
    );

    // onSnapshot creates a real-time listener
    onSnapshot(q, (querySnapshot) => {
      // Clear the existing messages
      chatMessagesContainer.innerHTML = '';
      
      // Loop through the messages (which are in reverse order)
      querySnapshot.forEach((doc) => {
        const msg = doc.data();
        
        const msgElement = document.createElement('div');
        msgElement.style.marginBottom = '6px';
        msgElement.style.lineHeight = '1.3';
        msgElement.style.wordBreak = 'break-word';

        const sender = document.createElement('strong');
        sender.style.color = 'var(--gold)'; 
        sender.textContent = msg.senderName ? `${msg.senderName}: ` : 'System: ';
        
        const text = document.createTextNode(msg.text);

        msgElement.appendChild(sender);
        msgElement.appendChild(text);
        
        chatMessagesContainer.appendChild(msgElement);
      });

    }, (error) => {
      console.error("Chat listener error: ", error);
      chatMessagesContainer.innerHTML = '<div style="color: red;">Error loading chat.</div>';
    });
  }
  // +++ NEW CHAT FUNCTIONS END +++


  // --- LEADERBOARD FUNCTION (Unchanged) ---
  window.renderLeaderboards = async function() {
    const contentContainer = document.getElementById('leaderboardContent'); 
    if (!contentContainer) return;
    contentContainer.innerHTML = `
      <div style="text-align:center; margin-top: 20px; color: #fff; opacity: 0.7;">Refreshing...</div>
    `;
    try {
      const playersCol = collection(db, "players");
      const q = query(playersCol);
      const querySnapshot = await getDocs(q);
      let players = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (!data.name || data.name === "") return;
        const totalXp = data.mining?.totalXP || 0; 
        players.push({
          name: data.name,
          totalXp: totalXp,
        });
      });
      players.sort((a, b) => b.totalXp - a.totalXp);
      let leaderboardHtml = '';
      players.slice(0, 10).forEach((player, index) => {
        const rank = index + 1;
        const xpFormatted = player.totalXp.toLocaleString();
        const isCurrentPlayer = (auth.currentUser && game.name === player.name); 
        leaderboardHtml += `
          <div style="display: flex; justify-content: space-between; padding: 2px 10px; border-bottom: 1px dashed rgba(255,255,255,0.1); background: ${isCurrentPlayer ? 'rgba(181, 166, 66, 0.1)' : 'transparent'};">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="width: 20px; text-align: right; font-weight: bold; color: ${rank <= 3 ? 'var(--gold)' : '#fff'};">${rank}.</span>
              <span>${xpFormatted}</span>
            </div>
            <span>${player.name}</span>
          </div>
        `;
      });
      if(players.length === 0){
        leaderboardHtml += `<div style="text-align:center; padding: 20px; opacity: 0.7;">No players found. Start playing to get on the board!</div>`;
      }
      contentContainer.innerHTML = leaderboardHtml;
    } catch (e) {
      console.error("Failed to load leaderboards:", e);
      contentContainer.innerHTML = `<div style="text-align:center; margin-top: 0px; color: red;">Failed to load data.</div>`;
    }
  }
  
  // +++ MODIFIED DOMContentLoaded +++
  document.addEventListener('DOMContentLoaded', () => {
    if (refreshLeaderboardBtn) {
        refreshLeaderboardBtn.onclick = window.renderLeaderboards;
    }

    // +++ ADDED CHAT LISTENERS +++
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatInput = document.getElementById('chatInput');

    if (chatSendBtn) {
      chatSendBtn.onclick = sendChatMessage;
    }

    if (chatInput) {
      // Optional: Allow sending by pressing 'Enter'
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault(); // Prevents a line break
          sendChatMessage();
        }
      });
    }
  });

  // --- Autosave and Logout functions (Unchanged) ---
  setInterval(() => {
    const user = auth.currentUser;
    if (user) {
      window.savePlayerData();
    }
  }, 30000);

  window.addEventListener('beforeunload', (e) => {
    try {
      const user = auth.currentUser;
      if (user) {
        window.savePlayerData();
      }
    } catch (err) { /* ignore */ }
  });

  window.firebaseLogout = async function() {
    try {
      await window.savePlayerData();
      await signOut(auth);
      if (window.resetGameState) {
        window.resetGameState();
      }
      alert("Logged out."); 
    } catch (e) {
      console.error("Logout failed:", e);
    }
  };
</script>
</body>
</html>